---
phase: 18-og-images-shareability
plan: 02
type: execute
wave: 2
depends_on: [18-01]
files_modified:
  - src/components/beauty-index/ShareControls.astro
  - src/pages/beauty-index/[slug].astro
autonomous: true

must_haves:
  truths:
    - "Clicking 'Download' on a language detail page saves a PNG file of the radar chart to the user's device"
    - "On mobile, clicking 'Share' opens the native OS share sheet with the radar chart as a PNG file"
    - "On desktop, clicking 'Copy' copies the radar chart PNG to the clipboard, with a toast confirmation"
    - "If clipboard image copy fails, the page URL is copied as text fallback"
  artifacts:
    - path: "src/components/beauty-index/ShareControls.astro"
      provides: "Download, share, and copy buttons with client-side SVG-to-PNG conversion"
      contains: "data-share-controls"
    - path: "src/pages/beauty-index/[slug].astro"
      provides: "ShareControls component integrated below the radar chart"
      contains: "ShareControls"
  key_links:
    - from: "src/components/beauty-index/ShareControls.astro"
      to: "RadarChart SVG element"
      via: "querySelector('[role=\"img\"][aria-label*=\"Radar chart\"]')"
      pattern: "querySelector.*role.*img.*Radar chart"
    - from: "src/components/beauty-index/ShareControls.astro"
      to: "navigator.share"
      via: "Web Share API with canShare guard"
      pattern: "navigator\\.share"
    - from: "src/components/beauty-index/ShareControls.astro"
      to: "navigator.clipboard.write"
      via: "Clipboard API with ClipboardItem"
      pattern: "ClipboardItem"
    - from: "src/pages/beauty-index/[slug].astro"
      to: "src/components/beauty-index/ShareControls.astro"
      via: "Astro component import"
      pattern: "import ShareControls"
---

<objective>
Add download, share, and copy functionality for radar chart images on language detail pages.

Purpose: Users can save radar charts as PNGs for presentations, share them via native mobile share sheets, or copy them to clipboard for pasting into messages. This satisfies SHARE-02 (download), SHARE-03 (Web Share API), and SHARE-04 (clipboard copy).

Output: A new ShareControls.astro component with client-side JavaScript for SVG-to-PNG conversion, and integration into the language detail page template.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-og-images-shareability/18-RESEARCH.md
@.planning/phases/18-og-images-shareability/18-01-SUMMARY.md

Key source files:
@src/components/beauty-index/RadarChart.astro
@src/pages/beauty-index/[slug].astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShareControls component with download/share/copy</name>
  <files>src/components/beauty-index/ShareControls.astro</files>
  <action>
Create `src/components/beauty-index/ShareControls.astro` — a component with two buttons and a toast notification, plus a client-side `<script>` for SVG-to-PNG conversion, download, Web Share API, and clipboard copy.

**Props interface:**
```typescript
interface Props {
  languageName: string;
  languageId: string;
}
```
Destructure props and compute `pageUrl = \`https://patrykgolabek.dev/beauty-index/${languageId}/\``

**HTML structure:**
- A container `<div>` with `class="flex items-center gap-3 mt-4"`, `data-share-controls`, `data-language-name={languageName}`, `data-page-url={pageUrl}`
- Download button: `<button type="button" data-action="download">` with a download SVG icon (16x16, path: "M8 2v8m0 0L5 7m3 3l3-3M3 12h10") and text "Download", aria-label "Download {languageName} radar chart as PNG"
- Share/Copy button: `<button type="button" data-action="share">` with a share SVG icon (16x16, path: "M6 9l4-4m-4 0h4v4M4 7v5h8") and text wrapped in `<span data-share-label>Share</span>`, aria-label "Share {languageName} radar chart"
- Both buttons styled: `class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-[var(--color-border)] text-sm hover:border-[var(--color-accent)] transition-colors"`
- Toast div: `<div data-toast>` positioned fixed bottom-6 center with opacity-0, pointer-events-none, transition-opacity, z-50, role="status" aria-live="polite". Background: `bg-[var(--color-text-primary)]`, text: `text-[var(--color-surface)]`

**Client-side script (inside `<script>` tag):**

Define `initShareControls()` function:

1. **Find elements:** Query `[data-share-controls]` container and extract `data-language-name`, `data-page-url`. Query the RadarChart SVG via `document.querySelector('[role="img"][aria-label*="Radar chart"]') as SVGSVGElement`. Return early if either is missing.

2. **Update button label:** If `navigator.share` and `navigator.canShare` exist, keep "Share" label. Otherwise change `[data-share-label]` text to "Copy".

3. **`svgToBlob(svg: SVGSVGElement): Promise<Blob>`** helper:
   - Serialize SVG with `new XMLSerializer().serializeToString(svg)`
   - Create Blob from serialized string (type: "image/svg+xml;charset=utf-8")
   - Create object URL from blob
   - Create canvas at 2x scale for crisp PNG output
   - Read SVG width/height from `svg.width.baseVal.value || 300` / `svg.height.baseVal.value || 300`
   - Set canvas.width = w * 2, canvas.height = h * 2, ctx.scale(2, 2)
   - Load image via `new Image()`, set src to object URL
   - In img.onload: fill white background (#faf8f5), draw image, revoke URL, call canvas.toBlob() to resolve promise
   - Wait for `document.fonts.ready` before serializing (ensures Noto Sans / DM Sans loaded)

4. **`showToast(message: string)`** helper:
   - Query `[data-toast]`, set textContent, set opacity to "1"
   - setTimeout to set opacity back to "0" after 2000ms

5. **Download handler:** `[data-action="download"]` click listener:
   - `await svgToBlob(svgElement)`
   - Create object URL, create `<a>` element with href and download filename `${languageName.toLowerCase().replace(/\s+/g, '-')}-beauty-index.png`
   - Append to body, click, remove, revoke URL

6. **Share/Copy handler:** `[data-action="share"]` click listener:
   - `const blob = await svgToBlob(svgElement)`
   - If `navigator.share && navigator.canShare`: create File from blob, build shareData with title, url, files. If `canShare(shareData)`, try `await navigator.share(shareData)`, return on success. Catch AbortError (user cancelled) and return. Other errors fall through to clipboard.
   - Clipboard fallback: `try { await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]); showToast('Chart copied to clipboard'); } catch { await navigator.clipboard.writeText(pageUrl); showToast('Link copied to clipboard'); }`

7. **Event binding:** `document.addEventListener('astro:page-load', initShareControls)` — this ensures the script re-runs on view transitions (matches the pattern used by ScoringTable's inline script).

**Important implementation notes:**
- All event listeners must be set up inside `initShareControls()` so they re-attach on view transitions
- The SVG element selector `[role="img"][aria-label*="Radar chart"]` matches the RadarChart.astro component which has `role="img"` and `aria-label="Radar chart for {language.name}..."`
- Use `async () => {}` for click handlers since svgToBlob is async and Web Share API requires the gesture context to still be active
- Do NOT use setTimeout or requestAnimationFrame between the click event and navigator.share() — the user gesture activation would expire
  </action>
  <verify>
Build succeeds: `npx astro build 2>&1 | tail -10`
Component file exists and contains the required elements: `grep -c 'data-share-controls' src/components/beauty-index/ShareControls.astro` returns >= 1
Script contains all three handlers: `grep -c 'data-action' src/components/beauty-index/ShareControls.astro` returns >= 2
  </verify>
  <done>
ShareControls.astro component exists with two visible buttons (Download and Share/Copy), a hidden toast, and a client-side script that converts inline SVG to PNG via canvas, supports download via anchor click, native sharing via Web Share API, and clipboard copy with ClipboardItem fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ShareControls into language detail pages</name>
  <files>src/pages/beauty-index/[slug].astro</files>
  <action>
Modify `src/pages/beauty-index/[slug].astro` to include the ShareControls component below the radar chart:

1. **Add import:** In the frontmatter, add `import ShareControls from '../../components/beauty-index/ShareControls.astro';` alongside existing imports.

2. **Place component:** In the "Chart + Scores row" grid (the `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">` section), add ShareControls below the RadarChart inside its flex container. The current structure is:
```html
<div class="flex justify-center">
  <RadarChart language={language} size={300} />
</div>
```
Change it to:
```html
<div class="flex flex-col items-center gap-2">
  <RadarChart language={language} size={300} />
  <ShareControls languageName={language.name} languageId={language.id} />
</div>
```
This places the download/share buttons directly below the radar chart, contextually near the visual they operate on (per research recommendation for button placement).

Note: The `flex justify-center` becomes `flex flex-col items-center gap-2` to stack the chart and buttons vertically while keeping them centered.
  </action>
  <verify>
Build succeeds: `npx astro build 2>&1 | tail -10`
Check ShareControls is rendered: `grep -c 'data-share-controls' dist/beauty-index/rust/index.html` returns >= 1
Check buttons exist: `grep -c 'data-action' dist/beauty-index/rust/index.html` returns >= 2
Check script is included: `grep -c 'initShareControls' dist/beauty-index/rust/index.html` returns >= 1
  </verify>
  <done>
Every language detail page at /beauty-index/[slug]/ renders Download and Share/Copy buttons below its radar chart. The buttons are functional: Download saves a 2x PNG, Share triggers native OS share sheet on mobile, and Copy puts the chart image on the clipboard (with text URL fallback) on desktop.
  </done>
</task>

</tasks>

<verification>
1. `npx astro build` completes without errors
2. Language detail pages contain ShareControls buttons: `grep 'data-share-controls' dist/beauty-index/python/index.html`
3. Download button has correct aria-label: `grep 'Download.*radar chart' dist/beauty-index/python/index.html`
4. Share button has correct aria-label: `grep 'Share.*radar chart' dist/beauty-index/python/index.html`
5. Client-side script initializes on page load: `grep 'astro:page-load' dist/beauty-index/python/index.html`
6. Toast element exists for feedback: `grep 'data-toast' dist/beauty-index/python/index.html`
7. SVG selector matches RadarChart output: `grep 'role="img"' dist/beauty-index/python/index.html`
</verification>

<success_criteria>
- ShareControls component renders on all 25 language detail pages
- Download button present with accessible label
- Share/Copy button present with adaptive label (Share on mobile, Copy on desktop)
- Client-side script handles SVG-to-PNG conversion at 2x resolution
- Web Share API used when available (navigator.share + canShare guard)
- Clipboard API fallback with ClipboardItem for image, writeText for URL
- Toast notification provides feedback for copy operations
- View transitions handled via astro:page-load re-initialization
</success_criteria>

<output>
After completion, create `.planning/phases/18-og-images-shareability/18-02-SUMMARY.md`
</output>
