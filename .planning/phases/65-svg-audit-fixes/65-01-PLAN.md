---
phase: 65-svg-audit-fixes
plan: 01
type: execute
wave: 1
depends_on: []
requirements: [SVG-03, SVG-04]
files_modified:
  - src/lib/eda/technique-renderer.ts
  - src/lib/eda/svg-generators/composite-plot.ts
autonomous: true

must_haves:
  truths:
    - "Bihistogram renders as back-to-back bars from a shared center line, not two stacked independent histograms"
    - "Mean Plot and SD Plot render as connected-dot plots with reference lines, not bar charts"
    - "Block Plot renders as connected group means across blocks, not bar chart"
    - "DOE Plots panel uses connected-dot mean/SD plots, not bar charts"
    - "6-Plot renders regression diagnostics (response vs predictor, residuals panels), not time-series ACF/spectral"
  artifacts:
    - path: "src/lib/eda/technique-renderer.ts"
      provides: "Rewired renderer map using dedicated generators for bihistogram, block-plot, mean-plot, std-deviation-plot, doe-plots"
      contains: "generateBihistogram"
    - path: "src/lib/eda/svg-generators/composite-plot.ts"
      provides: "Regression-based 6-plot"
      contains: "residuals"
  key_links:
    - from: "src/lib/eda/technique-renderer.ts"
      to: "src/lib/eda/svg-generators/bihistogram.ts"
      via: "import generateBihistogram"
      pattern: "generateBihistogram"
    - from: "src/lib/eda/technique-renderer.ts"
      to: "src/lib/eda/svg-generators/block-plot.ts"
      via: "import generateBlockPlot"
      pattern: "generateBlockPlot"
    - from: "src/lib/eda/technique-renderer.ts"
      to: "src/lib/eda/svg-generators/doe-mean-plot.ts"
      via: "import generateDoeMeanPlot"
      pattern: "generateDoeMeanPlot"
    - from: "src/lib/eda/technique-renderer.ts"
      to: "src/lib/eda/svg-generators/composite-plot.ts"
      via: "generate6Plot(scatterData) replacing generate6Plot(timeSeries)"
      pattern: "scatterData"
---

<objective>
Wire dedicated SVG generators into technique-renderer.ts for the 5 HIGH-priority techniques that currently use incorrect visual representations (bar charts instead of connected-dot plots, stacked histograms instead of back-to-back layout), and restructure the 6-plot as a regression diagnostic.

Purpose: These 5 techniques + 6-plot are the most visually inaccurate relative to NIST originals. The dedicated generators already exist but were never integrated. This plan connects them.
Output: technique-renderer.ts uses dedicated generators for bihistogram, block-plot, mean-plot, std-deviation-plot, and doe-plots; 6-plot renders regression diagnostics.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-svg-audit-fixes/65-RESEARCH.md
@src/lib/eda/technique-renderer.ts
@src/lib/eda/svg-generators/index.ts
@src/lib/eda/svg-generators/bihistogram.ts
@src/lib/eda/svg-generators/block-plot.ts
@src/lib/eda/svg-generators/doe-mean-plot.ts
@src/lib/eda/svg-generators/interaction-plot.ts
@src/lib/eda/svg-generators/autocorrelation-plot.ts
@src/lib/eda/svg-generators/composite-plot.ts
@src/data/eda/datasets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire dedicated generators for bihistogram, block-plot, mean-plot, std-deviation-plot, and doe-plots</name>
  <files>src/lib/eda/technique-renderer.ts</files>
  <action>
In technique-renderer.ts:

1. **Add imports** for the 5 dedicated generators from `./svg-generators`:
   - `generateBihistogram` (already exported from index.ts)
   - `generateBlockPlot` (already exported from index.ts)
   - `generateDoeMeanPlot` (already exported from index.ts)
   - `generateInteractionPlot` (already exported from index.ts -- needed for DOE interaction panel)

2. **Replace bihistogram** in TECHNIQUE_RENDERERS:
   - Remove `composeBihistogram` function call
   - Replace with:
     ```typescript
     'bihistogram': () => generateBihistogram({
       topData: normalRandom,
       bottomData: uniformRandom.map(v => v * 4 - 2),
       topLabel: 'Group A (Normal)',
       bottomLabel: 'Group B (Uniform)',
       title: 'Bihistogram',
       xLabel: 'Value',
     }),
     ```

3. **Replace block-plot** in TECHNIQUE_RENDERERS:
   - Remove `composeBlockPlot` function call
   - Replace with `generateBlockPlot` using data from doeFactors. Build blocks as treatment combinations, with CONSISTENT group names across all blocks so `generateBlockPlot` can draw connecting lines between groups:
     ```typescript
     'block-plot': () => {
       // NIST block plot: blocks on x-axis, groups are treatment levels that appear in EVERY block.
       // generateBlockPlot draws lines connecting same-named groups across blocks.
       // Group names MUST be identical across all blocks for lines to connect.
       return generateBlockPlot({
         blocks: [
           { label: 'Block 1', values: [
             { group: 'Catalyst A', mean: mean(doeFactors.filter(f => f.factor === 'Catalyst' && f.level === 'A').map(f => f.response)) },
             { group: 'Catalyst B', mean: mean(doeFactors.filter(f => f.factor === 'Catalyst' && f.level === 'B').map(f => f.response)) },
           ]},
           { label: 'Block 2', values: [
             { group: 'Catalyst A', mean: mean(doeFactors.filter(f => f.factor === 'Temperature' && f.level === 'Low').map(f => f.response)) },
             { group: 'Catalyst B', mean: mean(doeFactors.filter(f => f.factor === 'Temperature' && f.level === 'High').map(f => f.response)) },
           ]},
         ],
         title: 'Block Plot',
         yLabel: 'Mean Response',
         xLabel: 'Block',
       });
     },
     ```
     CRITICAL: The same group labels ('Catalyst A', 'Catalyst B') appear in EVERY block. This ensures `generateBlockPlot` draws connecting lines between blocks for each group. If group names differ across blocks (e.g., 'Catalyst' in Block 1 vs 'Temperature' in Block 2), no connecting lines will be drawn, producing disconnected dots instead of the NIST-standard connected-dot layout.

4. **Replace mean-plot** in TECHNIQUE_RENDERERS:
   - Remove the `generateBarPlot` call
   - Replace with `generateDoeMeanPlot`:
     ```typescript
     'mean-plot': () => generateDoeMeanPlot({
       factors: [
         { name: 'Temperature', levels: [{ label: 'Low', value: 73.5 }, { label: 'High', value: 85.9 }] },
         { name: 'Pressure', levels: [{ label: 'Low', value: 76.5 }, { label: 'High', value: 82.9 }] },
       ],
       grandMean: (73.5 + 85.9 + 76.5 + 82.9) / 4,
       title: 'Mean Plot',
       yLabel: 'Mean Response',
     }),
     ```

5. **Replace std-deviation-plot** in TECHNIQUE_RENDERERS:
   - Remove the `generateBarPlot` call
   - Replace with `generateDoeMeanPlot` (same generator works for SD plots, just different data and labels):
     ```typescript
     'std-deviation-plot': () => generateDoeMeanPlot({
       factors: [
         { name: 'Temperature', levels: [{ label: 'Low', value: 3.9 }, { label: 'High', value: 4.7 }] },
         { name: 'Pressure', levels: [{ label: 'Low', value: 7.2 }, { label: 'High', value: 7.9 }] },
       ],
       grandMean: (3.9 + 4.7 + 7.2 + 7.9) / 4,
       title: 'Standard Deviation Plot',
       yLabel: 'Std Dev',
     }),
     ```

6. **Replace doe-plots** composition:
   - Replace `composeDoePlots` with a new composition that uses:
     - Panel 1: DOE scatter (keep existing `generateScatterPlot` -- this is correct)
     - Panel 2: DOE mean plot via `generateDoeMeanPlot` (replaces `generateBarPlot`)
     - Panel 3: DOE SD plot via `generateDoeMeanPlot` (replaces `generateBarPlot`)
   - The composition layout (3 panels side-by-side) stays the same, only the inner generators change.

7. **Remove dead composition functions** that are now fully replaced:
   - `composeBihistogram` (replaced by dedicated generator)
   - `composeBlockPlot` (replaced by dedicated generator)
   - Keep `composeDoePlots` but refactor its inner panel generators

8. **Verify** `generateBarPlot` import can be removed ONLY if it is no longer used anywhere in the file. Check that no remaining technique or composition still calls it. If it is still used, keep the import.

Important: Do NOT modify any of the generator files themselves. Only modify technique-renderer.ts.
  </action>
  <verify>Run `npx astro build 2>&1 | tail -30` -- build must complete without errors. Spot-check: `npx astro build 2>&1 | grep -i "error"` returns nothing.</verify>
  <done>Bihistogram, block-plot, mean-plot, std-deviation-plot, and doe-plots all use dedicated generators (connected-dot style, not bar charts). No build errors.</done>
</task>

<task type="auto">
  <name>Task 2: Restructure 6-plot as regression diagnostic</name>
  <files>src/lib/eda/svg-generators/composite-plot.ts, src/lib/eda/technique-renderer.ts</files>
  <action>
The NIST 6-plot (Section 1.3.3.33) is a regression diagnostic display, not an enhanced 4-plot. Restructure `generate6Plot` in composite-plot.ts to show regression diagnostics:

1. **Change the function signature** of `generate6Plot` to accept bivariate data:
   ```typescript
   export function generate6Plot(
     data: { x: number; y: number }[],
     config?: Partial<PlotConfig>,
   ): string
   ```

2. **Import `linearRegression` and `mean`** from `../math/statistics` in composite-plot.ts.

3. **Import `generateScatterPlot`** from `./scatter-plot` in composite-plot.ts (for the response vs predictor panel).

4. **Compute regression** inside generate6Plot:
   ```typescript
   const xs = data.map(d => d.x);
   const ys = data.map(d => d.y);
   const reg = linearRegression(xs, ys);
   const residuals = data.map(d => d.y - (reg.slope * d.x + reg.intercept));
   const predicted = data.map(d => reg.slope * d.x + reg.intercept);
   ```

5. **Build 6 panels** (3x2 grid):
   - **Top-left:** Response vs Predictor (scatter plot with regression line) -- `generateScatterPlot({ data, showRegression: true })`
   - **Top-right:** Residuals vs Predictor -- `generateScatterPlot({ data: xs.map((x, i) => ({ x, y: residuals[i] })) })`
   - **Mid-left:** Residuals vs Predicted -- `generateScatterPlot({ data: predicted.map((p, i) => ({ x: p, y: residuals[i] })) })`
   - **Mid-right:** Lag plot of residuals -- `generateLagPlot({ data: residuals, lag: 1 })`
   - **Bottom-left:** Histogram of residuals -- `generateHistogram({ data: residuals, showKDE: true })`
   - **Bottom-right:** Normal probability plot of residuals -- `generateProbabilityPlot({ data: residuals, type: 'normal' })`

6. **Update technique-renderer.ts** to pass `scatterData` (bivariate) instead of `timeSeries` (univariate):
   ```typescript
   '6-plot': () => generate6Plot(scatterData),
   ```
   The `scatterData` import already exists in technique-renderer.ts.

7. **Add appropriate panel titles**: 'Y vs X', 'Residuals vs X', 'Residuals vs Predicted', 'Lag of Residuals', 'Residual Histogram', 'Residual Normal Prob'.

Important: Do NOT change `generate4Plot` -- it remains a time-series diagnostic and is correct.
  </action>
  <verify>Run `npx astro build 2>&1 | tail -30` -- build must complete without errors. The 6-plot page at `/eda/techniques/6-plot` must render (check build output for that route).</verify>
  <done>6-plot generates a 3x2 regression diagnostic display (response vs predictor, residuals vs predictor, residuals vs predicted, lag of residuals, residual histogram, residual normal probability). Build succeeds.</done>
</task>

</tasks>

<verification>
1. `npx astro build` completes with 0 errors
2. The following slugs now use dedicated generators (not bar plots or stacked compositions):
   - bihistogram -> generateBihistogram (back-to-back layout)
   - block-plot -> generateBlockPlot (connected dots)
   - mean-plot -> generateDoeMeanPlot (connected dots with grand mean line)
   - std-deviation-plot -> generateDoeMeanPlot (connected dots with grand mean line)
   - doe-plots -> uses generateDoeMeanPlot for mean/SD panels
3. 6-plot accepts bivariate scatterData and renders regression diagnostics
</verification>

<success_criteria>
- Build passes with zero errors
- 5 HIGH-priority techniques switched from bar charts / stacked histograms to dedicated generators
- 6-plot is a regression diagnostic, not a time-series diagnostic
- No other techniques broken (all 29 still render)
</success_criteria>

<output>
After completion, create `.planning/phases/65-svg-audit-fixes/65-01-SUMMARY.md`
</output>
