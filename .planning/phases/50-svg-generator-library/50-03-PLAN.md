---
phase: 50-svg-generator-library
plan: 03
type: execute
wave: 3
depends_on: [50-01, 50-02]
files_modified:
  - package.json
  - package-lock.json
  - src/lib/eda/svg-generators/contour-plot.ts
  - src/lib/eda/svg-generators/distribution-curve.ts
  - src/lib/eda/svg-generators/composite-plot.ts
  - src/lib/eda/svg-generators/index.ts
  - src/data/eda/datasets.ts
autonomous: true
requirements: [SVG-08, SVG-10, SVG-11]

must_haves:
  truths:
    - "Contour plot generator produces valid SVG with isolines from a 2D response surface grid"
    - "Distribution curve generator produces both PDF and CDF curves for at least normal, exponential, and chi-square distributions"
    - "Composite 4-plot generator correctly composes run-sequence, lag, histogram, and normal probability into a 2x2 grid layout"
    - "Composite 6-plot generator correctly composes all 4-plot charts plus ACF and spectral into a 3x2 grid layout"
    - "index.ts re-exports all 13 generators from a single entry point"
    - "Every generator is importable and produces valid SVG from sample data"
  artifacts:
    - path: "src/lib/eda/svg-generators/contour-plot.ts"
      provides: "Contour plot for response surface visualization"
      exports: ["generateContourPlot", "ContourPlotOptions"]
    - path: "src/lib/eda/svg-generators/distribution-curve.ts"
      provides: "Distribution PDF/CDF curve generator for at least 6 distributions"
      exports: ["generateDistributionCurve", "DistributionCurveOptions"]
    - path: "src/lib/eda/svg-generators/composite-plot.ts"
      provides: "4-plot and 6-plot composite layouts"
      exports: ["generate4Plot", "generate6Plot"]
    - path: "src/lib/eda/svg-generators/index.ts"
      provides: "Barrel export for all 13 SVG generators"
      exports: ["generateHistogram", "generateBoxPlot", "generateBarPlot", "generateScatterPlot", "generateLinePlot", "generateLagPlot", "generateProbabilityPlot", "generateSpectralPlot", "generateStarPlot", "generateContourPlot", "generateDistributionCurve", "generate4Plot", "generate6Plot"]
  key_links:
    - from: "src/lib/eda/svg-generators/contour-plot.ts"
      to: "d3-contour"
      via: "npm dependency for marching squares contour generation"
      pattern: "import.*from.*d3-contour"
    - from: "src/lib/eda/svg-generators/composite-plot.ts"
      to: "src/lib/eda/svg-generators/histogram.ts"
      via: "imports generateHistogram for 4-plot sub-panel"
      pattern: "import.*generateHistogram.*from"
    - from: "src/lib/eda/svg-generators/composite-plot.ts"
      to: "src/lib/eda/svg-generators/line-plot.ts"
      via: "imports generateLinePlot for run-sequence and ACF sub-panels"
      pattern: "import.*generateLinePlot.*from"
    - from: "src/lib/eda/svg-generators/composite-plot.ts"
      to: "src/lib/eda/svg-generators/lag-plot.ts"
      via: "imports generateLagPlot for lag sub-panel"
      pattern: "import.*generateLagPlot.*from"
    - from: "src/lib/eda/svg-generators/composite-plot.ts"
      to: "src/lib/eda/svg-generators/probability-plot.ts"
      via: "imports generateProbabilityPlot for normal probability sub-panel"
      pattern: "import.*generateProbabilityPlot.*from"
    - from: "src/lib/eda/svg-generators/index.ts"
      to: "src/lib/eda/svg-generators/*.ts"
      via: "re-exports all generators from single entry point"
      pattern: "export.*from"
---

<objective>
Install d3-contour, create the final three generator types (contour plot, distribution curves, composite layouts), wire up the barrel export index, and validate the complete 13-generator library produces valid SVG for all chart types.

Purpose: Completes the SVG generator library with the most complex generators -- contour plots requiring a new dependency, distribution curves requiring multi-function math, and composite layouts that compose 4-6 sub-generators into multi-panel diagnostic plots. The barrel export provides a clean public API for Phase 51+ consumption.

Output: 4 new TypeScript files + d3-contour dependency + datasets.ts update + full library validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-svg-generator-library/50-RESEARCH.md
@.planning/phases/50-svg-generator-library/50-01-SUMMARY.md
@.planning/phases/50-svg-generator-library/50-02-SUMMARY.md
@src/data/eda/datasets.ts
@src/lib/eda/svg-generators/plot-base.ts
@src/lib/eda/svg-generators/histogram.ts
@src/lib/eda/svg-generators/line-plot.ts
@src/lib/eda/svg-generators/lag-plot.ts
@src/lib/eda/svg-generators/probability-plot.ts
@src/lib/eda/svg-generators/spectral-plot.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install d3-contour, create contour plot and distribution curve generators, add response surface dataset</name>
  <files>
    package.json
    package-lock.json
    src/lib/eda/svg-generators/contour-plot.ts
    src/lib/eda/svg-generators/distribution-curve.ts
    src/data/eda/datasets.ts
  </files>
  <action>
**Install d3-contour:**
```bash
npm install d3-contour@^4.0.2
```
This is the only new npm dependency for Phase 50 (~4KB, pure computation, marching squares algorithm for contour generation).

**Update `src/data/eda/datasets.ts`** — add a 2D response surface grid for contour plot testing:

Add a new export `responseSurface` at the end of the file (before DATASET_SOURCES). This is a synthetic 2D grid generated from the DOE factors using a simple polynomial response model:

```typescript
// 7. Response Surface Grid (for contour plot testing)
// Synthetic 2D response surface: z = f(temperature, pressure)
// Grid: 20x20 points, temperature [60,100], pressure [10,50]
export const responseSurface: { width: number; height: number; values: number[] } = {
  width: 20,
  height: 20,
  values: /* 400-element flat array computed as z = -0.01*(T-80)^2 - 0.005*(P-30)^2 + 92 + noise */
};
```

Generate the 400 values using the polynomial formula with small random noise (use fixed seed values, not Math.random -- hardcode the array for reproducibility). The response surface should show a clear peak around temperature=80, pressure=30. Also add the entry to DATASET_SOURCES.

**Create `src/lib/eda/svg-generators/contour-plot.ts`** (SVG-08):

1. Export `ContourPlotOptions` interface:
   - `grid: { width: number; height: number; values: number[] }` — flat array of z-values on regular grid (row-major order)
   - `xDomain?: [number, number]` — X axis range (default: [0, grid.width])
   - `yDomain?: [number, number]` — Y axis range (default: [0, grid.height])
   - `thresholds?: number` — number of contour levels (default: 10)
   - `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Export `generateContourPlot(options): string`:
   - Guard clause: if grid.values.length !== grid.width * grid.height, return placeholder SVG
   - Import `contours` from `d3-contour`. Create contour generator: `contours().size([grid.width, grid.height]).thresholds(thresholds)`
   - Call `contoursGen(grid.values)` to get GeoJSON MultiPolygon features with threshold values
   - Use `d3-scale` scaleLinear to map grid coordinates to SVG plot area coordinates
   - Use `d3-scale` scaleSequential with `d3-interpolate` `interpolateRgbBasis` to create a color scale from PALETTE.dataSecondary (low values) through PALETTE.surface (mid) to PALETTE.dataPrimary (high values). Since we need CSS-var-free colors for the interpolation, use the actual hex values: `['#006d6d', '#fffaf7', '#c44b20']` for light mode. Wrap each contour path in a `<g>` with `class="contour-fill"` so dark mode can be handled via CSS if needed
   - For each contour level, convert the GeoJSON coordinates to SVG path data. Scale coordinates: `xSvg = margin.left + (geoX / grid.width) * innerWidth`, `ySvg = margin.top + (1 - geoY / grid.height) * innerHeight` (flip Y)
   - Render filled contour bands as `<path>` with the color scale fill and 0.7 opacity
   - Render contour lines (outlines) as `<path>` with PALETTE.textSecondary stroke, 0.5px
   - Add color legend: small rectangles at the right side showing the threshold-to-color mapping
   - Grid lines, axes, title. Use wider right margin (50px instead of 20px) to accommodate legend

**Create `src/lib/eda/svg-generators/distribution-curve.ts`** (SVG-11):

1. Export `DistributionCurveOptions` interface:
   - `type: 'pdf' | 'cdf'`
   - `distribution: 'normal' | 'exponential' | 'chi-square' | 'uniform' | 't' | 'gamma'`
   - `params: Record<string, number>` — distribution-specific parameters (e.g., `{mu: 0, sigma: 1}` for normal)
   - `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Implement distribution math functions (private helpers within the module):
   - `normalPDF(x, mu, sigma)` and `normalCDF(x, mu, sigma)` — using standard formula and erf approximation
   - `exponentialPDF(x, lambda)` and `exponentialCDF(x, lambda)` — `lambda * exp(-lambda*x)` for x >= 0
   - `chiSquarePDF(x, k)` and `chiSquareCDF(x, k)` — using gamma function approximation (Stirling). Only needs to work for integer k from 1-30
   - `uniformPDF(x, a, b)` and `uniformCDF(x, a, b)` — piecewise constant/linear
   - `tPDF(x, nu)` and `tCDF(x, nu)` — Student's t using gamma ratio formula
   - `gammaPDF(x, alpha, beta)` and `gammaCDF(x, alpha, beta)` — using Lanczos gamma approximation

3. Export `generateDistributionCurve(options): string`:
   - Determine x-domain from distribution type and parameters (e.g., normal: [mu - 4*sigma, mu + 4*sigma], exponential: [0, 5/lambda], etc.)
   - Generate 200 evaluation points across the x-domain
   - Compute y-values using the appropriate PDF or CDF function
   - Use `d3-scale` scaleLinear for X and Y. Y range inverted
   - Render curve as `<path>` using `d3-shape` line() with curveBasis, PALETTE.dataPrimary stroke 2px
   - Fill area under PDF curve with PALETTE.dataPrimary at 0.1 opacity using `d3-shape` area()
   - For CDF: no fill, just the line
   - Add distribution name + parameter annotation as text in the plot area
   - Grid lines, axes, title

4. Implement the erf approximation for normalCDF using Abramowitz and Stegun formula 7.1.26 (max error 1.5e-7). This is a well-known polynomial approximation:
   ```
   erf(x) = 1 - (a1*t + a2*t^2 + a3*t^3 + a4*t^4 + a5*t^5) * exp(-x^2)
   where t = 1/(1 + 0.3275911*x)
   ```

5. Implement the Lanczos gamma function approximation for gamma/chi-square/t distributions. Use g=7, standard Lanczos coefficients. This gives accurate results for real positive arguments.

**Success criteria 5 requires normal, exponential, chi-square at minimum. This implements 6 distributions (normal, exponential, chi-square, uniform, t, gamma) per research recommendation.**
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
      const { generateContourPlot } = require('./src/lib/eda/svg-generators/contour-plot');
      const { generateDistributionCurve } = require('./src/lib/eda/svg-generators/distribution-curve');
      const { responseSurface } = require('./src/data/eda/datasets');

      // Contour plot
      const contour = generateContourPlot({ grid: responseSurface, title: 'Response Surface', xLabel: 'Temperature', yLabel: 'Pressure' });
      if (!contour.includes('<svg') || !contour.includes('viewBox')) throw new Error('Invalid contour SVG');
      if (!contour.includes('<path')) throw new Error('Contour missing path elements');

      // Distribution curves - test the 3 required distributions (normal, exponential, chi-square)
      const normalPdf = generateDistributionCurve({ type: 'pdf', distribution: 'normal', params: { mu: 0, sigma: 1 }, title: 'Standard Normal PDF' });
      const normalCdf = generateDistributionCurve({ type: 'cdf', distribution: 'normal', params: { mu: 0, sigma: 1 }, title: 'Standard Normal CDF' });
      const expPdf = generateDistributionCurve({ type: 'pdf', distribution: 'exponential', params: { lambda: 1 }, title: 'Exponential PDF' });
      const chiPdf = generateDistributionCurve({ type: 'pdf', distribution: 'chi-square', params: { k: 5 }, title: 'Chi-Square PDF (k=5)' });

      for (const [n, s] of [['contour', contour], ['normalPdf', normalPdf], ['normalCdf', normalCdf], ['expPdf', expPdf], ['chiPdf', chiPdf]]) {
        if (!s.includes('<svg')) throw new Error(n + ' invalid SVG');
        if (s.includes('NaN')) throw new Error(n + ' contains NaN');
      }

      // Verify all 6 distributions work
      const tPdf = generateDistributionCurve({ type: 'pdf', distribution: 't', params: { nu: 5 } });
      const gammaPdf = generateDistributionCurve({ type: 'pdf', distribution: 'gamma', params: { alpha: 2, beta: 1 } });
      const uniformPdf = generateDistributionCurve({ type: 'pdf', distribution: 'uniform', params: { a: 0, b: 1 } });
      for (const [n, s] of [['t', tPdf], ['gamma', gammaPdf], ['uniform', uniformPdf]]) {
        if (s.includes('NaN')) throw new Error(n + ' contains NaN');
      }

      console.log('PASS: contour (' + contour.length + '), 3 required dist curves + 3 additional verified');
    "</automated>
  </verify>
  <done>
    - d3-contour@^4.0.2 installed as npm dependency
    - responseSurface dataset added to datasets.ts (20x20 grid with polynomial response model)
    - generateContourPlot produces valid SVG with filled contour bands and isolines from response surface data (SVG-08)
    - generateDistributionCurve produces valid PDF and CDF curves for all 6 distributions: normal, exponential, chi-square, uniform, t, gamma (SVG-11)
    - Success criteria 5 met: normal, exponential, and chi-square all produce correct curves
    - No NaN in any generated SVG
  </done>
</task>

<task type="auto">
  <name>Task 2: Create composite plot generators, barrel export index, and validate complete library</name>
  <files>
    src/lib/eda/svg-generators/composite-plot.ts
    src/lib/eda/svg-generators/index.ts
  </files>
  <action>
**Create `src/lib/eda/svg-generators/composite-plot.ts`** (SVG-10):

1. Export `generate4Plot(data: number[], config?: Partial<PlotConfig>): string`:
   - Creates a 2x2 grid layout composing 4 individual generators:
     - Top-left: Run sequence plot (generateLinePlot, mode='run-sequence')
     - Top-right: Lag plot (generateLagPlot, lag=1)
     - Bottom-left: Histogram (generateHistogram, showKDE=true)
     - Bottom-right: Normal probability plot (generateProbabilityPlot, type='normal')
   - Use a wider viewBox: width=800, height=600 (or config override)
   - Compute sub-plot dimensions: halfW = (width - 20) / 2, halfH = (height - 20) / 2
   - Create sub-config: `{ width: halfW, height: halfH, margin: { top: 30, right: 15, bottom: 35, left: 50 } }`
   - Call each generator with sub-config and the shared data array
   - Strip `<svg>...</svg>` wrapper from each sub-output (regex: remove opening `<svg[^>]*>` and closing `</svg>`)
   - Wrap each stripped output in a `<g transform="translate(x, y)">` positioned in the 2x2 grid:
     - Top-left: translate(0, 0)
     - Top-right: translate(halfW + 10, 0)
     - Bottom-left: translate(0, halfH + 10)
     - Bottom-right: translate(halfW + 10, halfH + 10)
   - Wrap everything in svgOpen with the full config and aria-label "4-Plot diagnostic layout"

2. Export `generate6Plot(data: number[], config?: Partial<PlotConfig>): string`:
   - Creates a 3x2 grid layout composing 6 individual generators:
     - Row 1: Run sequence (left), Lag plot (right)
     - Row 2: Histogram with KDE (left), Normal probability plot (right)
     - Row 3: Autocorrelation plot (generateLinePlot, mode='autocorrelation') (left), Spectral plot (generateSpectralPlot) (right)
   - Use viewBox: width=800, height=900 (or config override)
   - Compute sub-plot dimensions: halfW = (width - 20) / 2, thirdH = (height - 30) / 3
   - Create sub-config with margins appropriate for smaller panels
   - Same strip-and-translate pattern as 4-plot but with 6 positions in 3x2 grid:
     - (0, 0), (halfW+10, 0), (0, thirdH+10), (halfW+10, thirdH+10), (0, 2*(thirdH+10)), (halfW+10, 2*(thirdH+10))

3. Import all needed generators from their individual files (NOT from index.ts to avoid circular imports):
   - `generateLinePlot` from './line-plot'
   - `generateLagPlot` from './lag-plot'
   - `generateHistogram` from './histogram'
   - `generateProbabilityPlot` from './probability-plot'
   - `generateSpectralPlot` from './spectral-plot'

**Create `src/lib/eda/svg-generators/index.ts`** — barrel export:

Re-export all generators and their option types from a single entry point:

```typescript
// Chart generators
export { generateHistogram, type HistogramOptions } from './histogram';
export { generateBoxPlot, type BoxPlotOptions } from './box-plot';
export { generateBarPlot, type BarPlotOptions } from './bar-plot';
export { generateScatterPlot, type ScatterPlotOptions } from './scatter-plot';
export { generateLinePlot, type LinePlotOptions } from './line-plot';
export { generateLagPlot, type LagPlotOptions } from './lag-plot';
export { generateProbabilityPlot, type ProbabilityPlotOptions } from './probability-plot';
export { generateSpectralPlot, type SpectralPlotOptions } from './spectral-plot';
export { generateStarPlot, type StarPlotOptions } from './star-plot';
export { generateContourPlot, type ContourPlotOptions } from './contour-plot';
export { generateDistributionCurve, type DistributionCurveOptions } from './distribution-curve';
export { generate4Plot, generate6Plot } from './composite-plot';

// Shared types and utilities
export { PALETTE, DEFAULT_CONFIG, type PlotConfig } from './plot-base';
```

**Final validation:** After creating both files, run a comprehensive test that imports every generator from the index and produces SVG from the appropriate dataset, checking:
- All 15 exports exist (13 generators + PALETTE + DEFAULT_CONFIG)
- Every SVG contains `viewBox` and no fixed `width=` attribute
- Every SVG contains CSS variable references `var(--color`
- No SVG contains `NaN`
- 4-plot contains 4 sub-panels (verify it contains data from run-sequence, lag, histogram, and probability sub-generators)
- 6-plot contains 6 sub-panels
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
      const idx = require('./src/lib/eda/svg-generators/index');
      const ds = require('./src/data/eda/datasets');

      // Verify all 15 exports exist
      const required = ['generateHistogram','generateBoxPlot','generateBarPlot','generateScatterPlot','generateLinePlot','generateLagPlot','generateProbabilityPlot','generateSpectralPlot','generateStarPlot','generateContourPlot','generateDistributionCurve','generate4Plot','generate6Plot','PALETTE','DEFAULT_CONFIG'];
      for (const r of required) { if (!idx[r]) throw new Error('Missing export: ' + r); }

      // Test composite 4-plot
      const fourPlot = idx.generate4Plot(ds.normalRandom);
      if (!fourPlot.includes('<svg') || !fourPlot.includes('viewBox')) throw new Error('Invalid 4-plot');
      if (!fourPlot.includes('<g transform')) throw new Error('4-plot missing transform groups');
      if (fourPlot.includes('NaN')) throw new Error('4-plot contains NaN');

      // Test composite 6-plot
      const sixPlot = idx.generate6Plot(ds.timeSeries);
      if (!sixPlot.includes('<svg') || !sixPlot.includes('viewBox')) throw new Error('Invalid 6-plot');
      if (!sixPlot.includes('<g transform')) throw new Error('6-plot missing transform groups');
      if (sixPlot.includes('NaN')) throw new Error('6-plot contains NaN');

      // Full library validation: generate one SVG per generator type
      const tests = [
        ['histogram', idx.generateHistogram({ data: ds.normalRandom })],
        ['boxPlot', idx.generateBoxPlot({ groups: ds.boxPlotData.map(g => ({ label: g.group, values: g.values })) })],
        ['barPlot', idx.generateBarPlot({ categories: [{ label: 'A', value: 72 }, { label: 'B', value: 85 }] })],
        ['scatter', idx.generateScatterPlot({ data: ds.scatterData })],
        ['linePlot', idx.generateLinePlot({ data: ds.timeSeries })],
        ['lagPlot', idx.generateLagPlot({ data: ds.normalRandom })],
        ['probPlot', idx.generateProbabilityPlot({ data: ds.normalRandom })],
        ['spectral', idx.generateSpectralPlot({ data: ds.timeSeries })],
        ['starPlot', idx.generateStarPlot({ axes: [{ label: 'A', value: 7 }, { label: 'B', value: 5 }, { label: 'C', value: 8 }] })],
        ['contour', idx.generateContourPlot({ grid: ds.responseSurface })],
        ['distCurve', idx.generateDistributionCurve({ type: 'pdf', distribution: 'normal', params: { mu: 0, sigma: 1 } })],
        ['4plot', fourPlot],
        ['6plot', sixPlot],
      ];

      let totalSize = 0;
      for (const [name, svg] of tests) {
        if (!svg.includes('viewBox')) throw new Error(name + ' missing viewBox');
        if (svg.includes('NaN')) throw new Error(name + ' has NaN');
        totalSize += svg.length;
      }

      console.log('PASS: All 13 generators validated. Total SVG output: ' + (totalSize / 1024).toFixed(1) + ' KB');
      console.log('4-plot: ' + fourPlot.length + ' chars, 6-plot: ' + sixPlot.length + ' chars');
    "</automated>
  </verify>
  <done>
    - composite-plot.ts generate4Plot composes run-sequence + lag + histogram + normal probability in 2x2 grid (SVG-10)
    - composite-plot.ts generate6Plot composes all 4-plot charts + ACF + spectral in 3x2 grid (SVG-10)
    - index.ts re-exports all 13 generators + PALETTE + DEFAULT_CONFIG from single entry point
    - Full library validation: all 13 generators produce valid SVG from datasets.ts data with no NaN
    - All SVGs use viewBox (SVG-12) and CSS variables (SVG-13)
    - d3-contour installed and used by contour-plot.ts (SVG-08)
    - Phase 50 complete: 15 SVG requirements satisfied
  </done>
</task>

</tasks>

<verification>
1. `npm ls d3-contour` confirms d3-contour@^4.0.2 installed
2. All 13 generators importable from `src/lib/eda/svg-generators/index.ts`
3. Every generator produces valid SVG with viewBox, CSS variables, no NaN
4. 4-plot contains 4 `<g transform>` groups composing sub-generators
5. 6-plot contains 6 `<g transform>` groups composing sub-generators
6. Distribution curve works for normal, exponential, chi-square (success criteria 5)
7. `npm run build` succeeds without errors (no build regression)
</verification>

<success_criteria>
- contour-plot.ts, distribution-curve.ts, composite-plot.ts, index.ts all exist and export documented interfaces
- d3-contour is installed as npm dependency
- responseSurface dataset added to datasets.ts
- generate4Plot and generate6Plot correctly compose sub-generators into multi-panel SVG
- index.ts barrel exports all 13 generators + shared types
- Complete library validation passes: 13 generators, all valid SVG, no NaN, viewBox-only, CSS-variable-themed
- Phase 50 success criteria all met (15 generator functions, viewBox responsive, dark/light theme, composite layouts, distribution curves for 3+ distributions)
</success_criteria>

<output>
After completion, create `.planning/phases/50-svg-generator-library/50-03-SUMMARY.md`
</output>
