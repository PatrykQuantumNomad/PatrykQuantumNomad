---
phase: 50-svg-generator-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/eda/svg-generators/plot-base.ts
  - src/lib/eda/math/statistics.ts
  - src/styles/global.css
  - src/lib/eda/svg-generators/histogram.ts
  - src/lib/eda/svg-generators/box-plot.ts
  - src/lib/eda/svg-generators/bar-plot.ts
autonomous: true
requirements: [SVG-01, SVG-02, SVG-03, SVG-07, SVG-12, SVG-13]

must_haves:
  truths:
    - "plot-base.ts provides shared axes, grid lines, viewBox, and palette constants that all generators import"
    - "statistics.ts provides KDE, linear regression, normal quantile, autocorrelation, FFT, and power spectrum functions"
    - "Histogram generator produces valid SVG with bars and optional KDE overlay from normalRandom dataset"
    - "Box plot generator produces valid SVG with quartile markers, median, whiskers, and outlier dots from boxPlotData"
    - "Bar plot generator produces valid SVG with grouped bars from doeFactors dataset"
    - "All generated SVGs use viewBox with no fixed width/height attributes"
    - "All generated SVGs use CSS variable references via PALETTE constants for dark/light theme support"
    - "Dark mode CSS variable overrides exist in global.css for SVG readability"
  artifacts:
    - path: "src/lib/eda/svg-generators/plot-base.ts"
      provides: "PALETTE, PlotConfig, DEFAULT_CONFIG, svgOpen, innerDimensions, xAxis, yAxis, gridLinesH, gridLinesV"
      exports: ["PALETTE", "PlotConfig", "DEFAULT_CONFIG", "svgOpen", "innerDimensions", "xAxis", "yAxis", "gridLinesH", "gridLinesV"]
    - path: "src/lib/eda/math/statistics.ts"
      provides: "Statistical math functions for SVG generators"
      exports: ["kde", "silvermanBandwidth", "linearRegression", "normalQuantile", "autocorrelation", "fft", "powerSpectrum", "mean", "standardDeviation"]
    - path: "src/lib/eda/svg-generators/histogram.ts"
      provides: "Histogram SVG generator with configurable bins and KDE overlay"
      exports: ["generateHistogram", "HistogramOptions"]
    - path: "src/lib/eda/svg-generators/box-plot.ts"
      provides: "Box plot SVG generator with quartiles, whiskers, outliers"
      exports: ["generateBoxPlot", "BoxPlotOptions"]
    - path: "src/lib/eda/svg-generators/bar-plot.ts"
      provides: "Bar plot SVG generator for mean/SD/DOE plots"
      exports: ["generateBarPlot", "BarPlotOptions"]
  key_links:
    - from: "src/lib/eda/svg-generators/histogram.ts"
      to: "src/lib/eda/svg-generators/plot-base.ts"
      via: "imports PALETTE, svgOpen, xAxis, yAxis, gridLinesH, innerDimensions, DEFAULT_CONFIG"
      pattern: "import.*from.*plot-base"
    - from: "src/lib/eda/svg-generators/histogram.ts"
      to: "src/lib/eda/math/statistics.ts"
      via: "imports kde, silvermanBandwidth for KDE overlay"
      pattern: "import.*from.*statistics"
    - from: "src/styles/global.css"
      to: "src/lib/eda/svg-generators/plot-base.ts"
      via: "CSS variables referenced by PALETTE constants resolve in both light and dark themes"
      pattern: "html\\.dark.*--color"
---

<objective>
Create the SVG generator foundation (plot-base.ts, statistics.ts, dark mode CSS) and the first three chart generators (histogram, box plot, bar plot) that produce publication-quality SVG markup from NIST sample data.

Purpose: Establishes the shared infrastructure (axes, grid, palette, math) that all 13 chart generators depend on, plus delivers the three simplest bar/rect-based generators as proof that the pattern works end-to-end.

Output: 6 new TypeScript files + CSS update, producing valid SVG strings from datasets.ts data arrays.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-svg-generator-library/50-RESEARCH.md
@src/data/eda/datasets.ts
@src/lib/beauty-index/radar-math.ts
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plot-base.ts foundation, statistics.ts math module, and dark mode CSS overrides</name>
  <files>
    src/lib/eda/svg-generators/plot-base.ts
    src/lib/eda/math/statistics.ts
    src/styles/global.css
  </files>
  <action>
**Create `src/lib/eda/svg-generators/plot-base.ts`** — the shared foundation imported by every SVG generator:

1. Define `PALETTE` constant object mapping semantic roles to CSS custom property references:
   - `text`: `var(--color-text-primary)`, `textSecondary`: `var(--color-text-secondary)`
   - `axis`: `var(--color-text-secondary)`, `grid`: `var(--color-border)`
   - `dataPrimary`: `var(--color-accent)` (burnt orange), `dataSecondary`: `var(--color-accent-secondary)` (teal)
   - `dataTertiary`: `var(--color-gradient-end)`, `surface`: `var(--color-surface)`, `surfaceAlt`: `var(--color-surface-alt)`
   - Mark as `as const` for type safety

2. Define `PlotConfig` interface with: `width`, `height`, `margin` (top/right/bottom/left), optional `title`, `xLabel`, `yLabel`, `fontFamily`

3. Export `DEFAULT_CONFIG`: width=600, height=400, margin={top:40, right:20, bottom:50, left:60}, fontFamily="'DM Sans', sans-serif"

4. Implement helper functions (see research Pattern 1 for exact signatures):
   - `innerDimensions(config)` — returns `{innerWidth, innerHeight}` computed from config
   - `svgOpen(config, ariaLabel)` — returns `<svg viewBox="0 0 W H" xmlns="..." role="img" aria-label="..." style="width:100%;height:auto;max-width:Wpx">`. NO width/height attributes (SVG-12). Include `role="img"` and `aria-label` for accessibility
   - `gridLinesH(yTicks, yScale, xStart, xEnd)` — horizontal dashed grid lines using PALETTE.grid
   - `gridLinesV(xTicks, xScale, yStart, yEnd)` — vertical dashed grid lines using PALETTE.grid
   - `xAxis(ticks, scale, y, label, config, formatter?)` — axis line + tick marks + tick labels + axis label. Use PALETTE.axis for strokes, PALETTE.textSecondary for tick labels, PALETTE.text for axis label. Use `dy="0.35em"` for vertical text centering (avoids dominant-baseline inconsistency)
   - `yAxis(ticks, scale, x, label, config, formatter?)` — same pattern, rotated label via SVG transform
   - `titleText(config, title)` — centered title above plot area using PALETTE.text, font-weight bold, font-size 14

5. All numeric coordinates must use `.toFixed(2)` to prevent SVG bloat from high-precision decimals.

**Create `src/lib/eda/math/statistics.ts`** — pure math functions (no D3, no DOM):

1. `mean(data: number[]): number` — arithmetic mean
2. `standardDeviation(data: number[]): number` — sample standard deviation (Bessel's correction, n-1)
3. `kde(data: number[], bandwidth: number, points: number[]): number[]` — Gaussian kernel density estimation
4. `silvermanBandwidth(data: number[]): number` — Silverman's rule-of-thumb bandwidth selection
5. `linearRegression(x: number[], y: number[]): { slope: number; intercept: number; r2: number }` — OLS linear regression with R-squared
6. `normalQuantile(p: number): number` — Beasley-Springer-Moro rational approximation of the normal inverse CDF (probit). Handle p <= 0 and p >= 1 edge cases (return -Infinity/+Infinity)
7. `autocorrelation(data: number[], maxLag: number): number[]` — normalized autocorrelation function returning array of ACF values for lags 0..maxLag
8. `fft(re: number[], im: number[]): void` — in-place Cooley-Tukey radix-2 FFT. Input arrays must be power-of-2 length. Modifies arrays in place
9. `powerSpectrum(data: number[]): number[]` — zero-pad data to next power of 2, run FFT, return one-sided power spectral density array (length N/2+1)

Guard clauses: all functions should handle empty arrays gracefully (return 0, empty array, or NaN as appropriate). Add JSDoc comments for each function.

**Update `src/styles/global.css`** — add dark mode CSS variable overrides:

After the existing `:root` block (Tropical Sunset Palette), add:

```css
/* --- Dark Palette (Quantum Explorer) --- */
html.dark {
  --color-surface: #0f1117;
  --color-surface-alt: #1a1d27;
  --color-text-primary: #e8e8f0;
  --color-text-secondary: #9ca3af;
  --color-accent: #e06040;
  --color-accent-hover: #f07050;
  --color-accent-secondary: #00a3a3;
  --color-accent-glow: rgba(224, 96, 64, 0.3);
  --color-gradient-start: #e06040;
  --color-gradient-end: #00a3a3;
  --color-border: #2a2d3a;
  --color-glow-intense: rgba(224, 96, 64, 0.5);
  --color-glow-neon: rgba(0, 163, 163, 0.3);
}
```

These values are slightly brighter than the light palette to maintain contrast against the dark background. The same CSS variable names used in PALETTE will automatically resolve correctly in both themes.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
      const pb = require('./src/lib/eda/svg-generators/plot-base');
      const st = require('./src/lib/eda/math/statistics');
      // Check plot-base exports
      const exports = ['PALETTE','DEFAULT_CONFIG','svgOpen','innerDimensions','xAxis','yAxis','gridLinesH','gridLinesV'];
      for (const e of exports) { if (!pb[e]) throw new Error('Missing: ' + e); }
      // Check statistics exports
      const statExports = ['mean','standardDeviation','kde','silvermanBandwidth','linearRegression','normalQuantile','autocorrelation','fft','powerSpectrum'];
      for (const e of statExports) { if (!st[e]) throw new Error('Missing stat: ' + e); }
      // Check svgOpen produces viewBox without width/height attrs
      const svg = pb.svgOpen(pb.DEFAULT_CONFIG, 'test');
      if (!svg.includes('viewBox')) throw new Error('No viewBox');
      if (/width=\"\\d/.test(svg)) throw new Error('Has fixed width');
      // Check CSS variables in PALETTE
      if (!pb.PALETTE.text.includes('var(--')) throw new Error('PALETTE not using CSS vars');
      // Check mean function
      if (Math.abs(st.mean([1,2,3]) - 2) > 0.001) throw new Error('mean() broken');
      // Check normalQuantile
      if (Math.abs(st.normalQuantile(0.5)) > 0.001) throw new Error('normalQuantile(0.5) should be ~0');
      console.log('PASS: plot-base + statistics validated');
    "</automated>
    <manual>Open global.css and verify html.dark block exists with all 12 CSS variables</manual>
  </verify>
  <done>
    - plot-base.ts exports PALETTE, PlotConfig, DEFAULT_CONFIG, svgOpen, innerDimensions, xAxis, yAxis, gridLinesH, gridLinesV
    - statistics.ts exports mean, standardDeviation, kde, silvermanBandwidth, linearRegression, normalQuantile, autocorrelation, fft, powerSpectrum
    - svgOpen produces viewBox-only SVGs with role="img" and aria-label (SVG-12)
    - PALETTE uses CSS variable references exclusively (SVG-13)
    - global.css contains html.dark CSS variable overrides for dark mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Create histogram, box plot, and bar plot SVG generators</name>
  <files>
    src/lib/eda/svg-generators/histogram.ts
    src/lib/eda/svg-generators/box-plot.ts
    src/lib/eda/svg-generators/bar-plot.ts
  </files>
  <action>
**Create `src/lib/eda/svg-generators/histogram.ts`** (SVG-02):

1. Export `HistogramOptions` interface: `data: number[]`, `binCount?: number` (default: Sturges' formula `ceil(log2(n)+1)`), `showKDE?: boolean` (default: false), `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Export `generateHistogram(options: HistogramOptions): string` function:
   - Merge options.config with DEFAULT_CONFIG
   - Guard clause: if data.length < 2, return placeholder SVG with "Insufficient data" text
   - Use `d3-array` `bin()` to compute histogram bins. Set `.domain([min, max])` and `.thresholds(binCount)`
   - Use `d3-scale` `scaleLinear()` for X (data domain) and Y (0 to max bin count * 1.1)
   - Y scale range INVERTED: `.range([margin.top + innerHeight, margin.top])` (SVG Y-axis convention)
   - Render bars as `<rect>` with PALETTE.dataPrimary fill at 0.7 opacity, 1px gap between bars (`width - 1`)
   - If showKDE=true: compute bandwidth via `silvermanBandwidth()`, generate 100 evaluation points, call `kde()`, render as `<path>` using `d3-shape` `area()` with `curveBasis` interpolation, PALETTE.dataSecondary fill at 0.2 opacity
   - Add grid lines (horizontal only), X axis, Y axis, optional title
   - All coordinates `.toFixed(2)`

**Create `src/lib/eda/svg-generators/box-plot.ts`** (SVG-03):

1. Export `BoxPlotOptions` interface: `groups: { label: string; values: number[] }[]`, `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`, `showOutliers?: boolean` (default: true)

2. Export `generateBoxPlot(options: BoxPlotOptions): string` function:
   - Guard clause: if no groups or all empty, return placeholder SVG
   - Use `d3-scale` `scaleBand()` for X axis (group labels), `scaleLinear()` for Y axis (data range)
   - For each group, compute: sorted values, Q1 (25th percentile via `d3-array` `quantile()`), Q2 (median, 50th), Q3 (75th), IQR = Q3-Q1
   - Whisker limits: lower = max(min, Q1 - 1.5*IQR), upper = min(max, Q3 + 1.5*IQR)
   - Outliers: values below lower whisker or above upper whisker
   - Render per group:
     - Box `<rect>` from Q1 to Q3, PALETTE.dataPrimary fill at 0.3 opacity, 1px stroke
     - Median `<line>` at Q2, PALETTE.dataPrimary stroke, 2px width
     - Whisker `<line>` elements (vertical from box to whisker limit, horizontal caps at ends)
     - Outlier `<circle>` elements if showOutliers=true, r=3, PALETTE.dataSecondary fill
   - Add horizontal grid lines, Y axis with ticks, X axis with group labels, optional title

**Create `src/lib/eda/svg-generators/bar-plot.ts`** (SVG-07):

1. Export `BarPlotOptions` interface: `categories: { label: string; value: number; group?: string }[]`, `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`, `showErrorBars?: boolean`, `errorValues?: number[]`

2. Export `generateBarPlot(options: BarPlotOptions): string` function:
   - Guard clause: empty categories return placeholder SVG
   - Use `d3-scale` `scaleBand()` for X (category labels) with `.padding(0.2)`, `scaleLinear()` for Y (0 to max value * 1.1)
   - Render bars as `<rect>` with PALETTE.dataPrimary fill. If groups exist, use PALETTE.dataSecondary for alternating group color
   - If showErrorBars=true and errorValues provided, render error bar lines (vertical line + horizontal caps) at bar top
   - Add horizontal grid lines, both axes, optional title
   - All coordinates `.toFixed(2)`

**For all three generators:**
- Import from `./plot-base` (PALETTE, DEFAULT_CONFIG, svgOpen, innerDimensions, xAxis, yAxis, gridLinesH)
- Use `d3-scale` and `d3-array` for computations (NOT d3-selection)
- Every SVG element uses PALETTE constants for colors (never hardcoded hex)
- No fixed width/height on root SVG (viewBox only via svgOpen)
- Handle edge cases: constant data (all same value) by padding domain +/- 1
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
      const { generateHistogram } = require('./src/lib/eda/svg-generators/histogram');
      const { generateBoxPlot } = require('./src/lib/eda/svg-generators/box-plot');
      const { generateBarPlot } = require('./src/lib/eda/svg-generators/bar-plot');
      const { normalRandom, boxPlotData, doeFactors } = require('./src/data/eda/datasets');

      // Test histogram
      const hist = generateHistogram({ data: normalRandom, showKDE: true, title: 'Normal Random' });
      if (!hist.includes('<svg') || !hist.includes('viewBox') || !hist.includes('</svg>')) throw new Error('Invalid histogram SVG');
      if (!hist.includes('var(--color')) throw new Error('Histogram not using CSS vars');
      if (hist.includes('width=\"600\"')) throw new Error('Histogram has fixed width');

      // Test box plot
      const box = generateBoxPlot({ groups: boxPlotData.map(g => ({ label: g.group, values: g.values })), title: 'Filter Comparison' });
      if (!box.includes('<svg') || !box.includes('</svg>')) throw new Error('Invalid box plot SVG');
      if (!box.includes('<rect')) throw new Error('Box plot missing rectangles');

      // Test bar plot
      const uniqueFactors = [...new Set(doeFactors.map(d => d.factor))];
      const barData = uniqueFactors.map(f => {
        const vals = doeFactors.filter(d => d.factor === f);
        const avg = vals.reduce((s, d) => s + d.response, 0) / vals.length;
        return { label: f, value: avg };
      });
      const bar = generateBarPlot({ categories: barData, title: 'DOE Means' });
      if (!bar.includes('<svg') || !bar.includes('</svg>')) throw new Error('Invalid bar plot SVG');

      // Check no NaN in any SVG
      for (const [name, svg] of [['hist', hist], ['box', box], ['bar', bar]]) {
        if (svg.includes('NaN')) throw new Error(name + ' contains NaN');
      }

      console.log('PASS: histogram (' + hist.length + ' chars), box plot (' + box.length + ' chars), bar plot (' + bar.length + ' chars)');
    "</automated>
  </verify>
  <done>
    - generateHistogram produces valid SVG with bars and KDE overlay from normalRandom data (SVG-02)
    - generateBoxPlot produces valid SVG with Q1/Q2/Q3 boxes, whiskers, and outlier dots from boxPlotData (SVG-03)
    - generateBarPlot produces valid SVG with grouped bars from doeFactors (SVG-07)
    - All three generators use PALETTE CSS variables (no hardcoded colors)
    - All three generators use viewBox-only SVGs (no fixed dimensions)
    - No NaN values in any generated SVG output
  </done>
</task>

</tasks>

<verification>
1. `npx tsx -e "..."` validation scripts confirm all exports exist and produce valid SVG
2. Generated SVG strings contain `viewBox` and no fixed `width`/`height` attributes (SVG-12)
3. Generated SVG strings contain `var(--color-` CSS variable references (SVG-13)
4. No `NaN` or `Infinity` values in any SVG output
5. `global.css` contains `html.dark` block with all color variable overrides
6. Build still succeeds: `npm run build` completes without errors
</verification>

<success_criteria>
- plot-base.ts, statistics.ts, histogram.ts, box-plot.ts, bar-plot.ts all exist and export their documented interfaces
- global.css has dark mode CSS variable overrides
- All three generators produce valid SVG from datasets.ts sample data
- SVGs are viewBox-responsive and CSS-variable-themed
- No build regressions
</success_criteria>

<output>
After completion, create `.planning/phases/50-svg-generator-library/50-01-SUMMARY.md`
</output>
