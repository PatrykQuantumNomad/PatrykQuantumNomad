---
phase: 50-svg-generator-library
plan: 02
type: execute
wave: 2
depends_on: [50-01]
files_modified:
  - src/lib/eda/svg-generators/scatter-plot.ts
  - src/lib/eda/svg-generators/line-plot.ts
  - src/lib/eda/svg-generators/lag-plot.ts
  - src/lib/eda/svg-generators/probability-plot.ts
  - src/lib/eda/svg-generators/spectral-plot.ts
  - src/lib/eda/svg-generators/star-plot.ts
autonomous: true
requirements: [SVG-04, SVG-05, SVG-06, SVG-09, SVG-14, SVG-15]

must_haves:
  truths:
    - "Scatter plot generator produces valid SVG with data points, optional regression line, and optional confidence band from scatterData"
    - "Line plot generator produces valid SVG for run-sequence, autocorrelation, and time series modes from timeSeries data"
    - "Lag plot generator produces valid SVG showing x[i] vs x[i+k] scatter with diagonal reference line"
    - "Probability plot generator produces valid SVG for normal probability, Q-Q, Weibull, and PPCC plot types"
    - "Spectral plot generator produces valid SVG showing power spectrum with zero-padded FFT from timeSeries data"
    - "Star plot generator produces valid SVG radar/spider chart for multivariate display, reusing polarToCartesian from radar-math.ts"
  artifacts:
    - path: "src/lib/eda/svg-generators/scatter-plot.ts"
      provides: "Scatter plot with optional regression and confidence band"
      exports: ["generateScatterPlot", "ScatterPlotOptions"]
    - path: "src/lib/eda/svg-generators/line-plot.ts"
      provides: "Line plot for run-sequence, ACF, and time series"
      exports: ["generateLinePlot", "LinePlotOptions"]
    - path: "src/lib/eda/svg-generators/lag-plot.ts"
      provides: "Lag scatter plot for autocorrelation pattern detection"
      exports: ["generateLagPlot", "LagPlotOptions"]
    - path: "src/lib/eda/svg-generators/probability-plot.ts"
      provides: "Probability plot for normal, Q-Q, Weibull, PPCC"
      exports: ["generateProbabilityPlot", "ProbabilityPlotOptions"]
    - path: "src/lib/eda/svg-generators/spectral-plot.ts"
      provides: "Spectral plot with FFT power spectrum"
      exports: ["generateSpectralPlot", "SpectralPlotOptions"]
    - path: "src/lib/eda/svg-generators/star-plot.ts"
      provides: "Star/radar plot for multivariate display"
      exports: ["generateStarPlot", "StarPlotOptions"]
  key_links:
    - from: "src/lib/eda/svg-generators/scatter-plot.ts"
      to: "src/lib/eda/math/statistics.ts"
      via: "imports linearRegression for optional regression line"
      pattern: "import.*linearRegression.*from.*statistics"
    - from: "src/lib/eda/svg-generators/line-plot.ts"
      to: "src/lib/eda/math/statistics.ts"
      via: "imports autocorrelation, mean for ACF mode"
      pattern: "import.*autocorrelation.*from.*statistics"
    - from: "src/lib/eda/svg-generators/spectral-plot.ts"
      to: "src/lib/eda/math/statistics.ts"
      via: "imports powerSpectrum for FFT-based spectral density"
      pattern: "import.*powerSpectrum.*from.*statistics"
    - from: "src/lib/eda/svg-generators/star-plot.ts"
      to: "src/lib/beauty-index/radar-math.ts"
      via: "imports polarToCartesian for polar coordinate computation"
      pattern: "import.*polarToCartesian.*from.*radar-math"
    - from: "src/lib/eda/svg-generators/probability-plot.ts"
      to: "src/lib/eda/math/statistics.ts"
      via: "imports normalQuantile for theoretical quantile computation"
      pattern: "import.*normalQuantile.*from.*statistics"
---

<objective>
Create six XY-coordinate SVG generators (scatter, line, lag, probability, spectral, star) that transform numeric data into publication-quality SVG charts using the plot-base foundation from Plan 01.

Purpose: These generators cover the most frequently used EDA chart types -- scatter plots for correlation, line plots for time series analysis, lag/spectral plots for autocorrelation diagnostics, probability plots for distribution assessment, and star plots for multivariate comparison.

Output: 6 new TypeScript generator files, each producing valid SVG strings from datasets.ts sample data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-svg-generator-library/50-RESEARCH.md
@.planning/phases/50-svg-generator-library/50-01-SUMMARY.md
@src/data/eda/datasets.ts
@src/lib/beauty-index/radar-math.ts
@src/lib/eda/svg-generators/plot-base.ts
@src/lib/eda/math/statistics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scatter plot, line plot, and lag plot SVG generators</name>
  <files>
    src/lib/eda/svg-generators/scatter-plot.ts
    src/lib/eda/svg-generators/line-plot.ts
    src/lib/eda/svg-generators/lag-plot.ts
  </files>
  <action>
**Create `src/lib/eda/svg-generators/scatter-plot.ts`** (SVG-04):

1. Export `ScatterPlotOptions` interface:
   - `data: { x: number; y: number }[]` — point data
   - `showRegression?: boolean` (default: false) — add OLS regression line
   - `showConfidenceBand?: boolean` (default: false) — add 95% confidence band around regression
   - `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Export `generateScatterPlot(options): string`:
   - Guard clause: data.length < 2 returns placeholder SVG
   - Use `d3-scale` scaleLinear for X and Y. Y range inverted: [innerHeight, 0]
   - Handle constant data: if extent[0] === extent[1], pad domain by +/- 1
   - Render data points as `<circle>` r=3.5, PALETTE.dataPrimary fill at 0.6 opacity
   - If showRegression=true: import `linearRegression` from statistics.ts, compute slope/intercept/r2, render `<line>` from (xMin, f(xMin)) to (xMax, f(xMax)), PALETTE.dataSecondary stroke, 2px width, add R-squared annotation text
   - If showConfidenceBand=true: compute standard error of estimate, render `<path>` as filled area using `d3-shape` area() with curveBasis, PALETTE.dataSecondary fill at 0.1 opacity
   - Horizontal and vertical grid lines, both axes, optional title
   - All coordinates `.toFixed(2)`

**Create `src/lib/eda/svg-generators/line-plot.ts`** (SVG-05):

1. Export `LinePlotOptions` interface:
   - `data: number[]` — sequential values
   - `mode?: 'run-sequence' | 'autocorrelation' | 'time-series'` (default: 'run-sequence')
   - `maxLag?: number` (default: 20, only used in autocorrelation mode)
   - `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Export `generateLinePlot(options): string`:
   - Guard clause: data.length < 2 returns placeholder SVG
   - **run-sequence mode:** X = index (1..n), Y = data values. Render as `<path>` using `d3-shape` line() with curveLinear. Add horizontal reference line at mean value (dashed, PALETTE.dataSecondary)
   - **autocorrelation mode:** Import `autocorrelation` from statistics.ts. Compute ACF for lags 0..maxLag. X = lag number, Y = ACF value (-1 to 1). Render as vertical bars (lollipop style: `<line>` from (lag, 0) to (lag, acf[lag]) + `<circle>` at tip). Add horizontal dashed lines at +/- 1.96/sqrt(n) significance bounds (PALETTE.dataSecondary)
   - **time-series mode:** Same as run-sequence but X axis labeled as "Time" and no mean reference line
   - Use `d3-scale` scaleLinear for both axes. Y range inverted
   - Grid lines, axes, optional title. Line path uses PALETTE.dataPrimary, 1.5px stroke

**Create `src/lib/eda/svg-generators/lag-plot.ts`** (SVG-15):

1. Export `LagPlotOptions` interface:
   - `data: number[]`, `lag?: number` (default: 1), `config?: Partial<PlotConfig>`, `title?: string`

2. Export `generateLagPlot(options): string`:
   - Guard clause: data.length < lag + 2 returns placeholder SVG
   - Create lag pairs: `(data[i], data[i + lag])` for i in 0..n-lag-1
   - Both axes share the same domain (min of all values to max of all values) for square aspect
   - Render diagonal reference line (y=x) as dashed line using PALETTE.grid
   - Render data points as `<circle>` r=3, PALETTE.dataPrimary fill at 0.6 opacity
   - X axis labeled "Y(i)", Y axis labeled "Y(i+{lag})"
   - Grid lines, axes. See research code example for exact implementation pattern
   - All coordinates `.toFixed(2)`

**For all three generators:**
- Import from `./plot-base` (PALETTE, DEFAULT_CONFIG, PlotConfig, svgOpen, innerDimensions, xAxis, yAxis, gridLinesH, gridLinesV)
- Import D3 modules: `scaleLinear` from `d3-scale`, `line`/`area`/`curveBasis`/`curveLinear` from `d3-shape`, `extent`/`range` from `d3-array`
- Use PALETTE CSS variables exclusively (no hardcoded hex colors)
- viewBox-only via svgOpen (SVG-12)
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
      const { generateScatterPlot } = require('./src/lib/eda/svg-generators/scatter-plot');
      const { generateLinePlot } = require('./src/lib/eda/svg-generators/line-plot');
      const { generateLagPlot } = require('./src/lib/eda/svg-generators/lag-plot');
      const { scatterData, timeSeries, normalRandom } = require('./src/data/eda/datasets');

      // Scatter plot with regression
      const scatter = generateScatterPlot({ data: scatterData, showRegression: true, title: 'Load vs Deflection', xLabel: 'Load (kN)', yLabel: 'Deflection (mm)' });
      if (!scatter.includes('<svg') || !scatter.includes('viewBox')) throw new Error('Invalid scatter SVG');
      if (!scatter.includes('var(--color')) throw new Error('Scatter not using CSS vars');

      // Line plot - run sequence
      const runSeq = generateLinePlot({ data: timeSeries, mode: 'run-sequence', title: 'Run Sequence' });
      if (!runSeq.includes('<path') && !runSeq.includes('<line')) throw new Error('Line plot missing path/line elements');

      // Line plot - autocorrelation
      const acf = generateLinePlot({ data: normalRandom, mode: 'autocorrelation', title: 'ACF', maxLag: 20 });
      if (!acf.includes('<svg')) throw new Error('Invalid ACF SVG');

      // Lag plot
      const lag = generateLagPlot({ data: normalRandom, lag: 1, title: 'Lag 1 Plot' });
      if (!lag.includes('<circle')) throw new Error('Lag plot missing data points');

      // No NaN check
      for (const [n, s] of [['scatter', scatter], ['runSeq', runSeq], ['acf', acf], ['lag', lag]]) {
        if (s.includes('NaN')) throw new Error(n + ' contains NaN');
      }

      console.log('PASS: scatter (' + scatter.length + '), line-run (' + runSeq.length + '), line-acf (' + acf.length + '), lag (' + lag.length + ')');
    "</automated>
  </verify>
  <done>
    - generateScatterPlot produces SVG with circles, optional regression line + R-squared, optional confidence band (SVG-04)
    - generateLinePlot produces SVG in 3 modes: run-sequence with mean line, autocorrelation with lollipops and significance bounds, time-series (SVG-05)
    - generateLagPlot produces SVG with lag pairs, diagonal reference, and data circles (SVG-15)
    - All use CSS variables and viewBox-only SVGs
    - No NaN in any output
  </done>
</task>

<task type="auto">
  <name>Task 2: Create probability plot, spectral plot, and star plot SVG generators</name>
  <files>
    src/lib/eda/svg-generators/probability-plot.ts
    src/lib/eda/svg-generators/spectral-plot.ts
    src/lib/eda/svg-generators/star-plot.ts
  </files>
  <action>
**Create `src/lib/eda/svg-generators/probability-plot.ts`** (SVG-06):

1. Export `ProbabilityPlotOptions` interface:
   - `data: number[]`
   - `type?: 'normal' | 'qq' | 'weibull' | 'ppcc'` (default: 'normal')
   - `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Export `generateProbabilityPlot(options): string`:
   - Guard clause: data.length < 3 returns placeholder SVG
   - **normal probability plot:** Sort data ascending. For each point i, compute plotting position p_i = (i - 0.375) / (n + 0.25) (Blom formula). X = normalQuantile(p_i) (theoretical quantile), Y = sorted data value. Render as scatter points + best-fit line through Q1/Q3 reference points
   - **qq plot:** Same as normal but labeled "Theoretical Quantiles" (X) vs "Sample Quantiles" (Y). Add diagonal reference line (y=x transformed to the data scale)
   - **weibull plot:** Sort data ascending. Plotting position p_i = i / (n + 1). X = ln(-ln(1 - p_i)) (Weibull quantile), Y = ln(sorted data). Render as scatter + best-fit line. Filter out non-positive data values before log transform
   - **ppcc plot:** Compute probability plot correlation coefficient (PPCC) for shape parameters r in range [0.5, 5.0] step 0.1. X = shape parameter, Y = PPCC value (correlation between ordered data and theoretical quantiles). Render as line plot showing PPCC vs shape parameter. Mark maximum with a highlighted point
   - Import `normalQuantile`, `linearRegression` from statistics.ts
   - Scatter points as `<circle>` r=3, PALETTE.dataPrimary. Reference/fit line as PALETTE.dataSecondary
   - Grid lines, axes, title

**Create `src/lib/eda/svg-generators/spectral-plot.ts`** (SVG-14):

1. Export `SpectralPlotOptions` interface:
   - `data: number[]`, `config?: Partial<PlotConfig>`, `title?: string`, `xLabel?: string`, `yLabel?: string`

2. Export `generateSpectralPlot(options): string`:
   - Guard clause: data.length < 4 returns placeholder SVG
   - Import `powerSpectrum` from statistics.ts (which handles zero-padding to next power of 2 internally)
   - Call `powerSpectrum(data)` to get one-sided PSD array
   - X axis = frequency index (0 to N/2), normalized to [0, 0.5] (Nyquist). Label as "Frequency (cycles/sample)"
   - Y axis = power spectral density. Use log scale if max/min ratio > 100 (use `d3-scale` scaleLog), otherwise linear
   - Render as `<path>` using `d3-shape` line() with curveLinear, PALETTE.dataPrimary stroke, 1.5px
   - Optionally fill area under curve with PALETTE.dataPrimary at 0.1 opacity
   - Grid lines, axes, title

**Create `src/lib/eda/svg-generators/star-plot.ts`** (SVG-09):

1. Export `StarPlotOptions` interface:
   - `axes: { label: string; value: number; maxValue?: number }[]` — one entry per axis
   - `config?: Partial<PlotConfig>`, `title?: string`, `fillColor?: string` (default: PALETTE.dataPrimary), `fillOpacity?: number` (default: 0.3)

2. Export `generateStarPlot(options): string`:
   - Guard clause: axes.length < 3 returns placeholder SVG
   - Import `polarToCartesian` from `../../beauty-index/radar-math` (reuse existing utility per research recommendation)
   - Compute center point: cx = width/2, cy = height/2. Max radius = min(innerWidth, innerHeight) * 0.4
   - Draw concentric grid rings at 20%, 40%, 60%, 80%, 100% of max radius (regular polygons matching axis count), PALETTE.grid stroke
   - Draw axis lines from center to each vertex, PALETTE.grid stroke
   - Draw data polygon: for each axis, compute radius = (value / maxValue) * maxRadius, use polarToCartesian to get (x, y). Connect as `<polygon>` with specified fillColor and fillOpacity, plus 1.5px stroke
   - Draw axis labels outside the outermost ring, using PALETTE.text, positioned with text-anchor adjustments (start/middle/end based on angle quadrant)
   - Draw value labels at each data point (optional, small font)
   - Use svgOpen with adjusted viewBox to accommodate labels (add padding similar to radar-math.ts pattern)

**For all three generators:**
- Import from `./plot-base` consistently
- PALETTE CSS variables only (no hex colors except as defaults for optional params)
- viewBox-only SVGs via svgOpen
- All coordinates `.toFixed(2)`
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
      const { generateProbabilityPlot } = require('./src/lib/eda/svg-generators/probability-plot');
      const { generateSpectralPlot } = require('./src/lib/eda/svg-generators/spectral-plot');
      const { generateStarPlot } = require('./src/lib/eda/svg-generators/star-plot');
      const { normalRandom, timeSeries } = require('./src/data/eda/datasets');

      // Normal probability plot
      const normProb = generateProbabilityPlot({ data: normalRandom, type: 'normal', title: 'Normal Probability Plot' });
      if (!normProb.includes('<svg') || !normProb.includes('viewBox')) throw new Error('Invalid prob plot SVG');
      if (!normProb.includes('<circle')) throw new Error('Prob plot missing data points');

      // Weibull probability plot (filter positive values)
      const positiveData = normalRandom.filter(x => x > 0);
      const weibull = generateProbabilityPlot({ data: positiveData, type: 'weibull', title: 'Weibull Plot' });
      if (!weibull.includes('<svg')) throw new Error('Invalid Weibull SVG');

      // Spectral plot
      const spectral = generateSpectralPlot({ data: timeSeries, title: 'Power Spectrum' });
      if (!spectral.includes('<svg') || !spectral.includes('<path')) throw new Error('Invalid spectral SVG');

      // Star plot
      const star = generateStarPlot({
        axes: [
          { label: 'Accuracy', value: 8.5, maxValue: 10 },
          { label: 'Speed', value: 6.2, maxValue: 10 },
          { label: 'Memory', value: 7.8, maxValue: 10 },
          { label: 'Scalability', value: 9.1, maxValue: 10 },
          { label: 'Ease of Use', value: 5.5, maxValue: 10 },
        ],
        title: 'Star Plot Demo',
      });
      if (!star.includes('<polygon')) throw new Error('Star plot missing polygon');
      if (!star.includes('var(--color')) throw new Error('Star plot not using CSS vars');

      // No NaN check
      for (const [n, s] of [['normProb', normProb], ['weibull', weibull], ['spectral', spectral], ['star', star]]) {
        if (s.includes('NaN')) throw new Error(n + ' contains NaN');
      }

      console.log('PASS: probability (' + normProb.length + '), spectral (' + spectral.length + '), star (' + star.length + ')');
    "</automated>
  </verify>
  <done>
    - generateProbabilityPlot handles normal, Q-Q, Weibull, and PPCC plot types with data points and fit lines (SVG-06)
    - generateSpectralPlot produces power spectrum plot from FFT of time series data (SVG-14)
    - generateStarPlot produces radar/spider chart reusing polarToCartesian from radar-math.ts (SVG-09)
    - All use PALETTE CSS variables and viewBox-only SVGs
    - No NaN in any output
  </done>
</task>

</tasks>

<verification>
1. All 6 generators produce valid SVG strings from datasets.ts data without NaN
2. All SVGs use viewBox (no fixed width/height) confirming SVG-12
3. All SVGs use CSS variable references confirming SVG-13
4. star-plot.ts imports from radar-math.ts (confirmed via grep)
5. spectral-plot.ts uses powerSpectrum from statistics.ts (zero-padded FFT)
6. probability-plot.ts supports all 4 plot types
</verification>

<success_criteria>
- scatter-plot.ts, line-plot.ts, lag-plot.ts, probability-plot.ts, spectral-plot.ts, star-plot.ts all exist and export their documented interfaces
- Each generator produces valid SVG from appropriate dataset (scatterData, timeSeries, normalRandom)
- Scatter plot regression line and R-squared work correctly
- Autocorrelation mode renders lollipop bars with significance bounds
- Spectral plot uses FFT power spectrum
- Star plot reuses existing radar-math.ts polarToCartesian
</success_criteria>

<output>
After completion, create `.planning/phases/50-svg-generator-library/50-02-SUMMARY.md`
</output>
