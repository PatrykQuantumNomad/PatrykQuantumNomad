---
phase: 01-project-scaffold-deployment-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/deploy.yml
autonomous: false

must_haves:
  truths:
    - "Pushing to main triggers a GitHub Actions workflow that builds the Astro site and deploys to GitHub Pages"
    - "The workflow uses withastro/action for the build step and actions/deploy-pages for deployment"
    - "The site is accessible at patrykgolabek.dev over HTTPS after DNS configuration"
    - "CNAME persists across deploys — subsequent pushes do not lose the custom domain"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI/CD pipeline for automatic GitHub Pages deployment"
      contains: "withastro/action"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "package.json"
      via: "withastro/action reads package.json to determine package manager and runs build"
      pattern: "withastro/action"
    - from: ".github/workflows/deploy.yml"
      to: "public/CNAME"
      via: "CNAME is included in build output, preserving custom domain"
---

<objective>
Create the GitHub Actions deployment workflow and verify the complete build-deploy pipeline works.

Purpose: Without CI/CD, nothing ships. This plan creates the automated deployment pipeline that publishes the Astro site to GitHub Pages on every push to main, and verifies the full chain works end-to-end.

Output: A working `.github/workflows/deploy.yml` that triggers on push to main, builds the Astro site, and deploys to GitHub Pages. Human verifies DNS and Pages settings.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffold-deployment-pipeline/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions deployment workflow</name>
  <files>
    .github/workflows/deploy.yml
  </files>
  <action>
Create `.github/workflows/deploy.yml` using Astro's official deployment pattern for GitHub Pages:

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build with Astro
        uses: withastro/action@v3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

Key details:
- **Trigger:** push to `main` + manual `workflow_dispatch`
- **Permissions:** Read contents, write pages, write id-token (required for Pages deployment)
- **Concurrency:** Only one deploy at a time, do NOT cancel in-progress (prevents partial deploys)
- **Build job:** `withastro/action@v3` auto-detects package manager from lockfile, installs deps, runs `astro build`, and uploads the artifact
- **Deploy job:** `actions/deploy-pages@v4` takes the uploaded artifact and deploys to GitHub Pages
- Use `withastro/action@v3` — this is the latest stable release of Astro's official build action (INFRA-01 references v5 but that tag does not exist; v3 is current)

Do NOT add any custom build steps, Node.js setup, or caching — `withastro/action` handles all of this automatically.

After creating the file, run `npm run build` once more to confirm nothing is broken.
  </action>
  <verify>
1. File `.github/workflows/deploy.yml` exists
2. Contains `withastro/action@v3`
3. Contains `actions/deploy-pages@v4`
4. Contains `on: push: branches: [main]`
5. Contains `permissions: pages: write`
6. `npm run build` still succeeds (sanity check)
  </verify>
  <done>
GitHub Actions workflow file exists at `.github/workflows/deploy.yml` with the correct Astro build action, Pages deployment, and trigger configuration. Satisfies INFRA-01.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure GitHub Pages settings and DNS</name>
  <action>
These steps require manual configuration in the GitHub web UI and DNS registrar — Claude cannot perform them via CLI.
  </action>
  <instructions>
Complete these steps to activate the deployment pipeline:

**Step A: Push code to GitHub**
The executor will commit and push all project files to the `main` branch. Verify the push succeeded by checking the repo on GitHub.

**Step B: Enable GitHub Pages (GitHub web UI)**
1. Go to the repo Settings -> Pages (left sidebar, under "Code and automation")
2. Under "Build and deployment" -> Source: select **"GitHub Actions"** from the dropdown
3. Do NOT select "Deploy from a branch" — the Astro workflow handles this

**Step C: Verify the first deployment**
1. Go to the Actions tab in the repo
2. A workflow run should be triggered by the push
3. Wait for it to complete (green checkmark, ~2-5 minutes)
4. Once done, the site should be accessible at the GitHub Pages default URL (patrykquantumnomad.github.io)

**Step D: Configure DNS at your domain registrar (for patrykgolabek.dev)**
Add these DNS records:

A records (apex domain -> GitHub):
- 185.199.108.153
- 185.199.109.153
- 185.199.110.153
- 185.199.111.153

AAAA records (IPv6):
- 2606:50c0:8000::153
- 2606:50c0:8001::153
- 2606:50c0:8002::153
- 2606:50c0:8003::153

CNAME record:
- www -> patrykquantumnomad.github.io

CAA record (optional, authorizes Let's Encrypt):
- 0 issue "letsencrypt.org"

**Step E: Connect custom domain in GitHub**
1. Repo Settings -> Pages -> Custom domain -> enter `patrykgolabek.dev` -> Save
2. Wait for DNS check to pass (may take a few minutes to 24 hours)
3. Once it passes, check "Enforce HTTPS"
4. Optionally: Go to github.com profile Settings -> Pages -> Add a domain -> verify `patrykgolabek.dev` to prevent domain takeover

**Step F: Verify custom domain works**
1. Visit https://patrykgolabek.dev — should load the site
2. Push a trivial change and verify it redeploys (CNAME persists)
  </instructions>
  <resume-signal>Type "deployed" when the site is live at patrykgolabek.dev, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
After the human completes the checkpoint:

1. Visit https://patrykgolabek.dev — page loads over HTTPS
2. Page contains "Patryk Golabek" heading
3. GitHub Actions tab shows a successful workflow run
4. Push another commit to main — verify it triggers a new build and the site updates (CNAME persists)
</verification>

<success_criteria>
- GitHub Actions workflow triggers on push to main and deploys to GitHub Pages (INFRA-01)
- patrykgolabek.dev loads the site over HTTPS
- Subsequent pushes rebuild and redeploy without losing the custom domain (CNAME persistence)
- Phase 1 success criteria fully met: auto-deploy, HTTPS access, rebuild persistence
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-scaffold-deployment-pipeline/01-02-SUMMARY.md`
</output>
