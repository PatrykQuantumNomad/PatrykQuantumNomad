---
phase: 46-resource-relationship-graph
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/components/tools/k8s-results/K8sResourceGraph.tsx
  - src/components/tools/K8sResultsPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Switching to Graph tab renders an interactive React Flow graph with resource nodes and relationship edges"
    - "Nodes are color-coded by resource kind category (workload=blue, service=emerald, config=amber, storage=violet, rbac=red, scaling=cyan)"
    - "Edges show relationship type labels (selects, mounts, envFrom, routes to, scales, binds)"
    - "Dangling references render as red dashed edges pointing to phantom nodes with dashed red borders"
    - "Graph component is lazy-loaded via React.lazy() -- does not impact initial page load"
    - "Graph tab shows appropriate messages for null result and parse errors"
    - "Graph includes a compact color legend showing the 6 node categories"
    - "Dagre layout positions nodes hierarchically with top-to-bottom rank direction"
  artifacts:
    - path: "src/components/tools/k8s-results/K8sResourceGraph.tsx"
      provides: "Lazy-loaded React Flow graph with dagre layout"
      exports: ["default"]
    - path: "src/components/tools/K8sResultsPanel.tsx"
      provides: "Results panel with lazy-loaded graph tab replacing placeholder"
      contains: "React.lazy.*K8sResourceGraph"
  key_links:
    - from: "K8sResourceGraph.tsx"
      to: "k8s-graph-data-extractor.ts"
      via: "import extractK8sGraphData to build graph from analysis result"
      pattern: "import.*extractK8sGraphData.*from.*k8s-graph-data-extractor"
    - from: "K8sResourceGraph.tsx"
      to: "K8sResourceNode.tsx"
      via: "import for nodeTypes constant"
      pattern: "import.*K8sResourceNode.*from.*K8sResourceNode"
    - from: "K8sResourceGraph.tsx"
      to: "K8sRelationshipEdge.tsx"
      via: "import for edgeTypes constant"
      pattern: "import.*K8sRelationshipEdge.*from.*K8sRelationshipEdge"
    - from: "K8sResultsPanel.tsx"
      to: "K8sResourceGraph.tsx"
      via: "React.lazy() dynamic import"
      pattern: "lazy.*import.*K8sResourceGraph"
    - from: "K8sResultsPanel.tsx"
      to: "K8sGraphSkeleton.tsx"
      via: "Suspense fallback"
      pattern: "Suspense.*fallback.*K8sGraphSkeleton"
    - from: "K8sResourceGraph.tsx"
      to: "resource-registry.ts"
      via: "Rebuild registry from result.resources for graph extraction"
      pattern: "new ResourceRegistry"
---

<objective>
Assemble the K8s resource relationship graph by creating the main React Flow graph component with dagre layout and integrating it into K8sResultsPanel to replace the Phase 45 placeholder.

Purpose: Wire together the graph data extractor and custom visual components from Plan 01 into a complete, lazy-loaded interactive graph that renders when users click the Graph tab.

Output: 1 new file (K8sResourceGraph.tsx), 1 modified file (K8sResultsPanel.tsx).
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-resource-relationship-graph/46-RESEARCH.md
@.planning/phases/46-resource-relationship-graph/46-01-SUMMARY.md

# Key source files:
@src/components/tools/K8sResultsPanel.tsx
@src/lib/tools/k8s-analyzer/types.ts
@src/lib/tools/k8s-analyzer/resource-registry.ts
@src/stores/k8sAnalyzerStore.ts

# Plan 01 outputs:
@src/lib/tools/k8s-analyzer/k8s-graph-data-extractor.ts
@src/components/tools/k8s-results/K8sResourceNode.tsx
@src/components/tools/k8s-results/K8sRelationshipEdge.tsx
@src/components/tools/k8s-results/K8sGraphSkeleton.tsx
@src/components/tools/k8s-results/k8s-graph.css

# Reference implementation (Compose graph):
@src/components/tools/compose-results/DependencyGraph.tsx
@src/components/tools/ComposeResultsPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create K8sResourceGraph main component with dagre layout and legend</name>
  <files>src/components/tools/k8s-results/K8sResourceGraph.tsx</files>
  <action>
Create the main graph component as a **default export** (required for React.lazy). Follow the Compose DependencyGraph.tsx pattern exactly.

**Imports:**
- `useMemo` from react
- `ReactFlow, Controls, Background, BackgroundVariant, MarkerType, type Node, type Edge` from `@xyflow/react`
- `@xyflow/react/dist/style.css` (CSS import inside lazy-loaded file only)
- `dagre` from `@dagrejs/dagre`
- `K8sResourceNode, type K8sResourceNodeData, CATEGORY_COLORS` from `./K8sResourceNode`
- `K8sRelationshipEdge, type K8sRelationshipEdgeData` from `./K8sRelationshipEdge`
- `extractK8sGraphData, KIND_TO_CATEGORY` from `../../../lib/tools/k8s-analyzer/k8s-graph-data-extractor`
- `ResourceRegistry` from `../../../lib/tools/k8s-analyzer/resource-registry` (the class, not the interface)
- `type K8sAnalysisResult` from `../../../lib/tools/k8s-analyzer/types`
- `./k8s-graph.css`

**Module-level constants** (avoid re-registration on every render):
```typescript
const nodeTypes = { 'k8s-resource': K8sResourceNode };
const edgeTypes = { 'k8s-relationship': K8sRelationshipEdge };
const NODE_WIDTH = 200;
const NODE_HEIGHT = 70;
```

**`layoutGraph` function** (same pattern as Compose DependencyGraph):
- Creates a new `dagre.graphlib.Graph()` with `rankdir: 'TB'`, `nodesep: 60`, `ranksep: 100`
- Adds all nodes with `g.setNode(id, { width: NODE_WIDTH, height: NODE_HEIGHT })`
- Adds all edges with `g.setEdge(source, target)` -- include dangling edges so phantom nodes get positioned
- Calls `dagre.layout(g)`
- Maps nodes to positioned React Flow nodes: `position: { x: pos.x - NODE_WIDTH/2, y: pos.y - NODE_HEIGHT/2 }`

**Props:** `{ result: K8sAnalysisResult }`

**Main component logic (inside `useMemo` on `[result]`):**

1. Guard: if `!result.parseSuccess || result.resources.length === 0` return null

2. Rebuild ResourceRegistry from `result.resources`:
   ```typescript
   const registry = new ResourceRegistry();
   for (const r of result.resources) registry.add(r);
   ```

3. Call `extractK8sGraphData(result.resources, registry)`

4. Guard: if `data.nodes.length === 0` return null

5. Convert `K8sGraphNode[]` to React Flow `Node<K8sResourceNodeData>[]`:
   - `id: node.id`
   - `type: 'k8s-resource'`
   - `position: { x: 0, y: 0 }` (dagre will set final positions)
   - `data: { label: node.name, kind: node.kind, namespace: node.namespace, categoryColor: CATEGORY_COLORS[node.category] ?? '#888', isPhantom: node.isPhantom ?? false }`

6. Convert `K8sGraphEdge[]` to React Flow `Edge<K8sRelationshipEdgeData>[]`:
   - `id: \`e-${edge.sourceId}-${edge.targetId}-${edge.edgeType}\``
   - `source: edge.sourceId`
   - `target: edge.targetId`
   - `type: 'k8s-relationship'`
   - `markerEnd: { type: MarkerType.ArrowClosed, color: edge.resolved ? '#888' : '#ef4444' }`
   - `data: { edgeType: edge.edgeType, isDangling: !edge.resolved }`

7. Call `layoutGraph(rfNodes, rfEdges)` -- returns positioned nodes + edges

8. Return `{ nodes, edges, hasDanglingRefs: data.hasDanglingRefs }`

**Render:**
- If graphData is null: show "No resources found in the manifest." centered message (same as Compose)
- If graphData exists:
  - If `hasDanglingRefs`: show red warning banner "Dangling references detected -- broken edges highlighted in red" with warning SVG icon (exact same SVG as Compose DependencyGraph cycle warning)
  - **Color legend:** A compact horizontal flex row below the warning (or at top if no warning). Show 6 colored dots with category names: workload, service, config, storage, rbac, scaling. Each is a small colored circle (8x8) + 10px label text. Use `CATEGORY_COLORS` for the dot colors. Wrap in a div with `text-[10px] text-[var(--color-text-secondary)] flex flex-wrap gap-x-3 gap-y-1 mb-2`.
  - Graph container: `h-[300px]` div with rounded border and overflow hidden
  - `ReactFlow` with same props as Compose DependencyGraph:
    - `fitView`, `fitViewOptions={{ padding: 0.3 }}`
    - `proOptions={{ hideAttribution: true }}`
    - `minZoom: 0.3`, `maxZoom: 2`
    - `nodesDraggable`, `nodesConnectable: false`, `elementsSelectable`
  - `Controls` at bottom-right with `showInteractive: false`
  - `Background` with dots variant, same as Compose

**Wrap in `div className="k8s-graph flex flex-col"`** (matches k8s-graph.css class prefix).

Export as `export default K8sResourceGraph`.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- no TypeScript errors. Verify the file has a default export and imports all Plan 01 components.
  </verify>
  <done>
K8sResourceGraph.tsx exists as a default export, uses useMemo for graph computation, rebuilds ResourceRegistry from result.resources, converts graph data to React Flow nodes/edges, runs dagre layout, renders ReactFlow with Controls/Background, shows dangling reference warning when applicable, includes a compact color legend, and matches the Compose DependencyGraph pattern exactly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate lazy-loaded graph into K8sResultsPanel</name>
  <files>src/components/tools/K8sResultsPanel.tsx</files>
  <action>
Replace the Phase 45 placeholder in K8sResultsPanel with the lazy-loaded K8sResourceGraph.

**Add imports** at the top of the file:
```typescript
import { lazy, Suspense } from 'react';  // add lazy, Suspense to existing useState import
import { K8sGraphSkeleton } from './k8s-results/K8sGraphSkeleton';
```

Add lazy import after the regular imports:
```typescript
const LazyK8sResourceGraph = lazy(() => import('./k8s-results/K8sResourceGraph'));
```

Note: The existing `import { useState } from 'react'` must be updated to `import { useState, lazy, Suspense } from 'react'`.

**Replace the graph tab content** (lines 146-159 of current K8sResultsPanel.tsx). The current code is:
```tsx
result === null ? (
  <div className="flex items-center justify-center h-full text-center">
    <p className="text-[var(--color-text-secondary)]">
      Run analysis first to see the resource graph
    </p>
  </div>
) : (
  <div className="flex items-center justify-center h-full text-center py-12">
    <p className="text-[var(--color-text-secondary)]">
      Resource relationship graph coming in Phase 46
    </p>
  </div>
)
```

Replace with:
```tsx
result === null ? (
  <div className="flex items-center justify-center h-full text-center">
    <p className="text-[var(--color-text-secondary)]">
      Run analysis first to see the resource graph
    </p>
  </div>
) : !result.parseSuccess ? (
  <div className="flex items-center justify-center h-full text-center">
    <p className="text-[var(--color-text-secondary)]">
      Fix YAML parse errors to see the resource graph
    </p>
  </div>
) : (
  <Suspense fallback={<K8sGraphSkeleton />}>
    <LazyK8sResourceGraph result={result} />
  </Suspense>
)
```

This adds a parse error state (same as research recommendation) and wraps the graph in Suspense with the skeleton fallback (GRAPH-05 lazy loading requirement).
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Verify K8sResultsPanel.tsx imports `lazy, Suspense, K8sGraphSkeleton` and defines `LazyK8sResourceGraph`
3. Verify the old "Phase 46" placeholder text no longer appears in the file
4. `npm run build` succeeds (Astro build with the updated component)
  </verify>
  <done>
K8sResultsPanel.tsx lazy-loads K8sResourceGraph via React.lazy(), wraps it in Suspense with K8sGraphSkeleton fallback, handles null result and parse error states for the graph tab, and the old Phase 46 placeholder text is gone. Build succeeds and the graph component is code-split from the main bundle.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds (full Astro production build)
3. K8sResourceGraph.tsx is a default export and lazy-loaded from K8sResultsPanel
4. The React Flow bundle is code-split (verify by checking build output for a separate chunk containing @xyflow)
5. Graph tab shows "Run analysis first" when no result, "Fix YAML parse errors" on parse failure, and the interactive graph when analysis succeeds
6. Dangling references show red dashed edges and phantom nodes
7. Color legend displays all 6 categories with correct colors
8. Dagre layout positions nodes hierarchically
</verification>

<success_criteria>
- K8sResourceGraph.tsx exists as default export with useMemo graph computation, dagre layout, and color legend
- K8sResultsPanel.tsx lazy-loads the graph via React.lazy() + Suspense + K8sGraphSkeleton
- Old Phase 46 placeholder text no longer exists
- Build succeeds with code-split graph bundle
- All 6 GRAPH requirements (GRAPH-01 through GRAPH-06) are satisfied:
  - GRAPH-01: Interactive React Flow graph with dagre layout
  - GRAPH-02: Nodes color-coded by kind category
  - GRAPH-03: Edges represent 6 relationship types with labels
  - GRAPH-04: Dangling references as red dashed edges
  - GRAPH-05: Lazy-loaded via React.lazy()
  - GRAPH-06: Graph data derived from cross-resource validation results (via ParsedResource[])
</success_criteria>

<output>
After completion, create `.planning/phases/46-resource-relationship-graph/46-02-SUMMARY.md`
</output>
