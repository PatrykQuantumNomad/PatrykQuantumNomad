---
phase: 42-security-rules
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - src/lib/tools/k8s-analyzer/types.ts
  - src/lib/tools/k8s-analyzer/pss-compliance.ts
  - src/lib/tools/k8s-analyzer/engine.ts
  - src/lib/tools/k8s-analyzer/sample-manifest.ts
autonomous: true

must_haves:
  truths:
    - "Running runK8sEngine() on a manifest with security violations returns violations with KA-C0xx rule IDs"
    - "K8sEngineResult includes pssCompliance with baselineViolations and restrictedViolations counts"
    - "PSS compliance summary correctly classifies KA-C001/C006/C007/C008/C009/C010/C013/C014 as baseline violations"
    - "PSS compliance summary correctly classifies KA-C002/C003/C004/C005/C011 as restricted violations"
    - "A clean manifest (no security issues) produces pssCompliance with zero violations and both compliant flags true"
    - "rulesRun count includes both schema rules (10) and security rules (20) = 30 total"
    - "Sample manifest includes resources triggering at least 5 distinct security rule violations"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/pss-compliance.ts"
      provides: "PSS compliance computation from violations"
      exports: ["computePssCompliance", "PssComplianceSummary", "PSS_BASELINE_RULES", "PSS_RESTRICTED_RULES"]
    - path: "src/lib/tools/k8s-analyzer/types.ts"
      provides: "Updated K8sEngineResult with pssCompliance field"
      contains: "pssCompliance"
    - path: "src/lib/tools/k8s-analyzer/engine.ts"
      provides: "Security rule execution loop and PSS compliance computation"
      contains: "allK8sRules"
    - path: "src/lib/tools/k8s-analyzer/sample-manifest.ts"
      provides: "Sample manifest with security-violating resources"
      contains: "privileged"
  key_links:
    - from: "src/lib/tools/k8s-analyzer/engine.ts"
      to: "src/lib/tools/k8s-analyzer/rules/index.ts"
      via: "import allK8sRules"
      pattern: "import.*allK8sRules.*from.*rules"
    - from: "src/lib/tools/k8s-analyzer/engine.ts"
      to: "src/lib/tools/k8s-analyzer/pss-compliance.ts"
      via: "import computePssCompliance"
      pattern: "computePssCompliance\\(violations\\)"
    - from: "src/lib/tools/k8s-analyzer/engine.ts"
      to: "src/lib/tools/k8s-analyzer/types.ts"
      via: "K8sEngineResult.pssCompliance field"
      pattern: "pssCompliance"
---

<objective>
Wire all 20 security rules into the K8s engine, add PSS compliance summary computation, update the engine result type, and add security-violating resources to the sample manifest for end-to-end validation.

Purpose: This completes Phase 42 by integrating the security rules into the analysis pipeline and providing a PSS compliance summary (SCORE-05). Without engine integration, the rules are just standalone functions — this plan makes them execute as part of every analysis.

Output: Updated engine.ts with security rule loop, pss-compliance.ts helper, updated types.ts with PssComplianceSummary, and enhanced sample manifest with security violations.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-security-rules/42-RESEARCH.md  (Pattern 4: Engine Integration, Pattern 5: PSS Compliance Summary)
@.planning/phases/42-security-rules/42-01-SUMMARY.md (security rules, container helpers, indexes)
@.planning/phases/41-foundation-schema-infrastructure/41-04-SUMMARY.md (engine architecture)

# Source files to modify:
@src/lib/tools/k8s-analyzer/engine.ts (add security rule loop after registry build)
@src/lib/tools/k8s-analyzer/types.ts (add PssComplianceSummary, update K8sEngineResult)
@src/lib/tools/k8s-analyzer/sample-manifest.ts (add security-violating resources)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PSS compliance helper, update types, and integrate security rules into engine</name>
  <files>
    src/lib/tools/k8s-analyzer/pss-compliance.ts
    src/lib/tools/k8s-analyzer/types.ts
    src/lib/tools/k8s-analyzer/engine.ts
  </files>
  <action>
    **Step 1: Create `pss-compliance.ts`** at `src/lib/tools/k8s-analyzer/pss-compliance.ts`.

    Follow RESEARCH.md "Pattern 5: PSS Compliance Summary":

    - Export `PSS_BASELINE_RULES = new Set(['KA-C001', 'KA-C006', 'KA-C007', 'KA-C008', 'KA-C009', 'KA-C010', 'KA-C013', 'KA-C014'])`
    - Export `PSS_RESTRICTED_RULES = new Set(['KA-C002', 'KA-C003', 'KA-C004', 'KA-C005', 'KA-C011'])`
    - Export `PssComplianceSummary` interface: `{ baselineViolations: number, restrictedViolations: number, totalPssViolations: number, baselineCompliant: boolean, restrictedCompliant: boolean }`
    - Export `computePssCompliance(violations: K8sRuleViolation[]): PssComplianceSummary` — iterate violations, count those whose ruleId is in PSS_BASELINE_RULES vs PSS_RESTRICTED_RULES, compute compliant booleans (baseline: 0 baseline violations, restricted: 0 baseline AND 0 restricted violations since Restricted inherits all Baseline controls)
    - Import `K8sRuleViolation` from `./types`

    **Step 2: Update `types.ts`** — add `PssComplianceSummary` to the types and update `K8sEngineResult`:

    - Add to `K8sEngineResult` interface: `pssCompliance: PssComplianceSummary` field (import from pss-compliance would create circular dep, so add `PssComplianceSummary` interface directly to types.ts AND re-export from pss-compliance.ts)
    - Actually, to avoid circular imports: define `PssComplianceSummary` interface in types.ts, then import it in pss-compliance.ts. This follows the same pattern as ResourceRegistry being defined as interface in types.ts.
    - Add to K8sEngineResult: `pssCompliance: PssComplianceSummary;`

    **Step 3: Update `engine.ts`** — add security rule execution after registry build:

    - Add import: `import { allK8sRules } from './rules';`
    - Add import: `import { computePssCompliance } from './pss-compliance';`
    - Add import: `K8sRuleContext` to the existing types import
    - Between Step 3 (Build resource registry) and Step 4 (Sort and return), add Step 3.5:

    ```typescript
    // ── Step 3.5: Run lint rules (security, reliability, best practice) ──
    const ruleCtx: K8sRuleContext = {
      resources: registry.getAll(),
      registry,
      lineCounter: parseResult.lineCounter,
      rawText,
    };

    for (const rule of allK8sRules) {
      const ruleViolations = rule.check(ruleCtx);
      violations.push(...ruleViolations);
      for (const v of ruleViolations) {
        rulesTriggered.add(v.ruleId);
      }
    }
    ```

    - Update total rule count calculation: change `const totalSchemaRules = 10;` and `const rulesPassed = totalSchemaRules - rulesTriggered.size;` to:
    ```typescript
    const totalRules = 10 + allK8sRules.length; // 10 schema + N lint rules
    const rulesPassed = totalRules - rulesTriggered.size;
    ```
    - Update `rulesRun` to use `totalRules`
    - Add `pssCompliance: computePssCompliance(violations)` to the return object

    **Step 4: Verify TypeScript compiles** — `npx tsc -p tsconfig.json --noEmit`.
  </action>
  <verify>
    Run `npx tsc -p tsconfig.json --noEmit` — no new errors.
    Grep for `allK8sRules` in engine.ts to confirm import and usage.
    Grep for `pssCompliance` in engine.ts return statement.
    Grep for `PssComplianceSummary` in types.ts.
    Confirm pss-compliance.ts has both PSS_BASELINE_RULES and PSS_RESTRICTED_RULES sets.
  </verify>
  <done>
    engine.ts runs all security rules via allK8sRules after registry build and before sorting.
    K8sRuleContext is correctly constructed with resources, registry, lineCounter, and rawText.
    rulesRun count is 10 (schema) + 20 (security) = 30 total.
    rulesPassed correctly computed as totalRules minus rulesTriggered.size.
    pssCompliance is computed and returned in K8sEngineResult.
    PssComplianceSummary type added to types.ts and K8sEngineResult.
    TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sample manifest with security-violating resources and verify full pipeline</name>
  <files>
    src/lib/tools/k8s-analyzer/sample-manifest.ts
  </files>
  <action>
    **Step 1: Add 2-3 security-violating resources to `sample-manifest.ts`.**

    Keep ALL existing resources unchanged (they test Phase 41 schema/diagnostic rules). Append new resources BEFORE the trailing empty document (the `---` at the end that triggers KA-S010).

    Add these resources (insert after the "My_Invalid_Name" ConfigMap, before the trailing `---`):

    **Resource 1: Privileged Deployment (triggers KA-C001, KA-C002, KA-C011, KA-C012, KA-C017, KA-C020 on init container)**
    ```yaml
    ---
    # Issue: Security violations — privileged container, no capabilities drop
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: insecure-app
      namespace: online-store
      labels:
        app: insecure-app
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: insecure-app
      template:
        metadata:
          labels:
            app: insecure-app
        spec:
          containers:
            - name: app
              image: myapp/insecure:1.0
              securityContext:
                privileged: true
                allowPrivilegeEscalation: true
              ports:
                - containerPort: 8080
          initContainers:
            - name: init
              image: busybox:1.36
              command: ["sh", "-c", "echo init"]
    ```

    **Resource 2: Host namespace pod (triggers KA-C006, KA-C008, KA-C014 or KA-C015)**
    ```yaml
    ---
    # Issue: Host namespace sharing and sensitive volume mount
    apiVersion: v1
    kind: Pod
    metadata:
      name: debug-pod
      namespace: default
    spec:
      hostPID: true
      hostNetwork: true
      containers:
        - name: debug
          image: alpine:3.19
          command: ["sleep", "3600"]
          env:
            - name: DB_PASSWORD
              value: "s3cr3t-passw0rd"
      volumes:
        - name: docker-sock
          hostPath:
            path: /var/run/docker.sock
    ```

    This second resource also triggers:
    - KA-C019 (default namespace)
    - KA-C018 (DB_PASSWORD env var with inline value)
    - KA-C015 (docker socket mount)
    - KA-C020 (missing securityContext on debug container)

    Update the file's JSDoc comment at the top to mention the additional security triggers:
    ```
    * Triggers: KA-S005 (schema), KA-S006 (deprecated), KA-S008 (name),
    * KA-S009 (labels), KA-S010 (empty document), KA-C001 (privileged),
    * KA-C006 (hostPID), KA-C008 (hostNetwork), KA-C015 (docker socket),
    * KA-C018 (secrets in env), KA-C019 (default namespace).
    ```

    **Step 2: Run the full pipeline end-to-end** using a Node.js inline script:

    ```bash
    node --loader ts-node/esm -e "
      import { runK8sEngine } from './src/lib/tools/k8s-analyzer/engine.ts';
      import { SAMPLE_K8S_MANIFEST } from './src/lib/tools/k8s-analyzer/sample-manifest.ts';
      const result = await runK8sEngine(SAMPLE_K8S_MANIFEST);
      console.log('Violations:', result.violations.length);
      console.log('Resources:', result.resources.length);
      console.log('Rules run:', result.rulesRun);
      console.log('Rules passed:', result.rulesPassed);
      console.log('PSS Compliance:', JSON.stringify(result.pssCompliance, null, 2));
      console.log('\\nViolation IDs:', [...new Set(result.violations.map(v => v.ruleId))].sort().join(', '));
      console.log('\\nSecurity violations:');
      result.violations.filter(v => v.ruleId.startsWith('KA-C')).forEach(v => console.log(\`  L\${v.line}: [\${v.ruleId}] \${v.message}\`));
    "
    ```

    If the ts-node import approach does not work (common in Astro projects), use `npx tsx` instead:
    ```bash
    npx tsx -e "..."
    ```

    Or create a temporary test script and run with tsx. The goal is to confirm:
    - Total violations include both schema (KA-S0xx) and security (KA-C0xx) rule IDs
    - rulesRun = 30 (10 schema + 20 security)
    - PSS compliance shows non-zero baseline and restricted violations
    - At least KA-C001, KA-C006, KA-C015, KA-C018, KA-C019 appear in security violations
    - Violations are sorted by line number

    If the inline script approach has module resolution issues, verify compilation instead: `npx tsc -p tsconfig.json --noEmit` and do a structural check: confirm engine.ts imports allK8sRules and calls rule.check(), and sample-manifest.ts has `privileged: true` and `hostPID: true` content.

    **Step 3: Final TypeScript compilation check** — `npx tsc -p tsconfig.json --noEmit`.
  </action>
  <verify>
    `npx tsc -p tsconfig.json --noEmit` passes.
    sample-manifest.ts contains `privileged: true` and `hostPID: true`.
    sample-manifest.ts still contains all original resources (Namespace, ConfigMap, Secret, Deployment web-frontend, Service, Ingress, etc.).
    Grep for `KA-C` rule IDs in engine output (or structural check if runtime test not feasible).
    PSS compliance summary has both baselineViolations > 0 and restrictedViolations > 0 (or structural check on pss-compliance.ts).
  </verify>
  <done>
    Sample manifest updated with 2 security-violating resources (insecure-app Deployment + debug-pod Pod).
    Original resources preserved for Phase 41 schema/diagnostic test coverage.
    Full pipeline produces both schema and security violations.
    PSS compliance summary reports non-zero baseline and restricted violation counts.
    rulesRun includes all 30 rules (10 schema + 20 security).
    Phase 42 is functionally complete.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p tsconfig.json --noEmit` passes with no new errors
2. engine.ts contains `allK8sRules` import and iterates rules with `rule.check(ruleCtx)`
3. engine.ts return object includes `pssCompliance: computePssCompliance(violations)`
4. types.ts K8sEngineResult has `pssCompliance: PssComplianceSummary` field
5. pss-compliance.ts has PSS_BASELINE_RULES (8 entries) and PSS_RESTRICTED_RULES (5 entries)
6. sample-manifest.ts contains `privileged: true`, `hostPID: true`, `DB_PASSWORD`, `/var/run/docker.sock`
7. sample-manifest.ts still contains all 10 original resources
</verification>

<success_criteria>
- Engine executes all 20 security rules via allK8sRules on every analysis
- K8sEngineResult includes PssComplianceSummary with baseline/restricted violation counts
- rulesRun reflects total rules (30 = 10 schema + 20 security)
- Sample manifest demonstrates at least 5 distinct security violations for the UI
- Full TypeScript compilation passes
- Phase 42 success criteria met: privileged/root containers produce errors, host namespace sharing produces errors, missing security contexts produce warnings, PSS compliance summary shows violation counts
</success_criteria>

<output>
After completion, create `.planning/phases/42-security-rules/42-02-SUMMARY.md`
</output>
