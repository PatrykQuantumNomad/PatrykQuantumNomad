---
phase: 47-seo-documentation-site-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/k8s-analyzer/rules/index.ts
  - src/lib/tools/k8s-analyzer/rules/related.ts
  - src/lib/tools/k8s-analyzer/cis-benchmark.ts
autonomous: true

must_haves:
  truths:
    - "allDocumentedK8sRules contains all 67 rules (57 lint + 10 schema)"
    - "getRelatedK8sRules returns up to 5 same-category rules sorted by severity"
    - "CIS_BENCHMARK_REFS maps applicable security rule IDs to CIS Benchmark section references"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/rules/index.ts"
      provides: "allDocumentedK8sRules with 67 rules"
      contains: "SCHEMA_RULE_METADATA"
    - path: "src/lib/tools/k8s-analyzer/rules/related.ts"
      provides: "getRelatedK8sRules function"
      exports: ["getRelatedK8sRules"]
    - path: "src/lib/tools/k8s-analyzer/cis-benchmark.ts"
      provides: "CIS Benchmark reference mapping"
      exports: ["CIS_BENCHMARK_REFS"]
  key_links:
    - from: "src/lib/tools/k8s-analyzer/rules/index.ts"
      to: "src/lib/tools/k8s-analyzer/diagnostic-rules.ts"
      via: "import SCHEMA_RULE_METADATA"
      pattern: "SCHEMA_RULE_METADATA"
    - from: "src/lib/tools/k8s-analyzer/rules/related.ts"
      to: "src/lib/tools/k8s-analyzer/rules/index.ts"
      via: "import allDocumentedK8sRules"
      pattern: "allDocumentedK8sRules"
---

<objective>
Expand the documented rule registry to include all 67 K8s rules (57 lint + 10 schema), add the related rules function, and create the CIS Benchmark reference mapping.

Purpose: Rule documentation pages (Plan 03) need the complete rule list, related rules lookup, and compliance reference data to render.
Output: Complete rule data layer for static page generation.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/tools/k8s-analyzer/rules/index.ts
@src/lib/tools/k8s-analyzer/diagnostic-rules.ts
@src/lib/tools/k8s-analyzer/pss-compliance.ts
@src/lib/tools/k8s-analyzer/types.ts
@src/lib/tools/compose-validator/rules/related.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand allDocumentedK8sRules with schema rules + create related rules function</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/index.ts
    src/lib/tools/k8s-analyzer/rules/related.ts
  </files>
  <action>
**rules/index.ts changes:**
Import `SCHEMA_RULE_METADATA` from `../diagnostic-rules` and merge into `allDocumentedK8sRules`:
```typescript
import { SCHEMA_RULE_METADATA } from '../diagnostic-rules';

export const allDocumentedK8sRules: DocumentedK8sRule[] = [
  ...(allK8sRules as DocumentedK8sRule[]),
  ...Object.values(SCHEMA_RULE_METADATA),
];
```
This produces exactly 67 entries (57 lint + 10 schema). The `SchemaRuleMetadata` interface is compatible with `DocumentedK8sRule` (same fields: id, title, severity, category, explanation, fix).

**rules/related.ts (new file):**
Follow the exact pattern from `src/lib/tools/compose-validator/rules/related.ts`. Create `getRelatedK8sRules(ruleId: string, limit = 5): DocumentedK8sRule[]` that:
1. Finds the rule by ID in `allDocumentedK8sRules`
2. Filters to same category, excluding self
3. Sorts by severity (error > warning > info) using `SEVERITY_ORDER` map
4. Returns up to `limit` results

Use `K8sSeverity` from `../types` for the severity order Record type.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify `allDocumentedK8sRules.length` is 67 by checking the code logic: 57 (allK8sRules spread) + 10 (Object.values(SCHEMA_RULE_METADATA)).
  </verify>
  <done>allDocumentedK8sRules contains 67 rules; getRelatedK8sRules returns same-category rules sorted by severity.</done>
</task>

<task type="auto">
  <name>Task 2: Create CIS Benchmark reference mapping</name>
  <files>
    src/lib/tools/k8s-analyzer/cis-benchmark.ts
  </files>
  <action>
Create a new file exporting `CIS_BENCHMARK_REFS` as a `Record<string, { section: string; title: string }>` mapping K8s security rule IDs to CIS Kubernetes Benchmark v1.8 sections. Focus on the 20 security rules (KA-C001 through KA-C020) that have direct CIS Benchmark mappings. Not every rule maps to a CIS section -- only include where a clear mapping exists.

Key mappings (CIS Kubernetes Benchmark v1.8):
- KA-C001 (privileged containers) -> 5.2.1 "Ensure that the cluster has at least one active policy control mechanism in place"
- KA-C002 (privilege escalation) -> 5.2.5 "Minimize the admission of containers with allowPrivilegeEscalation"
- KA-C003 (run as root) -> 5.2.6 "Minimize the admission of root containers"
- KA-C004 (runAsNonRoot missing) -> 5.2.6 "Minimize the admission of root containers"
- KA-C005 (UID 0) -> 5.2.6 "Minimize the admission of root containers"
- KA-C006 (hostPID) -> 5.2.2 "Minimize the admission of privileged containers" / 5.2.4 "Minimize the admission of containers sharing host PID namespace"
- KA-C007 (hostIPC) -> 5.2.3 "Minimize the admission of containers sharing host IPC namespace"
- KA-C008 (hostNetwork) -> 5.2.4 "Minimize the admission of containers wishing to share the host network namespace"
- KA-C010 (dangerous capabilities) -> 5.2.7 "Minimize the admission of containers with added capabilities"
- KA-C011 (capabilities not dropped) -> 5.2.7 "Minimize the admission of containers with added capabilities"
- KA-C012 (Docker socket) -> 5.2.12 "Minimize the admission of HostPath volumes"
- KA-C013 (seccomp missing) -> 5.7.2 "Ensure that the seccomp profile is set to docker/default in your Pod definitions"
- KA-C014 (sensitive host path) -> 5.2.12 "Minimize the admission of HostPath volumes"
- KA-C015 (service account token) -> 5.1.6 "Ensure that Service Account Tokens are only mounted where necessary"
- KA-C016 (default SA) -> 5.1.5 "Ensure that default service accounts are not actively used"
- KA-C018 (secrets in env) -> Information level, no direct CIS section (omit)
- KA-C019 (default namespace) -> 5.7.1 "Create administrative boundaries between resources using namespaces"
- KA-C020 (missing securityContext) -> 5.7.3 "Apply Security Context to Your Pods and Containers"
- KA-A001 (wildcard RBAC) -> 5.1.3 "Minimize wildcard use in Roles and ClusterRoles"
- KA-A002 (cluster-admin binding) -> 5.1.1 "Ensure that the cluster-admin role is only used where required"
- KA-A003 (pod exec access) -> 5.1.4 "Minimize access to create pods"
- KA-A004 (secret access) -> 5.1.2 "Minimize access to secrets"

Export as:
```typescript
export const CIS_BENCHMARK_REFS: Record<string, { section: string; title: string }> = {
  'KA-C001': { section: '5.2.1', title: 'Ensure that the cluster has at least one active policy control mechanism in place' },
  // ...
};
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify the export is importable: the Record type is self-contained with no external dependencies beyond string literals.
  </verify>
  <done>CIS_BENCHMARK_REFS maps ~20 security/RBAC rule IDs to CIS Benchmark v1.8 section numbers and titles.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `allDocumentedK8sRules` contains 67 entries (verify import chain: 57 from allK8sRules + 10 from SCHEMA_RULE_METADATA)
3. `getRelatedK8sRules('KA-C001')` would return up to 5 other security rules
4. `CIS_BENCHMARK_REFS` has entries for applicable security and RBAC rules
</verification>

<success_criteria>
All 67 rules are accessible via allDocumentedK8sRules, related rules function exists following the compose-validator pattern, and CIS Benchmark references are mapped for documentation display.
</success_criteria>

<output>
After completion, create `.planning/phases/47-seo-documentation-site-integration/47-01-SUMMARY.md`
</output>
