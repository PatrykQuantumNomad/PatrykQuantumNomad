---
phase: 64-infrastructure-foundation
plan: 02
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - src/pages/eda/techniques/[slug].astro
autonomous: true
requirements:
  - INFRA-03
  - INFRA-04
  - INFRA-05
  - INFRA-06

must_haves:
  truths:
    - "A technique with a questions array renders a 'Questions This Plot Answers' section with a bullet list"
    - "A technique with an importance string renders a 'Why It Matters' section"
    - "A technique with definitionExpanded renders expanded text below the existing definition"
    - "A technique with examples renders an 'Examples' section with labeled descriptions"
    - "A technique with caseStudySlugs renders pill buttons linking to real case study pages with correct titles and URLs"
    - "A technique with formulas renders KaTeX math in the formula slot and loads KaTeX CSS (useKatex=true)"
    - "A technique without formulas does NOT load KaTeX CSS (useKatex=false)"
    - "A technique with pythonCode renders a syntax-highlighted Python code block in the code slot"
  artifacts:
    - path: "src/pages/eda/techniques/[slug].astro"
      provides: "Updated graphical technique template with all new sections, formula slot, code slot, and case study resolution"
      min_lines: 100
      contains: "import.*Code.*from.*astro-expressive-code"
  key_links:
    - from: "src/pages/eda/techniques/[slug].astro"
      to: "katex"
      via: "import katex and katex.renderToString() in frontmatter"
      pattern: "katex\\.renderToString"
    - from: "src/pages/eda/techniques/[slug].astro"
      to: "astro-expressive-code"
      via: "import { Code } and <Code code={} lang='python' />"
      pattern: "Code.*code=.*lang.*python"
    - from: "src/pages/eda/techniques/[slug].astro"
      to: "src/lib/eda/routes.ts"
      via: "import { caseStudyUrl } for case study URL generation"
      pattern: "caseStudyUrl"
    - from: "src/pages/eda/techniques/[slug].astro"
      to: "astro:content getCollection('edaPages')"
      via: "getCollection in getStaticPaths for case study title resolution"
      pattern: "getCollection.*edaPages"
    - from: "src/pages/eda/techniques/[slug].astro"
      to: "src/components/eda/TechniquePage.astro"
      via: "useKatex prop computed from content.formulas"
      pattern: "useKatex=.*hasFormulas"
---

<objective>
Update the graphical technique [slug].astro template to render all new content sections (questions, importance, expanded definitions, examples, case study cross-links), activate the formula slot with build-time KaTeX rendering, and activate the code slot with astro-expressive-code Python highlighting.

Purpose: After this plan, any graphical technique with new content fields populated will automatically render the corresponding sections -- no further template changes needed for Phases 66-68.
Output: Updated src/pages/eda/techniques/[slug].astro with full section rendering, KaTeX integration, Code component, and case study resolution.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-infrastructure-foundation/64-RESEARCH.md
@.planning/phases/64-infrastructure-foundation/64-01-SUMMARY.md

@src/pages/eda/techniques/[slug].astro
@src/pages/eda/quantitative/[slug].astro
@src/components/eda/TechniquePage.astro
@src/layouts/EDALayout.astro
@src/lib/eda/routes.ts

<interfaces>
<!-- From Plan 01 output: the extended TechniqueContent interface -->

From src/lib/eda/technique-content/types.ts (created by Plan 01):
```typescript
export interface TechniqueContent {
  // Required (existing)
  definition: string;
  purpose: string;
  interpretation: string;
  assumptions: string;
  nistReference: string;
  // Optional (new)
  questions?: string[];
  importance?: string;
  definitionExpanded?: string;
  formulas?: Array<{ label: string; tex: string; explanation: string }>;
  pythonCode?: string;
  caseStudySlugs?: string[];
  examples?: Array<{ label: string; description: string; variantLabel?: string }>;
}
```

From src/lib/eda/technique-content/index.ts (created by Plan 01):
```typescript
export type { TechniqueContent } from './types';
export function getTechniqueContent(slug: string): TechniqueContent | undefined;
```

From src/components/eda/TechniquePage.astro (layout component):
```typescript
interface Props {
  title: string;
  description: string;
  category: string;
  nistSection: string;
  slug?: string;
  relatedTechniques?: Array<{ slug: string; name: string; url: string }>;
  useKatex?: boolean;  // <-- Controls conditional KaTeX CSS loading
}
// Slots: plot, description, formula, code, interpretation
```

From src/layouts/EDALayout.astro:
```typescript
// useKatex prop controls:
// - <link rel="stylesheet" href="/styles/katex.min.css" />
// - .katex { color: var(--color-text-primary); } dark mode fix
```

From src/lib/eda/routes.ts:
```typescript
export function caseStudyUrl(slug: string): string;
// Returns: /eda/case-studies/{slug}/
```

From src/pages/eda/quantitative/[slug].astro (BLUEPRINT to copy from):
```typescript
import { Code } from 'astro-expressive-code/components';
import katex from 'katex';
// KaTeX pre-rendering:
const renderedFormulas = content?.formulas.map(f => ({
  ...f,
  html: katex.renderToString(f.tex, { displayMode: true, throwOnError: false }),
})) ?? [];
// Code component usage:
// <Code code={content.pythonCode} lang="python" />
```

Available case study slugs (for testing):
beam-deflections, ceramic-strength, cryothermometry, fatigue-life,
filter-transmittance, heat-flow-meter, normal-random-numbers, random-walk,
standard-resistor, uniform-random-numbers
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add case study resolution and KaTeX pre-rendering to getStaticPaths</name>
  <files>src/pages/eda/techniques/[slug].astro</files>
  <action>
Update the frontmatter of `src/pages/eda/techniques/[slug].astro` to add three new capabilities. Copy patterns EXACTLY from `src/pages/eda/quantitative/[slug].astro`.

**New imports (add after existing imports):**
```typescript
import { Code } from 'astro-expressive-code/components';
import katex from 'katex';
import { caseStudyUrl } from '../../../lib/eda/routes';
```
Note: `techniqueUrl` is already imported. `caseStudyUrl` is a NEW import from the same file.

**Update getStaticPaths() to resolve case studies:**

Inside `getStaticPaths()`, BEFORE the `return graphical.map(...)`:
1. Fetch case study pages: `const caseStudyPages = await getCollection('edaPages');`
2. Build lookup map: Filter to `category === 'case-studies'`, map `p.id.replace('case-studies/', '')` to `p.data`
3. In each technique's props, compute `caseStudyLinks` from `content?.caseStudySlugs ?? []`: filter by map.has(), map to `{ slug, title, url: caseStudyUrl(slug) }`
4. Add `caseStudyLinks` to the returned props

**Add KaTeX pre-rendering after the existing const declarations:**

After `const content = getTechniqueContent(technique.slug);`:
```typescript
// Pre-render KaTeX formulas at build time (pattern from quantitative/[slug].astro)
const renderedFormulas = content?.formulas?.map(f => ({
  ...f,
  html: katex.renderToString(f.tex, { displayMode: true, throwOnError: false }),
})) ?? [];
const hasFormulas = renderedFormulas.length > 0;
```

Note the `?.` on `content?.formulas?.map` -- the formulas field is optional (unlike quantitative where it's required).

**Update the TechniquePage component to pass useKatex:**

Change `<TechniquePage ...>` to include `useKatex={hasFormulas}`. This is data-driven -- never hardcode `useKatex={true}`.

**Destructure caseStudyLinks from props:**
Add `caseStudyLinks` to the destructured `Astro.props`.

IMPORTANT: Do NOT change anything about the plot slot, PlotVariantSwap, or renderTechniquePlot -- those remain identical.
  </action>
  <verify>
Run `npx astro build 2>&1 | tail -20` -- build must succeed. Since no technique currently has formulas, pythonCode, or caseStudySlugs, the visible output should be identical to before.
  </verify>
  <done>getStaticPaths resolves case study titles and URLs. KaTeX pre-rendering is wired. useKatex is data-driven from content.formulas. Code and katex imports are present. Build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Render new description sections + formula slot + code slot</name>
  <files>src/pages/eda/techniques/[slug].astro</files>
  <action>
Update the template (HTML) portion of `src/pages/eda/techniques/[slug].astro` to render all new content sections in the correct order, plus activate the formula and code slots.

**Replace the existing description slot content** with the full section ordering from the research. All sections follow the same Tailwind pattern: `text-xl font-heading font-bold mb-3` for h2, `text-[var(--color-text-secondary)] leading-relaxed` for paragraph text.

The description slot must render these sections IN ORDER (skip any that are absent/empty):

1. **What It Is** -- `content.definition` (existing, unchanged) + `content.definitionExpanded` (new, render as additional paragraph below if present)
2. **Questions This Plot Answers** -- `content.questions` array. Render as a `<ul>` with `<li>` items. Only show section if questions array exists and has items.
3. **Why It Matters** -- `content.importance` string. Only show if present.
4. **When to Use It** -- `content.purpose` (existing, unchanged)
5. **How to Interpret** -- `content.interpretation` (existing, unchanged)
6. **Examples** -- `content.examples` array. Each example: `<h3>` with label, `<p>` with description. Only show if examples array exists and has items.
7. **Assumptions and Limitations** -- `content.assumptions` (existing, unchanged)
8. **See It In Action** -- `content.caseStudyLinks` (from props). Render pill buttons matching the relatedTechniques pattern in TechniquePage.astro: `inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-[var(--color-accent)]/10 text-[var(--color-accent)] hover:bg-[var(--color-accent)]/20 transition-colors`. Include introductory text: "This technique is demonstrated in the following case studies:". Only show if caseStudyLinks.length > 0.
9. **Reference** -- `content.nistReference` (existing, unchanged)

**Add formula slot** (copy pattern EXACTLY from quantitative/[slug].astro lines 85-98):
```astro
{renderedFormulas.length > 0 && (
  <Fragment slot="formula">
    <section class="prose-section mt-8 space-y-6">
      <h2 class="text-xl font-heading font-bold mb-3">Formulas</h2>
      {renderedFormulas.map(f => (
        <div class="formula-block mb-6">
          <h3 class="text-lg font-semibold mb-2">{f.label}</h3>
          <div class="katex-display-wrapper my-4 overflow-x-auto" set:html={f.html} />
          <p class="text-[var(--color-text-secondary)]">{f.explanation}</p>
        </div>
      ))}
    </section>
  </Fragment>
)}
```

**Add code slot** (copy pattern EXACTLY from quantitative/[slug].astro lines 100-107):
```astro
{content?.pythonCode && (
  <Fragment slot="code">
    <section class="prose-section mt-8">
      <h2 class="text-xl font-heading font-bold mb-3">Python Example</h2>
      <Code code={content.pythonCode} lang="python" />
    </section>
  </Fragment>
)}
```

**Section rendering rules:**
- Every conditional section uses `{condition && (...)}` pattern (no ternary with empty fragment)
- Use `<ul class="list-disc list-inside space-y-1 text-[var(--color-text-secondary)]">` for questions list
- The caseStudyLinks variable comes from Astro.props, NOT from content (it was resolved in getStaticPaths)
- Keep the plot slot completely unchanged (before description)
  </action>
  <verify>
Run `npx astro build 2>&1 | tail -20` -- build must succeed with zero errors. Since no technique currently has the new optional fields populated, all 29 pages should render with only the original 4 sections (What It Is, When to Use It, How to Interpret, Assumptions) plus Reference. Verify by checking one page output: `grep -c 'Questions This Plot Answers\|Why It Matters\|See It In Action\|Python Example\|Formulas' dist/eda/techniques/histogram/index.html` -- expect 0 (no new sections rendered because fields are empty).
  </verify>
  <done>All 9 description sections conditionally render based on content fields. Formula slot renders KaTeX HTML via set:html. Code slot renders Python via Code component. Case study pill buttons render from resolved caseStudyLinks. Build passes with zero errors. Pages with no new fields look identical to before.</done>
</task>

</tasks>

<verification>
1. `npx astro build` completes with zero errors
2. All 29 graphical technique pages are generated (check dist/eda/techniques/ for 29 subdirectories)
3. Existing pages have no visual regression (same 4 sections + Reference as before)
4. Template has all required imports: Code from astro-expressive-code, katex, caseStudyUrl from routes
5. Template computes useKatex dynamically from content.formulas (not hardcoded)
6. Template renders all 9 description sections conditionally
7. Formula slot and code slot are wired with correct patterns from quantitative/[slug].astro
</verification>

<success_criteria>
- [slug].astro imports Code from astro-expressive-code, katex, and caseStudyUrl
- getStaticPaths resolves case study slugs to { slug, title, url } objects
- KaTeX formulas are pre-rendered at build time via katex.renderToString()
- useKatex is computed from content.formulas (data-driven, never hardcoded)
- Description slot renders 9 sections in NIST order, each conditional on field presence
- Formula slot renders KaTeX HTML blocks with set:html
- Code slot renders Python syntax-highlighted blocks via Code component
- Case study section renders pill buttons matching existing relatedTechniques styling
- `astro build` passes with zero errors
- No regressions on existing pages (all new fields are optional and absent)
</success_criteria>

<output>
After completion, create `.planning/phases/64-infrastructure-foundation/64-02-SUMMARY.md`
</output>
