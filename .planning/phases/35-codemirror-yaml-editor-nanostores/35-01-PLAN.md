---
phase: 35-codemirror-yaml-editor-nanostores
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/composeValidatorStore.ts
  - src/lib/tools/compose-validator/use-codemirror-yaml.ts
  - src/lib/tools/compose-validator/sample-compose.ts
  - package.json
  - package-lock.json
autonomous: true
requirements:
  - EDIT-01
  - EDIT-03
  - EDIT-04
  - EDIT-05
  - EDIT-08

must_haves:
  truths:
    - "Nanostore atoms exist for compose analysis state (result, analyzing, editorView, stale)"
    - "A CodeMirror hook creates an EditorView with YAML syntax highlighting and Mod-Enter shortcut"
    - "A sample compose file triggers violations across all 5 rule categories (schema, semantic, security, best-practice, style)"
    - "The editor destroys cleanly on astro:before-swap and React unmount"
  artifacts:
    - path: "src/stores/composeValidatorStore.ts"
      provides: "Nanostore atoms for compose validator cross-component state"
      exports: ["composeResult", "composeAnalyzing", "composeEditorViewRef", "composeResultsStale"]
    - path: "src/lib/tools/compose-validator/use-codemirror-yaml.ts"
      provides: "React hook creating CodeMirror 6 EditorView with YAML lang, dark theme, Mod-Enter"
      exports: ["useCodeMirrorYaml"]
    - path: "src/lib/tools/compose-validator/sample-compose.ts"
      provides: "Pre-loaded sample docker-compose.yml with deliberate issues across all 5 categories"
      exports: ["SAMPLE_COMPOSE"]
  key_links:
    - from: "src/lib/tools/compose-validator/use-codemirror-yaml.ts"
      to: "src/stores/composeValidatorStore.ts"
      via: "import composeEditorViewRef, composeResultsStale, composeResult atoms"
      pattern: "import.*from.*composeValidatorStore"
    - from: "src/lib/tools/compose-validator/use-codemirror-yaml.ts"
      to: "src/lib/tools/dockerfile-analyzer/editor-theme.ts"
      via: "import shared editor theme (NOT duplicated)"
      pattern: "import.*from.*dockerfile-analyzer/editor-theme"
    - from: "src/lib/tools/compose-validator/use-codemirror-yaml.ts"
      to: "@codemirror/lang-yaml"
      via: "import yaml() native Lezer language support"
      pattern: "import.*yaml.*from.*@codemirror/lang-yaml"
---

<objective>
Create the nanostore atoms, CodeMirror YAML hook, and sample compose file that form the data and editor foundation for the Compose Validator UI.

Purpose: These three modules are the foundation that ComposeEditorPanel and ComposeResultsPanel will consume. The nanostore provides cross-component state, the hook manages the CodeMirror lifecycle with YAML highlighting and keyboard shortcut, and the sample file gives users meaningful first-run results.

Output: Three new TypeScript modules + @codemirror/lang-yaml installed
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-codemirror-yaml-editor-nanostores/35-RESEARCH.md

# Existing patterns to follow:
@src/stores/dockerfileAnalyzerStore.ts
@src/lib/tools/dockerfile-analyzer/use-codemirror.ts
@src/lib/tools/dockerfile-analyzer/editor-theme.ts
@src/lib/tools/dockerfile-analyzer/highlight-line.ts
@src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts

# Compose validator pipeline (Phase 33-34 outputs):
@src/lib/tools/compose-validator/types.ts
@src/lib/tools/compose-validator/parser.ts
@src/lib/tools/compose-validator/engine.ts
@src/lib/tools/compose-validator/scorer.ts
@src/lib/tools/compose-validator/rules/index.ts
@src/lib/tools/compose-validator/rules/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @codemirror/lang-yaml and create nanostore + sample compose file</name>
  <files>
    package.json
    package-lock.json
    src/stores/composeValidatorStore.ts
    src/lib/tools/compose-validator/sample-compose.ts
  </files>
  <action>
1. Install the only new dependency:
   ```
   npm install @codemirror/lang-yaml
   ```

2. Create `src/stores/composeValidatorStore.ts` following the exact pattern from `dockerfileAnalyzerStore.ts`:
   - `composeResult` atom typed `ComposeAnalysisResult | null`, initial null
   - `composeAnalyzing` atom typed `boolean`, initial false
   - `composeEditorViewRef` atom typed `EditorView | null`, initial null
   - `composeResultsStale` atom typed `boolean`, initial false
   - Import `ComposeAnalysisResult` from `../lib/tools/compose-validator/types`
   - Import `EditorView` as type-only from `@codemirror/view`
   - Add JSDoc comments matching the dockerfile store style

3. Create `src/lib/tools/compose-validator/sample-compose.ts` exporting a `SAMPLE_COMPOSE` template literal string. The sample MUST trigger violations across ALL 5 rule categories:
   - **Schema**: Include a typo like `servces:` (unknown top-level property triggers CV-S002)
   - **Semantic**: Include `nonexistent` in a service's networks array (undefined network triggers CV-M003), use duplicate host port 8080 on two services (CV-M001), create circular depends_on between api and worker (CV-M002), add orphan network `backend` and orphan volume `data` (CV-M007/CV-M008)
   - **Security**: Add `privileged: true` (CV-C001), Docker socket mount (CV-C002), `network_mode: host` (CV-C003), secret in environment var like `DB_PASSWORD: supersecret123` (CV-C008), `image: nginx:latest` (CV-C014)
   - **Best Practice**: Include `version: "3.8"` deprecated field (CV-B006), services without healthcheck or resource limits are implicitly covered
   - **Style**: Use unquoted port like `8080:80` (CV-F002 detects unquoted ports at AST level)
   - Add inline comments in the sample explaining which rules each issue triggers
   - The sample should look realistic -- a plausible (but flawed) multi-service compose file

   Follow the exact pattern from `sample-dockerfile.ts` (template literal export, const named `SAMPLE_COMPOSE`).
  </action>
  <verify>
  Run `npm ls @codemirror/lang-yaml` to confirm installation. Run `npx tsc --noEmit` to verify both new files have no type errors.
  </verify>
  <done>
  @codemirror/lang-yaml installed in package.json. composeValidatorStore.ts exports 4 nanostore atoms with correct types. sample-compose.ts exports SAMPLE_COMPOSE containing a realistic docker-compose.yml with deliberate issues spanning all 5 rule categories. Both files pass TypeScript strict mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useCodeMirrorYaml hook with YAML language, dark theme, and Mod-Enter shortcut</name>
  <files>
    src/lib/tools/compose-validator/use-codemirror-yaml.ts
  </files>
  <action>
Create `src/lib/tools/compose-validator/use-codemirror-yaml.ts` following the existing `use-codemirror.ts` pattern with these specific changes:

1. **Interface**: Accept `UseCodeMirrorYamlOptions` with `initialDoc: string` and `onAnalyze: () => void` callback (the Dockerfile version does NOT have onAnalyze -- this is new for Mod-Enter support).

2. **Refs**: `containerRef` (HTMLDivElement), `viewRef` (EditorView | null), and `analyzeRef` (holds onAnalyze to avoid stale closures). Update `analyzeRef.current = onAnalyze` on every call (outside useEffect).

3. **EditorState extensions** (order matters for keymap precedence):
   - `basicSetup` from `codemirror`
   - `yaml()` from `@codemirror/lang-yaml` -- this is the native Lezer parser, NOT StreamLanguage. This replaces the `StreamLanguage.define(dockerFile)` from the Dockerfile version.
   - `lintGutter()` from `@codemirror/lint` -- NO `linter()` (EDIT-02: button-triggered only)
   - `keymap.of([{ key: 'Mod-Enter', run: () => { analyzeRef.current(); return true; } }])` -- place BEFORE theme extensions for correct precedence. "Mod" maps to Cmd on macOS, Ctrl on Windows/Linux.
   - `oneDarkTheme`, `a11ySyntaxHighlighting`, `editorTheme` imported from `../../dockerfile-analyzer/editor-theme` (REUSE, do NOT create a new editor-theme.ts)
   - `highlightLineField` imported from `../../dockerfile-analyzer/highlight-line` (REUSE)
   - `EditorView.lineWrapping`
   - `EditorView.contentAttributes.of({ 'aria-label': 'Docker Compose editor -- paste or type your docker-compose.yml here' })`
   - `EditorView.updateListener.of(...)` that sets `composeResultsStale.set(true)` when `update.docChanged && composeResult.get() !== null`

4. **View Transitions cleanup**: Add `astro:before-swap` event listener that destroys the EditorView and nulls `composeEditorViewRef`. This is CRITICAL for Astro View Transitions (EDIT-08). Also return cleanup function from useEffect that removes the listener AND destroys the view.

5. **Return** `{ containerRef, viewRef }`.

6. **Import nanostore atoms** from `../../../stores/composeValidatorStore` (composeEditorViewRef, composeResultsStale, composeResult).

Key differences from use-codemirror.ts:
- `yaml()` instead of `StreamLanguage.define(dockerFile)`
- `onAnalyze` callback + `analyzeRef` pattern for Mod-Enter
- `keymap.of()` extension for Mod-Enter shortcut
- aria-label says "Docker Compose editor" not "Dockerfile editor"
- Imports compose nanostore atoms instead of dockerfile atoms
  </action>
  <verify>
  Run `npx tsc --noEmit` to confirm no type errors. Verify the file imports `yaml` from `@codemirror/lang-yaml` (not from legacy-modes). Verify it imports editor-theme from `../../dockerfile-analyzer/editor-theme` (not a local copy). Verify it includes `keymap.of` with `Mod-Enter`.
  </verify>
  <done>
  use-codemirror-yaml.ts exports the useCodeMirrorYaml hook that creates a CodeMirror 6 EditorView with: (a) native YAML syntax highlighting via @codemirror/lang-yaml, (b) dark theme reused from dockerfile-analyzer, (c) Mod-Enter keyboard shortcut triggering the onAnalyze callback, (d) lintGutter for on-demand diagnostics, (e) View Transitions cleanup via astro:before-swap, (f) stale-results detection via updateListener. Passes TypeScript strict mode.
  </done>
</task>

</tasks>

<verification>
1. `npm ls @codemirror/lang-yaml` shows the package installed
2. `npx tsc --noEmit` passes with zero errors
3. `grep -r "yaml()" src/lib/tools/compose-validator/use-codemirror-yaml.ts` confirms native Lezer usage
4. `grep -r "Mod-Enter" src/lib/tools/compose-validator/use-codemirror-yaml.ts` confirms keyboard shortcut
5. `grep -r "astro:before-swap" src/lib/tools/compose-validator/use-codemirror-yaml.ts` confirms View Transitions cleanup
6. `grep -r "dockerfile-analyzer/editor-theme" src/lib/tools/compose-validator/use-codemirror-yaml.ts` confirms theme reuse (not duplication)
7. No `editor-theme.ts` exists in `src/lib/tools/compose-validator/` (must import from dockerfile-analyzer)
</verification>

<success_criteria>
- @codemirror/lang-yaml installed as a dependency
- composeValidatorStore.ts exports 4 typed nanostore atoms
- sample-compose.ts exports SAMPLE_COMPOSE with issues across all 5 rule categories
- use-codemirror-yaml.ts creates EditorView with YAML lang, dark theme, Mod-Enter, lintGutter, View Transitions cleanup
- All files pass TypeScript strict mode compilation
</success_criteria>

<output>
After completion, create `.planning/phases/35-codemirror-yaml-editor-nanostores/35-01-SUMMARY.md`
</output>
