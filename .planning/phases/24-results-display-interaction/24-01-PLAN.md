---
phase: 24-results-display-interaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/dockerfileAnalyzerStore.ts
  - src/lib/tools/dockerfile-analyzer/editor-theme.ts
  - src/lib/tools/dockerfile-analyzer/highlight-line.ts
  - src/lib/tools/dockerfile-analyzer/use-codemirror.ts
  - src/components/tools/EditorPanel.tsx
autonomous: true
requirements:
  - RESULT-01
  - RESULT-05

must_haves:
  truths:
    - "After analysis, gutter markers show red circles for errors, amber triangles for warnings, and blue squares for info"
    - "Squiggly underlines appear under problematic lines in severity-matched colors"
    - "EditorView reference is accessible by sibling components via nanostore for click-to-navigate"
    - "Results dim with opacity after the user edits the Dockerfile post-analysis"
  artifacts:
    - path: "src/stores/dockerfileAnalyzerStore.ts"
      provides: "editorViewRef and resultsStale nanostore atoms"
      contains: "editorViewRef"
    - path: "src/lib/tools/dockerfile-analyzer/editor-theme.ts"
      provides: "Severity color overrides for gutter markers and underlines"
      contains: "cm-lint-marker-error"
    - path: "src/lib/tools/dockerfile-analyzer/highlight-line.ts"
      provides: "highlightAndScroll function and highlightLineField extension"
      exports: ["highlightAndScroll", "highlightLineField"]
    - path: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      provides: "EditorView stored in nanostore, highlight extension registered, stale results listener"
      contains: "highlightLineField"
    - path: "src/components/tools/EditorPanel.tsx"
      provides: "EditorView ref set in nanostore on mount, cleared on unmount"
      contains: "editorViewRef"
  key_links:
    - from: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      to: "src/stores/dockerfileAnalyzerStore.ts"
      via: "editorViewRef.set(view) on mount"
      pattern: "editorViewRef\\.set"
    - from: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      to: "src/stores/dockerfileAnalyzerStore.ts"
      via: "resultsStale.set(true) on doc change after analysis"
      pattern: "resultsStale\\.set"
    - from: "src/lib/tools/dockerfile-analyzer/highlight-line.ts"
      to: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      via: "highlightLineField registered as extension"
      pattern: "highlightLineField"
---

<objective>
Wire the editor infrastructure for results display: severity-colored gutter markers and underlines (RESULT-01), EditorView ref sharing via nanostore for click-to-navigate (RESULT-05 foundation), stale results detection, and the highlight-line extension.

Purpose: Provide the plumbing that Plan 02's UI components will consume. Without the editorViewRef atom, click-to-navigate cannot work. Without the highlight extension, line flash on navigation cannot work. Without severity colors, gutter markers look generic.
Output: Modified store, editor theme, hook, and EditorPanel + new highlight-line.ts module.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-results-display-interaction/24-RESEARCH.md
@src/stores/dockerfileAnalyzerStore.ts
@src/lib/tools/dockerfile-analyzer/editor-theme.ts
@src/lib/tools/dockerfile-analyzer/use-codemirror.ts
@src/lib/tools/dockerfile-analyzer/types.ts
@src/components/tools/EditorPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nanostore atoms, severity theme overrides, and highlight-line extension</name>
  <files>
    src/stores/dockerfileAnalyzerStore.ts
    src/lib/tools/dockerfile-analyzer/editor-theme.ts
    src/lib/tools/dockerfile-analyzer/highlight-line.ts
  </files>
  <action>
**dockerfileAnalyzerStore.ts** -- Add two new atoms to the existing file (keep existing analysisResult and isAnalyzing):
- `editorViewRef = atom<EditorView | null>(null)` -- EditorView instance set by EditorPanel, read by ResultsPanel for click-to-navigate. Import `EditorView` type from `@codemirror/view` (type-only import).
- `resultsStale = atom<boolean>(false)` -- Set true when doc changes after analysis, reset to false when new analysis runs.

**editor-theme.ts** -- Add severity color overrides to the existing `editorTheme` object. Override gutter marker SVGs and underline colors:
- `.cm-lint-marker-error`: Override `content` with SVG data URL for a red (#ef4444) filled circle with #dc2626 stroke.
- `.cm-lint-marker-warning`: Override `content` with SVG data URL for an amber (#f59e0b) triangle with #d97706 stroke.
- `.cm-lint-marker-info`: Override `content` with SVG data URL for a blue (#3b82f6) square with #2563eb stroke (rounded corners).
- `.cm-lintRange-error`: `backgroundImage` with a red squiggly underline pattern or simply set `textDecoration: 'underline wavy #ef4444'`.
- `.cm-lintRange-warning`: `textDecoration: 'underline wavy #f59e0b'`.
- `.cm-lintRange-info`: `textDecoration: 'underline wavy #3b82f6'`.
- `.cm-highlight-line`: `backgroundColor: 'rgba(100, 255, 218, 0.15)'` for the click-to-navigate flash highlight (accent-secondary tint).

Use the `lintMarkerSvg` helper pattern from research to generate SVG data URLs:
```typescript
function lintMarkerSvg(content: string): string {
  return `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40">${encodeURIComponent(content)}</svg>')`;
}
```

**highlight-line.ts** -- Create new file in `src/lib/tools/dockerfile-analyzer/`. Exports:
1. `highlightLineEffect = StateEffect.define<{ line: number }>()` -- dispatched to highlight a line.
2. `clearHighlightEffect = StateEffect.define<null>()` -- dispatched to clear highlight.
3. `highlightLineField = StateField.define<DecorationSet>()` -- manages the `.cm-highlight-line` decoration. On `highlightLineEffect`, creates a `Decoration.line({ class: 'cm-highlight-line' })` at the target line. On `clearHighlightEffect`, returns `Decoration.none`. Maps decorations through document changes.
4. `highlightAndScroll(view: EditorView, lineNumber: number): void` -- Clamps lineNumber to `Math.min(lineNumber, view.state.doc.lines)` to handle stale results. Dispatches selection (anchor=line.from, head=line.to), `EditorView.scrollIntoView(line.from, { y: 'center' })`, and `highlightLineEffect`. Calls `view.focus()`. Sets a 1500ms `setTimeout` to dispatch `clearHighlightEffect`.

Import `StateEffect`, `StateField` from `@codemirror/state`. Import `Decoration`, `EditorView` and type `DecorationSet` from `@codemirror/view`.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -E "(highlight-line|editor-theme|dockerfileAnalyzerStore)" | head -20` -- no type errors in these files. Check that highlight-line.ts exports are importable: `grep -r "highlightAndScroll\|highlightLineField" src/lib/tools/dockerfile-analyzer/highlight-line.ts`.
  </verify>
  <done>
Three files ready: store has editorViewRef + resultsStale atoms, editor-theme has severity color overrides for all 3 severity levels plus highlight-line class, highlight-line.ts exports highlightAndScroll + highlightLineField.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire use-codemirror hook and EditorPanel with new infrastructure</name>
  <files>
    src/lib/tools/dockerfile-analyzer/use-codemirror.ts
    src/components/tools/EditorPanel.tsx
  </files>
  <action>
**use-codemirror.ts** -- Three additions to the existing hook:

1. **Register highlight extension:** Import `highlightLineField` from `./highlight-line`. Add it to the `extensions` array in `EditorState.create()`, alongside the existing extensions (after `editorTheme`, before `EditorView.lineWrapping`).

2. **Store EditorView in nanostore:** Import `editorViewRef` from `../../stores/dockerfileAnalyzerStore`. After `const view = new EditorView(...)`, call `editorViewRef.set(view)`. In both cleanup paths (React useEffect return AND `handleSwap`), add `editorViewRef.set(null)` before or alongside `viewRef.current = null`.

3. **Stale results listener:** Import `resultsStale` and `analysisResult` from `../../stores/dockerfileAnalyzerStore`. Add `EditorView.updateListener.of((update) => { if (update.docChanged && analysisResult.get() !== null) { resultsStale.set(true); } })` to the extensions array. This dims results after the user edits the Dockerfile post-analysis.

**EditorPanel.tsx** -- One addition:

At the start of the `analyzeRef.current` function body (before `isAnalyzing.set(true)`), import and call `resultsStale` from `../../stores/dockerfileAnalyzerStore` and set `resultsStale.set(false)` to reset stale state when a new analysis starts. Add the import at the top of the file.
  </action>
  <verify>
1. Run `npx astro build 2>&1 | tail -20` -- build completes without errors.
2. Verify the highlight extension is registered: `grep "highlightLineField" src/lib/tools/dockerfile-analyzer/use-codemirror.ts` should match.
3. Verify editorViewRef is set: `grep "editorViewRef" src/lib/tools/dockerfile-analyzer/use-codemirror.ts` should match at least 3 times (import, set, clear).
4. Verify resultsStale reset: `grep "resultsStale" src/components/tools/EditorPanel.tsx` should match.
  </verify>
  <done>
use-codemirror hook registers the highlight-line extension, stores EditorView in nanostore on mount, clears on both cleanup paths, and detects stale results on doc changes. EditorPanel resets stale flag on new analysis. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx astro build` completes without errors -- all new modules bundle correctly.
2. `grep -r "editorViewRef" src/` shows the atom defined in store, set/cleared in use-codemirror.
3. `grep -r "resultsStale" src/` shows the atom in store, set in use-codemirror updateListener, reset in EditorPanel.
4. `grep -r "highlightAndScroll" src/` shows the function exported from highlight-line.ts.
5. `grep "cm-lint-marker-error" src/lib/tools/dockerfile-analyzer/editor-theme.ts` confirms severity overrides exist.
</verification>

<success_criteria>
- editorViewRef nanostore atom exists and is set/cleared in use-codemirror lifecycle
- resultsStale nanostore atom exists, set on doc change after analysis, reset on new analysis
- Gutter markers override default CodeMirror colors with red/amber/blue severity scheme
- Squiggly underlines use severity-matched wavy text decoration colors
- highlightAndScroll function and highlightLineField extension exported from highlight-line.ts
- highlight-line extension registered in EditorState extensions array
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-results-display-interaction/24-01-SUMMARY.md`
</output>
