---
phase: 22-editor-foundation-technology-validation
plan: 02
type: execute
wave: 2
depends_on:
  - 22-01
files_modified:
  - src/lib/tools/dockerfile-analyzer/use-codemirror.ts
  - src/lib/tools/dockerfile-analyzer/editor-theme.ts
  - src/components/tools/DockerfileAnalyzer.tsx
  - src/components/tools/EditorPanel.tsx
  - src/components/tools/ResultsPanel.tsx
  - src/pages/tools/dockerfile-analyzer/index.astro
autonomous: true
requirements:
  - EDIT-01
  - EDIT-02
  - EDIT-04
  - EDIT-05
  - EDIT-06
  - EDIT-07
  - EDIT-08

must_haves:
  truths:
    - "Visiting /tools/dockerfile-analyzer/ displays a CodeMirror 6 editor with Dockerfile syntax highlighting"
    - "FROM, RUN, COPY keywords are visibly colored in the editor"
    - "Editor is pre-loaded with the sample Dockerfile from Plan 01"
    - "Clicking Analyze parses the Dockerfile via dockerfile-ast and updates the Nanostore"
    - "Pressing Cmd/Ctrl+Enter triggers the same analyze action as the button"
    - "Editor displays dark theme matching the site aesthetic"
    - "Layout is stacked on mobile and side-by-side on desktop"
    - "Navigating away and back produces a functional editor with no console errors"
    - "No orphaned EditorView instances after navigation cycles"
  artifacts:
    - path: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      provides: "React hook creating/destroying EditorView with View Transitions lifecycle"
      exports: ["useCodeMirror"]
      min_lines: 50
    - path: "src/lib/tools/dockerfile-analyzer/editor-theme.ts"
      provides: "Custom CodeMirror theme layered on oneDark"
      exports: ["editorTheme"]
    - path: "src/components/tools/EditorPanel.tsx"
      provides: "CodeMirror mount + Analyze button + keyboard shortcut indicator"
      min_lines: 40
    - path: "src/components/tools/ResultsPanel.tsx"
      provides: "Placeholder results panel reading from Nanostore"
      min_lines: 20
    - path: "src/components/tools/DockerfileAnalyzer.tsx"
      provides: "Root React island composing EditorPanel + ResultsPanel in responsive grid"
      min_lines: 15
    - path: "src/pages/tools/dockerfile-analyzer/index.astro"
      provides: "Astro page shell with Layout, heading, and client:only='react' island"
      min_lines: 15
  key_links:
    - from: "src/components/tools/EditorPanel.tsx"
      to: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      via: "useCodeMirror hook"
      pattern: "useCodeMirror"
    - from: "src/components/tools/EditorPanel.tsx"
      to: "src/lib/tools/dockerfile-analyzer/parser.ts"
      via: "parseDockerfile call in handleAnalyze"
      pattern: "parseDockerfile"
    - from: "src/components/tools/EditorPanel.tsx"
      to: "src/stores/dockerfileAnalyzerStore.ts"
      via: "analysisResult.set() after parsing"
      pattern: "analysisResult\\.set"
    - from: "src/components/tools/ResultsPanel.tsx"
      to: "src/stores/dockerfileAnalyzerStore.ts"
      via: "useStore(analysisResult) subscription"
      pattern: "useStore.*analysisResult"
    - from: "src/pages/tools/dockerfile-analyzer/index.astro"
      to: "src/components/tools/DockerfileAnalyzer.tsx"
      via: "client:only='react' directive"
      pattern: "client:only=\"react\""
    - from: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      to: "astro:before-swap"
      via: "View Transitions cleanup listener"
      pattern: "astro:before-swap"
---

<objective>
Build the complete CodeMirror 6 editor island with Dockerfile syntax highlighting, on-demand analysis via setDiagnostics, keyboard shortcuts, dark theme, responsive layout, and View Transitions lifecycle management. Wire everything into an Astro page at /tools/dockerfile-analyzer/.

Purpose: This is the user-facing deliverable of Phase 22 -- the working editor that confirms the entire technology stack operates end-to-end in the browser.

Output: 6 new source files (hook, theme, 3 React components, 1 Astro page) delivering a fully functional Dockerfile editor at /tools/dockerfile-analyzer/.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-editor-foundation-technology-validation/22-RESEARCH.md
@.planning/phases/22-editor-foundation-technology-validation/22-01-SUMMARY.md
@src/layouts/Layout.astro
@src/stores/tabStore.ts
@src/components/beauty-index/LanguageFilter.tsx
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCodeMirror hook and editor theme</name>
  <files>
    src/lib/tools/dockerfile-analyzer/use-codemirror.ts
    src/lib/tools/dockerfile-analyzer/editor-theme.ts
  </files>
  <action>
**Create `src/lib/tools/dockerfile-analyzer/editor-theme.ts`:**
A custom CodeMirror theme that layers on top of `oneDark` to match the site's Quantum Explorer aesthetic. This provides the dark background, syntax colors, and font settings.

```typescript
import { EditorView } from '@codemirror/view';

// Custom overrides layered on top of oneDark
export const editorTheme = EditorView.theme({
  '&': {
    fontSize: '14px',
    fontFamily: '"Fira Code", "JetBrains Mono", monospace',
    borderRadius: '8px',
    border: '1px solid var(--color-border, rgba(255,255,255,0.1))',
  },
  '.cm-content': {
    padding: '12px 0',
  },
  '.cm-gutters': {
    borderRight: '1px solid rgba(255,255,255,0.06)',
    backgroundColor: 'transparent',
  },
  '.cm-activeLine': {
    backgroundColor: 'rgba(255,255,255,0.03)',
  },
  '.cm-activeLineGutter': {
    backgroundColor: 'rgba(255,255,255,0.03)',
  },
  '&.cm-focused': {
    outline: '2px solid var(--color-accent, #64ffda)',
    outlineOffset: '-1px',
  },
  '.cm-scroller': {
    overflow: 'auto',
  },
}, { dark: true });
```

The `{ dark: true }` ensures CodeMirror applies dark defaults for any unstyled elements. The `oneDark` extension (added in the hook) provides syntax token colors; this theme only overrides chrome/layout.

**Create `src/lib/tools/dockerfile-analyzer/use-codemirror.ts`:**
The core React hook that creates and manages the EditorView lifecycle.

Key requirements:
1. Create EditorView with: `basicSetup`, `StreamLanguage.define(dockerFile)`, `lintGutter()`, `oneDark`, custom theme, `EditorView.lineWrapping`, and the Cmd/Ctrl+Enter keymap.
2. Use `useRef` for both the container div and the EditorView instance.
3. Implement double cleanup for View Transitions: React `useEffect` cleanup AND `astro:before-swap` listener.
4. Accept `initialDoc` (string) and `onAnalyze` callback as parameters.
5. Return `containerRef` (for mounting) and `viewRef` (for imperative access from parent).

CRITICAL implementation details:
- Import `dockerFile` (camelCase, not `dockerfile`) from `@codemirror/legacy-modes/mode/dockerfile`.
- Include `lintGutter()` in extensions even though we are NOT using `linter()`. This enables gutter markers when `setDiagnostics` pushes diagnostics.
- Do NOT include `linter()` in extensions. EDIT-02 requires button-triggered analysis only.
- Use `keymap.of([{ key: 'Mod-Enter', run: ... }])` for the keyboard shortcut.
- The `onAnalyze` callback receives the `EditorView` so the caller can read document content and dispatch diagnostics.

```typescript
import { useRef, useEffect } from 'react';
import { EditorView, keymap } from '@codemirror/view';
import { EditorState } from '@codemirror/state';
import { basicSetup } from 'codemirror';
import { StreamLanguage } from '@codemirror/language';
import { dockerFile } from '@codemirror/legacy-modes/mode/dockerfile';
import { lintGutter } from '@codemirror/lint';
import { oneDark } from '@codemirror/theme-one-dark';
import { editorTheme } from './editor-theme';

interface UseCodeMirrorOptions {
  initialDoc: string;
  onAnalyze: (view: EditorView) => void;
}

export function useCodeMirror({ initialDoc, onAnalyze }: UseCodeMirrorOptions) {
  const containerRef = useRef<HTMLDivElement>(null);
  const viewRef = useRef<EditorView | null>(null);

  useEffect(() => {
    if (!containerRef.current) return;

    const analyzeKeymap = keymap.of([
      {
        key: 'Mod-Enter',
        run: (view) => {
          onAnalyze(view);
          return true;
        },
      },
    ]);

    const state = EditorState.create({
      doc: initialDoc,
      extensions: [
        basicSetup,
        StreamLanguage.define(dockerFile),
        lintGutter(),
        analyzeKeymap,
        oneDark,
        editorTheme,
        EditorView.lineWrapping,
      ],
    });

    const view = new EditorView({
      state,
      parent: containerRef.current,
    });

    viewRef.current = view;

    // View Transitions safety: destroy on swap even if React cleanup races
    const handleSwap = () => {
      if (viewRef.current) {
        viewRef.current.destroy();
        viewRef.current = null;
      }
    };
    document.addEventListener('astro:before-swap', handleSwap);

    return () => {
      document.removeEventListener('astro:before-swap', handleSwap);
      view.destroy();
      viewRef.current = null;
    };
  }, []); // Empty deps: create once, destroy on unmount

  return { containerRef, viewRef };
}
```

Note on the empty dependency array: The `onAnalyze` callback is intentionally NOT in the deps array. The hook creates the EditorView once. If the analyze function needs to change, it should be wrapped in a ref by the caller. This avoids destroying/recreating the entire editor on every render.
  </action>
  <verify>
`npx tsc --noEmit` passes with no errors for both files. Verify imports: `dockerFile` from legacy-modes, `lintGutter` from @codemirror/lint, `oneDark` from theme-one-dark, `EditorView` and `keymap` from @codemirror/view, `EditorState` from @codemirror/state, `basicSetup` from codemirror.
  </verify>
  <done>useCodeMirror hook creates EditorView with Dockerfile syntax highlighting (dockerFile legacy mode), lintGutter, oneDark + custom theme, line wrapping, and Mod-Enter keymap. Double cleanup implemented (useEffect + astro:before-swap). Editor theme matches dark aesthetic with Fira Code/JetBrains Mono font stack.</done>
</task>

<task type="auto">
  <name>Task 2: Create React components and Astro page shell</name>
  <files>
    src/components/tools/EditorPanel.tsx
    src/components/tools/ResultsPanel.tsx
    src/components/tools/DockerfileAnalyzer.tsx
    src/pages/tools/dockerfile-analyzer/index.astro
  </files>
  <action>
**Create `src/components/tools/EditorPanel.tsx`:**
Mounts the CodeMirror editor and provides the Analyze button + keyboard shortcut hint.

Key behaviors:
- Calls `useCodeMirror` with `SAMPLE_DOCKERFILE` as initialDoc.
- The `handleAnalyze` function: reads `view.state.doc.toString()`, calls `parseDockerfile()`, sets `isAnalyzing` to true then false, dispatches `setDiagnostics` (empty array for Phase 22 -- no rules yet), and writes to `analysisResult` nanostore.
- Wraps the `handleAnalyze` function in a `useRef` so the keymap callback always calls the latest version without re-creating the EditorView.
- Shows an "Analyze" button below the editor with a keyboard shortcut hint "(Cmd+Enter)" / "(Ctrl+Enter)" based on platform detection.
- The analyze button should be visually prominent -- use accent color, rounded, with a play/analyze icon or text.

```tsx
import { useRef, useCallback } from 'react';
import type { EditorView } from '@codemirror/view';
import { setDiagnostics } from '@codemirror/lint';
import { useCodeMirror } from '../../lib/tools/dockerfile-analyzer/use-codemirror';
import { parseDockerfile } from '../../lib/tools/dockerfile-analyzer/parser';
import { SAMPLE_DOCKERFILE } from '../../lib/tools/dockerfile-analyzer/sample-dockerfile';
import { analysisResult, isAnalyzing } from '../../stores/dockerfileAnalyzerStore';

export default function EditorPanel() {
  const analyzeRef = useRef<(view: EditorView) => void>(() => {});

  analyzeRef.current = (view: EditorView) => {
    const content = view.state.doc.toString();
    if (!content.trim()) {
      view.dispatch(setDiagnostics(view.state, []));
      analysisResult.set(null);
      return;
    }

    isAnalyzing.set(true);

    const result = parseDockerfile(content);

    // Phase 22: no rules yet, so diagnostics are empty
    // Phase 23 will produce real Diagnostic[] from rule engine
    view.dispatch(setDiagnostics(view.state, []));

    analysisResult.set({
      violations: [],
      astNodeCount: result.nodeCount,
      parseSuccess: result.success,
      timestamp: Date.now(),
    });

    isAnalyzing.set(false);
  };

  const { containerRef, viewRef } = useCodeMirror({
    initialDoc: SAMPLE_DOCKERFILE,
    onAnalyze: (view) => analyzeRef.current(view),
  });

  const handleButtonClick = () => {
    if (viewRef.current) {
      analyzeRef.current(viewRef.current);
    }
  };

  const isMac = typeof navigator !== 'undefined' && /Mac/.test(navigator.platform);
  const shortcutHint = isMac ? 'Cmd+Enter' : 'Ctrl+Enter';

  return (
    <div className="flex flex-col h-full">
      <div className="flex items-center justify-between mb-3">
        <h2 className="text-lg font-heading font-semibold">Editor</h2>
        <button
          onClick={handleButtonClick}
          className="..."  // Style below
        >
          Analyze
        </button>
      </div>
      <div
        ref={containerRef}
        className="flex-1 min-h-[300px] lg:min-h-[450px] overflow-hidden rounded-lg"
      />
      <p className="mt-2 text-xs text-[var(--color-text-secondary)]">
        {shortcutHint} to analyze
      </p>
    </div>
  );
}
```

Style the Analyze button to match the site's accent aesthetic:
- Background: `var(--color-accent)` or a cyan/teal tone (#64ffda area)
- Text: dark (black or near-black for contrast)
- Padding: `px-4 py-2`
- Rounded: `rounded-lg`
- Hover: slight brightness increase
- Font: `font-semibold text-sm`

**Create `src/components/tools/ResultsPanel.tsx`:**
Minimal results panel for Phase 22. Shows parse result from Nanostore. Will be fully built in Phase 24.

- Subscribe to `analysisResult` and `isAnalyzing` nanostores using `useStore` from `@nanostores/react`.
- Before first analysis: show a placeholder message ("Click Analyze to check your Dockerfile").
- After analysis: show "Parsed successfully -- {N} instructions found" or "Parse error: {message}".
- When analyzing: show a brief "Analyzing..." state.
- This is a placeholder -- Phase 24 will replace with score gauge, category breakdown, and violation list.

```tsx
import { useStore } from '@nanostores/react';
import { analysisResult, isAnalyzing } from '../../stores/dockerfileAnalyzerStore';

export default function ResultsPanel() {
  const result = useStore(analysisResult);
  const analyzing = useStore(isAnalyzing);

  return (
    <div className="flex flex-col h-full">
      <h2 className="text-lg font-heading font-semibold mb-3">Results</h2>
      <div className="flex-1 rounded-lg border border-[var(--color-border)] bg-[var(--color-surface-alt,rgba(0,0,0,0.2))] p-4">
        {analyzing ? (
          <p className="text-[var(--color-text-secondary)]">Analyzing...</p>
        ) : result === null ? (
          <div className="flex items-center justify-center h-full text-center">
            <p className="text-[var(--color-text-secondary)]">
              Click <strong>Analyze</strong> or press <kbd className="...">Cmd/Ctrl+Enter</kbd> to check your Dockerfile
            </p>
          </div>
        ) : result.parseSuccess ? (
          <div>
            <p className="text-green-400 font-medium mb-2">Parse successful</p>
            <p className="text-sm text-[var(--color-text-secondary)]">
              {result.astNodeCount} instruction{result.astNodeCount !== 1 ? 's' : ''} found
            </p>
            <p className="text-xs text-[var(--color-text-secondary)] mt-4">
              Rule engine coming in Phase 23 — violations will appear here.
            </p>
          </div>
        ) : (
          <p className="text-red-400">Parse error — check Dockerfile syntax</p>
        )}
      </div>
    </div>
  );
}
```

Style the `<kbd>` element with: `px-1.5 py-0.5 rounded border border-[var(--color-border)] bg-[var(--color-surface-alt)] text-xs font-mono`.

**Create `src/components/tools/DockerfileAnalyzer.tsx`:**
Root island component composing EditorPanel + ResultsPanel in a responsive grid.

```tsx
import EditorPanel from './EditorPanel';
import ResultsPanel from './ResultsPanel';

export default function DockerfileAnalyzer() {
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
      <div className="min-h-[350px] lg:min-h-[500px]">
        <EditorPanel />
      </div>
      <div className="min-h-[200px] lg:min-h-[500px]">
        <ResultsPanel />
      </div>
    </div>
  );
}
```

EDIT-06: Responsive layout -- `grid-cols-1` stacks on mobile, `lg:grid-cols-2` goes side-by-side on desktop.

**Create `src/pages/tools/dockerfile-analyzer/index.astro`:**
The Astro page shell. Uses the existing Layout component. Mounts DockerfileAnalyzer with `client:only="react"`.

```astro
---
import Layout from '../../../layouts/Layout.astro';
import DockerfileAnalyzer from '../../../components/tools/DockerfileAnalyzer';
---

<Layout
  title="Dockerfile Analyzer | Patryk Golabek"
  description="Paste your Dockerfile and get instant best-practice analysis from a Kubernetes architect. 100% client-side — your code never leaves your browser."
>
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <h1 class="text-3xl sm:text-4xl font-heading font-bold mb-2 text-[var(--color-text-primary)]">
      Dockerfile Analyzer
    </h1>
    <p class="text-[var(--color-text-secondary)] mb-8 max-w-2xl">
      Paste your Dockerfile below and click <strong>Analyze</strong> for best-practice feedback
      from a Kubernetes architect's perspective. 100% client-side — your code never leaves your browser.
    </p>

    <DockerfileAnalyzer client:only="react" />
  </section>
</Layout>
```

IMPORTANT: Use `client:only="react"` (not `client:load` or `client:visible`). This is the ONLY safe directive for CodeMirror because it skips SSR entirely. The string `"react"` tells Astro which renderer to use.

Use `max-w-7xl` for the container (wider than the typical `max-w-6xl`) because the side-by-side layout needs room for both panels.

After creating all files, run:
1. `npm run build` to verify the full build succeeds
2. `npm run dev` to visually confirm the editor renders at http://localhost:4321/tools/dockerfile-analyzer/

Verify:
- Dockerfile syntax highlighting is visible (FROM, RUN, COPY should be colored)
- Clicking Analyze produces "Parse successful" in the results panel
- Pressing Cmd/Ctrl+Enter also triggers analysis
- The layout is responsive (test with browser dev tools)
- Navigate to another page and back -- editor should re-mount cleanly
  </action>
  <verify>
1. `npm run build` exits with code 0 (production build succeeds)
2. Navigate to /tools/dockerfile-analyzer/ in dev server -- editor renders with syntax highlighting
3. Click Analyze button -- results panel shows "Parse successful" with instruction count
4. Press Cmd/Ctrl+Enter -- same analysis result appears
5. Browser console shows no errors on page load or after analysis
6. Resize browser to mobile width -- layout stacks vertically
7. Navigate to /blog/ then back to /tools/dockerfile-analyzer/ -- editor re-mounts, no console errors, no blank editor
  </verify>
  <done>
Full working Dockerfile editor at /tools/dockerfile-analyzer/ with:
- CodeMirror 6 with Dockerfile syntax highlighting (FROM, RUN, COPY colored) [EDIT-01]
- Analyze button triggering lint cycle via setDiagnostics (not real-time) [EDIT-02]
- Sample Dockerfile pre-loaded [EDIT-03]
- Cmd/Ctrl+Enter keyboard shortcut [EDIT-04]
- Dark theme (oneDark + custom overrides) [EDIT-05]
- Responsive stacked/side-by-side layout [EDIT-06]
- client:only="react" island [EDIT-07]
- View Transitions lifecycle with double cleanup [EDIT-08]
  </done>
</task>

</tasks>

<verification>
1. Visit /tools/dockerfile-analyzer/ — CodeMirror editor visible with Dockerfile syntax highlighting
2. FROM, RUN, COPY keywords are distinctly colored (not plain white text)
3. Sample Dockerfile is pre-loaded in the editor
4. Click "Analyze" button — results panel shows "Parse successful" with instruction count
5. Press Cmd/Ctrl+Enter — same result, same behavior as button
6. Editor has dark theme (dark background, colored syntax, not light/white)
7. On mobile viewport (< 1024px) — editor and results stack vertically
8. On desktop viewport (>= 1024px) — editor and results side-by-side
9. Navigate to /blog/ then press Back — editor re-mounts with sample Dockerfile, no console errors
10. Repeat navigation 3x — no console errors, no blank editor, no memory leak warnings
11. `npm run build` exits with 0 — production build works
</verification>

<success_criteria>
All 8 EDIT requirements are satisfied:
- EDIT-01: CodeMirror 6 with dockerFile legacy mode syntax highlighting
- EDIT-02: Analyze button triggers on-demand lint cycle via setDiagnostics
- EDIT-03: Pre-loaded sample Dockerfile with issues across all 5 categories
- EDIT-04: Cmd/Ctrl+Enter keyboard shortcut triggers analysis
- EDIT-05: Dark-only editor theme (oneDark + custom overrides)
- EDIT-06: Responsive layout (stacked mobile, side-by-side desktop)
- EDIT-07: React island with client:only="react"
- EDIT-08: View Transitions lifecycle with destroy/recreate and astro:before-swap safety
</success_criteria>

<output>
After completion, create `.planning/phases/22-editor-foundation-technology-validation/22-02-SUMMARY.md`
</output>
