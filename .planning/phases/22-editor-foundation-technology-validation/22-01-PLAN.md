---
phase: 22-editor-foundation-technology-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/lib/tools/dockerfile-analyzer/types.ts
  - src/lib/tools/dockerfile-analyzer/parser.ts
  - src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts
  - src/stores/dockerfileAnalyzerStore.ts
autonomous: true
requirements:
  - EDIT-03
  - EDIT-07

must_haves:
  truths:
    - "dockerfile-ast bundles in Vite without CJS conversion errors"
    - "dockerfile-ast gzipped portion is under 50 KB in the production build"
    - "DockerfileParser.parse() accepts a plain string and returns a typed AST with instructions"
    - "Sample Dockerfile contains deliberate issues across Security, Efficiency, Maintainability, Reliability, and Best Practice categories"
  artifacts:
    - path: "src/lib/tools/dockerfile-analyzer/types.ts"
      provides: "Shared types for analysis pipeline (AnalysisResult, LintViolation stubs, RuleSeverity, RuleCategory)"
      exports: ["AnalysisResult", "RuleSeverity", "RuleCategory"]
    - path: "src/lib/tools/dockerfile-analyzer/parser.ts"
      provides: "dockerfile-ast wrapper exposing parseDockerfile function"
      exports: ["parseDockerfile"]
    - path: "src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts"
      provides: "Pre-loaded sample Dockerfile constant with deliberate issues"
      exports: ["SAMPLE_DOCKERFILE"]
    - path: "src/stores/dockerfileAnalyzerStore.ts"
      provides: "Nanostore atoms for analysis state bridge"
      exports: ["analysisResult", "isAnalyzing"]
  key_links:
    - from: "src/lib/tools/dockerfile-analyzer/parser.ts"
      to: "dockerfile-ast"
      via: "DockerfileParser.parse() import"
      pattern: "DockerfileParser\\.parse"
    - from: "src/stores/dockerfileAnalyzerStore.ts"
      to: "src/lib/tools/dockerfile-analyzer/types.ts"
      via: "AnalysisResult type import"
      pattern: "import.*AnalysisResult.*from"
---

<objective>
Install CodeMirror 6 and dockerfile-ast dependencies, validate the go/no-go gate (dockerfile-ast Vite bundle compatibility and size), and create the foundation modules (types, parser wrapper, sample Dockerfile, Nanostore) that Plan 02 builds upon.

Purpose: The dockerfile-ast Vite bundle is the highest-risk item in the entire v1.4 milestone. If it doesn't bundle cleanly or exceeds 50 KB gzipped, we need to know before building any UI. This plan resolves that risk first, then establishes the shared types and data layer.

Output: 4 new npm packages installed, go/no-go gate passed, 4 new source files in src/lib/tools/ and src/stores/.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-editor-foundation-technology-validation/22-RESEARCH.md
@src/stores/tabStore.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and validate dockerfile-ast go/no-go gate</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the 4 new dependencies:
```bash
npm install codemirror@^6.0.2 @codemirror/legacy-modes@^6.5.2 @codemirror/theme-one-dark@^6.1.3 dockerfile-ast@^0.7.1
```

Then validate the go/no-go gate:

1. Create a minimal temporary test: Add a one-line import of `DockerfileParser` from `dockerfile-ast` inside any existing page or create a throwaway `.ts` file that the build will pick up. The simplest approach: temporarily add this import to any file that will be client-bundled, or create a minimal Astro page at `src/pages/tools/dockerfile-analyzer/index.astro` that imports and uses `DockerfileParser.parse()` in a `client:only="react"` island (a quick throwaway React component).

   Alternatively (preferred): Create the actual `src/lib/tools/dockerfile-analyzer/parser.ts` file (Task 2 below) FIRST, then create a minimal React component that imports it, mount it as `client:only="react"` on a temp page, and run `astro build`.

2. Run `npm run build` (which runs `astro build`).

3. Verify ALL three conditions:
   - **No build errors**: The build completes successfully (exit code 0).
   - **No CJS conversion warnings**: Check build output for "Could not resolve", "Missing export", or "CommonJS" warnings. If present, note them -- minor warnings may be acceptable, but errors are not.
   - **Bundle size**: After build, check the dockerfile-ast chunk size. Use `ls -la dist/_astro/*.js | sort -k5 -n` to see JS chunk sizes. The dockerfile-ast portion (identifiable by containing "DockerfileParser" or "vscode-languageserver" in the chunk) must be under 50 KB gzipped. Check with: `gzip -c dist/_astro/[chunk-name].js | wc -c` (result in bytes, divide by 1024 for KB).

**GO/NO-GO DECISION:**
- If all 3 pass: PROCEED with Phase 22.
- If build errors or chunk > 50 KB gzipped: STOP. Document the failure in the SUMMARY. The fallback (custom lightweight parser) requires a design decision before continuing.

Note: The temp page/component used for validation will become the real page in Plan 02, so this is not throwaway work.
  </action>
  <verify>
`npm run build` exits with code 0. No "Could not resolve" or CJS conversion error warnings in build output. dockerfile-ast chunk is under 50 KB gzipped (verify with gzip -c on the relevant chunk file).
  </verify>
  <done>All 4 packages in package.json dependencies. `astro build` succeeds with dockerfile-ast import present. Bundle size verified under 50 KB gzipped for the parser portion.</done>
</task>

<task type="auto">
  <name>Task 2: Create foundation modules (types, parser, sample, store)</name>
  <files>
    src/lib/tools/dockerfile-analyzer/types.ts
    src/lib/tools/dockerfile-analyzer/parser.ts
    src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts
    src/stores/dockerfileAnalyzerStore.ts
  </files>
  <action>
**Create `src/lib/tools/dockerfile-analyzer/types.ts`:**
Define shared types for the analysis pipeline. These will be used in Phase 22 and expanded in Phase 23.

```typescript
// Rule severity levels matching CodeMirror Diagnostic severity
export type RuleSeverity = 'error' | 'warning' | 'info';

// Rule categories for grouping and scoring (Phase 23)
export type RuleCategory = 'security' | 'efficiency' | 'maintainability' | 'reliability' | 'best-practice';

// Stub for lint violation -- will be expanded in Phase 23 with rule engine
export interface LintViolation {
  line: number;        // 1-based line number
  message: string;
  severity: RuleSeverity;
  category: RuleCategory;
  ruleId: string;      // e.g., "DL3006", "PG001"
}

// Analysis result stored in nanostore
export interface AnalysisResult {
  violations: LintViolation[];
  astNodeCount: number;
  parseSuccess: boolean;
  timestamp: number;
}
```

**Create `src/lib/tools/dockerfile-analyzer/parser.ts`:**
Thin wrapper around dockerfile-ast. Handles the parse call and extracts basic metadata.

```typescript
import { DockerfileParser } from 'dockerfile-ast';

export interface ParseResult {
  instructions: Array<{
    keyword: string;
    line: number;       // 0-based line from AST
    content: string;    // full instruction text
  }>;
  nodeCount: number;
  success: boolean;
  error?: string;
}

export function parseDockerfile(content: string): ParseResult {
  try {
    const ast = DockerfileParser.parse(content);
    const instructions = ast.getInstructions().map((inst) => ({
      keyword: inst.getKeyword(),
      line: inst.getRange().start.line,
      content: inst.toString(),
    }));
    return {
      instructions,
      nodeCount: instructions.length,
      success: true,
    };
  } catch (err) {
    return {
      instructions: [],
      nodeCount: 0,
      success: false,
      error: err instanceof Error ? err.message : String(err),
    };
  }
}
```

IMPORTANT: The export name from dockerfile-ast is `DockerfileParser` (capital D, capital P). The parse method is `DockerfileParser.parse(content)` where content is a plain string. Verify this works -- if it requires a TextDocument object instead, create a thin adapter using `TextDocument.create()` from `vscode-languageserver-textdocument`.

**Create `src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts`:**
Pre-loaded sample with deliberate issues across all 5 rule categories.

```typescript
export const SAMPLE_DOCKERFILE = `# Dockerfile with common issues — paste yours to analyze!

FROM ubuntu:latest

MAINTAINER john@example.com

RUN apt-get update
RUN apt-get install -y curl wget git python3 nodejs

ADD https://example.com/app.tar.gz /app/
COPY . /app

WORKDIR app
RUN cd /tmp && do-something

ENV API_KEY=sk-1234567890abcdef
ENV DATABASE_URL=postgres://admin:password@db:5432/myapp

RUN pip install flask requests numpy
RUN npm install

EXPOSE 80
EXPOSE 8080

RUN chmod 777 /app

USER root

CMD node server.js
`;
```

Issues covered:
- Security: secrets in ENV, chmod 777, running as root, ADD from URL
- Efficiency: multiple RUN layers (not consolidated), using latest tag
- Maintainability: MAINTAINER (deprecated), no LABEL, no .dockerignore hint
- Reliability: no pinned versions for pip/npm, WORKDIR relative path
- Best Practice: COPY . before specific files, no HEALTHCHECK, multiple EXPOSE

**Create `src/stores/dockerfileAnalyzerStore.ts`:**
Follow the existing nanostore pattern from `src/stores/tabStore.ts`.

```typescript
import { atom } from 'nanostores';
import type { AnalysisResult } from '../lib/tools/dockerfile-analyzer/types';

/** Current analysis result — null before first analysis */
export const analysisResult = atom<AnalysisResult | null>(null);

/** Whether analysis is currently running */
export const isAnalyzing = atom<boolean>(false);
```

Keep it minimal -- the store is a bridge, not a state machine. Phase 24 may add more atoms for UI state.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm all 4 files have no TypeScript errors. Verify imports resolve: `dockerfile-ast` in parser.ts, `nanostores` in store, type imports between files.
  </verify>
  <done>4 source files created with proper TypeScript types, no compilation errors. Parser wrapper correctly wraps DockerfileParser.parse(). Sample Dockerfile has issues across all 5 categories. Nanostore follows existing tabStore.ts pattern.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes with exit code 0 (go/no-go gate passed)
2. No CJS conversion warnings in build output related to dockerfile-ast
3. dockerfile-ast chunk under 50 KB gzipped in production build
4. `npx tsc --noEmit` passes with no errors
5. All 4 source files exist at their specified paths
6. `DockerfileParser.parse()` successfully parses the sample Dockerfile (verified during build or via a quick runtime test)
</verification>

<success_criteria>
Go/no-go gate PASSED: dockerfile-ast bundles cleanly in Vite under 50 KB gzipped with no CJS errors. Foundation types, parser wrapper, sample Dockerfile, and Nanostore atoms are created and compile without errors. All 4 new npm packages installed.
</success_criteria>

<output>
After completion, create `.planning/phases/22-editor-foundation-technology-validation/22-01-SUMMARY.md`
</output>
