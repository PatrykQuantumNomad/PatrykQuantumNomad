---
phase: 15-filtering-animations-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ProjectFilterBar.astro
  - src/pages/projects/index.astro
  - src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "Category filter tabs appear at top of projects page with 'All' selected by default"
    - "Clicking a filter tab shows only that category's projects and hides unrelated sections"
    - "Filter transitions are smooth -- cards animate position changes via GSAP Flip, not instant show/hide"
    - "Active filter tab is visually distinct with accent-styled pill button"
    - "Selected filter is reflected in URL hash (e.g., #kubernetes) and restores on page load"
    - "Hero section hides when a non-All filter is active"
    - "Category section headers and dividers hide for filtered-out categories"
  artifacts:
    - path: "src/components/ProjectFilterBar.astro"
      provides: "Filter tab bar with pill buttons for All + 4 categories"
      contains: "data-filter"
    - path: "src/pages/projects/index.astro"
      provides: "Filter logic script, data-category-section wrappers, data-hero-section attribute"
      contains: "Flip.from"
    - path: "src/styles/global.css"
      provides: "Filter tab styling with hover and aria-pressed active states"
      contains: "filter-tab"
  key_links:
    - from: "src/components/ProjectFilterBar.astro"
      to: "src/pages/projects/index.astro"
      via: "data-filter attribute on buttons, consumed by inline script"
      pattern: "data-filter"
    - from: "src/pages/projects/index.astro"
      to: "gsap/Flip"
      via: "import and Flip.from() call in inline script"
      pattern: "Flip\\.from"
    - from: "src/pages/projects/index.astro"
      to: "window.location.hash"
      via: "replaceState for hash sync"
      pattern: "replaceState"
---

<objective>
Build the category filter system for the projects page with smooth GSAP Flip layout transitions and URL hash synchronization.

Purpose: Users can filter projects by category (AI/ML, Kubernetes, Platform, Security) with animated layout transitions, enabling quick discovery of relevant work. Filter state persists in URL hash for shareability.
Output: ProjectFilterBar component, updated projects page with filter logic, filter tab CSS.

NOTE: ANIM-01 (card stagger-reveal on scroll) is NOT a deliverable of this plan. It is already implemented via existing `data-card-group` attributes and `initCardGroupStagger()` in `src/lib/scroll-animations.ts`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-filtering-animations-polish/15-RESEARCH.md
@.planning/phases/13-data-model-bento-grid-layout/13-02-SUMMARY.md
@.planning/phases/14-visual-design-card-components/14-01-SUMMARY.md
@src/pages/projects/index.astro
@src/components/ProjectCard.astro
@src/data/projects.ts
@src/lib/scroll-animations.ts
@src/styles/global.css
@src/components/animations/TiltCard.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectFilterBar and update projects page markup</name>
  <files>
    src/components/ProjectFilterBar.astro
    src/pages/projects/index.astro
    src/styles/global.css
  </files>
  <action>
**Create `src/components/ProjectFilterBar.astro`:**
- Import `categories` from `../data/projects`
- Define `categoryMeta` mapping matching ProjectCard's slugs: `'AI/ML & LLM Agents' -> { slug: 'ai-ml', label: 'AI / ML' }`, `'Kubernetes & Infrastructure' -> { slug: 'kubernetes', label: 'Kubernetes' }`, `'Platform & DevOps Tooling' -> { slug: 'platform', label: 'Platform' }`, `'Security & Networking' -> { slug: 'security', label: 'Security' }`
- Build tabs array: `[{ slug: 'all', label: 'All' }, ...categories.map(c => categoryMeta[c])]`
- Render `<nav class="flex flex-wrap gap-2 mb-10" aria-label="Filter projects by category">` containing `<button>` elements (NOT `<a>` tags -- prevents Astro ClientRouter interception)
- Each button: `class="filter-tab meta-mono px-4 py-1.5 rounded-full border border-[var(--color-border)] transition-all duration-200"`, `data-filter={tab.slug}`, `aria-pressed={tab.slug === 'all' ? 'true' : 'false'}`

**Update `src/pages/projects/index.astro`:**
- Import `ProjectFilterBar` component
- Add `<ProjectFilterBar />` after the intro paragraph and before the hero section
- Wrap the hero section `ProjectHero` in a div with `data-hero-section` attribute
- Wrap each category section in a div with `data-category-section={slug}` and `data-section-bg={slug}` and `style="position: relative;"` where slug comes from the same categoryMeta mapping (define it in the frontmatter or inline). Compute slug from category name using a local `categoryMeta` record matching the same slugs used in ProjectCard.
- Move the gradient divider INSIDE the `data-category-section` wrapper (not outside it) so it hides with the section
- Ensure each card already has `data-category` (it does, from ProjectCard.astro) and `data-card-item` (it does)

**Add filter tab CSS to `src/styles/global.css`:**
Add after the card-hover section (around line 213), before the icon-hover section:
```css
/* --- Filter Tab Pill Buttons --- */
.filter-tab {
  cursor: pointer;
  background: transparent;
  color: var(--color-text-secondary);
  font-size: 0.8125rem;
}
.filter-tab:hover {
  border-color: var(--color-accent);
  color: var(--color-accent);
}
.filter-tab[aria-pressed="true"] {
  background: var(--color-accent);
  color: white;
  border-color: var(--color-accent);
  box-shadow: 0 2px 12px var(--color-accent-glow);
}
```
  </action>
  <verify>
Run `npx astro build` -- must pass with 0 errors. Grep the built HTML for `data-filter` buttons (should find 5: All + 4 categories). Grep for `data-category-section` (should find 4 sections). Grep for `data-hero-section` (should find 1).
  </verify>
  <done>
ProjectFilterBar renders 5 pill buttons (All, AI/ML, Kubernetes, Platform, Security) with correct data-filter attributes. Projects page has data-category-section on each category wrapper and data-hero-section on the hero wrapper. Filter tab CSS provides hover and active (aria-pressed) styling. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement GSAP Flip filter logic and URL hash sync</name>
  <files>
    src/pages/projects/index.astro
  </files>
  <action>
Add an inline `<script>` tag at the bottom of `projects/index.astro` (after the Layout closing tag is NOT valid in Astro -- place it inside the Layout, after the BreadcrumbJsonLd, as a sibling). The script implements the full filter system:

**Imports:**
```typescript
import { gsap } from 'gsap';
import { Flip } from 'gsap/Flip';
import { ScrollTrigger } from 'gsap/ScrollTrigger';
gsap.registerPlugin(Flip, ScrollTrigger);
```

**Constants:**
- `REDUCED_MOTION = window.matchMedia('(prefers-reduced-motion: reduce)').matches`
- `let isAnimating = false` -- guard against rapid clicks during Flip animation
- `VALID_SLUGS = ['ai-ml', 'kubernetes', 'platform', 'security']` for hash validation

**`initProjectFilter()` function (called on `astro:page-load`):**
1. Query all `[data-filter]` buttons, `[data-card-item]` cards, `[data-category-section]` sections, `[data-hero-section]` hero
2. If no tabs found, return early
3. Read initial filter from URL hash via `getFilterFromHash()`. If not 'all', call `applyFilter(slug, false)` (no animation on load) and `setActiveTab(slug)`
4. Add click listener to each tab: guard `if (isAnimating) return`, get `slug` from `tab.dataset.filter`, call `applyFilter(slug, !REDUCED_MOTION)`, `setActiveTab(slug)`, `setFilterHash(slug)`
5. Add `hashchange` listener for browser back/forward

**`applyFilter(slug, animate)` function:**
- If `animate`:
  1. Set `isAnimating = true`
  2. Destroy vanilla-tilt on all visible `[data-tilt]` elements before capturing Flip state: `document.querySelectorAll('[data-tilt]').forEach(el => { if ((el as any).vanillaTilt) (el as any).vanillaTilt.destroy(); })`
  3. Capture state: `const state = Flip.getState('[data-card-item]')`
  4. Call `toggleVisibility(slug)`
  5. `Flip.from(state, { duration: 0.5, ease: 'power2.inOut', stagger: 0.03, absolute: true, absoluteOnLeave: true, onEnter: els => gsap.fromTo(els, { opacity: 0, scale: 0.9 }, { opacity: 1, scale: 1, duration: 0.4, stagger: 0.03 }), onLeave: els => gsap.to(els, { opacity: 0, scale: 0.9, duration: 0.3 }), onComplete: () => { isAnimating = false; ScrollTrigger.refresh(); reinitTilt(); } })`
- If not animate: call `toggleVisibility(slug)`, then call `reinitTilt()` (re-init tilt for visible cards after non-animated filter, e.g., on page load with hash)

**`toggleVisibility(slug)` function:**
- `showAll = slug === 'all'`
- Cards: `forEach` -- set `style.display = (showAll || card.dataset.category === slug) ? '' : 'none'`
- Sections: `forEach` -- set `style.display = (showAll || section.dataset.categorySection === slug) ? '' : 'none'`
- Hero: `heroSection.style.display = showAll ? '' : 'none'` (hero hides for non-All filters per research recommendation)

**`reinitTilt()` function â€” EXPLICIT vanilla-tilt lifecycle:**
TiltCard.astro uses dynamic `import('vanilla-tilt')`, so VanillaTilt is NOT available on `window`. The reinit function must use the same dynamic import pattern:
```typescript
async function reinitTilt() {
  if (window.matchMedia('(pointer: coarse)').matches) return;
  if (REDUCED_MOTION) return;

  const VanillaTilt = (await import('vanilla-tilt')).default;
  document.querySelectorAll<HTMLElement>('[data-tilt]:not([style*="display: none"])').forEach(el => {
    // Only init if not already initialized (destroyed elements won't have vanillaTilt)
    if (!(el as any).vanillaTilt) {
      VanillaTilt.init(el, {
        max: 15,
        speed: 300,
        glare: true,
        'max-glare': 0.3,
        perspective: 800,
      });
    }
  });
}
```
The tilt params (max: 15, speed: 300, glare: true, max-glare: 0.3, perspective: 800) MUST match TiltCard.astro's init params exactly.

**`setActiveTab(slug)` function:**
- `document.querySelectorAll('[data-filter]').forEach(tab => tab.setAttribute('aria-pressed', tab.dataset.filter === slug ? 'true' : 'false'))`

**`getFilterFromHash()` function:**
- `const hash = window.location.hash.slice(1).toLowerCase()`
- Return `VALID_SLUGS.includes(hash) ? hash : 'all'`

**`setFilterHash(slug)` function:**
- Use `history.replaceState` (NOT pushState -- avoids polluting browser history)
- `if (slug === 'all') history.replaceState(null, '', window.location.pathname)` else `history.replaceState(null, '', '#' + slug)`

**Critical implementation notes from research:**
- Do NOT use `!important` on display:none -- GSAP Flip needs to override display during animation
- The `absolute: true` parameter is essential to prevent grid collapse during animation
- Use `replaceState` not `pushState` for hash updates
- Filter tabs MUST be `<button>` elements, not `<a>` links
- `ScrollTrigger.refresh()` in onComplete callback to recalculate scroll positions after page height changes
- vanilla-tilt destroy MUST happen BEFORE `Flip.getState()` to capture clean geometry
- vanilla-tilt reinit MUST happen AFTER `Flip.from()` completes (in `onComplete`) so elements are in final positions
  </action>
  <verify>
Run `npx astro build` -- must pass. Manually verify the built JS contains `Flip.from` and `gsap.registerPlugin`. Check that the script tag exists in the built HTML for the projects page.

**Pitfall-specific verification:**
1. Reduced-motion: Grep the built JS for `prefers-reduced-motion` -- must appear (REDUCED_MOTION constant)
2. Hash restore: Grep for `getFilterFromHash` -- must appear in the astro:page-load handler
3. Rapid-click guard: Grep for `isAnimating` -- must appear in click handler guard
4. Tilt lifecycle: Grep for `vanillaTilt.destroy` and `import('vanilla-tilt')` -- both must appear (destroy before Flip, dynamic import in reinitTilt)
5. ScrollTrigger refresh: Grep for `ScrollTrigger.refresh` -- must appear in onComplete
  </verify>
  <done>
Clicking a filter tab toggles category visibility with smooth GSAP Flip animation (or instant toggle when reduced-motion is active). URL hash updates on filter click and restores filter state on page load. Hero section hides for non-All filters. Category section wrappers (headers + grids + dividers) hide/show together. Rapid-click guard prevents animation conflicts. vanilla-tilt is explicitly destroyed before Flip.getState() and re-initialized via dynamic import('vanilla-tilt') in Flip.from onComplete callback, using identical params to TiltCard.astro.
  </done>
</task>

</tasks>

<verification>
1. `npx astro build` passes with 0 errors
2. Built HTML for /projects/ contains 5 `data-filter` buttons
3. Built HTML contains 4 `data-category-section` elements
4. Built HTML contains 1 `data-hero-section` element
5. Built JS contains `Flip.from` and `Flip.getState`
6. Filter tab CSS includes `.filter-tab[aria-pressed="true"]` rule
7. `prefers-reduced-motion` check gates the Flip animation
8. vanilla-tilt destroyed before Flip state capture, reinited via dynamic import in onComplete
9. `isAnimating` guard prevents rapid-click conflicts
10. Hash restore works on page load via `getFilterFromHash()`
</verification>

<success_criteria>
- Filter tabs render with correct aria-pressed state
- Clicking a tab filters projects with animated Flip layout transition
- URL hash reflects active filter and restores on load
- Hero section hides for filtered views
- Category sections (headers, dividers, grids) hide/show as units
- Reduced-motion users get instant toggle instead of animation
- vanilla-tilt lifecycle is explicit: destroy before Flip, reinit after Flip completes
- Rapid-click guard prevents animation conflicts
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-filtering-animations-polish/15-01-SUMMARY.md`
</output>
