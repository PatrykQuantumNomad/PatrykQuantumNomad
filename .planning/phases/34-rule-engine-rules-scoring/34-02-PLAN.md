---
phase: 34-rule-engine-rules-scoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/compose-validator/rules/security/CV-C001-privileged-mode.ts
  - src/lib/tools/compose-validator/rules/security/CV-C002-docker-socket-mount.ts
  - src/lib/tools/compose-validator/rules/security/CV-C003-host-network-mode.ts
  - src/lib/tools/compose-validator/rules/security/CV-C004-host-pid-mode.ts
  - src/lib/tools/compose-validator/rules/security/CV-C005-host-ipc-mode.ts
  - src/lib/tools/compose-validator/rules/security/CV-C006-dangerous-capabilities.ts
  - src/lib/tools/compose-validator/rules/security/CV-C007-default-capabilities-not-dropped.ts
  - src/lib/tools/compose-validator/rules/security/CV-C008-secrets-in-environment.ts
  - src/lib/tools/compose-validator/rules/security/CV-C009-unbound-port-interface.ts
  - src/lib/tools/compose-validator/rules/security/CV-C010-missing-no-new-privileges.ts
  - src/lib/tools/compose-validator/rules/security/CV-C011-writable-filesystem.ts
  - src/lib/tools/compose-validator/rules/security/CV-C012-seccomp-disabled.ts
  - src/lib/tools/compose-validator/rules/security/CV-C013-selinux-disabled.ts
  - src/lib/tools/compose-validator/rules/security/CV-C014-image-latest-no-tag.ts
  - src/lib/tools/compose-validator/rules/security/index.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B001-missing-healthcheck.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B002-no-restart-policy.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B003-no-resource-limits.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B004-image-tag-not-pinned.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B005-no-logging-config.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B006-deprecated-version-field.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B007-missing-project-name.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B008-build-and-image.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B009-anonymous-volume.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B010-no-memory-reservation.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B011-healthcheck-timeout-exceeds-interval.ts
  - src/lib/tools/compose-validator/rules/best-practice/CV-B012-default-network-only.ts
  - src/lib/tools/compose-validator/rules/best-practice/index.ts
autonomous: true
requirements: [SEC-01, SEC-02, SEC-03, SEC-04, SEC-05, SEC-06, SEC-07, SEC-08, SEC-09, SEC-10, SEC-11, SEC-12, SEC-13, SEC-14, BP-01, BP-02, BP-03, BP-04, BP-05, BP-06, BP-07, BP-08, BP-09, BP-10, BP-11, BP-12]

must_haves:
  truths:
    - "Security rules flag privileged mode, Docker socket mounts, host namespace modes, dangerous capabilities, secrets in env vars, and missing hardening"
    - "Best practice rules detect missing healthchecks, restart policies, resource limits, logging config, and deprecated/ambiguous configurations"
    - "Security rules include CWE references in violation messages where applicable"
    - "SEC-08 uses suffix-based patterns to avoid false positives on non-secret environment variables"
  artifacts:
    - path: "src/lib/tools/compose-validator/rules/security/index.ts"
      provides: "Security rules registry array"
      exports: ["securityRules"]
    - path: "src/lib/tools/compose-validator/rules/best-practice/index.ts"
      provides: "Best practice rules registry array"
      exports: ["bestPracticeRules"]
    - path: "src/lib/tools/compose-validator/rules/security/CV-C001-privileged-mode.ts"
      provides: "Privileged mode detection rule"
      exports: ["CVC001"]
    - path: "src/lib/tools/compose-validator/rules/best-practice/CV-B001-missing-healthcheck.ts"
      provides: "Missing healthcheck detection rule"
      exports: ["CVB001"]
  key_links:
    - from: "src/lib/tools/compose-validator/rules/security/CV-C009-unbound-port-interface.ts"
      to: "src/lib/tools/compose-validator/port-parser.ts"
      via: "import parsePortString for IP binding check"
      pattern: "import.*from.*port-parser"
    - from: "all rule files"
      to: "src/lib/tools/compose-validator/parser.ts"
      via: "import getNodeLine for line extraction"
      pattern: "import.*getNodeLine.*from.*parser"
---

<objective>
Create all 14 security rules and 12 best practice rules for Docker Compose validation.

Purpose: Security rules (30% weight) and best practice rules (20% weight) together represent 50% of the scoring weight. Security rules flag container isolation failures and missing hardening. Best practice rules detect common misconfigurations that reduce reliability and maintainability. These are simpler per-service checks (unlike semantic rules' cross-service analysis).

Output: 14 security rule files (CV-C001 through CV-C014), 12 best practice rule files (CV-B001 through CV-B012), security/index.ts and best-practice/index.ts registries
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-rule-engine-rules-scoring/34-RESEARCH.md
@.planning/phases/33-yaml-parsing-schema-validation-foundation/33-01-SUMMARY.md
@.planning/phases/33-yaml-parsing-schema-validation-foundation/33-02-SUMMARY.md

@src/lib/tools/compose-validator/types.ts
@src/lib/tools/compose-validator/parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 14 security rules and security/index.ts registry</name>
  <files>
    src/lib/tools/compose-validator/rules/security/CV-C001-privileged-mode.ts
    src/lib/tools/compose-validator/rules/security/CV-C002-docker-socket-mount.ts
    src/lib/tools/compose-validator/rules/security/CV-C003-host-network-mode.ts
    src/lib/tools/compose-validator/rules/security/CV-C004-host-pid-mode.ts
    src/lib/tools/compose-validator/rules/security/CV-C005-host-ipc-mode.ts
    src/lib/tools/compose-validator/rules/security/CV-C006-dangerous-capabilities.ts
    src/lib/tools/compose-validator/rules/security/CV-C007-default-capabilities-not-dropped.ts
    src/lib/tools/compose-validator/rules/security/CV-C008-secrets-in-environment.ts
    src/lib/tools/compose-validator/rules/security/CV-C009-unbound-port-interface.ts
    src/lib/tools/compose-validator/rules/security/CV-C010-missing-no-new-privileges.ts
    src/lib/tools/compose-validator/rules/security/CV-C011-writable-filesystem.ts
    src/lib/tools/compose-validator/rules/security/CV-C012-seccomp-disabled.ts
    src/lib/tools/compose-validator/rules/security/CV-C013-selinux-disabled.ts
    src/lib/tools/compose-validator/rules/security/CV-C014-image-latest-no-tag.ts
    src/lib/tools/compose-validator/rules/security/index.ts
  </files>
  <action>
Create all 14 security rules implementing `ComposeLintRule` interface. Each rule file exports a single const (e.g., `CVC001`). All import `isMap, isPair, isScalar, isSeq` from 'yaml' and `getNodeLine` from `../../parser`. Category is always `'security'`.

**Rule specifications:**

**CV-C001 (error):** Privileged mode. Iterate services, find `privileged` key, check if value is `true`. Report on the `privileged` key node. Message includes "(CWE-250)".
Explanation: Running in privileged mode grants all Linux kernel capabilities and host device access, effectively disabling container isolation.
Fix: Remove `privileged: true` and use specific `cap_add` capabilities instead.

**CV-C002 (error):** Docker socket mounted. Iterate services, find `volumes` key. For each volume entry (both short string and long map syntax), check if the string contains `/var/run/docker.sock`. For long syntax, check the `source` key value. Report on the volume entry node. Message includes "(CWE-250)".
Explanation: Mounting the Docker socket grants root-level control over the host Docker daemon.
Fix: Use Docker API proxy with limited permissions, or avoid socket mounting.

**CV-C003 (error):** Host network mode. Find `network_mode` key, check if value is `'host'`. Report on the `network_mode` key. Message includes security implications.
Explanation: Host network mode bypasses Docker network isolation, exposing all host ports to the container.
Fix: Use user-defined bridge networks for service-to-service communication.

**CV-C004 (error):** Host PID mode. Find `pid` key, check if value is `'host'`. Report on `pid` key.
Explanation: Sharing the host PID namespace allows container processes to see and signal host processes.
Fix: Remove `pid: host` unless debugging.

**CV-C005 (error):** Host IPC mode. Find `ipc` key, check if value is `'host'`. Report on `ipc` key.
Explanation: Sharing the host IPC namespace allows container access to host shared memory.
Fix: Remove `ipc: host` or use `ipc: shareable` between specific services.

**CV-C006 (error):** Dangerous capabilities. Find `cap_add` key (should be a YAMLSeq). Check each item against dangerous set: `SYS_ADMIN`, `NET_ADMIN`, `ALL`, `SYS_PTRACE`, `SYS_RAWIO`, `DAC_OVERRIDE`, `NET_RAW`. Report on each dangerous capability node. Message: "Service '{svc}' adds dangerous capability '{cap}' (CWE-250)."

**CV-C007 (warning):** Default capabilities not dropped. Iterate services. Check if service has `cap_drop` key containing `ALL` (meaning all default caps are dropped before selectively adding back). If no `cap_drop: [ALL]`, report on the service name node. Message: "Service '{svc}' does not drop default capabilities. Add 'cap_drop: [ALL]' and explicitly add back only needed capabilities."

**CV-C008 (warning):** Secrets in environment variables. Find `environment` key. Handle both map form (`environment: { KEY: value }`) and list form (`environment: ["KEY=value"]`). Use SUFFIX-BASED pattern to avoid false positives: check if env var name ENDS with or IS one of: `PASSWORD`, `PASSWD`, `SECRET`, `API_KEY`, `TOKEN`, `AUTH_TOKEN`, `ACCESS_KEY`, `PRIVATE_KEY`, `CREDENTIALS`, `DB_PASS`. Pattern: `/(?:_|^)(PASSWORD|PASSWD|SECRET|API_KEY|TOKEN|AUTH_TOKEN|ACCESS_KEY|SECRET_KEY|PRIVATE_KEY|CREDENTIALS|DB_PASS)$/i`. Do NOT match names like `PASSWORD_MIN_LENGTH` or `TOKEN_EXPIRY`. Report on the env entry node. Message: "Service '{svc}' may contain secrets in environment variable '{key}'. Use Docker secrets or .env files instead."

**CV-C009 (warning):** Unbound port interface. Find `ports` key. For each short-syntax string port entry, import `parsePortString` from `../../port-parser`. If parsed port has `hostPort` defined but `hostIp` is undefined (meaning it binds to 0.0.0.0), report on the port node. Skip long-syntax map ports that have `host_ip` defined. Skip ports with no host port (container-only). Message: "Port '{port}' in service '{svc}' binds to all interfaces (0.0.0.0). Bind to 127.0.0.1 for local-only access."

**CV-C010 (warning):** Missing no-new-privileges. Find `security_opt` key (YAMLSeq). Check if any item contains `no-new-privileges:true` or `no-new-privileges=true`. If `security_opt` is missing or doesn't contain it, report on the service name node. Message: "Service '{svc}' does not set no-new-privileges. This allows processes to gain additional privileges via setuid/setgid."

**CV-C011 (warning):** Writable filesystem. Check if service has `read_only: true`. If missing or false, report on the service name node. Message: "Service '{svc}' has a writable root filesystem. Set 'read_only: true' and use tmpfs for writable paths."

**CV-C012 (warning):** Seccomp disabled. Find `security_opt` key. Check if any item contains `seccomp:unconfined` or `seccomp=unconfined`. If found, report on that entry. Message: "Service '{svc}' disables seccomp profile. This removes syscall filtering protections."

**CV-C013 (warning):** SELinux disabled. Find `security_opt` key. Check if any item contains `label:disable` or `label=disable`. If found, report on that entry. Message: "Service '{svc}' disables SELinux labeling."

**CV-C014 (warning):** Image uses latest/no tag. Find `image` key. Check if the image string has no `:` (no tag), ends with `:latest`, or the tag portion matches common mutable tags (already handled by BP-04 for mutable tags, so this rule focuses on `:latest` and missing tag). If image has no colon or ends with `:latest`, report. Skip images with `@sha256:` digest pinning. Message: "Service '{svc}' uses image '{img}' without a specific version tag."

**security/index.ts:** Import all 14 rules and export as `securityRules: ComposeLintRule[]` array.
  </action>
  <verify>
Run `npx astro build` to confirm no TypeScript compilation errors. Verify security/index.ts exports `securityRules` array with 14 entries.
  </verify>
  <done>
All 14 security rules exist under rules/security/, each implementing ComposeLintRule with check() method. Rules handle both short and long syntax for volumes (C002) and ports (C009). SEC-08 uses suffix-based patterns to minimize false positives. CWE references included where applicable. The security/index.ts exports securityRules with all 14 rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create 12 best practice rules and best-practice/index.ts registry</name>
  <files>
    src/lib/tools/compose-validator/rules/best-practice/CV-B001-missing-healthcheck.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B002-no-restart-policy.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B003-no-resource-limits.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B004-image-tag-not-pinned.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B005-no-logging-config.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B006-deprecated-version-field.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B007-missing-project-name.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B008-build-and-image.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B009-anonymous-volume.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B010-no-memory-reservation.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B011-healthcheck-timeout-exceeds-interval.ts
    src/lib/tools/compose-validator/rules/best-practice/CV-B012-default-network-only.ts
    src/lib/tools/compose-validator/rules/best-practice/index.ts
  </files>
  <action>
Create all 12 best practice rules implementing `ComposeLintRule` interface. Each rule file exports a single const (e.g., `CVB001`). Category is always `'best-practice'`.

**Rule specifications:**

**CV-B001 (warning):** Missing healthcheck. Iterate services. Check if service has a `healthcheck` key. If not, report on the service name node. Skip services that set `healthcheck: { disable: true }` (explicit opt-out). Message: "Service '{svc}' has no healthcheck defined."
Fix: Add a healthcheck with test, interval, timeout, retries.

**CV-B002 (warning):** No restart policy. Check if service has `restart` key OR `deploy.restart_policy` key. If neither, report on service name node. Message: "Service '{svc}' has no restart policy."
Fix: Add `restart: unless-stopped` or `restart: on-failure`.

**CV-B003 (warning):** No resource limits. Check for `deploy` key containing `resources.limits` (nested map: deploy -> resources -> limits). If missing, report on service name node. Message: "Service '{svc}' has no resource limits defined."
Fix: Add deploy.resources.limits with cpus and memory.

**CV-B004 (warning):** Image tag not pinned (mutable tags). Find `image` key. Check if the tag portion matches mutable tags: `latest`, `stable`, `edge`, `lts`, `beta`, `alpha`, `rc`, `dev`, `nightly`, `canary`, `main`, `master`. Skip images with `@sha256:` digest. Message: "Service '{svc}' uses mutable tag '{tag}' which may change unexpectedly."
Fix: Pin to a specific version tag or SHA digest.

**CV-B005 (info):** No logging configuration. Check if service has `logging` key. If not, report on service name node. Message: "Service '{svc}' has no logging configuration."
Fix: Add logging driver and options for structured logging.

**CV-B006 (warning):** Deprecated version field. This is a TOP-LEVEL check (not per-service). Traverse `ctx.doc.contents` items (should be a YAMLMap). If a top-level key is `version`, report on that key node. Message: "The top-level 'version' field is deprecated. Docker Compose V2 ignores it."
Fix: Remove the `version` field entirely.

**CV-B007 (info):** Missing project name. Top-level check. Traverse `ctx.doc.contents` items. Check if a `name` key exists. If not, report on line 1 (or the first key node). Message: "No top-level 'name' field. Docker Compose derives the project name from the directory name, which may be unpredictable."
Fix: Add `name: my-project` at the top level.

**CV-B008 (warning):** Both build and image specified. Iterate services. Check if service has BOTH `build` and `image` keys. If so, report on the `build` key node. Message: "Service '{svc}' specifies both 'build' and 'image'. The image tag will be applied to the built image, which may cause confusion."
Fix: Use either `build` or `image`, not both, unless intentionally tagging build output.

**CV-B009 (info):** Anonymous volume usage. Iterate services, find `volumes` key. For each volume entry that is a short-syntax string: if it's a single path with no `:` separator (e.g., `/data` or `/var/lib/data`), it's an anonymous volume. Do NOT flag bind mounts or named volumes. For long syntax, check if `type: volume` with empty/missing `source`. Report on the volume entry node. Message: "Service '{svc}' uses anonymous volume '{path}'. Named volumes are easier to manage and backup."
Fix: Use a named volume with a top-level volumes definition.

**CV-B010 (info):** No memory reservation alongside limits. Check if service has `deploy.resources.limits.memory` but NOT `deploy.resources.reservations.memory`. Navigate the nested map: deploy -> resources -> limits -> memory (must exist) then deploy -> resources -> reservations -> memory (must be absent). Report on the `limits` node. Message: "Service '{svc}' sets memory limits without memory reservations."
Fix: Add deploy.resources.reservations.memory for graceful scheduling.

**CV-B011 (warning):** Healthcheck timeout exceeds interval. Find `healthcheck` key. Extract `timeout` and `interval` values. Parse Docker duration strings using a simple parser: match `/(\d+)(ns|us|ms|s|m|h)/g` and convert to milliseconds. If timeout >= interval, report on the `timeout` key node. Handle defaults: Docker default interval is 30s, default timeout is 30s. Only compare when both are explicitly set. Message: "Service '{svc}' healthcheck timeout ({timeout}) exceeds interval ({interval})."
Fix: Set timeout shorter than interval.

**CV-B012 (info):** Default network only. Top-level check. Check if `ctx.networks.size === 0` (no top-level networks defined). Only fire when there are 2+ services AND no service uses `network_mode: host`. Report on line 1. Message: "No custom networks defined. All services share the default network."
Fix: Define custom networks for service isolation.

**best-practice/index.ts:** Import all 12 rules and export as `bestPracticeRules: ComposeLintRule[]` array.
  </action>
  <verify>
Run `npx astro build` to confirm no TypeScript compilation errors. Verify best-practice/index.ts exports `bestPracticeRules` array with 12 entries.
  </verify>
  <done>
All 12 best practice rules exist under rules/best-practice/, each implementing ComposeLintRule with check() method. BP-06 and BP-07 check top-level keys (not per-service). BP-09 correctly distinguishes anonymous volumes from bind mounts and named volumes. BP-11 includes a simple duration parser. BP-12 only fires with 2+ services and no host network mode. The best-practice/index.ts exports bestPracticeRules with all 12 rules.
  </done>
</task>

</tasks>

<verification>
1. `npx astro build` succeeds with no TypeScript errors
2. 14 files exist in rules/security/ (CV-C001 through CV-C014) plus index.ts
3. 12 files exist in rules/best-practice/ (CV-B001 through CV-B012) plus index.ts
4. Each rule file exports a ComposeLintRule with all required fields and a check() method
5. Security rules include CWE references where applicable
6. SEC-08 uses suffix-based pattern matching to avoid false positives
7. Rules handle both short and long syntax forms (volumes in C002, ports in C009, environment in C008)
</verification>

<success_criteria>
- All 14 security rules detect the specified container security issues
- All 12 best practice rules detect the specified configuration issues
- SEC-08 does NOT flag variables like PASSWORD_MIN_LENGTH or TOKEN_EXPIRY (suffix-based matching)
- BP-06/BP-07 check top-level document keys, not per-service keys
- BP-09 flags only anonymous volumes (single path, no colon), not bind mounts or named volumes
- BP-11 compares parsed durations, not raw strings
- BP-12 does not fire on single-service files or files using network_mode: host
- Astro build succeeds with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/34-rule-engine-rules-scoring/34-02-SUMMARY.md`
</output>
