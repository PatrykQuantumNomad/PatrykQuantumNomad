---
phase: 06-visual-effects-quantum-explorer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layouts/Layout.astro
  - src/components/ParticleCanvas.astro
  - src/pages/index.astro
autonomous: true

must_haves:
  truths:
    - "Home page hero displays an animated particle canvas with floating dots on a dark gradient background"
    - "Particle effects pause when the browser tab is hidden and resume when it becomes visible"
    - "Mobile devices render ~30 particles, tablets ~50, desktops ~80"
    - "Users with prefers-reduced-motion see a static gradient fallback with no canvas animation"
    - "Navigating between pages produces smooth view transitions instead of full-page reload flash"
    - "Theme (dark/light) applies correctly after every view transition with no FOUC"
    - "Typing animation on the home hero does not double-fire or accelerate after navigating away and back"
  artifacts:
    - path: "src/components/ParticleCanvas.astro"
      provides: "Self-contained particle canvas with gradient fallback, Page Visibility API pause, reduced-motion bail-out, mobile particle count reduction"
      min_lines: 80
    - path: "src/layouts/Layout.astro"
      provides: "ClientRouter for view transitions, astro:after-swap theme handler"
      contains: "ClientRouter"
    - path: "src/pages/index.astro"
      provides: "ParticleCanvas in hero section with transition:persist, fixed typing animation"
      contains: "ParticleCanvas"
  key_links:
    - from: "src/layouts/Layout.astro"
      to: "astro:transitions"
      via: "import { ClientRouter } from 'astro:transitions'"
      pattern: "ClientRouter"
    - from: "src/layouts/Layout.astro"
      to: "theme persistence"
      via: "astro:after-swap event listener calling applyTheme"
      pattern: "astro:after-swap"
    - from: "src/pages/index.astro"
      to: "src/components/ParticleCanvas.astro"
      via: "Astro component import in hero section"
      pattern: "import ParticleCanvas"
    - from: "src/pages/index.astro"
      to: "view transition persistence"
      via: "transition:persist on particle container"
      pattern: "transition:persist"
---

<objective>
Add the Astro ClientRouter for smooth page transitions, create the "Quantum Explorer" particle canvas component, and wire it into the home page hero section. Fix the theme detection script to survive view transitions and guard the typing animation against double-initialization.

Purpose: This is the visual centerpiece of the site -- the animated particle canvas creates the signature dark-space aesthetic, and view transitions make navigation feel like a modern SPA.

Output: Layout.astro gains ClientRouter and transition-safe theme script. New ParticleCanvas.astro component. Home page hero displays animated particles behind heading text.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visual-effects-quantum-explorer/06-RESEARCH.md
@src/layouts/Layout.astro
@src/pages/index.astro
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ClientRouter to Layout and create ParticleCanvas component</name>
  <files>src/layouts/Layout.astro, src/components/ParticleCanvas.astro</files>
  <action>
**Layout.astro changes:**

1. Import `{ ClientRouter }` from `'astro:transitions'` in the frontmatter.
2. Add `<ClientRouter />` inside `<head>`, after the charset/viewport meta tags but before SEOHead.
3. Update the existing theme detection `<script is:inline>` to ALSO register an `astro:after-swap` listener so theme class reapplies when ClientRouter swaps the DOM. The pattern:
```javascript
(function() {
  function applyTheme() {
    const stored = localStorage.getItem('theme');
    if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }
  applyTheme();
  document.addEventListener('astro:after-swap', applyTheme);
})();
```
This is safe to call multiple times because `is:inline` scripts re-execute on each navigation, but `addEventListener` on `astro:after-swap` is idempotent for this usage since the script re-runs each time anyway (the old listener is garbage collected when the old script element is removed from the DOM).

**ParticleCanvas.astro (new file):**

Create `src/components/ParticleCanvas.astro` as a self-contained Astro component with:

1. A `<div>` container with `id="particle-container"` using classes: `absolute inset-0 -z-10`. Apply a radial gradient background via `<style>` so there's always a visual backdrop (gradient fallback for reduced-motion).

2. A `<canvas id="particle-canvas">` inside the container.

3. A `<style>` block:
   - `.particle-container` gets `background: radial-gradient(ellipse at 50% 0%, var(--color-surface-alt) 0%, var(--color-surface) 70%)`.
   - `@media (prefers-reduced-motion: reduce)` hides the canvas with `display: none`.

4. A `<script is:inline>` block implementing the particle system EXACTLY as specified in 06-RESEARCH.md Pattern 1:
   - IIFE wrapping everything.
   - First line: bail out if `window.matchMedia('(prefers-reduced-motion: reduce)').matches`.
   - Get canvas, context (`{ alpha: true }`), container, dpr.
   - `getParticleCount()`: returns 30 if container width < 640, 50 if < 1024, 80 otherwise.
   - `resize()`: sets canvas width/height to container dimensions * dpr, CSS dimensions to container dimensions, calls `ctx.scale(dpr, dpr)`.
   - `createParticle(w, h)`: random x, y, size (0.5-2.5), alpha (0.1-0.7), dx/dy (-0.3 to 0.3).
   - `init()`: calls resize, creates particle array.
   - `draw()`: clears canvas, updates positions (wrap-around edges), draws each particle as arc with `rgba(124, 115, 255, alpha)` fill. Calls `requestAnimationFrame(draw)`.
   - `start()`/`stop()`: manage `isRunning` flag and `cancelAnimationFrame`.
   - `visibilitychange` listener: stop on hidden, start on visible.
   - `resize` listener: recalculates canvas size and adjusts particle count.
   - Calls `init()` then `start()`.

Use `is:inline` (not a module script) because this script needs to re-execute if the element is NOT persisted, and the IIFE pattern prevents leaking globals.
  </action>
  <verify>
Run `npm run build` from project root. Verify:
- Build succeeds with no errors.
- `grep -r "ClientRouter" src/layouts/Layout.astro` finds the import and usage.
- File `src/components/ParticleCanvas.astro` exists with canvas, script, and style blocks.
- `grep "astro:after-swap" src/layouts/Layout.astro` confirms theme script update.
  </verify>
  <done>
Layout.astro contains ClientRouter import and component in head, theme script has astro:after-swap listener. ParticleCanvas.astro exists as a self-contained component with canvas rendering, gradient fallback, reduced-motion bail-out, Page Visibility API pause, responsive particle counts, and HiDPI support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ParticleCanvas into home hero and fix typing animation</name>
  <files>src/pages/index.astro</files>
  <action>
**Integrate ParticleCanvas into the hero section:**

1. Import `ParticleCanvas` from `'../components/ParticleCanvas.astro'` in the frontmatter.

2. Wrap the hero `<section>` content in a `<div>` with `class="relative"` and add `transition:persist="particle-hero"` to this wrapper div. This keeps the particle canvas alive when navigating away and back to the home page.

3. Inside this wrapper div, place `<ParticleCanvas />` BEFORE the existing hero content. The particle canvas uses `absolute inset-0 -z-10` so it renders behind the text.

4. Keep all existing hero content (h1, typing role, paragraph, CTA buttons) exactly as they are, just nested inside the relative wrapper.

**Fix the typing animation script to work with ClientRouter:**

The current `<script is:inline>` uses `setInterval` without cleanup. With ClientRouter, navigating away and back re-executes the script, creating duplicate intervals that make text cycle faster.

Replace the existing typing script with:
```javascript
(function() {
  // Guard against double-initialization
  if (window.__typingInterval) {
    clearInterval(window.__typingInterval);
  }
  const roles = ['Cloud-Native Architect', 'Kubernetes Pioneer', 'AI/ML Engineer', 'Platform Builder'];
  let i = 0;
  const el = document.getElementById('typing-role');
  if (el) {
    window.__typingInterval = setInterval(function() {
      i = (i + 1) % roles.length;
      el.textContent = roles[i];
    }, 3000);
  }
})();
```

This clears any previously-set interval before creating a new one, preventing the acceleration bug described in research Pitfall 5.
  </action>
  <verify>
Run `npm run build` -- build succeeds.
Run `npm run dev` and visit `http://localhost:4321/`:
- Canvas particles should animate behind the hero text.
- Navigate to /about/ then back to / -- particles should still render, typing should not accelerate.
- In browser dev tools, set `prefers-reduced-motion: reduce` -- canvas should disappear, gradient remains.
  </verify>
  <done>
Home page hero displays animated particle canvas behind text. Particle container uses transition:persist to survive view transitions. Typing animation has interval cleanup guard preventing double-initialization. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors.
2. Home page at `/` shows animated particle dots floating behind the hero section text.
3. Particles pause when switching browser tabs (check via console logging or observing CPU usage drop).
4. On mobile viewport (< 640px), fewer particles render than on desktop.
5. With `prefers-reduced-motion: reduce` enabled in browser, canvas is hidden and only gradient background shows.
6. Navigating from / to /about/ and back shows smooth view transition (no flash of white/unstyled page).
7. After navigation round-trip, theme (dark/light) is preserved correctly.
8. After navigation round-trip, typing animation runs at normal speed (no acceleration).
</verification>

<success_criteria>
- ClientRouter provides smooth page transitions across all navigation paths
- Particle canvas renders on home hero with dark-space aesthetic
- Particles are responsive to viewport size (30/50/80 count tiers)
- Particles pause on hidden tab via Page Visibility API
- Reduced-motion users see static gradient, no animation
- Theme persists correctly through view transitions
- Typing animation does not double-fire after view transition navigation
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-effects-quantum-explorer/06-01-SUMMARY.md`
</output>
