---
phase: 36-results-panel-dependency-graph
plan: 02
type: execute
wave: 2
depends_on:
  - 36-01
files_modified:
  - src/lib/tools/compose-validator/graph-data-extractor.ts
  - src/components/tools/compose-results/ServiceNode.tsx
  - src/components/tools/compose-results/DependencyEdge.tsx
  - src/components/tools/compose-results/DependencyGraph.tsx
  - src/components/tools/ComposeResultsPanel.tsx
autonomous: true
requirements:
  - GRAPH-01
  - GRAPH-02
  - GRAPH-03
  - GRAPH-04
  - GRAPH-05
  - GRAPH-06
  - GRAPH-07

must_haves:
  truths:
    - "Dependency graph renders service nodes with names, images, and port summaries"
    - "Directed edges connect services based on depends_on relationships with condition labels"
    - "Circular dependencies are highlighted with red edges"
    - "Graph supports zoom, pan, and drag interactions"
    - "Network membership is indicated by node border color"
    - "React Flow is lazy-loaded -- graph bundle only loads when user clicks the Graph tab"
    - "Lighthouse Performance stays at 90+ with React Flow deferred"
  artifacts:
    - path: "src/lib/tools/compose-validator/graph-data-extractor.ts"
      provides: "Extracts image, port, and network metadata from parsed compose JSON for graph nodes"
      exports: ["extractServiceMetadata", "EnrichedServiceNode"]
    - path: "src/components/tools/compose-results/ServiceNode.tsx"
      provides: "Custom React Flow node displaying service name, image, ports, and network color"
      min_lines: 25
    - path: "src/components/tools/compose-results/DependencyEdge.tsx"
      provides: "Custom React Flow edge with condition labels and cycle highlighting"
      min_lines: 30
    - path: "src/components/tools/compose-results/DependencyGraph.tsx"
      provides: "Complete React Flow graph with dagre layout, cycle-safe positioning, controls, dark theme"
      min_lines: 80
    - path: "src/components/tools/ComposeResultsPanel.tsx"
      provides: "Updated with React.lazy import for DependencyGraph and Suspense wrapper"
      contains: "React.lazy"
  key_links:
    - from: "src/components/tools/compose-results/DependencyGraph.tsx"
      to: "src/lib/tools/compose-validator/graph-builder.ts"
      via: "buildDependencyGraph + detectCycles"
      pattern: "buildDependencyGraph|detectCycles"
    - from: "src/components/tools/compose-results/DependencyGraph.tsx"
      to: "src/lib/tools/compose-validator/graph-data-extractor.ts"
      via: "extractServiceMetadata for node enrichment"
      pattern: "extractServiceMetadata"
    - from: "src/components/tools/compose-results/DependencyGraph.tsx"
      to: "@xyflow/react"
      via: "ReactFlow component with nodeTypes and edgeTypes"
      pattern: "ReactFlow|nodeTypes|edgeTypes"
    - from: "src/components/tools/ComposeResultsPanel.tsx"
      to: "src/components/tools/compose-results/DependencyGraph.tsx"
      via: "React.lazy dynamic import"
      pattern: "lazy\\(.*DependencyGraph"
    - from: "src/components/tools/compose-results/DependencyGraph.tsx"
      to: "@dagrejs/dagre"
      via: "dagre.layout for node positioning"
      pattern: "dagre\\.layout"
---

<objective>
Build the interactive service dependency graph using React Flow with dagre layout, custom service nodes, condition-labeled edges, cycle highlighting, and network color-coding -- all lazy-loaded for Lighthouse 90+ performance.

Purpose: Users need to visualize their Docker Compose service architecture, see dependency relationships, and identify circular dependencies at a glance.
Output: Fully interactive dependency graph in the Graph tab with lazy loading, custom nodes/edges, and dark theme integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-results-panel-dependency-graph/36-RESEARCH.md
@.planning/phases/36-results-panel-dependency-graph/36-01-SUMMARY.md

@src/components/tools/ComposeResultsPanel.tsx
@src/components/tools/compose-results/GraphSkeleton.tsx
@src/lib/tools/compose-validator/graph-builder.ts
@src/lib/tools/compose-validator/types.ts
@src/stores/composeValidatorStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Flow + dagre and create graph data extractor and custom node/edge components</name>
  <files>
    src/lib/tools/compose-validator/graph-data-extractor.ts
    src/components/tools/compose-results/ServiceNode.tsx
    src/components/tools/compose-results/DependencyEdge.tsx
  </files>
  <action>
**Install dependencies:**
```bash
npm install @xyflow/react @dagrejs/dagre
```
Note: `@xyflow/react` 12.x (NOT the old `reactflow` package). `@dagrejs/dagre` 2.x (NOT the unmaintained `dagre` package).

**1. graph-data-extractor.ts** -- New utility at `src/lib/tools/compose-validator/graph-data-extractor.ts`.

Export an `EnrichedServiceNode` interface:
```typescript
export interface EnrichedServiceNode {
  name: string;
  image?: string;
  portSummary?: string;  // e.g., "8080:80, 3000:3000"
  networks: string[];
}
```

Export `extractServiceMetadata(json: Record<string, unknown>): Map<string, EnrichedServiceNode>`.
- Read `json.services` as `Record<string, any>`
- For each service: extract `image` (string), `ports` (array -> join first 3 as comma-separated strings), and `networks` (array of strings or object keys)
- Handle both array-form networks (`networks: [frontend, backend]`) and map-form (`networks: { frontend: { aliases: [...] } }`)
- Return Map keyed by service name

**2. ServiceNode.tsx** -- Custom React Flow node component.

Import `Handle`, `Position`, `type NodeProps`, `type Node` from `@xyflow/react`.

Define `ServiceNodeData` type:
```typescript
type ServiceNodeData = {
  label: string;
  image?: string;
  ports?: string;
  networks?: string[];
  networkColor?: string;
};
```

Render a styled div matching the Quantum Explorer dark theme:
- Container: `px-3 py-2 rounded-lg border text-sm min-w-[180px]` with `borderColor` from `data.networkColor` (falls back to `var(--color-border)`), `backgroundColor: var(--color-surface-alt, rgba(0,0,0,0.4))`
- Service name in bold (`font-bold text-[var(--color-text-primary)]`)
- Image name below in secondary text, truncated (`text-xs text-[var(--color-text-secondary)] truncate`)
- Port summary in accent color (`text-xs text-[var(--color-accent)]`)
- Top `Handle` (type="target") and bottom `Handle` (type="source")

Export as default function and also export the ServiceNodeData type.

**3. DependencyEdge.tsx** -- Custom React Flow edge with condition labels and cycle highlighting.

Import `BaseEdge`, `EdgeLabelRenderer`, `getSmoothStepPath`, `type EdgeProps`, `type Edge` from `@xyflow/react`.

Define `DependencyEdgeData` type:
```typescript
type DependencyEdgeData = {
  condition?: string;
  isCycle?: boolean;
};
```

Use `getSmoothStepPath` for edge routing (provides cleaner look than bezier for DAG layouts).

Style:
- Normal edges: `stroke: var(--color-border)` (or `rgba(255,255,255,0.2)`), `strokeWidth: 1.5`
- Cycle edges: `stroke: #ef4444` (red), `strokeWidth: 2.5`
- Condition label (when present): positioned via `EdgeLabelRenderer` at `(labelX, labelY)` with absolute positioning + translate transform. Styled as `text-xs px-1.5 py-0.5 rounded bg-[var(--color-surface)] border border-[var(--color-border)] text-[var(--color-text-secondary)]`

Export as default function and also export DependencyEdgeData type.
  </action>
  <verify>
Run `npx tsc --noEmit` -- all new files plus the installed packages compile. Verify `@xyflow/react` and `@dagrejs/dagre` appear in package.json dependencies. Verify `ls src/components/tools/compose-results/` shows ServiceNode.tsx and DependencyEdge.tsx. Verify `ls src/lib/tools/compose-validator/graph-data-extractor.ts` exists.
  </verify>
  <done>
@xyflow/react and @dagrejs/dagre installed. graph-data-extractor.ts extracts image, port, and network metadata from compose JSON. ServiceNode renders service name/image/ports with network border color. DependencyEdge renders smooth-step edges with condition labels and red cycle highlighting. All files compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DependencyGraph component with dagre layout and wire into ComposeResultsPanel via lazy loading</name>
  <files>
    src/components/tools/compose-results/DependencyGraph.tsx
    src/components/tools/ComposeResultsPanel.tsx
  </files>
  <action>
**1. DependencyGraph.tsx** -- The main graph visualization component at `src/components/tools/compose-results/DependencyGraph.tsx`.

This file MUST import the React Flow CSS inside itself (not globally) so it only loads when this component loads:
```typescript
import '@xyflow/react/dist/style.css';
```

**Module-level constants (OUTSIDE the component function -- critical to avoid re-render issues):**
```typescript
const nodeTypes = { service: ServiceNode };
const edgeTypes = { dependency: DependencyEdge };
```

**Network color palette** -- fixed array of 6-8 distinct colors for network membership:
```typescript
const NETWORK_COLORS = [
  '#3b82f6', '#8b5cf6', '#06b6d4', '#10b981',
  '#f59e0b', '#ec4899', '#6366f1', '#14b8a6',
];
```

Assign colors to networks by order of first appearance. For services in multiple networks, use the first network's color for the border.

**Props:** Accept `result: ComposeAnalysisResult` (from the nanostore -- passed by parent).

The component needs access to the parsed compose JSON to build the graph. Since `ComposeAnalysisResult` does not contain the raw JSON, the component should re-parse the compose YAML from the editor. Read the YAML content from `composeEditorViewRef.get()?.state.doc.toString()`, then call `parseComposeYaml(content)` to get `services` and `json`. This avoids modifying the nanostore type.

Alternatively (simpler): Accept `yamlContent: string` as a prop from ComposeResultsPanel, which reads it from the editor view. Choose the simpler approach.

**Graph building flow:**
1. Parse YAML: `const parseResult = parseComposeYaml(yamlContent)`
2. Build graph: `const graph = buildDependencyGraph(parseResult.services)`
3. Detect cycles: `const { cycleParticipants } = detectCycles(graph)`
4. Extract metadata: `const metadata = extractServiceMetadata(parseResult.json)`
5. Build network color map: iterate all services' networks, assign colors from palette
6. Convert to React Flow nodes/edges (using the pattern from 36-RESEARCH.md code examples)
7. Run cycle-safe dagre layout:
   - Separate cycle edges from normal edges
   - Feed only normal edges + all nodes to dagre
   - `rankdir: 'TB'`, `nodesep: 60`, `ranksep: 100`
   - NODE_WIDTH = 220, NODE_HEIGHT = 80
   - After dagre.layout(), center nodes by subtracting half width/height
   - Re-combine cycle edges with normal edges

**Memoize** the layout computation with `useMemo` keyed on `yamlContent` (or `result.timestamp` to avoid re-layout when content hasn't changed).

**Render:**
```tsx
<div className="compose-graph w-full h-full min-h-[400px]">
  <ReactFlow
    nodes={layoutedNodes}
    edges={layoutedEdges}
    nodeTypes={nodeTypes}
    edgeTypes={edgeTypes}
    fitView
    proOptions={{ hideAttribution: true }}
  >
    <Controls />
    <Background variant={BackgroundVariant.Dots} gap={16} size={1} color="rgba(255,255,255,0.05)" />
  </ReactFlow>
</div>
```

**CSS theme overrides** -- add a `<style>` tag or use inline styles/CSS module to override React Flow defaults for dark theme:
```css
.compose-graph .react-flow {
  --xy-background-color: transparent;
  --xy-node-color: var(--color-text-primary);
  --xy-edge-stroke: rgba(255, 255, 255, 0.2);
  --xy-edge-stroke-selected: var(--color-accent);
  --xy-attribution-background-color: transparent;
}
.compose-graph .react-flow__controls button {
  background-color: var(--color-surface, #1a1a2e);
  border-color: var(--color-border, rgba(255,255,255,0.1));
  color: var(--color-text-primary);
  fill: var(--color-text-primary);
}
.compose-graph .react-flow__controls button:hover {
  background-color: rgba(255, 255, 255, 0.05);
}
```

Use a `<style>` JSX tag inside the component (React supports this) or create the styles as a string injected via useEffect into a style element. The simplest approach: put the CSS in a companion `dependency-graph.css` file imported alongside the React Flow CSS, both inside this lazy-loaded module.

**Handle empty graph:** If no services exist or graph has 0 nodes, show a centered message: "No services found in the compose file."

**Handle cycle indicator:** If `hasCycle`, show a small warning banner above the graph: "Circular dependency detected" with a red icon.

**2. Update ComposeResultsPanel.tsx** -- Wire in the lazy-loaded graph.

At the top of ComposeResultsPanel.tsx, add:
```typescript
import { lazy, Suspense } from 'react';
const LazyDependencyGraph = lazy(() => import('./compose-results/DependencyGraph'));
```

In the graph tab content section, replace the placeholder GraphSkeleton with:
```tsx
{activeTab === 'graph' && (
  result ? (
    <Suspense fallback={<GraphSkeleton />}>
      <LazyDependencyGraph result={result} yamlContent={yamlContent} />
    </Suspense>
  ) : (
    <div className="flex items-center justify-center h-full min-h-[400px]">
      <p className="text-[var(--color-text-secondary)]">
        Run analysis first to see the dependency graph
      </p>
    </div>
  )
)}
```

To get `yamlContent`, read from the editor view:
```typescript
const editorView = composeEditorViewRef.get();
const yamlContent = editorView?.state.doc.toString() ?? '';
```

This should be read inside a useMemo or just inline when rendering (it's a cheap read from the already-mounted editor view).
  </action>
  <verify>
1. `npx tsc --noEmit` -- all files compile
2. `npm run build` -- Astro builds successfully (React Flow is code-split into a separate chunk)
3. In dev server (`npm run dev`):
   a. Navigate to /tools/compose-validator/
   b. Click Analyze with the sample compose file
   c. Click the "Dependency Graph" tab
   d. Verify: service nodes appear with names, images, and port info (GRAPH-02)
   e. Verify: edges connect services with condition labels visible (GRAPH-03)
   f. Verify: if sample has circular depends_on, cycle edges are red (GRAPH-04)
   g. Verify: services in different networks have different border colors (GRAPH-05)
   h. Verify: zoom (scroll wheel), pan (drag background), drag nodes work (GRAPH-06)
4. Check build output for code splitting: the React Flow chunk should be a separate JS file (grep dist/ for "xyflow" or check network tab -- graph JS should not load until Graph tab is clicked) (GRAPH-07)
  </verify>
  <done>
DependencyGraph component renders an interactive service graph with dagre layout, custom ServiceNode components showing name/image/ports, DependencyEdge components with condition labels, red cycle highlighting, network color-coding, zoom/pan/drag controls, and dark theme integration. React Flow is lazy-loaded via React.lazy + Suspense -- the graph chunk only downloads when the user clicks the Graph tab. All 7 GRAPH requirements (GRAPH-01 through GRAPH-07) met.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully with code-split React Flow chunk
3. Navigate to /tools/compose-validator/ -- initial page load does NOT download React Flow JS
4. Click Analyze -> Click "Dependency Graph" tab -> React Flow chunk downloads -> graph renders
5. Service nodes show name, image, and ports (GRAPH-02)
6. Edges show condition labels like "service_healthy" (GRAPH-03)
7. Cycle edges appear red if circular dependencies exist (GRAPH-04)
8. Network membership reflected in node border colors (GRAPH-05)
9. Zoom, pan, and drag all functional (GRAPH-06)
10. Lighthouse Performance audit on /tools/compose-validator/ scores 90+ (GRAPH-07)
</verification>

<success_criteria>
- @xyflow/react and @dagrejs/dagre installed and working
- All 7 GRAPH requirements implemented (GRAPH-01 through GRAPH-07)
- React Flow lazy-loaded -- not in initial bundle
- Graph renders with correct dagre layout, handles cycles safely
- Dark theme integration matches site aesthetic
- Build succeeds with code-split output
</success_criteria>

<output>
After completion, create `.planning/phases/36-results-panel-dependency-graph/36-02-SUMMARY.md`
</output>
