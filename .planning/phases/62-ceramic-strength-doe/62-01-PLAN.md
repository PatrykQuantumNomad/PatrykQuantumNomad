---
phase: 62-ceramic-strength-doe
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/eda/svg-generators/bihistogram.ts
  - src/lib/eda/svg-generators/doe-mean-plot.ts
  - src/lib/eda/svg-generators/block-plot.ts
  - src/lib/eda/svg-generators/interaction-plot.ts
  - src/lib/eda/svg-generators/index.ts
  - src/components/eda/CeramicStrengthPlots.astro
  - src/data/eda/pages/case-studies/ceramic-strength.mdx
autonomous: true
requirements: [CER-01, CER-02, CER-03]

must_haves:
  truths:
    - "Response Variable Analysis section has H2 heading with 5 named H3 plot subsections (4-Plot, Run Sequence, Lag, Histogram, Normal Probability)"
    - "Batch Effect Analysis section has individually named subsections: Bihistogram, Batch Box Plot, Batch Block Plots, Batch Statistical Tests"
    - "Lab Effect Analysis section has individually named subsections: Lab Box Plot, Lab Box Plot by Batch, Lab Statistical Tests"
    - "Lab Statistical Tests subsection contains a one-way ANOVA F-test comparing lab means with F-statistic, degrees of freedom, critical value, and conclusion confirming labs are homogeneous"
    - "Bihistogram SVG renders two back-to-back histograms on shared x-axis for Batch 1 vs Batch 2"
    - "Block plot SVG renders batch means by lab showing consistent batch effect across all 8 labs"
    - "Lab box plots render 8-group box plots for all data, Batch 1 only, and Batch 2 only"
  artifacts:
    - path: "src/lib/eda/svg-generators/bihistogram.ts"
      provides: "Back-to-back histogram generator"
      contains: "generateBihistogram"
    - path: "src/lib/eda/svg-generators/doe-mean-plot.ts"
      provides: "DOE mean/SD plot generator with multi-panel layout"
      contains: "generateDoeMeanPlot"
    - path: "src/lib/eda/svg-generators/block-plot.ts"
      provides: "Block plot generator showing means by block and group"
      contains: "generateBlockPlot"
    - path: "src/lib/eda/svg-generators/interaction-plot.ts"
      provides: "Interaction plot generator for factor interactions"
      contains: "generateInteractionPlot"
    - path: "src/lib/eda/svg-generators/index.ts"
      provides: "Barrel exports for all 4 new generators"
      contains: "generateBihistogram"
    - path: "src/components/eda/CeramicStrengthPlots.astro"
      provides: "Extended PlotType union with batch-bihistogram, batch-block-plot, lab-box-plot, lab-box-plot-batch1, lab-box-plot-batch2 and DOE types"
      contains: "batch-bihistogram"
    - path: "src/data/eda/pages/case-studies/ceramic-strength.mdx"
      provides: "Restructured MDX with DOE Variation template headings and component calls for Response Variable, Batch Effect, Lab Effect sections including Lab Statistical Tests"
      contains: "## Response Variable Analysis"
  key_links:
    - from: "src/lib/eda/svg-generators/bihistogram.ts"
      to: "src/lib/eda/svg-generators/plot-base.ts"
      via: "import shared SVG utilities"
      pattern: "import.*plot-base"
    - from: "src/lib/eda/svg-generators/index.ts"
      to: "src/lib/eda/svg-generators/bihistogram.ts"
      via: "barrel export"
      pattern: "export.*generateBihistogram.*bihistogram"
    - from: "src/components/eda/CeramicStrengthPlots.astro"
      to: "src/lib/eda/svg-generators/index.ts"
      via: "import new generators"
      pattern: "import.*generateBihistogram.*index"
    - from: "src/data/eda/pages/case-studies/ceramic-strength.mdx"
      to: "src/components/eda/CeramicStrengthPlots.astro"
      via: "component calls for new plot types"
      pattern: "CeramicStrengthPlots type=\"batch-bihistogram\""
---

<objective>
Create 4 new DOE-specific SVG generators (bihistogram, DOE mean plot, block plot, interaction plot), restructure the Ceramic Strength MDX to the DOE Variation canonical template, and wire all Response Variable, Batch Effect, and Lab Effect plot subsections with component calls.

Purpose: CER-01 requires renaming to "Response Variable Analysis" with named subsections. CER-02 requires batch-specific plots including bihistogram and block plots. CER-03 requires lab-specific box plots AND statistical tests comparing labs. This plan handles all engineering (4 new generators) and restructures the first 3 analysis sections of the DOE template.

Output: 4 new SVG generator files, updated barrel exports, extended CeramicStrengthPlots component, restructured ceramic-strength.mdx with DOE template headings
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-ceramic-strength-doe/62-RESEARCH.md
@src/data/eda/pages/case-studies/ceramic-strength.mdx
@src/components/eda/CeramicStrengthPlots.astro
@src/lib/eda/svg-generators/plot-base.ts
@src/lib/eda/svg-generators/index.ts
@src/lib/eda/svg-generators/histogram.ts
@src/lib/eda/svg-generators/bar-plot.ts
@src/data/eda/datasets.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/eda/svg-generators/plot-base.ts:
```typescript
export const PALETTE = {
  text: 'var(--color-text-primary)',
  textSecondary: 'var(--color-text-secondary)',
  axis: 'var(--color-text-secondary)',
  grid: 'var(--color-border)',
  dataPrimary: 'var(--color-accent)',
  dataSecondary: 'var(--color-accent-secondary)',
  dataTertiary: 'var(--color-gradient-end)',
  surface: 'var(--color-surface)',
  surfaceAlt: 'var(--color-surface-alt)',
};

export interface PlotConfig {
  width: number; height: number;
  margin: { top: number; right: number; bottom: number; left: number };
  title?: string; xLabel?: string; yLabel?: string; fontFamily?: string;
}

export const DEFAULT_CONFIG: PlotConfig;
export function innerDimensions(config: PlotConfig): { innerWidth: number; innerHeight: number };
export function svgOpen(config: PlotConfig, ariaLabel: string): string;
export function gridLinesH(yTicks: number[], yScale: (v: number) => number, xStart: number, xEnd: number): string;
export function gridLinesV(xTicks: number[], xScale: (v: number) => number, yStart: number, yEnd: number): string;
export function xAxis(ticks: number[], scale: (v: number) => number, y: number, label: string, config: PlotConfig, formatter?: (v: number) => string): string;
export function yAxis(ticks: number[], scale: (v: number) => number, x: number, label: string, config: PlotConfig, formatter?: (v: number) => string): string;
export function titleText(config: PlotConfig, title: string): string;
```

From src/data/eda/datasets.ts:
```typescript
export interface CeramicStrengthObs {
  id: number;
  lab: number;          // 1-8
  strength: number;     // flexural strength
  tableSpeed: -1 | 1;   // X1 factor
  downFeed: -1 | 1;     // X2 factor
  wheelGrit: -1 | 1;    // X3 factor
  batch: 1 | 2;         // nuisance factor
  rep: 1 | 2;           // replication
}
export const ceramicStrength: CeramicStrengthObs[];
```

From src/components/eda/CeramicStrengthPlots.astro (current PlotType):
```typescript
type PlotType =
  | '4-plot' | 'run-sequence' | 'lag' | 'histogram' | 'probability'
  | 'batch-box-plot' | 'batch1-histogram' | 'batch2-histogram';
```

From src/lib/eda/svg-generators/index.ts (current exports):
```typescript
export { generateHistogram, type HistogramOptions } from './histogram';
export { generateBoxPlot, type BoxPlotOptions } from './box-plot';
export { generateBarPlot, type BarPlotOptions } from './bar-plot';
// ... 13 generators total. New generators must be added here.
```

From src/lib/eda/math/statistics.ts (relevant functions for ANOVA computation):
```typescript
export function mean(data: number[]): number;
export function fQuantile(p: number, df1: number, df2: number): number;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 4 new DOE-specific SVG generators and export from index.ts</name>
  <files>
    src/lib/eda/svg-generators/bihistogram.ts
    src/lib/eda/svg-generators/doe-mean-plot.ts
    src/lib/eda/svg-generators/block-plot.ts
    src/lib/eda/svg-generators/interaction-plot.ts
    src/lib/eda/svg-generators/index.ts
  </files>
  <action>
Create 4 new SVG generator files following the established pattern in plot-base.ts, histogram.ts, and bar-plot.ts. Each generator must import from `./plot-base` and use the shared PALETTE, config, axis, grid, and title utilities. Keep each generator under 150 lines per the research guidance. All generators produce static SVG strings at build time with no client-side JS.

**File 1: src/lib/eda/svg-generators/bihistogram.ts**

Create a back-to-back histogram generator. Two histograms share the same x-axis domain and bin edges: the top histogram bars extend UPWARD from a center dividing line, the bottom histogram bars extend DOWNWARD.

```typescript
export interface BihistogramOptions {
  topData: number[];
  bottomData: number[];
  topLabel: string;
  bottomLabel: string;
  binCount?: number;
  config?: Partial<PlotConfig>;
  title?: string;
  xLabel?: string;
}

export function generateBihistogram(options: BihistogramOptions): string
```

Key implementation details:
- Compute shared x-domain from `[...topData, ...bottomData]` using d3 `extent`
- Use d3 `bin()` with shared domain and thresholds for BOTH datasets so bars align vertically
- Center dividing line at `margin.top + innerHeight / 2`
- Top bars: fill with `PALETTE.dataPrimary`, opacity 0.7, grow upward from center
- Bottom bars: fill with `PALETTE.dataSecondary`, opacity 0.7, grow downward from center
- Y-axis shows frequency counts (positive both directions from center)
- Add text labels for topLabel and bottomLabel near the center line (left side, one above center, one below)
- Use `gridLinesH` for horizontal grid lines in both halves
- Use shared `xAxis` at the bottom, `titleText` at the top
- CRITICAL: The y-scale must be shared -- use `Math.max()` across both bin arrays to determine the maximum frequency, so both halves use the same scale for fair comparison

**File 2: src/lib/eda/svg-generators/doe-mean-plot.ts**

Create a DOE mean plot generator. Shows group means for each factor level as connected points with a dashed grand mean reference line. Supports multi-panel layout (one panel per factor, side by side).

```typescript
export interface DoeMeanPlotOptions {
  factors: {
    name: string;
    levels: { label: string; value: number }[];  // value = mean or SD
  }[];
  grandMean: number;      // dashed reference line
  config?: Partial<PlotConfig>;
  title?: string;
  yLabel?: string;
}

export function generateDoeMeanPlot(options: DoeMeanPlotOptions): string
```

Key implementation details:
- Divide innerWidth into equal panels, one per factor (typically 3 factors = 3 panels)
- Each panel has its own x-axis band for factor levels but ALL panels share the same y-axis scale
- The y-axis domain should be focused on the range of means with ~10% padding (NOT the full data range 300-820, which would flatten the lines -- see Pitfall 4 in research)
- Within each panel: plot points at each factor level's mean, connect with a line using `PALETTE.dataPrimary`
- Draw a dashed horizontal line at grandMean across all panels using `PALETTE.dataSecondary`
- Label each panel with the factor name below its x-axis area
- Steeper lines = larger effect (this is the visual interpretation)
- Use `yAxis` on the far left only, `gridLinesH` across full width, `titleText` at top
- Points: circles r=5, filled with `PALETTE.dataPrimary`
- Lines: stroke `PALETTE.dataPrimary`, stroke-width 2

**File 3: src/lib/eda/svg-generators/block-plot.ts**

Create a block plot generator. Shows mean response for each block (e.g., lab) with separate symbols/colors for each group (e.g., batch).

```typescript
export interface BlockPlotOptions {
  blocks: {
    label: string;  // e.g., "Lab 1"
    values: { group: string; mean: number }[];  // e.g., [{group: "Batch 1", mean: 695}, {group: "Batch 2", mean: 615}]
  }[];
  config?: Partial<PlotConfig>;
  title?: string;
  xLabel?: string;
  yLabel?: string;
}

export function generateBlockPlot(options: BlockPlotOptions): string
```

Key implementation details:
- X-axis: block labels (use `scaleBand` from d3-scale)
- Y-axis: mean response (use `scaleLinear` from d3-scale, domain from extent of all means with padding)
- For each block: plot a point for each group at the block's x-position
- Connect same-group points across blocks with lines (one line per group)
- Use `PALETTE.dataPrimary` for first group, `PALETTE.dataSecondary` for second group
- Points: circles r=4, filled
- Add a legend in the upper-right corner showing group colors/labels
- Use `xAxis`, `yAxis`, `gridLinesH`, `titleText` from plot-base

**File 4: src/lib/eda/svg-generators/interaction-plot.ts**

Create an interaction plot generator. Shows mean response at each level of Factor A, with separate lines for each level of Factor B. Non-parallel lines indicate interaction.

```typescript
export interface InteractionPlotOptions {
  factorA: { label: string; levels: string[] };   // x-axis factor
  factorB: { label: string; levels: string[] };   // separate lines
  means: { aLevel: string; bLevel: string; mean: number }[];  // 2x2 = 4 means
  config?: Partial<PlotConfig>;
  title?: string;
  yLabel?: string;
}

export function generateInteractionPlot(options: InteractionPlotOptions): string
```

Key implementation details:
- X-axis: Factor A levels (use `scaleBand` or `scalePoint`)
- Y-axis: mean response (focused domain around the means, NOT full data range)
- One line per Factor B level, connecting means across Factor A levels
- Use `PALETTE.dataPrimary` for first Factor B level, `PALETTE.dataSecondary` for second
- Points: circles r=5, filled
- Lines: stroke-width 2
- If lines cross or diverge strongly, this visually shows interaction
- Add legend showing Factor B level labels and colors
- Use plot-base utilities for axes, grid, title

**File 5: Update src/lib/eda/svg-generators/index.ts**

Add barrel exports for all 4 new generators at the end of the chart generators section (before the shared types section):

```typescript
export { generateBihistogram, type BihistogramOptions } from './bihistogram';
export { generateDoeMeanPlot, type DoeMeanPlotOptions } from './doe-mean-plot';
export { generateBlockPlot, type BlockPlotOptions } from './block-plot';
export { generateInteractionPlot, type InteractionPlotOptions } from './interaction-plot';
```

IMPORTANT ANTI-PATTERNS TO AVOID:
- Do NOT use the standard template structure (no "## Test Underlying Assumptions" or "### Goals" -- this is a DOE case study)
- Do NOT build overly complex generators -- NIST plots are basic points+lines+labels. Each file should be under 150 lines.
- Do NOT use `extent(allData)` for DOE mean plot y-axis -- use `extent(means)` with padding so effect differences are visible
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx astro check 2>&1 | tail -5</automated>
  </verify>
  <done>
- bihistogram.ts exists and exports `generateBihistogram`
- doe-mean-plot.ts exists and exports `generateDoeMeanPlot`
- block-plot.ts exists and exports `generateBlockPlot`
- interaction-plot.ts exists and exports `generateInteractionPlot`
- index.ts exports all 4 new generators (17 total generators now)
- All generators import from `./plot-base` and use shared utilities
- Each generator file is under 150 lines
- `npx astro check` reports 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure MDX to DOE template and wire Response Variable, Batch Effect, and Lab Effect plot subsections</name>
  <files>
    src/components/eda/CeramicStrengthPlots.astro
    src/data/eda/pages/case-studies/ceramic-strength.mdx
  </files>
  <action>
**Step 1: Extend CeramicStrengthPlots.astro with all new plot types**

1a. Add imports for new generators at the top (after existing imports):
```typescript
import {
  generateBihistogram,
  generateBlockPlot,
  generateDoeMeanPlot,
  generateInteractionPlot,
} from '../../lib/eda/svg-generators/index';
import { mean, fQuantile } from '../../lib/eda/math/statistics';
```

1b. Extend the PlotType union with all new types:
```typescript
type PlotType =
  // Existing:
  | '4-plot' | 'run-sequence' | 'lag' | 'histogram' | 'probability'
  | 'batch-box-plot' | 'batch1-histogram' | 'batch2-histogram'
  // New for Batch Effect (CER-02):
  | 'batch-bihistogram'
  | 'batch-block-plot'
  // New for Lab Effect (CER-03):
  | 'lab-box-plot'
  | 'lab-box-plot-batch1'
  | 'lab-box-plot-batch2'
  // New for Primary Factors (CER-04) -- wired here, MDX subsections in Plan 02:
  | 'doe-mean-batch1'
  | 'doe-mean-batch2'
  | 'doe-sd-batch1'
  | 'doe-sd-batch2'
  | 'interaction-batch1-x1x3'
  | 'interaction-batch2-x1x3';
```

1c. Compute group data needed for all new plot types. Add this AFTER the existing `const batch2 = ...` line:

```typescript
// Lab-grouped data
const labs = [1, 2, 3, 4, 5, 6, 7, 8];

// For lab box plots
const labGroups = labs.map(lab => ({
  label: `Lab ${lab}`,
  values: ceramicStrength.filter(d => d.lab === lab).map(d => d.strength),
}));
const labGroupsBatch1 = labs.map(lab => ({
  label: `Lab ${lab}`,
  values: ceramicStrength.filter(d => d.lab === lab && d.batch === 1).map(d => d.strength),
}));
const labGroupsBatch2 = labs.map(lab => ({
  label: `Lab ${lab}`,
  values: ceramicStrength.filter(d => d.lab === lab && d.batch === 2).map(d => d.strength),
}));

// For block plot: batch means by lab
const labBatchMeans = labs.map(lab => ({
  label: `Lab ${lab}`,
  values: [
    { group: 'Batch 1', mean: mean(ceramicStrength.filter(d => d.lab === lab && d.batch === 1).map(d => d.strength)) },
    { group: 'Batch 2', mean: mean(ceramicStrength.filter(d => d.lab === lab && d.batch === 2).map(d => d.strength)) },
  ],
}));

// --- Lab ANOVA computation (CER-03: lab statistical tests) ---
// One-way ANOVA comparing lab means across all 8 labs
const allStrength = ceramicStrength.map(d => d.strength);
const grandMean = mean(allStrength);
const N = allStrength.length; // 480
const k = 8; // number of labs

// Between-group sum of squares: SSB = sum_j(n_j * (mean_j - grandMean)^2)
const labMeans = labs.map(lab => {
  const vals = ceramicStrength.filter(d => d.lab === lab).map(d => d.strength);
  return { lab, mean: mean(vals), n: vals.length };
});
const SSB = labMeans.reduce((sum, lm) => sum + lm.n * (lm.mean - grandMean) ** 2, 0);

// Within-group sum of squares: SSW = sum_j sum_i (x_ij - mean_j)^2
const SSW = labs.reduce((sum, lab) => {
  const vals = ceramicStrength.filter(d => d.lab === lab).map(d => d.strength);
  const labMean = mean(vals);
  return sum + vals.reduce((s, v) => s + (v - labMean) ** 2, 0);
}, 0);

const dfBetween = k - 1;       // 7
const dfWithin = N - k;         // 472
const MSB = SSB / dfBetween;
const MSW = SSW / dfWithin;
const labFStatistic = MSB / MSW;
const labFCritical = fQuantile(0.95, dfBetween, dfWithin);
const labAnovaReject = labFStatistic > labFCritical;
// Expected result: F is small (labs are homogeneous), fail to reject H0
```

IMPORTANT: Export these ANOVA values so they can be referenced. Add them to an exported object or make them available as template variables. The MDX will reference the computed values via `<InlineMath>` with the actual numbers. The executor should compute the values first (e.g., by temporarily logging them), then hardcode the computed values into the MDX text. Alternatively, if CeramicStrengthPlots.astro can pass computed props, use that pattern.

The simplest approach matching existing patterns: compute the ANOVA in the Astro component frontmatter, then log the values during the first build to get exact numbers. Write those exact numbers into the MDX as `<InlineMath>` expressions. The ANOVA computation code should remain in CeramicStrengthPlots.astro as documentation/verification but the MDX text uses the hardcoded computed values.

1d. Add switch cases for ALL new plot types. For each case, call the appropriate generator with the computed data. Use the singleConfig (720x450) for all single-panel plots, and use a wider config `{ width: 720, height: 400, margin: { top: 35, right: 20, bottom: 55, left: 55 } }` for multi-panel DOE mean/SD plots.

1e. Add default captions for all new plot types to the `defaultCaptions` record:
- `'batch-bihistogram'`: 'Bihistogram comparing Batch 1 (top) and Batch 2 (bottom) ceramic strength distributions. Batch 1 is centered approximately 78 units higher.'
- `'batch-block-plot'`: 'Block plot of mean strength by lab and batch. Batch 1 consistently exceeds Batch 2 across all 8 labs.'
- `'lab-box-plot'`: 'Box plot of ceramic strength by lab (all data pooled). Minor variation in medians across labs compared to the dominant batch effect.'
- `'lab-box-plot-batch1'`: 'Box plot of ceramic strength by lab for Batch 1 only. Median ranges from 650 to 700 across labs.'
- `'lab-box-plot-batch2'`: 'Box plot of ceramic strength by lab for Batch 2 only. Median ranges from 550 to 600 across labs.'
- `'doe-mean-batch1'`: 'DOE mean plot for Batch 1 showing mean strength at each factor level. Table speed (X1) has the steepest slope, indicating the largest effect.'
- `'doe-mean-batch2'`: 'DOE mean plot for Batch 2 showing mean strength at each factor level. Down feed rate (X2) has the steepest slope, indicating the largest effect.'
- `'doe-sd-batch1'`: 'DOE standard deviation plot for Batch 1 showing variability at each factor level.'
- `'doe-sd-batch2'`: 'DOE standard deviation plot for Batch 2 showing variability at each factor level.'
- `'interaction-batch1-x1x3'`: 'Interaction plot for Batch 1: Table Speed (X1) vs Wheel Grit (X3). Non-parallel lines indicate a substantial X1*X3 interaction effect of -20.25.'
- `'interaction-batch2-x1x3'`: 'Interaction plot for Batch 2: Table Speed (X1) vs Wheel Grit (X3). Non-parallel lines indicate an X1*X3 interaction effect of -16.71.'

// For DOE mean plots: factor means by batch
const factorMeansBatch1 = [
  { name: 'Table Speed (X1)', levels: [
    { label: 'Low (-1)', value: mean(batch1.filter(d => d.tableSpeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: mean(batch1.filter(d => d.tableSpeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Down Feed (X2)', levels: [
    { label: 'Low (-1)', value: mean(batch1.filter(d => d.downFeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: mean(batch1.filter(d => d.downFeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Wheel Grit (X3)', levels: [
    { label: '150 (-1)', value: mean(batch1.filter(d => d.wheelGrit === -1).map(d => d.strength)) },
    { label: '80 (+1)', value: mean(batch1.filter(d => d.wheelGrit === 1).map(d => d.strength)) },
  ]},
];
const batch1Mean = mean(batch1.map(d => d.strength));

const factorMeansBatch2 = [
  { name: 'Table Speed (X1)', levels: [
    { label: 'Low (-1)', value: mean(batch2.filter(d => d.tableSpeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: mean(batch2.filter(d => d.tableSpeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Down Feed (X2)', levels: [
    { label: 'Low (-1)', value: mean(batch2.filter(d => d.downFeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: mean(batch2.filter(d => d.downFeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Wheel Grit (X3)', levels: [
    { label: '150 (-1)', value: mean(batch2.filter(d => d.wheelGrit === -1).map(d => d.strength)) },
    { label: '80 (+1)', value: mean(batch2.filter(d => d.wheelGrit === 1).map(d => d.strength)) },
  ]},
];
const batch2Mean = mean(batch2.map(d => d.strength));

// For DOE SD plots: factor standard deviations by batch
const sd = (arr: number[]) => {
  const m = mean(arr);
  return Math.sqrt(arr.reduce((s, v) => s + (v - m) ** 2, 0) / (arr.length - 1));
};

const factorSdBatch1 = [
  { name: 'Table Speed (X1)', levels: [
    { label: 'Low (-1)', value: sd(batch1.filter(d => d.tableSpeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: sd(batch1.filter(d => d.tableSpeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Down Feed (X2)', levels: [
    { label: 'Low (-1)', value: sd(batch1.filter(d => d.downFeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: sd(batch1.filter(d => d.downFeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Wheel Grit (X3)', levels: [
    { label: '150 (-1)', value: sd(batch1.filter(d => d.wheelGrit === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: sd(batch1.filter(d => d.wheelGrit === 1).map(d => d.strength)) },
  ]},
];
const batch1Sd = sd(batch1.map(d => d.strength));

const factorSdBatch2 = [
  { name: 'Table Speed (X1)', levels: [
    { label: 'Low (-1)', value: sd(batch2.filter(d => d.tableSpeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: sd(batch2.filter(d => d.tableSpeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Down Feed (X2)', levels: [
    { label: 'Low (-1)', value: sd(batch2.filter(d => d.downFeed === -1).map(d => d.strength)) },
    { label: 'High (+1)', value: sd(batch2.filter(d => d.downFeed === 1).map(d => d.strength)) },
  ]},
  { name: 'Wheel Grit (X3)', levels: [
    { label: '150 (-1)', value: sd(batch2.filter(d => d.wheelGrit === -1).map(d => d.strength)) },
    { label: '80 (+1)', value: sd(batch2.filter(d => d.wheelGrit === 1).map(d => d.strength)) },
  ]},
];
const batch2Sd = sd(batch2.map(d => d.strength));

// For interaction plots: X1*X3 interaction means by batch
const interactionBatch1X1X3 = {
  factorA: { label: 'Table Speed (X1)', levels: ['Low (-1)', 'High (+1)'] },
  factorB: { label: 'Wheel Grit (X3)', levels: ['150 (-1)', '80 (+1)'] },
  means: [
    { aLevel: 'Low (-1)', bLevel: '150 (-1)', mean: mean(batch1.filter(d => d.tableSpeed === -1 && d.wheelGrit === -1).map(d => d.strength)) },
    { aLevel: 'Low (-1)', bLevel: '80 (+1)', mean: mean(batch1.filter(d => d.tableSpeed === -1 && d.wheelGrit === 1).map(d => d.strength)) },
    { aLevel: 'High (+1)', bLevel: '150 (-1)', mean: mean(batch1.filter(d => d.tableSpeed === 1 && d.wheelGrit === -1).map(d => d.strength)) },
    { aLevel: 'High (+1)', bLevel: '80 (+1)', mean: mean(batch1.filter(d => d.tableSpeed === 1 && d.wheelGrit === 1).map(d => d.strength)) },
  ],
};
const interactionBatch2X1X3 = {
  factorA: { label: 'Table Speed (X1)', levels: ['Low (-1)', 'High (+1)'] },
  factorB: { label: 'Wheel Grit (X3)', levels: ['150 (-1)', '80 (+1)'] },
  means: [
    { aLevel: 'Low (-1)', bLevel: '150 (-1)', mean: mean(batch2.filter(d => d.tableSpeed === -1 && d.wheelGrit === -1).map(d => d.strength)) },
    { aLevel: 'Low (-1)', bLevel: '80 (+1)', mean: mean(batch2.filter(d => d.tableSpeed === -1 && d.wheelGrit === 1).map(d => d.strength)) },
    { aLevel: 'High (+1)', bLevel: '150 (-1)', mean: mean(batch2.filter(d => d.tableSpeed === 1 && d.wheelGrit === -1).map(d => d.strength)) },
    { aLevel: 'High (+1)', bLevel: '80 (+1)', mean: mean(batch2.filter(d => d.tableSpeed === 1 && d.wheelGrit === 1).map(d => d.strength)) },
  ],
};

NOTE: `batch1` and `batch2` are already computed as arrays of CeramicStrengthObs objects:
```typescript
const batch1 = ceramicStrength.filter(d => d.batch === 1);
const batch2 = ceramicStrength.filter(d => d.batch === 2);
```
But the CURRENT code maps to `.map(d => d.strength)` right away. You need to change the existing batch extraction to keep the full objects, then create separate strength arrays:
```typescript
const batch1Data = ceramicStrength.filter(d => d.batch === 1);
const batch2Data = ceramicStrength.filter(d => d.batch === 2);
const batch1 = batch1Data.map(d => d.strength);
const batch2 = batch2Data.map(d => d.strength);
```
Then use `batch1Data` / `batch2Data` for all the filtering above.

**Step 2: Restructure ceramic-strength.mdx to DOE Variation template**

Restructure the MDX headings and add component calls. This is primarily heading reorganization and adding `<CeramicStrengthPlots>` calls to sections that currently only have text.

2a. Rename `## Graphical Output and Interpretation` to `## Response Variable Analysis`. Keep all 5 existing subsections (4-Plot Overview, Run Sequence Plot, Lag Plot, Histogram, Normal Probability Plot) exactly as they are -- they already have component calls and interpretation text. VERIFY: All 5 subsections are already correctly structured with individual component calls. No changes needed inside them.

2b. Restructure `### Batch Effect Analysis` (currently an H3 under the old "Graphical Output" section) into `## Batch Effect Analysis` (promoted to H2). Break it into named H3 subsections:

```mdx
## Batch Effect Analysis

The batch effect is the dominant finding in this case study -- an unexpected difference of approximately 78 units between the two batches.

### Bihistogram

A [bihistogram](/eda/techniques/bihistogram/) comparing Batch 1 and Batch 2 reveals a clear batch effect: Batch 1 responses are centered at approximately 689, while Batch 2 responses are centered at approximately 611. The variability is comparable for both batches, though Batch 1 exhibits lower-tail skewness while Batch 2 shows central skewness. Both batches contain low-lying outlier points.

<CeramicStrengthPlots type="batch-bihistogram" />

### Batch Box Plot

[Box plots](/eda/techniques/box-plot/) by batch confirm the location difference and show multiple outliers on the low side for both batches, with Batch 2 also showing high-side outliers. The quantile-quantile plot comparing batches is not linear -- Batch 1 quantiles consistently exceed Batch 2 (except in the right tail), indicating the batch difference involves more than a simple location shift.

<CeramicStrengthPlots type="batch-box-plot" />

### Batch Block Plots

[Block plots](/eda/techniques/block-plot/) showing mean strength by lab and batch demonstrate that the batch effect is consistent across all 8 labs and all primary factor levels -- Batch 1 means exceed Batch 2 means in every case. This consistency across blocks confirms the batch effect is a genuine material property difference rather than a lab-specific artifact.

<CeramicStrengthPlots type="batch-block-plot" />

### Batch Statistical Tests

[Move the existing F-test and t-test content here verbatim from the current "## Quantitative Output and Interpretation > ### Batch Comparison" section. Keep all tables, formulas, and conclusions exactly as they are. This includes the "#### F-Test for Equal Variances" and "#### Two-Sample t-Test for Equal Means" subsections with all InlineMath values.]
```

IMPORTANT: The F-test and t-test content currently lives under "## Quantitative Output and Interpretation > ### Batch Comparison". MOVE this content (including the "#### F-Test for Equal Variances" and "#### Two-Sample t-Test for Equal Means" sub-subsections) to become "### Batch Statistical Tests" under "## Batch Effect Analysis". This is a DOE-specific reorganization where batch tests belong with the batch analysis, not in a generic "Quantitative Output" section.

2c. Restructure `### Lab Effect Analysis` (currently an H3) into `## Lab Effect Analysis` (promoted to H2). Break into named H3 subsections:

```mdx
## Lab Effect Analysis

### Lab Box Plot

[Box plots](/eda/techniques/box-plot/) by lab show minor variation in medians across the 8 labs, with relatively constant scales. Two labs (3 and 5) show outliers on the low side.

<CeramicStrengthPlots type="lab-box-plot" />

### Lab Box Plot by Batch

When analyzed separately by batch, the lab effects show:

- **Batch 1** -- median strength ranges from 650 to 700 across labs; variability is relatively constant; all labs contain at least one low-side outlier
- **Batch 2** -- median strength ranges from 550 to 600 across labs; there is somewhat more variability across labs compared to Batch 1; six labs show high-side outliers and three show low-side outliers

<CeramicStrengthPlots type="lab-box-plot-batch1" caption="Box plot of ceramic strength by lab for Batch 1. Median ranges from 650 to 700 with relatively constant variability." />

<CeramicStrengthPlots type="lab-box-plot-batch2" caption="Box plot of ceramic strength by lab for Batch 2. Median ranges from 550 to 600 with somewhat more inter-lab variability." />

### Lab Statistical Tests

A [one-factor ANOVA](/eda/quantitative/one-factor-anova/) tests whether the 8 lab means differ significantly.

<div class="my-4 px-4 py-3 rounded-lg bg-[var(--color-surface-alt)] border border-[var(--color-border)] text-center">
  <InlineMath tex="H_0\!: \mu_1 = \mu_2 = \cdots = \mu_8 \quad \text{vs.} \quad H_a\!: \text{at least one } \mu_j \text{ differs}" />
</div>

The one-way ANOVA decomposes total variability into between-lab and within-lab components:

| Source | df | SS | MS | F |
|--------|----|----|----|----|
| Between labs | <InlineMath tex="7" /> | <InlineMath tex="\text{SSB}" /> | <InlineMath tex="\text{MSB}" /> | <InlineMath tex="F" /> |
| Within labs | <InlineMath tex="472" /> | <InlineMath tex="\text{SSW}" /> | <InlineMath tex="\text{MSW}" /> | |
| Total | <InlineMath tex="479" /> | <InlineMath tex="\text{SST}" /> | | |

IMPORTANT: The executor must compute the actual ANOVA values from the dataset at build time. The ANOVA computation is included in CeramicStrengthPlots.astro (Step 1c above). During the first build, temporarily log the computed values (labFStatistic, labFCritical, SSB, SSW, MSB, MSW) to get the exact numbers, then replace the placeholder `\text{SSB}`, `\text{SSW}`, etc. in the ANOVA table with the actual computed values formatted to 2-4 decimal places.

The ANOVA table in the MDX should look like (with actual computed values):

| Source | df | SS | MS | F |
|--------|----|----|----|----|
| Between labs | <InlineMath tex="7" /> | <InlineMath tex="{computed SSB}" /> | <InlineMath tex="{computed MSB}" /> | <InlineMath tex="{computed F}" /> |
| Within labs | <InlineMath tex="472" /> | <InlineMath tex="{computed SSW}" /> | <InlineMath tex="{computed MSW}" /> | |
| Total | <InlineMath tex="479" /> | <InlineMath tex="{computed SST}" /> | | |

| Parameter | Value |
|-----------|-------|
| Test statistic <InlineMath tex="F" /> | {computed value} |
| Numerator df <InlineMath tex="\nu_1" /> | 7 |
| Denominator df <InlineMath tex="\nu_2" /> | 472 |
| Significance level <InlineMath tex="\alpha" /> | 0.05 |
| Critical value <InlineMath tex="F_{0.95,\,7,\,472}" /> | {computed value} |

**Conclusion:** The F-statistic {falls within / exceeds} the critical value. {If F < F_critical:} We **fail to reject** <InlineMath tex="H_0" /> -- the lab means are not significantly different at the 5% level, confirming that the labs can be treated as homogeneous. {If F > F_critical:} We **reject** <InlineMath tex="H_0" /> -- at least one lab mean differs; however, the lab effect remains small relative to the dominant batch effect.

NOTE: Based on the existing MDX text stating "It is reasonable to treat the labs as homogeneous," the expected outcome is that the lab ANOVA F-statistic will be modest relative to the critical value, supporting the homogeneity conclusion. However, the batch effect inflates within-lab variability, so consider also computing the ANOVA on within-batch residuals (i.e., after removing the batch mean). If the pooled ANOVA yields a significant result due to the batch confound, add a brief note explaining this and also report the within-batch analysis. The executor should check the results and write an accurate conclusion.

The batch effect of approximately 75 to 100 units on location dominates any lab effects. It is reasonable to treat the labs as homogeneous for purposes of analyzing the primary machining factors.
```

2d. Move the "### Factor Effects" content (currently under "## Quantitative Output and Interpretation") into a new "## Primary Factors Analysis" H2 section. Move the existing ranked effects tables and batch comparison of factor effects text. Leave placeholder headings for DOE visualizations that Plan 02 will fill:

```mdx
## Primary Factors Analysis

The designed experiment analysis examines the effects of three primary machining factors. Because the batch effect dominates, factor effects are analyzed separately by batch.

| Factor | Symbol | Level 1 | Level 2 |
|--------|--------|---------|---------|
| Table speed | <InlineMath tex="X_1" /> | 0.025 | 0.125 |
| Down feed rate | <InlineMath tex="X_2" /> | 0.050 | 0.125 |
| Wheel grit size | <InlineMath tex="X_3" /> | 150 | 80 |

### DOE Mean Plot

[DOE mean plots will be added in Plan 02]

### DOE Standard Deviation Plot

[DOE SD plots will be added in Plan 02]

### Interaction Effects

[Interaction plots will be added in Plan 02]

### Ranked Effects

[Move existing "#### Batch 1 -- Ranked Effects" and "#### Batch 2 -- Ranked Effects" tables and interpretation text here verbatim. Also move the "#### Batch Comparison of Factor Effects" text.]
```

2e. Update the remaining "## Quantitative Output and Interpretation" section. After moving Batch Comparison and Factor Effects out, this section should only contain:
- ### Summary Statistics (keep as-is)
- ### Distribution Test (keep as-is)
- ### Outlier Detection (keep as-is)

Remove the "### Batch Comparison" and "### Factor Effects" subsections (they were moved).

2f. Keep "## Conclusions" exactly as-is. (Plan 02 will add Interpretation before it and update it.)

CRITICAL CONTENT PRESERVATION: Map every paragraph to its new location before editing. The restructured MDX should have MORE lines than the original (266) because it adds new component calls and introductory text for subsections. If the line count decreases significantly, content has been lost.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx astro check 2>&1 | tail -5 && npx astro build 2>&1 | tail -3</automated>
  </verify>
  <done>
- ceramic-strength.mdx has "## Response Variable Analysis" (renamed from "Graphical Output and Interpretation")
- ceramic-strength.mdx has "## Batch Effect Analysis" as H2 with subsections: Bihistogram, Batch Box Plot, Batch Block Plots, Batch Statistical Tests
- ceramic-strength.mdx has "## Lab Effect Analysis" as H2 with subsections: Lab Box Plot, Lab Box Plot by Batch, Lab Statistical Tests
- Lab Statistical Tests subsection contains one-way ANOVA F-test with computed F-statistic, df (7, 472), critical value, ANOVA table, and conclusion about lab homogeneity
- ceramic-strength.mdx has "## Primary Factors Analysis" as H2 with placeholder subsections for DOE plots + moved Ranked Effects tables
- CeramicStrengthPlots.astro has all new plot types in PlotType union and switch statement
- CeramicStrengthPlots.astro computes lab ANOVA (SSB, SSW, MSB, MSW, F-statistic) from ceramicStrength dataset
- Bihistogram renders two back-to-back distributions with Batch 1 top and Batch 2 bottom
- Block plot renders batch means by lab showing consistent batch effect
- Lab box plots render 8-group box plots
- All component calls reference the correct new plot types
- No content from the original MDX has been lost (line count >= 300)
- `npx astro check` reports 0 errors
- `npx astro build` completes successfully
  </done>
</task>

</tasks>

<verification>
- `npx astro check` reports 0 errors
- `npx astro build` completes successfully
- grep for "## Response Variable Analysis" in ceramic-strength.mdx (renamed)
- grep for "## Batch Effect Analysis" confirms H2 promotion
- grep for "## Lab Effect Analysis" confirms H2 promotion
- grep for "## Primary Factors Analysis" confirms new section
- grep for "### Lab Statistical Tests" in ceramic-strength.mdx confirms lab ANOVA subsection exists
- grep for "one-factor ANOVA" or "one-way ANOVA" in ceramic-strength.mdx confirms ANOVA test content
- grep for "lab means are not significantly different" or "at least one lab mean" in ceramic-strength.mdx confirms ANOVA conclusion
- grep for "batch-bihistogram" in CeramicStrengthPlots.astro confirms new type
- grep for "batch-block-plot" in CeramicStrengthPlots.astro confirms new type
- grep for "lab-box-plot" in CeramicStrengthPlots.astro confirms new type
- grep for "generateBihistogram" in index.ts confirms export
- grep for "generateDoeMeanPlot" in index.ts confirms export
- grep for "generateBlockPlot" in index.ts confirms export
- grep for "generateInteractionPlot" in index.ts confirms export
- grep for "fQuantile" in CeramicStrengthPlots.astro confirms ANOVA critical value computation
- Count of CeramicStrengthPlots component calls in MDX should be >= 11 (original 8 + bihistogram + block plot + 3 lab box plots)
- No "## Graphical Output and Interpretation" heading remains (renamed)
</verification>

<success_criteria>
Four new DOE-specific SVG generators exist and produce valid SVG markup. The ceramic-strength.mdx follows the DOE Variation canonical template with 6 major H2 sections (Background, Response Variable, Batch Effect, Lab Effect, Primary Factors, Quantitative Output). All Response Variable, Batch Effect, and Lab Effect subsections have individually named headings with CeramicStrengthPlots component calls rendering actual visualizations. The Lab Effect Analysis section includes a Lab Statistical Tests subsection with a one-way ANOVA F-test comparing lab means, confirming the labs can be treated as homogeneous. The build passes with no errors.
</success_criteria>

<output>
After completion, create `.planning/phases/62-ceramic-strength-doe/62-01-SUMMARY.md`
</output>
