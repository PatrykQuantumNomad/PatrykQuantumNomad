---
phase: 23-rule-engine-scoring
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/lib/tools/dockerfile-analyzer/rules/security/PG001-secrets-in-env.ts
  - src/lib/tools/dockerfile-analyzer/rules/security/PG002-curl-pipe-shell.ts
  - src/lib/tools/dockerfile-analyzer/rules/security/PG003-copy-sensitive-files.ts
  - src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3003-use-workdir.ts
  - src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3009-remove-apt-lists.ts
  - src/lib/tools/dockerfile-analyzer/rules/efficiency/DL4006-set-pipefail.ts
  - src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3042-pip-no-cache-dir.ts
  - src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3019-use-apk-no-cache.ts
  - src/lib/tools/dockerfile-analyzer/rules/maintainability/DL3045-copy-relative-workdir.ts
  - src/lib/tools/dockerfile-analyzer/rules/maintainability/PG004-legacy-env-format.ts
  - src/lib/tools/dockerfile-analyzer/rules/reliability/DL3011-valid-port.ts
  - src/lib/tools/dockerfile-analyzer/rules/reliability/DL3012-one-healthcheck.ts
  - src/lib/tools/dockerfile-analyzer/rules/reliability/DL3024-unique-from-alias.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3027-no-apt-use-apt-get.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3013-pin-pip-versions.ts
  - src/lib/tools/dockerfile-analyzer/rules/maintainability/DL4001-wget-or-curl.ts
  - src/lib/tools/dockerfile-analyzer/rules/maintainability/DL3057-missing-healthcheck.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3001-avoid-bash-commands.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3022-copy-from-alias.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3030-yum-y.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3033-pin-yum-versions.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3038-dnf-y.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3041-pin-dnf-versions.ts
  - src/lib/tools/dockerfile-analyzer/rules/best-practice/PG005-inconsistent-casing.ts
  - src/lib/tools/dockerfile-analyzer/rules/index.ts
  - src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts
autonomous: true
requirements: [RULE-02, RULE-03]

must_haves:
  truths:
    - "The sample Dockerfile triggers at least one violation from ALL 5 categories (Security, Efficiency, Maintainability, Reliability, Best Practice)"
    - "Custom PG-prefixed rules (PG001-PG005) fire correctly on the sample Dockerfile"
    - "Analyzing the sample Dockerfile produces violations from Security, Efficiency, Maintainability, Reliability, and Best Practice â€” confirming all 39 rules across 3 tiers are active"
    - "The sample Dockerfile score demonstrates meaningful differentiation (not clustering at 85-100)"
    - "Each of the 24 new rules has expert-voice explanation and before/after fix"
  artifacts:
    - path: "src/lib/tools/dockerfile-analyzer/rules/index.ts"
      provides: "Complete registry of all 40 rules"
      contains: "allRules"
    - path: "src/lib/tools/dockerfile-analyzer/rules/security/PG001-secrets-in-env.ts"
      provides: "Secret detection in ENV/ARG instructions"
      exports: ["PG001"]
    - path: "src/lib/tools/dockerfile-analyzer/rules/security/PG002-curl-pipe-shell.ts"
      provides: "Curl pipe to shell detection"
      exports: ["PG002"]
    - path: "src/lib/tools/dockerfile-analyzer/rules/best-practice/PG005-inconsistent-casing.ts"
      provides: "Inconsistent instruction casing detection"
      exports: ["PG005"]
  key_links:
    - from: "src/lib/tools/dockerfile-analyzer/rules/index.ts"
      to: "all 24 new rule files"
      via: "import and push to allRules"
      pattern: "allRules"
    - from: "src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts"
      to: "all 5 categories"
      via: "sample content triggers rules from every category"
      pattern: "SAMPLE_DOCKERFILE"
---

<objective>
Implement the remaining 24 rules (15 Tier 2 + 9 Tier 3) to reach the full 39-rule set, update the sample Dockerfile to ensure all 5 categories are triggered, and verify scoring calibration.

Purpose: Complete the rule engine with all planned rules, ensuring comprehensive Dockerfile analysis covering security, efficiency, maintainability, reliability, and best practices. The sample Dockerfile must demonstrate meaningful score differentiation.

Output: 39 total rules registered in allRules. Sample Dockerfile triggers violations from all 5 categories. Score falls in a range that demonstrates differentiation (roughly 65-80, not 85-100).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-rule-engine-scoring/23-RESEARCH.md
@.planning/phases/23-rule-engine-scoring/23-01-SUMMARY.md
@src/lib/tools/dockerfile-analyzer/types.ts
@src/lib/tools/dockerfile-analyzer/rules/index.ts
@src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 15 Tier 2 high-value rules</name>
  <files>
    src/lib/tools/dockerfile-analyzer/rules/security/PG001-secrets-in-env.ts
    src/lib/tools/dockerfile-analyzer/rules/security/PG002-curl-pipe-shell.ts
    src/lib/tools/dockerfile-analyzer/rules/security/PG003-copy-sensitive-files.ts
    src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3003-use-workdir.ts
    src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3009-remove-apt-lists.ts
    src/lib/tools/dockerfile-analyzer/rules/efficiency/DL4006-set-pipefail.ts
    src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3042-pip-no-cache-dir.ts
    src/lib/tools/dockerfile-analyzer/rules/efficiency/DL3019-use-apk-no-cache.ts
    src/lib/tools/dockerfile-analyzer/rules/maintainability/DL3045-copy-relative-workdir.ts
    src/lib/tools/dockerfile-analyzer/rules/maintainability/PG004-legacy-env-format.ts
    src/lib/tools/dockerfile-analyzer/rules/reliability/DL3011-valid-port.ts
    src/lib/tools/dockerfile-analyzer/rules/reliability/DL3012-one-healthcheck.ts
    src/lib/tools/dockerfile-analyzer/rules/reliability/DL3024-unique-from-alias.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3027-no-apt-use-apt-get.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3013-pin-pip-versions.ts
    src/lib/tools/dockerfile-analyzer/rules/index.ts
  </files>
  <action>
Follow the EXACT same LintRule pattern established in Plan 01. Each rule exports a named object implementing the LintRule interface. Use dockerfile-ast typed APIs for AST inspection, regex ONLY for RUN argument inspection.

**Security (3 custom PG rules):**

1. **PG001** (secrets-in-env, error, security): Check ENV and ARG instructions for secrets. Use `dockerfile.getENVs()` -> `env.getProperties()` -> check name against secret keywords (`/(?:api[_-]?key|secret|password|passwd|token|auth)/i`) and value against specific key patterns (`/sk-[a-zA-Z0-9]{20,}/`, `ghp_` tokens, `postgres://user:pass@`, `mysql://user:pass@`). Also check `dockerfile.getARGs()` -> `arg.getProperty()`. Use `prop.getNameRange().start.line + 1` for line number.

2. **PG002** (curl-pipe-shell, error, security): For RUN instructions, regex `getArgumentsContent()` for `curl.*\|\s*(sh|bash|zsh)` or `wget.*\|\s*(sh|bash|zsh)`. This catches `curl url | sh`, `curl -sSL url | bash`, etc.

3. **PG003** (copy-sensitive-files, warning, security): For COPY and ADD instructions, check `getArgumentsContent()` for source files matching sensitive patterns: `.env`, `id_rsa`, `id_ed25519`, `*.pem`, `*.key`, `*.p12`, `*.pfx`, `credentials`, `.aws/`, `.ssh/`. Use regex on the source arguments (everything before the last argument which is the destination).

**Efficiency (5):**

4. **DL3003** (use-workdir, warning, efficiency): For RUN instructions, regex for `\bcd\s+\S+\s*&&` or `\bcd\s+\S+\s*;` in `getArgumentsContent()`. Suggests using WORKDIR instead.

5. **DL3009** (remove-apt-lists, info, efficiency): For RUN instructions containing `apt-get install`, check if the SAME RUN instruction (or any RUN in the Dockerfile) also contains `rm -rf /var/lib/apt/lists/*` or `rm -rf /var/lib/apt/lists`. Flag if install exists without cleanup. Only flag once per Dockerfile (not per RUN).

6. **DL4006** (set-pipefail, warning, efficiency): For RUN instructions containing `|` (pipe), check if a SHELL instruction with `pipefail` exists before this RUN. If no prior SHELL with pipefail, flag the RUN. Iterate instructions to find SHELL instructions and their positions.

7. **DL3042** (pip-no-cache-dir, warning, efficiency): For RUN instructions containing `pip install` or `pip3 install`, check for `--no-cache-dir`. Flag if missing.

8. **DL3019** (use-apk-no-cache, info, efficiency): For RUN instructions containing `apk add`, check for `--no-cache`. Flag if missing.

**Maintainability (2):**

9. **DL3045** (copy-relative-workdir, warning, maintainability): For COPY instructions, check if the destination (last argument) does NOT start with `/`. Then check if any WORKDIR instruction exists before this COPY in the current build stage. If no prior WORKDIR in the same stage, flag it. Use `dockerfile.getFROMs()` to find stage boundaries.

10. **PG004** (legacy-env-format, info, maintainability): For ENV instructions, check if they use the legacy space-separated format (e.g., `ENV KEY value` instead of `ENV KEY=value`). Detect by checking if `getArgumentsContent()` does NOT contain `=` on the first key-value pair. Alternative approach: if `env.getProperties().length === 1` and the property value position suggests space-separated format. Simplest detection: regex on `getArgumentsContent()` -- if first token after ENV has no `=`, it is legacy format.

**Reliability (3):**

11. **DL3011** (valid-port, error, reliability): For EXPOSE instructions, parse `getArgumentsContent()` to extract port numbers. Flag any port outside 0-65535 range. Handle `port/protocol` format (e.g., `8080/tcp`).

12. **DL3012** (one-healthcheck, error, reliability): `dockerfile.getHEALTHCHECKs().length > 1` -- flag all after the first one.

13. **DL3024** (unique-from-alias, error, reliability): Collect all `from.getBuildStage()` values from `dockerfile.getFROMs()`. Flag duplicates. Report on the second (and subsequent) FROM with the duplicate alias.

**Best Practice (2):**

14. **DL3027** (no-apt-use-apt-get, warning, best-practice): For RUN instructions, regex `\bapt\s` in `getArgumentsContent()` but NOT `apt-get` or `apt-cache` or `apt-key`. Use negative lookbehind or explicit check: match `\bapt\s+(install|update|upgrade|remove|purge|list|search|show)` to catch `apt install` etc.

15. **DL3013** (pin-pip-versions, warning, best-practice): For RUN instructions containing `pip install` or `pip3 install`, extract package names. Flag packages without `==` version pin. Skip flags (start with `-`), skip `-r requirements.txt` references, skip `.` and paths.

**Update rules/index.ts:** Import all 15 new rules and add to allRules array. Total should be 30 rules after this task.

**Expert explanations and fix suggestions required for every rule** -- same quality as Plan 01 rules.

**Null safety:** ALWAYS null-check `getArgumentsContent()` before using it.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -v "open-graph"` -- all new rule files compile. Verify `allRules.length === 30` in rules/index.ts.
  </verify>
  <done>
15 Tier 2 rule files exist in category subdirectories. Each exports a LintRule with expert explanation and fix suggestion. rules/index.ts imports all 30 rules (15 Tier 1 + 15 Tier 2). TypeScript compiles clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement 9 Tier 3 rules, update sample Dockerfile, verify calibration</name>
  <files>
    src/lib/tools/dockerfile-analyzer/rules/maintainability/DL4001-wget-or-curl.ts
    src/lib/tools/dockerfile-analyzer/rules/maintainability/DL3057-missing-healthcheck.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3001-avoid-bash-commands.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3022-copy-from-alias.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3030-yum-y.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3033-pin-yum-versions.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3038-dnf-y.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/DL3041-pin-dnf-versions.ts
    src/lib/tools/dockerfile-analyzer/rules/best-practice/PG005-inconsistent-casing.ts
    src/lib/tools/dockerfile-analyzer/rules/index.ts
    src/lib/tools/dockerfile-analyzer/sample-dockerfile.ts
  </files>
  <action>
**9 Tier 3 rules:**

**Maintainability (2):**

1. **DL4001** (wget-or-curl, warning, maintainability): Scan ALL RUN instructions' `getArgumentsContent()` for both `wget` and `curl` usage. If both are found across any combination of RUN instructions, flag the second-found occurrence. Only flag once per Dockerfile.

2. **DL3057** (missing-healthcheck, info, maintainability): `dockerfile.getHEALTHCHECKs().length === 0`. Flag on the last FROM instruction's line (or line 1 if no FROM). Only flag once per Dockerfile.

**Best Practice (7):**

3. **DL3001** (avoid-bash-commands, info, best-practice): For RUN instructions, check `getArgumentsContent()` for interactive/system commands: `ssh`, `vim`, `shutdown`, `service`, `ps`, `free`, `top`, `kill`, `mount`, `ifconfig`. Use word-boundary regex `\b(ssh|vim|...)\b`. These suggest the container is being used like a VM.

4. **DL3022** (copy-from-alias, warning, best-practice): For COPY instructions with `--from` flag, check if `getFromFlag()?.getValue()` is a numeric string (e.g., "0", "1"). If so, suggest using a named alias instead.

5. **DL3030** (yum-y, warning, best-practice): For RUN instructions containing `yum install`, check for `-y` flag. Flag if missing.

6. **DL3033** (pin-yum-versions, warning, best-practice): For RUN instructions containing `yum install`, extract package names, flag those without `-` version separator (yum uses `package-version` format, not `=`).

7. **DL3038** (dnf-y, warning, best-practice): Same as DL3030 but for `dnf install`.

8. **DL3041** (pin-dnf-versions, warning, best-practice): Same as DL3033 but for `dnf install`.

9. **PG005** (inconsistent-casing, info, best-practice): Collect all `instruction.getInstruction()` values (original casing). Determine if the Dockerfile uses mostly uppercase or mostly lowercase keywords. Flag instructions that deviate from the majority convention. Do NOT flag if all instructions are the same case. Flag each deviant instruction individually.

**Update rules/index.ts:** Import all 9 new rules and add to allRules array. Total should be 39 rules.

**Update sample-dockerfile.ts:** Verify the sample Dockerfile triggers at least one rule from ALL 5 categories. The current sample should already trigger Security (DL3007 latest, PG001 secrets, DL3004 no sudo via ADD URL, DL3002 USER root), Efficiency (DL3059 consecutive RUN, DL3014 apt-y issues, DL3015 no-install-recommends), Maintainability (DL4000 MAINTAINER, DL3000 relative WORKDIR, DL3057 missing HEALTHCHECK), and Best Practice (DL3013 pip versions).

However, the current sample has NO reliability category violations. Add a line to trigger at least one Reliability rule. Options:
- Add `EXPOSE 99999` (triggers DL3011 invalid port) somewhere after EXPOSE 80/8080
- Or add a second CMD line (triggers DL4003 multiple CMD)

Choose adding `EXPOSE 99999` as it is less likely to confuse users than duplicate CMD. Insert it after the existing EXPOSE lines.

After updating, run a mental calibration: the sample should produce roughly 18-22 violations across all 5 categories, scoring in the 65-80 range (C to B-).

**Expert explanations and fix suggestions required for every rule.**
  </action>
  <verify>
Run `npm run build` -- build completes with exit code 0. Run `npx tsc --noEmit 2>&1 | grep -v "open-graph"` -- no new errors. Verify `allRules.length === 39` in rules/index.ts. Manually verify sample-dockerfile.ts contains content that would trigger at least one rule from each of the 5 categories (Security, Efficiency, Maintainability, Reliability, Best Practice).
  </verify>
  <done>
39 total rules registered in allRules. Sample Dockerfile updated to trigger all 5 categories including Reliability. All rules have expert explanations and fix suggestions. Build and TypeScript compile pass. The complete rule engine is ready for Phase 24 (results display).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes with exit code 0
2. `npx tsc --noEmit 2>&1 | grep -v "open-graph"` shows no new errors
3. `allRules.length === 39` (15 Tier 1 + 15 Tier 2 + 9 Tier 3)
4. Sample Dockerfile triggers violations from all 5 categories
5. Every rule file has id, title, severity, category, explanation, fix, and check function
6. PG-prefixed custom rules (PG001-PG005) are present and functional
7. DL3030/DL3033/DL3038/DL3041 yum/dnf rules follow same pattern as apt rules
</verification>

<success_criteria>
- 24 additional rules implemented (15 Tier 2 + 9 Tier 3)
- Total of 39 rules registered in allRules
- Sample Dockerfile triggers all 5 categories
- PG001 fires on ENV API_KEY and ENV DATABASE_URL in sample
- PG005 fires if sample has mixed-case instructions
- Score on sample Dockerfile is in range 60-80 (meaningful differentiation)
- Build passes, TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/23-rule-engine-scoring/23-02-SUMMARY.md`
</output>
