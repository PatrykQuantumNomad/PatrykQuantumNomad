---
phase: 37-shareability-badge-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/compose-validator/badge-generator.ts
  - src/lib/tools/compose-validator/url-state.ts
  - src/components/tools/compose-results/ComposeShareActions.tsx
  - src/components/tools/ComposeEditorPanel.tsx
  - src/components/tools/ComposeResultsPanel.tsx
autonomous: true
requirements: [SHARE-01, SHARE-02, SHARE-03]

must_haves:
  truths:
    - "User can download a branded PNG badge showing their compose validation score and per-category breakdown"
    - "User can share a URL that encodes their compose YAML content so recipients see the exact same file and analysis results"
    - "On mobile the native share sheet opens, on desktop the URL is copied to clipboard, and unsupported browsers get a text URL fallback"
    - "When loading a shared URL with #compose= hash, the editor pre-fills with the decoded content and auto-triggers analysis"
    - "URL length warning appears when the composed URL exceeds 2000 characters"
  artifacts:
    - path: "src/lib/tools/compose-validator/badge-generator.ts"
      provides: "SVG badge generation and PNG download for compose scores"
      exports: ["buildComposeBadgeSvg", "downloadComposeBadgePng"]
    - path: "src/lib/tools/compose-validator/url-state.ts"
      provides: "URL hash encoding/decoding of compose YAML content via lz-string"
      exports: ["encodeToHash", "decodeFromHash", "buildShareUrl", "isUrlSafeLength"]
    - path: "src/components/tools/compose-results/ComposeShareActions.tsx"
      provides: "Download Badge + Share/Copy Link buttons with Web Share API support"
      exports: ["ComposeShareActions"]
  key_links:
    - from: "src/components/tools/compose-results/ComposeShareActions.tsx"
      to: "src/lib/tools/compose-validator/badge-generator.ts"
      via: "import downloadComposeBadgePng"
      pattern: "downloadComposeBadgePng"
    - from: "src/components/tools/compose-results/ComposeShareActions.tsx"
      to: "src/lib/tools/compose-validator/url-state.ts"
      via: "import buildShareUrl + isUrlSafeLength"
      pattern: "buildShareUrl|isUrlSafeLength"
    - from: "src/components/tools/ComposeEditorPanel.tsx"
      to: "src/lib/tools/compose-validator/url-state.ts"
      via: "import decodeFromHash for URL hash decoding on mount"
      pattern: "decodeFromHash"
    - from: "src/components/tools/ComposeResultsPanel.tsx"
      to: "src/components/tools/compose-results/ComposeShareActions.tsx"
      via: "renders ComposeShareActions after violations/empty state"
      pattern: "ComposeShareActions"
---

<objective>
Add shareability features to the Docker Compose Validator: PNG badge download, lz-string URL state encoding, and platform-adaptive sharing (Web Share API / Clipboard / fallback).

Purpose: Users can share their compose validation results via downloadable score badges and compressed shareable URLs, matching the proven Dockerfile Analyzer pattern.
Output: badge-generator.ts, url-state.ts, ComposeShareActions.tsx, modified ComposeEditorPanel.tsx and ComposeResultsPanel.tsx
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-shareability-badge-export/37-RESEARCH.md

# Mirror patterns from Dockerfile Analyzer (read these for exact structure)
@src/lib/tools/dockerfile-analyzer/badge-generator.ts
@src/lib/tools/dockerfile-analyzer/url-state.ts
@src/components/tools/results/ShareActions.tsx
@src/components/tools/EditorPanel.tsx

# Compose-specific files to modify or reference
@src/components/tools/ComposeEditorPanel.tsx
@src/components/tools/ComposeResultsPanel.tsx
@src/stores/composeValidatorStore.ts
@src/lib/tools/compose-validator/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compose badge-generator.ts and url-state.ts utility modules</name>
  <files>
    src/lib/tools/compose-validator/badge-generator.ts
    src/lib/tools/compose-validator/url-state.ts
  </files>
  <action>
Create two utility modules by mirroring the Dockerfile Analyzer patterns with compose-specific adaptations.

**badge-generator.ts** -- Mirror `src/lib/tools/dockerfile-analyzer/badge-generator.ts` exactly with these changes:
- Import `ComposeScoreResult` and `ComposeCategoryScore` from `./types` (not Dockerfile types)
- CATEGORY_LABELS: `{ security: 'Security', semantic: 'Semantic', 'best-practice': 'Best Practice', schema: 'Schema', style: 'Style' }`
- CATEGORY_COLORS: `{ security: '#ef4444', semantic: '#3b82f6', 'best-practice': '#06b6d4', schema: '#f59e0b', style: '#8b5cf6' }`
- `getGradeColor()` function -- identical to Dockerfile version
- `buildComposeBadgeSvg(score: ComposeScoreResult): string` -- same SVG structure (400x200), change title text to `'Docker Compose Analysis'`, change footer to `'patrykgolabek.dev/tools/compose-validator'`
- `downloadComposeBadgePng(score: ComposeScoreResult): Promise<void>` -- identical Canvas rasterization logic, change filename to `compose-score-${score.overall}-${score.grade}.png`, clamp devicePixelRatio to max 3
- Use system fonts only in SVG (system-ui, sans-serif, monospace) -- no @font-face (canvas taint risk)

**url-state.ts** -- Mirror `src/lib/tools/dockerfile-analyzer/url-state.ts` exactly with these changes:
- Same lz-string imports: `compressToEncodedURIComponent`, `decompressFromEncodedURIComponent`
- Change HASH_PREFIX to `'#compose='` (not `'#dockerfile='` -- distinct prefix prevents cross-tool collision)
- `encodeToHash(content: string): string` -- identical logic
- `decodeFromHash(): string | null` -- identical logic with try/catch
- `buildShareUrl(content: string): string` -- identical logic
- `isUrlSafeLength(content: string): { safe: boolean; length: number }` -- identical logic with 2000 char threshold
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both files compile with no type errors. Verify badge-generator.ts exports `buildComposeBadgeSvg` and `downloadComposeBadgePng`, and url-state.ts exports `encodeToHash`, `decodeFromHash`, `buildShareUrl`, and `isUrlSafeLength`.
  </verify>
  <done>
Both utility modules exist with correct compose-specific types, category labels/colors, hash prefix, title text, footer URL, and filename. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ComposeShareActions component and wire URL decode into editor and results panels</name>
  <files>
    src/components/tools/compose-results/ComposeShareActions.tsx
    src/components/tools/ComposeEditorPanel.tsx
    src/components/tools/ComposeResultsPanel.tsx
  </files>
  <action>
**ComposeShareActions.tsx** -- Create in `src/components/tools/compose-results/`, mirroring `src/components/tools/results/ShareActions.tsx` with these enhancements:
- Import `composeResult` and `composeEditorViewRef` from `../../../stores/composeValidatorStore`
- Import `downloadComposeBadgePng` from `../../../lib/tools/compose-validator/badge-generator`
- Import `buildShareUrl` and `isUrlSafeLength` from `../../../lib/tools/compose-validator/url-state`
- State: `copied` (boolean), `urlWarning` (string | null), `downloading` (boolean)
- Guard: return null if `!result || !result.parseSuccess`
- `handleDownloadBadge` -- call `downloadComposeBadgePng(result.score)` with downloading state and try/catch
- `handleShare` -- **Enhanced over Dockerfile pattern** with 3-tier fallback:
  1. Check `navigator.share` -- if available, call `navigator.share({ title: \`Compose Score: \${result.score.grade} (\${result.score.overall}/100)\`, url })`. Catch `AbortError` (user cancel) silently and return. On other errors, fall through.
  2. Try `navigator.clipboard.writeText(url)` + `history.replaceState(null, '', url)` + set copied state with 2s timeout
  3. Final fallback: `prompt('Copy this URL:', url)`
- Before sharing, check `isUrlSafeLength(content)` and set amber URL length warning if >2000 chars
- JSX: Same flex layout as Dockerfile ShareActions -- Download Badge button (accent bg) + Share Link button (border variant). Change "Copy Share Link" label to "Share Link" (since it may trigger native share on mobile, not just copy). Show `{copied ? 'Copied!' : 'Share Link'}` on the share button.
- Show urlWarning as amber text below buttons (matching Dockerfile pattern)
- Do NOT include PromptGenerator -- the SHARE requirements do not mention it, and compose rules differ from Dockerfile rules

**ComposeEditorPanel.tsx** -- Add URL hash decode on mount (SHARE-02):
- Add import: `import { decodeFromHash } from '../../lib/tools/compose-validator/url-state';`
- Add `useEffect` import (already used implicitly via useRef/useCallback -- add `useEffect` to the existing import from 'react')
- Before `analyzeRef` declaration, add: `const hashContentRef = useRef<string | null>(typeof window !== 'undefined' ? decodeFromHash() : null);`
- Change `initialDoc` in `useCodeMirrorYaml` call from `SAMPLE_COMPOSE` to `hashContentRef.current || SAMPLE_COMPOSE`
- After `useCodeMirrorYaml`, add auto-analyze useEffect: `useEffect(() => { if (hashContentRef.current && viewRef.current) { analyzeRef.current(viewRef.current); } }, []);`

**ComposeResultsPanel.tsx** -- Render ComposeShareActions:
- Add import: `import { ComposeShareActions } from './compose-results/ComposeShareActions';`
- Render `<ComposeShareActions />` in two places within the violations tab content:
  1. After the violations list (inside the `result.violations.length > 0` branch), add `<ComposeShareActions />` after `<ComposeViolationList ... />`
  2. After the empty state (inside the `result.violations.length === 0` branch), add `<ComposeShareActions />` after `<ComposeEmptyState ... />`
- Do NOT render ComposeShareActions in the graph tab or in the null/analyzing/parse-error states
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm all three files compile cleanly. Run `npm run build` to verify the full Astro build succeeds with no errors.
  </verify>
  <done>
ComposeShareActions renders Download Badge and Share Link buttons when analysis results exist. ComposeEditorPanel decodes URL hash content on mount and auto-triggers analysis. ComposeResultsPanel shows share actions after both violations list and empty state views. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` completes successfully
3. badge-generator.ts exports buildComposeBadgeSvg and downloadComposeBadgePng with compose category labels/colors
4. url-state.ts uses '#compose=' prefix (distinct from '#dockerfile=')
5. ComposeEditorPanel decodes hash content before editor creation and auto-analyzes
6. ComposeShareActions renders with Download Badge + Share Link buttons
7. ComposeResultsPanel shows share actions after violations and empty state
</verification>

<success_criteria>
- SHARE-01: buildComposeBadgeSvg produces 400x200 SVG with compose categories; downloadComposeBadgePng rasterizes to retina-aware PNG named compose-score-{N}-{grade}.png
- SHARE-02: URL hash encoding uses '#compose=' prefix with lz-string compression; decodeFromHash on editor mount pre-fills editor content and auto-triggers analysis
- SHARE-03: handleShare tries navigator.share (mobile) then navigator.clipboard.writeText (desktop) then prompt() fallback; AbortError handled silently; URL length warning shown for >2000 chars
</success_criteria>

<output>
After completion, create `.planning/phases/37-shareability-badge-export/37-01-SUMMARY.md`
</output>
