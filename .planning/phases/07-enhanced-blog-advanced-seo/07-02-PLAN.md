---
phase: 07-enhanced-blog-advanced-seo
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/og-image.ts
  - src/pages/open-graph/[...slug].png.ts
  - src/assets/fonts/Inter-Regular.ttf
  - src/assets/fonts/SpaceGrotesk-Bold.ttf
  - src/components/SEOHead.astro
  - src/layouts/Layout.astro
  - src/pages/blog/[slug].astro
  - src/components/BlogPostingJsonLd.astro
  - package.json
autonomous: true

must_haves:
  truths:
    - "Each blog post has a unique OG image at /open-graph/blog/{post.id}.png"
    - "Sharing a blog post URL on social media shows the post-specific image preview"
    - "OG images contain the post title, description, tags, and Patryk Golabek branding"
    - "BlogPostingJsonLd includes an image property pointing to the OG image URL"
    - "twitter:card is summary_large_image when an OG image is present"
  artifacts:
    - path: "src/lib/og-image.ts"
      provides: "Satori + Sharp OG image generation utility"
      exports: ["generateOgImage"]
    - path: "src/pages/open-graph/[...slug].png.ts"
      provides: "Static API endpoint generating PNG per blog post"
      contains: "getStaticPaths"
    - path: "src/assets/fonts/Inter-Regular.ttf"
      provides: "Body font for Satori rendering"
    - path: "src/assets/fonts/SpaceGrotesk-Bold.ttf"
      provides: "Heading font for Satori rendering"
  key_links:
    - from: "src/pages/open-graph/[...slug].png.ts"
      to: "src/lib/og-image.ts"
      via: "import generateOgImage"
      pattern: "generateOgImage"
    - from: "src/pages/blog/[slug].astro"
      to: "/open-graph/blog/{id}.png"
      via: "ogImage prop passed to Layout"
      pattern: "ogImage"
    - from: "src/components/SEOHead.astro"
      to: "og:image meta tag"
      via: "ogImage prop renders meta tags"
      pattern: "og:image"
    - from: "src/components/BlogPostingJsonLd.astro"
      to: "schema.image"
      via: "image property in JSON-LD"
      pattern: "\"image\""
---

<objective>
Add dynamic OG image generation for blog posts and enhance structured data for GEO optimization.

Purpose: SEO-07 (dynamic OG images) is the highest-complexity requirement in Phase 7. Each blog post gets a unique, branded social preview image generated at build time using Satori + Sharp. SEO-09 (GEO) adds the `image` property to BlogPostingJsonLd and ensures structured data supports AI engine citation. This plan depends on Plan 01 because it modifies `[slug].astro` which Plan 01 also touches.

Output: OG image generation pipeline (utility + endpoint + fonts), updated SEOHead with og:image support, updated Layout to pass ogImage prop, blog posts wired with OG image URLs, and enhanced BlogPostingJsonLd for GEO.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-enhanced-blog-advanced-seo/07-RESEARCH.md
@.planning/phases/07-enhanced-blog-advanced-seo/07-01-SUMMARY.md

@src/components/SEOHead.astro
@src/components/BlogPostingJsonLd.astro
@src/layouts/Layout.astro
@src/pages/blog/[slug].astro
@src/content.config.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, download fonts, and create OG image generation utility</name>
  <files>package.json, src/assets/fonts/Inter-Regular.ttf, src/assets/fonts/SpaceGrotesk-Bold.ttf, src/lib/og-image.ts</files>
  <action>
Install satori and sharp:
```
npm install satori sharp
```

Download TTF font files (NOT WOFF2 -- Satori does not support WOFF2):
- Inter Regular (400 weight): Download from Google Fonts github repo or use the direct download URL. Save to `src/assets/fonts/Inter-Regular.ttf`
- Space Grotesk Bold (700 weight): Download similarly. Save to `src/assets/fonts/SpaceGrotesk-Bold.ttf`

Font download approach: Use curl to download from the google-fonts GitHub releases or fontsource. For example:
- Inter: `https://github.com/google/fonts/raw/main/ofl/inter/Inter%5Bopsz%2Cwght%5D.ttf` -- this is a variable font. Instead, download the static TTF from `https://github.com/rsms/inter/releases` or use fontsource. The simplest reliable approach: download from `https://fonts.google.com/download?family=Inter` (ZIP), extract the static TTF, or use the GitHub raw URL for the static version. If the variable font works with Satori, use it. If not, find the static `Inter-Regular.ttf`.

Alternative reliable font source: Use npm package `@fontsource/inter` and `@fontsource/space-grotesk` to get the TTF files, then copy them. Or download directly from the repos:
- Inter static: `https://github.com/rsms/inter/raw/master/docs/font-files/Inter-Regular.otf` -- but we need TTF. Best approach: `npm install @fontsource/inter @fontsource/space-grotesk` temporarily, copy the TTF/WOFF files, then uninstall. OR use Google Fonts API with `https://fonts.googleapis.com/css2?family=Inter:wght@400` -- parse the CSS for the TTF URL.

Simplest approach: Download the font ZIP files from Google Fonts and extract the static TTFs. Use curl:
```bash
# Download Inter
curl -L "https://github.com/google/fonts/raw/main/ofl/inter/static/Inter-Regular.ttf" -o src/assets/fonts/Inter-Regular.ttf

# Download Space Grotesk Bold
curl -L "https://github.com/google/fonts/raw/main/ofl/spacegrotesk/static/SpaceGrotesk-Bold.ttf" -o src/assets/fonts/SpaceGrotesk-Bold.ttf
```

If those URLs fail, try alternative paths or download the font families as ZIPs and extract.

Create `src/lib/og-image.ts`:
- Import `satori` from `satori`, `sharp` from `sharp`, `readFile` from `node:fs/promises`
- Module-scope font caching: `let interFont: Buffer | undefined; let spaceGroteskFont: Buffer | undefined;`
- `async function loadFonts()` that reads both TTF files via `readFile()` from `./src/assets/fonts/` paths (relative to project root, since Astro endpoints run from project root at build time)
- Export `async function generateOgImage(title: string, description: string, tags: string[] = []): Promise<Buffer>`
- Inside: call `loadFonts()`, then call `satori()` with JSX object syntax (NOT satori-html):
  - Root div: 1200x630, dark background `#0a0a1a`, padding 60px, flex column, justify between
  - Top section (flex column):
    - Title: Space Grotesk bold, 48px, color `#e8e8f0`, max 2 lines (truncate if needed via limiting string length to ~80 chars with ellipsis)
    - Description: Inter regular, 22px, color `#9898b8`, lineHeight 1.5, marginTop 16px, max ~120 chars
  - Bottom section (flex row, justify between, align end):
    - Left: tags rendered as small pills (flex row, gap 8px) -- each tag in a div with `fontSize: 14, color: '#7c73ff', backgroundColor: 'rgba(124,115,255,0.15)', borderRadius: 20, padding: '4px 12px'`
    - Right: "patrykgolabek.dev" text in Inter, 18px, color `#6868a0`
  - A subtle accent line at top: div with height 4px, background linear gradient `#7c73ff` to `#a78bfa`, full width, positioned at the top of the card
- Satori options: `width: 1200, height: 630`, fonts array with Inter (weight 400) and Space Grotesk (weight 700)
- Convert SVG to PNG: `await sharp(Buffer.from(svg)).png().toBuffer()`
- Return the PNG buffer

Important: Use plain JSX object syntax (`{ type: 'div', props: { style: {...}, children: [...] } }`) -- do NOT use satori-html (unmaintained, per research).
  </action>
  <verify>Run `npm run build` -- if it compiles without import errors, the utility is valid. Additionally, create a quick test: run `node -e "import('./src/lib/og-image.ts')"` -- this will fail (TS), but the npm install of satori and sharp should succeed. The real verification is in Task 2 when the endpoint generates images.</verify>
  <done>satori and sharp installed. TTF font files saved to src/assets/fonts/. og-image.ts utility exports generateOgImage function using Satori JSX object syntax.</done>
</task>

<task type="auto">
  <name>Task 2: Create OG image endpoint and wire OG images into SEOHead, Layout, and blog posts</name>
  <files>src/pages/open-graph/[...slug].png.ts, src/components/SEOHead.astro, src/layouts/Layout.astro, src/pages/blog/[slug].astro</files>
  <action>
Create `src/pages/open-graph/[...slug].png.ts`:
- Import `APIRoute`, `GetStaticPaths` from `astro`, `getCollection` from `astro:content`, `generateOgImage` from `../../lib/og-image`
- `export const getStaticPaths: GetStaticPaths` that queries non-draft blog posts and returns paths with `params: { slug: "blog/" + post.id }` and `props: { title, description, tags }` from post.data
- `export const GET: APIRoute` that calls `generateOgImage(props.title, props.description, props.tags)` and returns `new Response(png, { headers: { 'Content-Type': 'image/png' } })`

Update `src/components/SEOHead.astro`:
- Add `ogImage?: string` to Props interface (absolute URL string)
- After existing OG meta tags, add conditional rendering when ogImage is truthy:
  ```
  <meta property="og:image" content={ogImage} />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:type" content="image/png" />
  ```
- Update the twitter:card meta tag from hardcoded `"summary"` to `{ogImage ? "summary_large_image" : "summary"}`
- Add conditional: `{ogImage && <meta name="twitter:image" content={ogImage} />}`

Update `src/layouts/Layout.astro`:
- Add `ogImage?: string` to Props interface
- Destructure ogImage from Astro.props (default undefined)
- Pass `ogImage={ogImage}` to the SEOHead component

Update `src/pages/blog/[slug].astro`:
- Compute the OG image URL: `const ogImageURL = new URL("/open-graph/blog/" + post.id + ".png", Astro.site).toString();`
- Pass `ogImage={ogImageURL}` to the Layout component
  </action>
  <verify>Run `npm run build` -- check that PNG files are generated in `dist/open-graph/blog/` directory. Check that blog post HTML contains `<meta property="og:image" content="https://patrykgolabek.dev/open-graph/blog/...">` and `<meta name="twitter:card" content="summary_large_image">`.</verify>
  <done>OG images generated as PNG files at /open-graph/blog/{id}.png for each blog post. Blog post pages include og:image and twitter:image meta tags with absolute URLs. twitter:card is summary_large_image on blog posts.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance BlogPostingJsonLd for GEO optimization</name>
  <files>src/components/BlogPostingJsonLd.astro, src/pages/blog/[slug].astro</files>
  <action>
Update `src/components/BlogPostingJsonLd.astro`:
- Add `image?: string` to Props interface (the OG image absolute URL)
- Add `image` to destructured props
- Add to the schema object: `if (image) { schema["image"] = { "@type": "ImageObject", "url": image, "width": 1200, "height": 630 }; }`
- This satisfies GEO requirement: BlogPostingJsonLd now includes the image property for richer structured data, improving AI engine citation potential

Update `src/pages/blog/[slug].astro`:
- Pass `image={ogImageURL}` to the BlogPostingJsonLd component (ogImageURL was already computed in Task 2)
- The component call should now include: `<BlogPostingJsonLd ... image={ogImageURL} />`

No other GEO changes needed -- the research identifies these as the actionable code changes:
1. Add `image` to BlogPostingJsonLd (this task)
2. `dateModified` already handled via `updatedDate` prop (already in place from Phase 5)
3. `keywords` already handled via `tags` prop (already in place from Phase 5)
4. Content structure (answer-first, self-contained sections) is a content authoring concern, not a code change
5. Author E-E-A-T signals already present via PersonJsonLd on homepage
  </action>
  <verify>Run `npm run build`. Check blog post HTML for `<script type="application/ld+json">` containing `"image":{"@type":"ImageObject","url":"https://patrykgolabek.dev/open-graph/blog/..."}`.</verify>
  <done>BlogPostingJsonLd includes image property with OG image URL. Structured data is GEO-optimized with image, dateModified, and keywords all present.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. PNG files exist in `dist/open-graph/blog/` for each non-draft blog post
3. Blog post HTML contains `og:image` meta tag with absolute URL to the generated PNG
4. Blog post HTML contains `twitter:card` set to `summary_large_image`
5. Blog post HTML contains `twitter:image` meta tag
6. BlogPostingJsonLd JSON-LD contains `"image"` with `"@type": "ImageObject"` and the OG image URL
7. Non-blog pages (home, about, projects, contact) do NOT have og:image tags (no image generated for them)
</verification>

<success_criteria>
- Every blog post has a unique OG image generated at /open-graph/blog/{id}.png
- Social media sharing shows branded image preview with post title, description, and tags
- SEOHead renders og:image and twitter:image meta tags on blog posts
- BlogPostingJsonLd includes image property for GEO optimization
- Build time increase is reasonable (roughly 1 second per blog post)
</success_criteria>

<output>
After completion, create `.planning/phases/07-enhanced-blog-advanced-seo/07-02-SUMMARY.md`
</output>
