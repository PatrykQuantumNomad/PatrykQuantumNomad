---
phase: 31-detail-pages
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/db-compass/CompassShareControls.astro
  - src/pages/tools/db-compass/[slug].astro
autonomous: true
requirements: [SHARE-01, SHARE-02]

must_haves:
  truths:
    - "Each detail page has share buttons for X, LinkedIn, Reddit, Bluesky, and a copy-link button"
    - "On mobile devices with Web Share API support, a 'More' share button appears"
    - "Clicking the download button saves the radar chart as a PNG file"
    - "Share controls and download work correctly after View Transitions navigation between detail pages"
  artifacts:
    - path: "src/components/db-compass/CompassShareControls.astro"
      provides: "Share controls with social links, copy-link, Web Share API, and SVG-to-PNG download"
      min_lines: 150
    - path: "src/pages/tools/db-compass/[slug].astro"
      provides: "Detail page now imports and renders CompassShareControls"
  key_links:
    - from: "src/components/db-compass/CompassShareControls.astro"
      to: "navigator.share"
      via: "Web Share API with feature detection"
      pattern: "navigator\\.share"
    - from: "src/components/db-compass/CompassShareControls.astro"
      to: "navigator.clipboard.writeText"
      via: "Clipboard API for copy-link"
      pattern: "clipboard\\.writeText"
    - from: "src/components/db-compass/CompassShareControls.astro"
      to: "SVG radar chart DOM element"
      via: "XMLSerializer + Canvas for PNG download"
      pattern: "XMLSerializer"
    - from: "src/pages/tools/db-compass/[slug].astro"
      to: "src/components/db-compass/CompassShareControls.astro"
      via: "Astro component import with model props"
      pattern: "import CompassShareControls"
---

<objective>
Add share controls and radar chart PNG download to all 12 detail pages.

Purpose: Shareability drives organic traffic -- users sharing radar charts on social media expands reach. The download-as-PNG feature lets developers save charts for presentations and documentation.
Output: CompassShareControls.astro component + integration into [slug].astro
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-detail-pages/31-RESEARCH.md
@.planning/phases/31-detail-pages/31-01-SUMMARY.md

@src/components/beauty-index/ShareControls.astro
@src/lib/tools/dockerfile-analyzer/badge-generator.ts
@src/pages/tools/db-compass/[slug].astro
@src/components/db-compass/CompassRadarChart.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CompassShareControls.astro with share links and SVG-to-PNG download</name>
  <files>src/components/db-compass/CompassShareControls.astro</files>
  <action>
Create CompassShareControls.astro by adapting ShareControls.astro (516 lines) for Database Compass. The component handles two concerns: social sharing (SHARE-01) and radar chart PNG download (SHARE-02).

**Props interface:**
```typescript
interface Props {
  slug: string;
  name: string;
  total: number;
}
```

**HTML structure:**
Render a section with share and download controls. Follow ShareControls.astro layout:
- Section heading: "Share" (or visually hidden if preferred)
- Row of social share buttons (X, LinkedIn, Reddit, Bluesky)
- Copy-link button with clipboard icon
- Web Share API "More" button (hidden by default, shown via JS on capable devices)
- Download PNG button with download icon
- Toast notification element (hidden by default, shown on copy/share success)

**Social share intent URLs:**
- X (Twitter): `https://x.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`
- LinkedIn: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`
- Reddit: `https://reddit.com/submit?url=${encodeURIComponent(pageUrl)}&title=${encodeURIComponent(shareText)}`
- Bluesky: `https://bsky.app/intent/compose?text=${encodeURIComponent(shareText + ' ' + pageUrl)}`

Where:
- shareText = `${name} scores ${total}/80 in the Database Compass!`
- pageUrl = `https://patrykgolabek.dev/tools/db-compass/${slug}/`

All social links open in new tabs: target="_blank" rel="noopener noreferrer"

**Inline script (with astro:page-load for View Transitions compatibility):**
Wrap all DOM setup in an init function called from `document.addEventListener('astro:page-load', initCompassShareControls)`.

The script must handle:

1. **Copy link:** On click, `navigator.clipboard.writeText(pageUrl)` then show toast "Link copied!" for 2 seconds.

2. **Web Share API:** Check `'share' in navigator`. If supported, show the "More" button. On click: `navigator.share({ title, text: shareText, url: pageUrl })`.

3. **Download PNG (SVG-to-PNG via DOM capture):**
   - Find the SVG: `document.querySelector('#radar-chart svg')` (the radar chart container has id="radar-chart" from Plan 01)
   - Wait for fonts: `await document.fonts.ready`
   - Serialize: `new XMLSerializer().serializeToString(svgEl)`
   - Get dimensions from viewBox: `svgEl.viewBox.baseVal` (use viewBox width/height, NOT the width/height attributes -- they differ per research pitfall 2)
   - Create DPR-scaled canvas: `dpr = Math.min(window.devicePixelRatio || 1, 3)`, canvas.width = W * dpr, canvas.height = H * dpr, ctx.scale(dpr, dpr)
   - Create Blob from SVG string: `new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' })`
   - Create object URL, load into Image element
   - On image load: draw to canvas, export as PNG blob via canvas.toBlob
   - Trigger download with anchor click: filename = `${slug}-radar-chart.png` (use slug, NOT name -- model names have parentheses per research anti-pattern)
   - Clean up object URLs

4. **Toast:** Show/hide a small notification element. Use CSS transition for fade. Auto-hide after 2 seconds via setTimeout.

**Styling:**
- Button row: flex flex-wrap gap-2 items-center
- Buttons: inline-flex items-center gap-1.5 px-3 py-1.5 rounded text-sm border border-[var(--color-border)] hover:border-[var(--color-accent)] transition-colors
- Active/download button: can use accent background for emphasis
- Toast: fixed bottom-4 left-1/2 -translate-x-1/2 bg-[var(--color-accent)] text-white px-4 py-2 rounded shadow-lg transition-opacity

Follow the exact ShareControls.astro patterns for button markup, icon SVGs (inline SVG icons for share, copy, download), and toast behavior. Adapt -- do not copy verbatim.

Do NOT use React. This is a pure Astro component with an inline script.
  </action>
  <verify>File exists at src/components/db-compass/CompassShareControls.astro. Run `npx astro check 2>&1 | grep -i "db-compass"` confirms zero type errors.</verify>
  <done>CompassShareControls.astro renders social share buttons (X, LinkedIn, Reddit, Bluesky), copy-link, conditional Web Share "More" button, and SVG-to-PNG download button with toast feedback and astro:page-load lifecycle.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CompassShareControls into [slug].astro detail page</name>
  <files>src/pages/tools/db-compass/[slug].astro</files>
  <action>
Update [slug].astro (created in Plan 01) to import and render CompassShareControls.

**Changes:**
1. Add import: `import CompassShareControls from '../../../components/db-compass/CompassShareControls.astro';`
2. Replace the placeholder comment (`<!-- CompassShareControls will be added in Plan 02 -->`) with:
   ```astro
   <CompassShareControls slug={model.slug} name={model.name} total={total} />
   ```
3. Place it between the score breakdown section and the character sketch section (natural position -- after seeing the scores, user might want to share).

**Verify radar chart container:**
Confirm the radar chart section has `id="radar-chart"` wrapper (should exist from Plan 01). The download script relies on `document.querySelector('#radar-chart svg')` to find the SVG element.

Do NOT change any other sections of [slug].astro. This is a surgical insertion of one component import and one component render.
  </action>
  <verify>Run `npm run build 2>&1 | tail -5` confirms build succeeds with same page count (~727). Verify share controls markup present: `grep -l "CompassShareControls" src/pages/tools/db-compass/\[slug\].astro`. Verify inline script present in built output: `grep -c "initCompassShareControls" dist/tools/db-compass/key-value/index.html` returns at least 1.</verify>
  <done>All 12 detail pages include share controls with social links, copy-link, Web Share API "More" button, and radar chart PNG download. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with ~727 pages
2. `grep -l "XMLSerializer" dist/tools/db-compass/key-value/index.html` confirms SVG-to-PNG script present
3. `grep -l "navigator.share" dist/tools/db-compass/relational/index.html` confirms Web Share API code
4. `grep -l "clipboard.writeText" dist/tools/db-compass/document/index.html` confirms copy-link
5. `grep -c "astro:page-load" dist/tools/db-compass/graph/index.html` returns at least 1 (View Transitions lifecycle)
</verification>

<success_criteria>
- CompassShareControls.astro renders share buttons and download button on all 12 detail pages
- Social share links generate correct intent URLs with model-specific text and page URL
- Download button script targets the correct SVG element via #radar-chart container
- All client-side functionality wrapped in astro:page-load for View Transitions compatibility
- Build produces ~727 pages with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-detail-pages/31-02-SUMMARY.md`
</output>
