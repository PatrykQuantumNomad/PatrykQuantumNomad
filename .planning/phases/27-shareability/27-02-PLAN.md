---
phase: 27-shareability
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - src/components/tools/results/ShareActions.tsx
  - src/components/tools/ResultsPanel.tsx
  - src/lib/tools/dockerfile-analyzer/use-codemirror.ts
  - src/components/tools/EditorPanel.tsx
autonomous: true
requirements: [SHARE-01, SHARE-02]

must_haves:
  truths:
    - "After analysis, users see Download Badge and Copy Share Link buttons below the score display"
    - "Clicking Download Badge triggers a PNG download of the score badge image"
    - "Clicking Copy Share Link copies a URL to the clipboard and shows Copied! feedback"
    - "When URL exceeds 2000 chars, a warning is shown to the user"
    - "Opening a shared URL with #dockerfile= hash loads the Dockerfile into the editor and triggers analysis automatically"
    - "Share buttons are hidden when no analysis result exists or parse failed"
  artifacts:
    - path: "src/components/tools/results/ShareActions.tsx"
      provides: "Download Badge and Copy Share Link buttons"
      exports: ["ShareActions"]
    - path: "src/components/tools/ResultsPanel.tsx"
      provides: "Results panel with ShareActions integrated"
      contains: "ShareActions"
    - path: "src/components/tools/EditorPanel.tsx"
      provides: "Editor panel with URL hash restore on mount"
      contains: "decodeFromHash"
    - path: "src/lib/tools/dockerfile-analyzer/use-codemirror.ts"
      provides: "CodeMirror hook accepting dynamic initialDoc"
      contains: "initialDoc"
  key_links:
    - from: "src/components/tools/results/ShareActions.tsx"
      to: "src/lib/tools/dockerfile-analyzer/badge-generator.ts"
      via: "import downloadBadgePng"
      pattern: "import.*downloadBadgePng.*from.*badge-generator"
    - from: "src/components/tools/results/ShareActions.tsx"
      to: "src/lib/tools/dockerfile-analyzer/url-state.ts"
      via: "import buildShareUrl, isUrlSafeLength"
      pattern: "import.*buildShareUrl.*from.*url-state"
    - from: "src/components/tools/EditorPanel.tsx"
      to: "src/lib/tools/dockerfile-analyzer/url-state.ts"
      via: "import decodeFromHash"
      pattern: "import.*decodeFromHash.*from.*url-state"
    - from: "src/components/tools/ResultsPanel.tsx"
      to: "src/components/tools/results/ShareActions.tsx"
      via: "import and render ShareActions"
      pattern: "import.*ShareActions.*from.*results/ShareActions"
---

<objective>
Wire the shareability features into the UI: create the ShareActions component with Download Badge and Copy Share Link buttons, integrate it into ResultsPanel, and add URL hash restore logic to EditorPanel so shared URLs auto-load and analyze the encoded Dockerfile.

Purpose: This plan connects the pure-logic modules from Plan 01 to the user-facing UI, completing both SHARE-01 (badge download) and SHARE-02 (shareable URLs).
Output: Working share buttons in the results panel and URL hash restore on page load.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-shareability/27-RESEARCH.md
@.planning/phases/27-shareability/27-01-SUMMARY.md

@src/components/tools/EditorPanel.tsx
@src/components/tools/ResultsPanel.tsx
@src/components/tools/DockerfileAnalyzer.tsx
@src/lib/tools/dockerfile-analyzer/use-codemirror.ts
@src/stores/dockerfileAnalyzerStore.ts
@src/lib/tools/dockerfile-analyzer/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShareActions component</name>
  <files>src/components/tools/results/ShareActions.tsx</files>
  <action>
    Create `src/components/tools/results/ShareActions.tsx` -- a React component that renders "Download Badge" and "Copy Share Link" buttons.

    **Props:** None. The component reads all data from nanostores and the editorViewRef.

    **Implementation:**
    1. Import `useStore` from `@nanostores/react`, `analysisResult` and `editorViewRef` from the nanostore, `downloadBadgePng` from `badge-generator`, and `buildShareUrl`/`isUrlSafeLength` from `url-state`.
    2. Use `useState` for: `copied` (boolean, false), `urlWarning` (string | null), `downloading` (boolean, false).
    3. If `result` is null/undefined or `!result.parseSuccess` or `result.violations === undefined`, return null (hide buttons).
    4. **handleDownloadBadge:**
       - Set downloading=true
       - Call `await downloadBadgePng(result.score)`
       - Wrap in try/catch (log error on failure)
       - Set downloading=false in finally
    5. **handleCopyLink:**
       - Get editor content from `editorViewRef.get()?.state.doc.toString()` -- if no view or empty content, return early
       - Check `isUrlSafeLength(content)` -- if not safe, set urlWarning to `"URL is ${length} chars -- may be truncated on some platforms"`, otherwise clear warning
       - Call `buildShareUrl(content)` to get the full URL
       - Copy to clipboard via `navigator.clipboard.writeText(url)`
       - Set copied=true, reset to false after 2000ms via setTimeout
       - Update browser URL via `history.replaceState(null, '', url)` so the address bar reflects the shareable URL (using history.replaceState, NOT window.location.hash, to avoid triggering navigation)
    6. **Render:**
       - Container div with `flex flex-wrap gap-2 mt-3 pt-3 border-t border-[var(--color-border)]`
       - Download Badge button: styled like the Analyze button but smaller (`text-xs px-3 py-1.5`), with a download icon (inline SVG arrow-down, 14x14). Disable and show "Saving..." text while downloading=true.
       - Copy Share Link button: same size, secondary style (`border border-[var(--color-border)] bg-transparent hover:bg-white/5`). Show "Copied!" for 2s after copy, with a link icon (inline SVG link, 14x14).
       - If urlWarning is set, show a small amber warning text below the buttons: `text-xs text-amber-400 mt-1`

    **Accessibility:** Both buttons have descriptive text. The "Copied!" state change is communicated via the button text changing (no separate aria-live needed since the button text itself updates).
  </action>
  <verify>
    - `npx tsc --noEmit src/components/tools/results/ShareActions.tsx` compiles
    - File exports ShareActions component
    - Component imports from badge-generator and url-state modules
  </verify>
  <done>ShareActions.tsx renders Download Badge and Copy Share Link buttons; badge downloads PNG on click; copy link writes URL to clipboard with 2s feedback; URL length warning shown when > 2000 chars</done>
</task>

<task type="auto">
  <name>Task 2: Wire ShareActions into ResultsPanel and add URL hash restore to EditorPanel</name>
  <files>src/components/tools/ResultsPanel.tsx, src/components/tools/EditorPanel.tsx, src/lib/tools/dockerfile-analyzer/use-codemirror.ts</files>
  <action>
    **Part A: Add ShareActions to ResultsPanel**

    1. Import `ShareActions` from `./results/ShareActions` at the top of ResultsPanel.tsx.
    2. Render `<ShareActions />` in TWO places within the results display:
       - After the empty state (zero violations): inside the stale wrapper div, after `<EmptyState ... />`, add `<ShareActions />`
       - After the violation list (has violations): inside the stale wrapper div, after `<ViolationList ... />`, add `<ShareActions />`
    3. Do NOT render ShareActions in the "analyzing", "no result", or "parse error" states -- it already handles this internally via its null return, but placing it only in the success states keeps the component tree clean.

    **Part B: URL hash restore in EditorPanel**

    This is the critical integration. The research recommends decoding the hash BEFORE `useCodeMirror` and passing as `initialDoc`. This avoids a race condition where the EditorView isn't ready when the hash decode runs.

    1. Import `decodeFromHash` from `../../lib/tools/dockerfile-analyzer/url-state` in EditorPanel.tsx.
    2. Before the `useCodeMirror` call, compute the initial document:
       ```
       const hashContent = typeof window !== 'undefined' ? decodeFromHash() : null;
       const initialDoc = hashContent || SAMPLE_DOCKERFILE;
       ```
       This reads the hash synchronously before the editor is created.
    3. Pass `initialDoc` (instead of `SAMPLE_DOCKERFILE`) to `useCodeMirror({ initialDoc, onAnalyze: ... })`.
    4. Add a `useEffect` to auto-trigger analysis when loading from a shared URL. This runs AFTER the editor is mounted:
       ```
       useEffect(() => {
         if (hashContent && viewRef.current) {
           analyzeRef.current(viewRef.current);
         }
       }, []);
       ```
       This must come AFTER the `useCodeMirror` call (which creates the EditorView in its own useEffect on mount). Since both use empty deps arrays and run in order of declaration, the editor useEffect fires first, creating the view, then this useEffect fires and triggers analysis.

       IMPORTANT: Store the decoded hash content in a ref (`useRef`) instead of a plain variable, so the useEffect closure captures it correctly:
       ```
       const hashContentRef = useRef<string | null>(
         typeof window !== 'undefined' ? decodeFromHash() : null
       );
       const initialDoc = hashContentRef.current || SAMPLE_DOCKERFILE;
       ```
       Then in the effect: `if (hashContentRef.current && viewRef.current) { ... }`

    **Part C: No changes needed to use-codemirror.ts**

    The `useCodeMirror` hook already accepts `initialDoc` as a prop and uses it as the initial EditorState document. No modifications needed to the hook itself -- the change is only in what EditorPanel passes as `initialDoc`.

    Verify the `useCodeMirror` interface: it takes `{ initialDoc: string; onAnalyze: (view: EditorView) => void }`. This already supports dynamic initial content.
  </action>
  <verify>
    - `npx astro build` completes without errors
    - Open the tool page in browser, analyze a Dockerfile, confirm "Download Badge" and "Copy Share Link" buttons appear below results
    - Click "Download Badge" -- a PNG file downloads
    - Click "Copy Share Link" -- clipboard contains URL with #dockerfile= hash, button shows "Copied!" for 2 seconds
    - Copy the share URL, open in a new tab -- the editor loads with the shared Dockerfile content and analysis runs automatically
    - Open the tool page without a hash -- the sample Dockerfile loads as before (no regression)
  </verify>
  <done>ShareActions visible after analysis in ResultsPanel; badge PNG downloads on click; share URL copies to clipboard; shared URLs auto-load Dockerfile and trigger analysis; sample Dockerfile still loads by default when no hash present</done>
</task>

</tasks>

<verification>
- `npx astro build` succeeds with zero errors
- Tool page at /tools/dockerfile-analyzer/ loads with sample Dockerfile (no hash) -- existing behavior unchanged
- After clicking Analyze, Download Badge and Copy Share Link buttons appear
- Download Badge produces a PNG file with score gauge, category bars, branding
- Copy Share Link produces a URL with #dockerfile= hash that recreates the analysis in a new tab
- URL longer than 2000 chars shows amber warning text
- Share buttons hidden before analysis and on parse error
</verification>

<success_criteria>
- SHARE-01 complete: Users can download a PNG score badge after analysis
- SHARE-02 complete: Users can copy a shareable URL; opening it recreates the analysis
- No regressions: sample Dockerfile loads by default, existing analyze flow unchanged
- All TypeScript compiles without errors
- Accessible: buttons have descriptive text, state changes communicated via button label
</success_criteria>

<output>
After completion, create `.planning/phases/27-shareability/27-02-SUMMARY.md`
</output>
