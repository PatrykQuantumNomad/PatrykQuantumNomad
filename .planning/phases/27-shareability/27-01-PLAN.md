---
phase: 27-shareability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/tools/dockerfile-analyzer/badge-generator.ts
  - src/lib/tools/dockerfile-analyzer/url-state.ts
autonomous: true
requirements: [SHARE-01, SHARE-02]

must_haves:
  truths:
    - "buildBadgeSvg produces a valid standalone SVG string with xmlns, inline styles, score gauge arc, category bars, and branding"
    - "downloadBadgePng rasterizes the SVG to a retina-aware PNG and triggers a browser download"
    - "encodeToHash compresses Dockerfile content into a URL-safe hash fragment"
    - "decodeFromHash reads and decompresses Dockerfile content from the current URL hash"
    - "buildShareUrl returns a full URL with compressed Dockerfile content in the hash"
    - "isUrlSafeLength returns safe=false when URL exceeds 2000 characters"
  artifacts:
    - path: "src/lib/tools/dockerfile-analyzer/badge-generator.ts"
      provides: "SVG badge builder and PNG download function"
      exports: ["buildBadgeSvg", "downloadBadgePng"]
    - path: "src/lib/tools/dockerfile-analyzer/url-state.ts"
      provides: "URL hash encoding/decoding for Dockerfile content"
      exports: ["encodeToHash", "decodeFromHash", "buildShareUrl", "isUrlSafeLength"]
  key_links:
    - from: "src/lib/tools/dockerfile-analyzer/badge-generator.ts"
      to: "src/lib/tools/dockerfile-analyzer/types.ts"
      via: "imports ScoreResult, CategoryScore types"
      pattern: "import.*ScoreResult.*from.*types"
    - from: "src/lib/tools/dockerfile-analyzer/url-state.ts"
      to: "lz-string"
      via: "npm dependency import"
      pattern: "import.*from.*lz-string"
---

<objective>
Install lz-string dependency and create the two core utility modules for Phase 27 shareability features: (1) a programmatic SVG badge generator with Canvas-based PNG export, and (2) URL state encoding/decoding utilities using lz-string compression.

Purpose: These pure-logic modules are prerequisites for the ShareActions UI component in Plan 02. Isolating them ensures they can be implemented and validated independently of UI wiring.
Output: Two new TypeScript modules with exported functions, plus lz-string installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-shareability/27-RESEARCH.md

@src/lib/tools/dockerfile-analyzer/types.ts
@src/components/tools/results/ScoreGauge.tsx
@src/components/tools/results/CategoryBreakdown.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install lz-string and create URL state utilities</name>
  <files>package.json, src/lib/tools/dockerfile-analyzer/url-state.ts</files>
  <action>
    1. Run `npm install lz-string` and `npm install -D @types/lz-string` to add the compression library (~1KB gzipped).

    2. Create `src/lib/tools/dockerfile-analyzer/url-state.ts` with these exports:

    - `encodeToHash(content: string): string` -- Compresses content via `compressToEncodedURIComponent` from lz-string, returns `#dockerfile={compressed}`.
    - `decodeFromHash(): string | null` -- Reads `window.location.hash`, checks for `#dockerfile=` prefix, decompresses and returns content or null. Wrap decompression in try/catch returning null on failure.
    - `buildShareUrl(content: string): string` -- Constructs full URL: `window.location.origin + window.location.pathname + encodeToHash(content)`.
    - `isUrlSafeLength(content: string): { safe: boolean; length: number }` -- Returns safe=true when buildShareUrl result is <= 2000 chars.

    Use `const HASH_PREFIX = '#dockerfile='` for the prefix constant.

    Follow the exact code pattern from the research RESEARCH.md code examples section.
  </action>
  <verify>
    - `npm ls lz-string` shows lz-string installed
    - `npx tsc --noEmit src/lib/tools/dockerfile-analyzer/url-state.ts` compiles without errors (or run `npx astro check` and confirm no new errors in this file)
  </verify>
  <done>url-state.ts exports encodeToHash, decodeFromHash, buildShareUrl, isUrlSafeLength; lz-string is in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create programmatic SVG badge generator with PNG download</name>
  <files>src/lib/tools/dockerfile-analyzer/badge-generator.ts</files>
  <action>
    Create `src/lib/tools/dockerfile-analyzer/badge-generator.ts` with these exports:

    1. **`buildBadgeSvg(score: ScoreResult): string`** -- Builds a 400x200 SVG badge as a string. Import `ScoreResult` and `CategoryScore` from `./types`. The SVG must:
       - Include `xmlns="http://www.w3.org/2000/svg"` (mandatory for standalone SVG rendering in Canvas)
       - Use a dark gradient background (#1a1a2e to #16213e) with 12px border radius
       - Render a circular score gauge (radius 40, stroke-width 6) using stroke-dasharray/stroke-dashoffset for the arc, with `transform="rotate(-90 ...)"` for 12-o'clock start
       - Display the numeric score (white, bold, font-size 22) and letter grade (grade-colored, font-size 13) centered in the gauge
       - Show "Dockerfile Analysis" title text above category bars
       - Render 5 category bars (110px wide) with labels, background tracks, score fill bars, and numeric scores
       - Include branding text "patrykgolabek.dev/tools/dockerfile-analyzer" at the bottom
       - All styles MUST be inline (no CSS classes, no external fonts) -- use `font-family: system-ui, sans-serif` throughout
       - Use the exact category colors from CategoryBreakdown.tsx: security=#ef4444, efficiency=#3b82f6, maintainability=#8b5cf6, reliability=#f59e0b, best-practice=#06b6d4
       - Use the grade color function from ScoreGauge.tsx: A=#22c55e, B=#84cc16, C=#eab308, D=#f97316, F=#ef4444

    2. **`downloadBadgePng(score: ScoreResult): Promise<void>`** -- Rasterizes the SVG to PNG and triggers download:
       - Create a canvas at 400x200 * devicePixelRatio (capped at 3x) for retina clarity
       - Scale context by dpr via `ctx.scale(dpr, dpr)`
       - Create SVG blob with `type: 'image/svg+xml;charset=utf-8'`, load via `URL.createObjectURL` into an Image
       - On image load: draw to canvas, call `canvas.toBlob` for PNG, create temporary `<a>` with `download` attribute
       - Filename pattern: `dockerfile-score-{overall}-{grade}.png`
       - Clean up all object URLs after use
       - Handle errors: throw on null canvas context, null blob, or image load error

    Define CATEGORY_LABELS and CATEGORY_COLORS as module-level Records (matching the values in CategoryBreakdown.tsx). Define getGradeColor locally (matching ScoreGauge.tsx logic).

    Follow the research code examples closely but ensure the SVG string is clean (no extra whitespace that could cause rendering issues).
  </action>
  <verify>
    - `npx tsc --noEmit src/lib/tools/dockerfile-analyzer/badge-generator.ts` compiles without errors (or `npx astro check` shows no new errors)
    - The file exports buildBadgeSvg and downloadBadgePng
    - The SVG template includes xmlns="http://www.w3.org/2000/svg"
  </verify>
  <done>badge-generator.ts exports buildBadgeSvg and downloadBadgePng; SVG contains xmlns, inline styles, gauge arc, category bars, and branding; PNG uses retina-aware canvas scaling</done>
</task>

</tasks>

<verification>
- `npm ls lz-string` confirms installation
- `npx astro build` completes without errors (tree-shaking should exclude unused imports)
- Both new files exist and export the documented functions
- No modifications to existing components (those happen in Plan 02)
</verification>

<success_criteria>
- lz-string is installed in package.json
- badge-generator.ts produces valid SVG with xmlns, score gauge, category bars, branding
- url-state.ts compresses/decompresses Dockerfile content to/from URL hash
- All TypeScript compiles without errors
- No existing files modified (foundation-only plan)
</success_criteria>

<output>
After completion, create `.planning/phases/27-shareability/27-01-SUMMARY.md`
</output>
