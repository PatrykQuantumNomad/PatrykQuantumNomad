---
phase: 53-distribution-pages-with-d3-explorers
plan: 02
type: execute
wave: 2
depends_on: ["53-01"]
files_modified:
  - src/components/eda/DistributionExplorer.tsx
  - src/components/eda/DistributionPage.astro
  - src/pages/eda/distributions/[slug].astro
autonomous: true
requirements: [DIST-01, DIST-02, DIST-03, DIST-04, DIST-05, DIST-06, DIST-07, DIST-08, DIST-09, DIST-10, DIST-11, DIST-12, DIST-13, DIST-14, DIST-15, DIST-16, DIST-17]

must_haves:
  truths:
    - "Each of the 19 distribution pages renders at its defined URL with static SVG fallback visible"
    - "DistributionExplorer React island loads via client:visible and renders dual PDF+CDF charts"
    - "Parameter sliders update PDF+CDF curves in real time without page reload"
    - "Discrete distributions show bar-stem PMF and step CDF in the interactive explorer"
    - "KaTeX formulas for PDF and CDF render at build time on each page"
  artifacts:
    - path: "src/components/eda/DistributionExplorer.tsx"
      provides: "Interactive React island with parameter sliders and dual D3 PDF+CDF charts"
      exports: ["default"]
    - path: "src/components/eda/DistributionPage.astro"
      provides: "Page template with slots for fallback SVG, explorer island, formulas, and related distributions"
      contains: "EDALayout"
    - path: "src/pages/eda/distributions/[slug].astro"
      provides: "Dynamic route generating 19 distribution pages via getStaticPaths"
      contains: "getStaticPaths"
  key_links:
    - from: "src/components/eda/DistributionExplorer.tsx"
      to: "src/lib/eda/math/distribution-math.ts"
      via: "import evalDistribution and getXDomain for client-side chart rendering"
      pattern: "import.*distribution-math"
    - from: "src/pages/eda/distributions/[slug].astro"
      to: "src/lib/eda/svg-generators/distribution-curve.ts"
      via: "import generateDistributionCurve for static SVG fallback"
      pattern: "generateDistributionCurve"
    - from: "src/pages/eda/distributions/[slug].astro"
      to: "src/components/eda/DistributionExplorer.tsx"
      via: "client:visible hydration"
      pattern: "client:visible"
---

<objective>
Build the DistributionExplorer.tsx interactive React island, DistributionPage.astro template, and [slug].astro dynamic route that together produce all 19 distribution pages with static SVG fallbacks and interactive D3 parameter explorers.

Purpose: This is the core deliverable of Phase 53 -- interactive distribution pages where users adjust parameters via sliders and see PDF/CDF curves update in real time, with static SVG fallbacks for no-JS users.

Output: 19 distribution pages at /eda/distributions/{slug}/ with dual PDF+CDF D3 charts, parameter sliders, build-time KaTeX formulas, and static SVG fallbacks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-distribution-pages-with-d3-explorers/53-RESEARCH.md
@.planning/phases/53-distribution-pages-with-d3-explorers/53-01-SUMMARY.md
@src/components/eda/DistributionExplorerStub.tsx
@src/components/eda/TechniquePage.astro
@src/pages/eda/quantitative/[slug].astro
@src/pages/eda/techniques/[slug].astro
@src/lib/eda/math/distribution-math.ts
@src/lib/eda/svg-generators/distribution-curve.ts
@src/lib/eda/routes.ts
@src/lib/eda/schema.ts
@src/data/eda/distributions.json
@src/layouts/EDALayout.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DistributionExplorer.tsx React island with parameter sliders and D3 dual charts</name>
  <files>src/components/eda/DistributionExplorer.tsx</files>
  <action>
Replace DistributionExplorerStub.tsx with a full DistributionExplorer.tsx. The stub file can remain for the test page but the new component is the production version.

Create `src/components/eda/DistributionExplorer.tsx` that:

**Props interface:**
```typescript
interface Parameter {
  name: string;
  symbol: string;
  min: number;
  max: number;
  default: number;
  step: number;
}

interface Props {
  distributionId: string;
  parameters: Parameter[];
  title: string;
  isDiscrete?: boolean;
}
```

**State management:**
- useState for parameter values, initialized from parameter defaults: `Object.fromEntries(parameters.map(p => [p.name, p.default]))`
- useCallback for updateParam to avoid re-renders

**D3 rendering (in useEffect that depends on [params, distributionId, isDiscrete]):**
1. Import ONLY from D3 micro-modules: `d3-selection`, `d3-scale`, `d3-shape`, `d3-axis` (locked decision -- NEVER full d3)
2. Import `evalDistribution`, `getXDomain`, `isDiscrete as isDiscreteCheck` from `../../lib/eda/math/distribution-math`
3. Two separate SVG refs: pdfRef and cdfRef
4. SVG cleanup on mount: `select(svgRef).selectAll('*').remove()` (locked decision from 48-03)
5. Return cleanup function from useEffect: `() => { select(pdfRef).selectAll('*').remove(); select(cdfRef).selectAll('*').remove(); }`

**Chart rendering function `renderChart(svgEl, chartType, distId, params, discrete)`:**
- viewBox: "0 0 400 250" (responsive via CSS, no fixed width/height -- SVG-12)
- Margin: { top: 20, right: 20, bottom: 35, left: 45 }
- Compute x-domain via getXDomain(distId, params)
- For continuous distributions (chartType=pdf): Generate 200 points, render with d3-shape `line` generator + `curveBasis`, fill area under PDF curve with opacity 0.1
- For continuous distributions (chartType=cdf): Same 200 points, render with `line` + `curveBasis`
- For discrete distributions (chartType=pdf/pmf): Iterate integer k values in x-domain, render vertical lines (bar-stems) from baseline to PMF value at each k, with circles at tops. Use lollipop style (line+circle) matching ACF plot pattern.
- For discrete distributions (chartType=cdf): Use `curveStepAfter` for step function rendering
- D3 axis: axisBottom(xScale).ticks(7), axisLeft(yScale).ticks(5)
- Colors: Use CSS custom properties from global.css: `var(--color-accent)` for data line, `var(--color-text-secondary)` for axis text, `var(--color-border)` for grid lines. These are already available in the EDA pages.
- Chart title: "PDF" or "CDF" rendered as text element at top

**Slider UI:**
- Flex wrap container with gap-4 for parameter sliders
- Each slider is a `<label>` with: parameter symbol display (raw text, not KaTeX -- too heavy for client), current value display, native `<input type="range">`
- Slider styling: Tailwind classes for consistent look with the site theme
- React's onChange (maps to input event) for real-time updates
- min-w-[160px] per slider label to prevent cramming on mobile

**Layout:**
- Parameter sliders at top in a flex-wrap row
- Grid: 1 column on mobile (grid-cols-1), 2 columns on md+ (md:grid-cols-2) for PDF and CDF side by side
- Each chart container has an h4 label ("PDF" / "CDF", or "PMF" / "CDF" for discrete)
- SVGs use `style={{ width: '100%' }}` with no maxWidth constraint (the viewBox handles scaling)

**Accessibility:**
- Each slider has aria-label with parameter name
- SVGs have role="img" and aria-label describing the chart

**Touch-friendliness:**
- Native `<input type="range">` is inherently touch-friendly (no custom gesture handling needed)
- Sliders have min-h-[44px] tap target via padding

Do NOT add ResizeObserver (research confirmed viewBox-based responsive sizing is sufficient).
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npx tsx -e "
import DistributionExplorer from './src/components/eda/DistributionExplorer';
console.log('DistributionExplorer export:', typeof DistributionExplorer);
if (typeof DistributionExplorer !== 'function') process.exit(1);
console.log('PASS: DistributionExplorer is a function component');
" && echo "--- Checking D3 imports ---" && grep -c 'from.*d3-' src/components/eda/DistributionExplorer.tsx && grep -c "import \* as d3" src/components/eda/DistributionExplorer.tsx || true</automated>
    <manual>DistributionExplorer.tsx exports a function component, imports only D3 micro-modules (not full d3)</manual>
  </verify>
  <done>DistributionExplorer.tsx is a complete React island component with parameter sliders, dual PDF+CDF D3 charts, discrete distribution support, SVG cleanup on mount/unmount, and touch-friendly controls.</done>
</task>

<task type="auto">
  <name>Task 2: Create DistributionPage.astro template and [slug].astro dynamic route for 19 distribution pages</name>
  <files>
    src/components/eda/DistributionPage.astro
    src/pages/eda/distributions/[slug].astro
  </files>
  <action>
**DistributionPage.astro** -- Follow the TechniquePage.astro pattern but for distribution pages:

```typescript
interface Props {
  title: string;
  description: string;
  nistSection: string;
  slug: string;
  relatedDistributions?: Array<{ slug: string; name: string; url: string }>;
}
```

- Use EDALayout with `useKatex={true}` (all distribution pages have formulas)
- BreadcrumbJsonLd: Home > EDA > Distributions > {title}
- EdaBreadcrumb: category="Distributions"
- Header: h1 title + NIST section reference
- Named slots: `fallback` (static SVG), `explorer` (React island), `formulas` (KaTeX), `properties` (mean/variance), `description` (prose)
- Related distributions section at bottom (same pill style as TechniquePage related techniques)
- `max-w-4xl` container (wider than technique pages to accommodate dual charts)

**[slug].astro** dynamic route -- Follow the quantitative/[slug].astro pattern:

```typescript
export async function getStaticPaths() {
  const distributions = await getCollection('edaDistributions');
  // Build a map for related distribution URL resolution
  const distMap = new Map(distributions.map(d => [d.data.slug, d.data]));

  return distributions.map(dist => ({
    params: { slug: dist.data.slug },
    props: {
      distribution: dist.data,
      relatedDistributions: dist.data.relatedDistributions
        .filter(slug => distMap.has(slug))
        .map(slug => ({
          slug,
          name: distMap.get(slug)!.title,
          url: distributionUrl(slug),
        })),
    },
  }));
}
```

**For each page, render:**
1. **Static SVG fallback** (slot="fallback"): Call `generateDistributionCurve()` twice (pdf + cdf) with default parameters. Wrap in a div with `class="distribution-fallback"` and `data-distribution-fallback` attribute. Add CSS: when a sibling `.distribution-explorer-active` class exists, hide the fallback.
2. **DistributionExplorer island** (slot="explorer"): `<DistributionExplorer client:visible distributionId={dist.id} parameters={dist.parameters} title={dist.title} isDiscrete={isDiscrete} />`. The island should set a state class `distribution-explorer-active` on its container when mounted to hide the fallback.
3. **KaTeX formulas** (slot="formulas"): Render pdfFormula and cdfFormula via `katex.renderToString(formula, { displayMode: true, throwOnError: false })` at build time. Display with labels "Probability Density Function" / "Cumulative Distribution Function" (or "Probability Mass Function" for discrete).
4. **Properties** (slot="properties"): Mean and Variance formulas rendered via KaTeX.
5. **Description** (slot="description"): The description text from distributions.json.

**Fallback hiding strategy:** Use a simple approach -- the DistributionExplorer.tsx adds `data-explorer-active` attribute to its container div on mount. CSS rule: `.distribution-fallback:has(~ [data-explorer-active]) { display: none; }`. If `:has()` is not supported (unlikely in 2026 but safe to handle), the fallback just stays visible alongside the explorer (graceful degradation).

**Determine discrete:** `const isDiscrete = ['binomial', 'poisson'].includes(distribution.id);`

**Imports:**
- `getCollection` from 'astro:content'
- `katex` from 'katex'
- `DistributionPage` from component
- `DistributionExplorer` from component
- `generateDistributionCurve` from svg-generators
- `distributionUrl` from routes
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npm run build 2>&1 | tail -10 && echo "--- Checking distribution pages ---" && ls dist/eda/distributions/normal/index.html dist/eda/distributions/beta/index.html dist/eda/distributions/binomial/index.html dist/eda/distributions/poisson/index.html dist/eda/distributions/tukey-lambda/index.html 2>&1 && echo "--- Checking page count ---" && COUNT=$(ls -d dist/eda/distributions/*/index.html 2>/dev/null | wc -l | tr -d ' ') && echo "Distribution pages: $COUNT" && [ "$COUNT" -eq 19 ] || { echo "FAIL: Expected 19 distribution pages, got $COUNT"; exit 1; }</automated>
    <manual>19 distribution pages exist in build output at /eda/distributions/{slug}/, each contains SVG fallback and DistributionExplorer island reference</manual>
  </verify>
  <done>19 distribution pages build at /eda/distributions/{slug}/ with static SVG fallbacks, DistributionExplorer client:visible island, KaTeX formulas, mean/variance properties, description, and related distribution links.</done>
</task>

</tasks>

<verification>
- 19 distribution pages render at their defined URLs in the build output
- Each page contains static SVG (visible before JS loads)
- Each page contains DistributionExplorer island reference with client:visible
- KaTeX formulas render correctly (no raw LaTeX in HTML)
- Related distribution links resolve to valid URLs
- D3 micro-module imports only (no full d3 import)
- SVG cleanup on mount+unmount present in DistributionExplorer
- Build passes without errors or regressions
</verification>

<success_criteria>
- DistributionExplorer.tsx renders dual PDF+CDF D3 charts with real-time parameter slider updates
- DistributionPage.astro provides slot-based template with breadcrumbs, JSON-LD, and EDALayout
- [slug].astro generates all 19 pages via getStaticPaths from edaDistributions collection
- npm run build produces exactly 19 distribution page HTML files with no errors
- DIST-01 through DIST-17 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/53-distribution-pages-with-d3-explorers/53-02-SUMMARY.md`
</output>
