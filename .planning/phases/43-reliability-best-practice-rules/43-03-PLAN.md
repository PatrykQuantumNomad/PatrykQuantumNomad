---
phase: 43-reliability-best-practice-rules
plan: 03
type: execute
wave: 2
depends_on: ["43-01", "43-02"]
files_modified:
  - src/lib/tools/k8s-analyzer/rules/index.ts
  - src/lib/tools/k8s-analyzer/sample-manifest.ts
autonomous: true
requirements:
  - REL-01
  - REL-02
  - REL-03
  - REL-04
  - REL-05
  - REL-06
  - REL-07
  - REL-08
  - REL-09
  - REL-10
  - REL-11
  - REL-12
  - BP-01
  - BP-02
  - BP-03
  - BP-04
  - BP-05
  - BP-06
  - BP-07
  - BP-08
  - BP-09
  - BP-10
  - BP-11
  - BP-12

must_haves:
  truths:
    - "allK8sRules contains all 20 security + 12 reliability + 12 best practice = 44 rules"
    - "The sample manifest triggers at least one reliability rule and one best practice rule"
    - "Engine totalRules auto-includes the 24 new rules via allK8sRules.length formula"
    - "TypeScript full project build compiles without errors"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/rules/index.ts"
      provides: "Master rule index with security + reliability + best-practice rules"
      exports: ["allK8sRules", "allDocumentedK8sRules", "getK8sRuleById"]
      contains: "reliabilityRules"
    - path: "src/lib/tools/k8s-analyzer/sample-manifest.ts"
      provides: "Updated sample manifest triggering reliability and best practice violations"
      contains: "SAMPLE_K8S_MANIFEST"
  key_links:
    - from: "src/lib/tools/k8s-analyzer/rules/index.ts"
      to: "./reliability"
      via: "import reliabilityRules"
      pattern: "import.*reliabilityRules.*from './reliability'"
    - from: "src/lib/tools/k8s-analyzer/rules/index.ts"
      to: "./best-practice"
      via: "import bestPracticeRules"
      pattern: "import.*bestPracticeRules.*from './best-practice'"
    - from: "src/lib/tools/k8s-analyzer/rules/index.ts"
      to: "allK8sRules spread"
      via: "spread operators combining all three categories"
      pattern: "\\.\\.\\.reliabilityRules.*\\.\\.\\.bestPracticeRules"
---

<objective>
Integrate reliability and best practice rules into the master index and update the sample manifest to trigger representative violations from both new rule categories.

Purpose: Wires the 24 new rules into the engine pipeline (via allK8sRules) and ensures the sample manifest demonstrates reliability/best-practice diagnostics alongside existing security and schema diagnostics.
Output: Updated rules/index.ts with 44 total rules, updated sample-manifest.ts with reliability/BP violation triggers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-reliability-best-practice-rules/43-01-SUMMARY.md
@.planning/phases/43-reliability-best-practice-rules/43-02-SUMMARY.md
@.planning/phases/42-security-rules/42-02-SUMMARY.md
@src/lib/tools/k8s-analyzer/rules/index.ts
@src/lib/tools/k8s-analyzer/sample-manifest.ts
@src/lib/tools/k8s-analyzer/engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update master rules index to include reliability and best practice rules</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/index.ts
  </files>
  <action>
Update rules/index.ts to import and spread the two new rule category arrays:

1. Add imports:
   - import { reliabilityRules } from './reliability';
   - import { bestPracticeRules } from './best-practice';

2. Update allK8sRules array to spread all three categories:
   ```
   export const allK8sRules: K8sLintRule[] = [
     ...securityRules,
     ...reliabilityRules,
     ...bestPracticeRules,
   ];
   ```

3. Remove the Phase 43 placeholder comments ("Phase 43 will add: ...reliabilityRules, ...bestPracticeRules").

4. Verify allDocumentedK8sRules already spreads allK8sRules (no change needed there).

5. No engine.ts changes needed -- totalRules = 10 + allK8sRules.length already accounts for new rules dynamically.
  </action>
  <verify>
    npx tsc --noEmit --project /Users/patrykattc/work/git/PatrykQuantumNomad/tsconfig.json 2>&1 | tail -5
  </verify>
  <done>rules/index.ts imports reliabilityRules and bestPracticeRules, allK8sRules contains 44 rules (20 security + 12 reliability + 12 best practice), TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Update sample manifest with reliability and best practice violation triggers</name>
  <files>
    src/lib/tools/k8s-analyzer/sample-manifest.ts
  </files>
  <action>
Update the sample manifest to trigger representative reliability and best practice violations while keeping total manifest under 250 lines. Modify existing resources and add 1-2 new ones:

1. **Existing web-frontend Deployment (already has replicas: 3, resources, image tag):** This resource is well-configured. Add a livenessProbe and readinessProbe that are IDENTICAL to trigger KA-R003 (identical probes). Example: both with httpGet path /healthz port 80, same initialDelaySeconds/periodSeconds. This also means it WON'T trigger R001/R002 (good -- shows compliant probes).

2. **Existing insecure-app Deployment (replicas: 1, no probes):** Already triggers security rules. It also naturally triggers: KA-R001 (no liveness), KA-R002 (no readiness), KA-R004 (single replica), KA-R006 (no strategy specified -- but default IS RollingUpdate, so R006 should NOT fire). No resource limits on app container triggers B001-B004. Missing 'version' label triggers B005. Add explicit `strategy: { type: Recreate }` to trigger KA-R006.

3. **Add a new CronJob resource** (after the debug-pod) to trigger KA-R012 (missing startingDeadlineSeconds). Also trigger B001-B004 (no resource limits), R009 (latest tag). Example:
   ```yaml
   apiVersion: batch/v1
   kind: CronJob
   metadata:
     name: cleanup-job
     namespace: online-store
   spec:
     schedule: "0 2 * * *"
     jobTemplate:
       spec:
         template:
           spec:
             restartPolicy: OnFailure
             containers:
               - name: cleanup
                 image: myapp/cleanup
   ```
   This triggers: R012 (no startingDeadlineSeconds), R009 (no image tag = implicit latest), B001-B004 (no resources), B005 (no app/version labels).

4. **Add a NodePort Service** (after existing Service) to trigger KA-B008:
   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: debug-nodeport
     namespace: online-store
   spec:
     type: NodePort
     selector:
       app: debug
     ports:
       - port: 8080
         targetPort: 8080
         nodePort: 30080
   ```

5. **Update the file's JSDoc comment** to list the new rule triggers: KA-R001, KA-R002, KA-R003, KA-R004, KA-R006, KA-R009, KA-R012, KA-B001-B004, KA-B005, KA-B008.

Keep the manifest as a readable "online store" example. Keep total lines under 250.
  </action>
  <verify>
    npx tsc --noEmit --project /Users/patrykattc/work/git/PatrykQuantumNomad/tsconfig.json 2>&1 | tail -5; echo "---"; wc -l /Users/patrykattc/work/git/PatrykQuantumNomad/src/lib/tools/k8s-analyzer/sample-manifest.ts
  </verify>
  <done>Sample manifest compiles, stays under 250 lines, and contains resources that trigger at least: KA-R001/R002 (missing probes), KA-R003 (identical probes), KA-R004 (single replica), KA-R006 (Recreate strategy), KA-R009 (latest/no tag), KA-R012 (CronJob deadline), KA-B001-B004 (missing resources), KA-B005 (missing labels), KA-B008 (NodePort).</done>
</task>

</tasks>

<verification>
- rules/index.ts imports and spreads reliabilityRules and bestPracticeRules
- allK8sRules.length === 44 (20 + 12 + 12)
- No placeholder comments remain in rules/index.ts
- Sample manifest triggers rules from all 3 custom categories (security, reliability, best-practice)
- Sample manifest stays under 250 lines
- Engine totalRules formula (10 + allK8sRules.length) now equals 54
- Full TypeScript project compiles: npx tsc --noEmit
- Astro build succeeds: npx astro check (if available) or npx astro build --dry-run
</verification>

<success_criteria>
All 24 Phase 43 rules are wired into the engine pipeline via allK8sRules. Sample manifest demonstrates the new rule categories. Full project compiles cleanly. The engine will automatically execute all 44 custom lint rules on any manifest.
</success_criteria>

<output>
After completion, create `.planning/phases/43-reliability-best-practice-rules/43-03-SUMMARY.md`
</output>
