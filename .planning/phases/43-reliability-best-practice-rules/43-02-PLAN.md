---
phase: 43-reliability-best-practice-rules
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B001-missing-cpu-requests.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B002-missing-cpu-limits.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B003-missing-memory-requests.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B004-missing-memory-limits.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B005-missing-labels.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B006-missing-namespace.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B007-ssh-port-exposed.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B008-nodeport-service.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B009-liveness-probe-port.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B010-readiness-probe-port.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B011-missing-priority-class.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/KA-B012-duplicate-env-keys.ts
  - src/lib/tools/k8s-analyzer/rules/best-practice/index.ts
autonomous: true
requirements:
  - BP-01
  - BP-02
  - BP-03
  - BP-04
  - BP-05
  - BP-06
  - BP-07
  - BP-08
  - BP-09
  - BP-10
  - BP-11
  - BP-12

must_haves:
  truths:
    - "A container without CPU requests produces a KA-B001 warning"
    - "A container without CPU limits produces a KA-B002 warning"
    - "A container without memory requests produces a KA-B003 warning"
    - "A container without memory limits produces a KA-B004 warning"
    - "A resource missing app or version labels produces a KA-B005 info"
    - "A resource without explicit namespace in metadata produces a KA-B006 info"
    - "A container exposing port 22 produces a KA-B007 info"
    - "A Service with type NodePort produces a KA-B008 info"
    - "A liveness probe port not matching container ports produces a KA-B009 warning"
    - "A readiness probe port not matching container ports produces a KA-B010 warning"
    - "A workload without priorityClassName produces a KA-B011 info"
    - "A container with duplicate env var names produces a KA-B012 warning"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/rules/best-practice/index.ts"
      provides: "bestPracticeRules array with 12 K8sLintRule entries"
      exports: ["bestPracticeRules"]
    - path: "src/lib/tools/k8s-analyzer/rules/best-practice/KA-B005-missing-labels.ts"
      provides: "KA-B005 rule checking for app and version labels"
      exports: ["KAB005"]
    - path: "src/lib/tools/k8s-analyzer/rules/best-practice/KA-B009-liveness-probe-port.ts"
      provides: "KA-B009 rule with probe port extraction supporting named and numeric ports"
      exports: ["KAB009"]
  key_links:
    - from: "src/lib/tools/k8s-analyzer/rules/best-practice/*.ts"
      to: "../../types"
      via: "import K8sLintRule, K8sRuleContext, K8sRuleViolation"
      pattern: "import type.*from '../../types'"
    - from: "src/lib/tools/k8s-analyzer/rules/best-practice/*.ts"
      to: "../../container-helpers"
      via: "getContainerSpecs/getPodSpec for workload iteration"
      pattern: "import.*from '../../container-helpers'"
    - from: "src/lib/tools/k8s-analyzer/rules/best-practice/index.ts"
      to: "individual rule files"
      via: "imports all 12 rules into bestPracticeRules array"
      pattern: "export const bestPracticeRules"
---

<objective>
Create all 12 best practice rules (KA-B001 through KA-B012) for the K8s Manifest Analyzer, covering resource requests/limits, labels, namespace, ports, probe port validation, priority class, and duplicate env vars.

Purpose: These rules detect best practice violations that indicate resources are not configured for production quality -- missing resource governance, lacking organizational metadata, or having misconfigured probes.
Output: 12 rule files in rules/best-practice/ plus an index.ts aggregator exporting bestPracticeRules array.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-reliability-best-practice-rules/43-RESEARCH.md
@.planning/phases/42-security-rules/42-01-SUMMARY.md
@src/lib/tools/k8s-analyzer/types.ts
@src/lib/tools/k8s-analyzer/container-helpers.ts
@src/lib/tools/k8s-analyzer/parser.ts
@src/lib/tools/k8s-analyzer/rules/security/KA-C001-privileged-container.ts
@src/lib/tools/k8s-analyzer/rules/security/KA-C019-default-namespace.ts
@src/lib/tools/k8s-analyzer/rules/security/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create best practice rules KA-B001 through KA-B006</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B001-missing-cpu-requests.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B002-missing-cpu-limits.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B003-missing-memory-requests.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B004-missing-memory-limits.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B005-missing-labels.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B006-missing-namespace.ts
  </files>
  <action>
Create the rules/best-practice/ directory and implement 6 best practice rules following the Phase 42 security rule pattern.

**KA-B001 (warning, container-level):** Use getContainerSpecs to check ALL containers (including initContainers). Flag if container.resources?.requests?.cpu is missing/undefined. Resolve AST at jsonPath/resources if resources object exists, or at jsonPath if no resources at all. Message: "Container '{name}' in {kind} '{resourceName}' has no CPU request defined."

**KA-B002 (warning, container-level):** Same pattern as B001 but check resources?.limits?.cpu. Message: "...has no CPU limit defined."

**KA-B003 (warning, container-level):** Same pattern as B001 but check resources?.requests?.memory. Message: "...has no memory request defined."

**KA-B004 (warning, container-level):** Same pattern as B001 but check resources?.limits?.memory. Message: "...has no memory limit defined."

**KA-B005 (info, resource-level):** Check resource.json.metadata.labels for presence of 'app' and 'version' keys. The requirement says 'app' and 'version' (simple labels, not the fully qualified app.kubernetes.io/name). Fire ONE violation per resource listing ALL missing labels (e.g., "missing labels: app, version"). Skip resources that have no metadata.labels at all (flag both missing). Resolve AST at /metadata/labels if labels exist, or /metadata if no labels. Apply to ALL resource kinds.

**KA-B006 (info, resource-level):** Check if resource.json.metadata.namespace is literally undefined (field not present in the YAML). This is different from KA-C019 which fires when namespace equals 'default'. BP-06 fires when namespace is ABSENT. Skip cluster-scoped resources: Namespace, ClusterRole, ClusterRoleBinding, PersistentVolume, Node, CustomResourceDefinition (same skip list as KA-C019). Resolve AST at /metadata. Message: "{kind} '{name}' does not specify a namespace."

Each rule: export named const (KAB001, etc.), implement K8sLintRule, category: 'best-practice', proper explanation and fix with beforeCode/afterCode.
  </action>
  <verify>
    npx tsc --noEmit --project /Users/patrykattc/work/git/PatrykQuantumNomad/tsconfig.json 2>&1 | grep -E "k8s-analyzer/rules/best-practice" | head -20; echo "---"; ls -la /Users/patrykattc/work/git/PatrykQuantumNomad/src/lib/tools/k8s-analyzer/rules/best-practice/KA-B00*.ts | wc -l
  </verify>
  <done>6 best practice rule files (KA-B001 through KA-B006) exist in rules/best-practice/, each exports a K8sLintRule with category 'best-practice', and TypeScript compiles without errors for these files.</done>
</task>

<task type="auto">
  <name>Task 2: Create best practice rules KA-B007 through KA-B012 and best-practice index</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B007-ssh-port-exposed.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B008-nodeport-service.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B009-liveness-probe-port.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B010-readiness-probe-port.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B011-missing-priority-class.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/KA-B012-duplicate-env-keys.ts
    src/lib/tools/k8s-analyzer/rules/best-practice/index.ts
  </files>
  <action>
Implement 6 more best practice rules and the category index:

**KA-B007 (info, container-level):** Use getContainerSpecs to check ALL containers. Check container.ports array for any entry where containerPort === 22. Resolve AST at the specific port entry (e.g., jsonPath/ports/i). Message: "Container '{name}' exposes SSH port 22."

**KA-B008 (info, Service-level):** Check Service resources only (resource.kind === 'Service'). Flag if spec.type === 'NodePort'. Resolve AST at /spec/type. Message: "Service '{name}' uses NodePort type. Prefer ClusterIP with Ingress or LoadBalancer."

**KA-B009 (warning, container-level):** Check containers only (NOT initContainers -- filter containerType === 'container'). For containers that have a livenessProbe, extract the probe port using a module-private getProbePort function (check httpGet.port then tcpSocket.port). If the probe specifies a port, build a Set of declared ports from container.ports (include both numeric containerPort values AND string name values). If the probe port is not in the declared set, flag. If the container has no ports array declared at all, skip (no false positive). Resolve AST at jsonPath/livenessProbe.

**KA-B010 (warning, container-level):** Same pattern as B009 but check readinessProbe instead of livenessProbe. Share the getProbePort and getDeclaredPorts helper functions by defining them in B009 file and importing in B010, OR define them in both files (duplicating ~15 lines is acceptable for rule isolation). Resolve AST at jsonPath/readinessProbe.

**KA-B011 (info, pod-level):** Use getPodSpec() to check for absence of priorityClassName on the podSpec. If podSpec.priorityClassName is undefined, flag. Apply to all workload kinds with a PodSpec. Resolve AST at the podSpecPath.

**KA-B012 (warning, container-level):** Check ALL containers (including initContainers). Scan container.env array for duplicate name fields. Use a Map to track seen names and their first index. On duplicate, fire violation pointing to the later occurrence (resolve AST at jsonPath/env/i/name). Fire one violation per duplicate occurrence (not per pair).

**best-practice/index.ts:** Import all 12 rule exports (KAB001 through KAB012) and export bestPracticeRules: K8sLintRule[] array. Follow exact pattern from security/index.ts.
  </action>
  <verify>
    npx tsc --noEmit --project /Users/patrykattc/work/git/PatrykQuantumNomad/tsconfig.json 2>&1 | grep -E "k8s-analyzer/rules/best-practice" | head -20; echo "---"; ls /Users/patrykattc/work/git/PatrykQuantumNomad/src/lib/tools/k8s-analyzer/rules/best-practice/*.ts | wc -l
  </verify>
  <done>13 files in rules/best-practice/ (12 rule files + index.ts), all compile without TypeScript errors, best-practice/index.ts exports bestPracticeRules array with 12 entries.</done>
</task>

</tasks>

<verification>
- All 12 best practice rule files exist in src/lib/tools/k8s-analyzer/rules/best-practice/
- best-practice/index.ts exports bestPracticeRules: K8sLintRule[] with 12 entries
- Every rule has category: 'best-practice'
- Resource limit rules (B001-B004) check ALL containers including initContainers
- B005 fires ONE violation per resource listing all missing labels
- B006 checks for literally absent namespace (not namespace === 'default', which is KA-C019)
- B006 skips cluster-scoped resources (Namespace, ClusterRole, ClusterRoleBinding, etc.)
- B009/B010 filter to containerType === 'container' (exclude initContainers)
- B009/B010 handle both numeric and named port references
- B012 fires per duplicate occurrence, not per pair
- TypeScript compiles with no errors: npx tsc --noEmit
</verification>

<success_criteria>
12 best practice rules and index aggregator compile cleanly and follow the Phase 42 rule pattern exactly. Each rule implements K8sLintRule with proper id, title, severity, category, explanation, fix, and check() method.
</success_criteria>

<output>
After completion, create `.planning/phases/43-reliability-best-practice-rules/43-02-SUMMARY.md`
</output>
