---
phase: 43-reliability-best-practice-rules
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R001-missing-liveness-probe.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R002-missing-readiness-probe.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R003-identical-probes.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R004-single-replica.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R005-missing-pdb.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R006-no-rolling-update.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R007-missing-anti-affinity.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R008-missing-topology-spread.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R009-latest-image-tag.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R010-image-pull-policy.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R011-selector-mismatch.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/KA-R012-cronjob-missing-deadline.ts
  - src/lib/tools/k8s-analyzer/rules/reliability/index.ts
autonomous: true
requirements:
  - REL-01
  - REL-02
  - REL-03
  - REL-04
  - REL-05
  - REL-06
  - REL-07
  - REL-08
  - REL-09
  - REL-10
  - REL-11
  - REL-12

must_haves:
  truths:
    - "A container without a livenessProbe produces a KA-R001 warning"
    - "A container without a readinessProbe produces a KA-R002 warning"
    - "A container with identical liveness and readiness probes produces a KA-R003 warning"
    - "A Deployment with 1 or unset replicas produces a KA-R004 warning"
    - "A Deployment without a PodDisruptionBudget produces a KA-R005 info"
    - "A Deployment without RollingUpdate strategy produces a KA-R006 warning"
    - "A workload without podAntiAffinity produces a KA-R007 info"
    - "A workload without topologySpreadConstraints produces a KA-R008 info"
    - "A container using latest or no image tag produces a KA-R009 warning"
    - "A container with imagePullPolicy not Always produces a KA-R010 info"
    - "A Deployment with selector/template label mismatch produces a KA-R011 error"
    - "A CronJob without startingDeadlineSeconds produces a KA-R012 warning"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/rules/reliability/index.ts"
      provides: "reliabilityRules array with 12 K8sLintRule entries"
      exports: ["reliabilityRules"]
    - path: "src/lib/tools/k8s-analyzer/rules/reliability/KA-R001-missing-liveness-probe.ts"
      provides: "KA-R001 rule implementation"
      exports: ["KAR001"]
    - path: "src/lib/tools/k8s-analyzer/rules/reliability/KA-R009-latest-image-tag.ts"
      provides: "KA-R009 rule with image tag parser handling registry ports"
      exports: ["KAR009"]
    - path: "src/lib/tools/k8s-analyzer/rules/reliability/KA-R011-selector-mismatch.ts"
      provides: "KA-R011 rule checking selector is subset of template labels"
      exports: ["KAR011"]
  key_links:
    - from: "src/lib/tools/k8s-analyzer/rules/reliability/*.ts"
      to: "../../types"
      via: "import K8sLintRule, K8sRuleContext, K8sRuleViolation"
      pattern: "import type.*from '../../types'"
    - from: "src/lib/tools/k8s-analyzer/rules/reliability/*.ts"
      to: "../../container-helpers"
      via: "getContainerSpecs/getPodSpec for workload iteration"
      pattern: "import.*from '../../container-helpers'"
    - from: "src/lib/tools/k8s-analyzer/rules/reliability/index.ts"
      to: "individual rule files"
      via: "imports all 12 rules into reliabilityRules array"
      pattern: "export const reliabilityRules"
---

<objective>
Create all 12 reliability rules (KA-R001 through KA-R012) for the K8s Manifest Analyzer, covering probes, replicas, update strategy, image tags, selectors, and CronJob deadline checks.

Purpose: These rules detect reliability issues that could cause downtime, failed rollouts, or degraded availability in production Kubernetes workloads.
Output: 12 rule files in rules/reliability/ plus an index.ts aggregator exporting reliabilityRules array.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-reliability-best-practice-rules/43-RESEARCH.md
@.planning/phases/42-security-rules/42-01-SUMMARY.md
@src/lib/tools/k8s-analyzer/types.ts
@src/lib/tools/k8s-analyzer/container-helpers.ts
@src/lib/tools/k8s-analyzer/parser.ts
@src/lib/tools/k8s-analyzer/rules/security/KA-C001-privileged-container.ts
@src/lib/tools/k8s-analyzer/rules/security/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reliability rules KA-R001 through KA-R006</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R001-missing-liveness-probe.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R002-missing-readiness-probe.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R003-identical-probes.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R004-single-replica.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R005-missing-pdb.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R006-no-rolling-update.ts
  </files>
  <action>
Create the rules/reliability/ directory and implement 6 reliability rules following the exact Phase 42 security rule pattern (import types from ../../types, parser from ../../parser, container-helpers from ../../container-helpers).

**KA-R001 (warning, container-level):** Check each container (NOT initContainers -- filter to containerType === 'container') for missing livenessProbe. Use getContainerSpecs, skip containers where containerType !== 'container'. Resolve AST node at jsonPath for line number.

**KA-R002 (warning, container-level):** Same pattern as R001 but check for missing readinessProbe. Filter to containerType === 'container' only.

**KA-R003 (warning, container-level):** Check containers (NOT initContainers) that have BOTH livenessProbe AND readinessProbe. Compare using a stableStringify helper function (recursive sorted key JSON serialization) since JSON.stringify alone may not handle nested key ordering. Define stableStringify as a module-private function in the same file. Only flag if both probes exist and are identical.

**KA-R004 (warning, deployment-level):** Check Deployment resources only (resource.kind === 'Deployment'). Flag if spec.replicas is 1 OR undefined (K8s default is 1). Resolve AST node at /spec/replicas if defined, or /spec if replicas is omitted.

**KA-R005 (info, deployment-level):** For Deployment resources with 2+ replicas, emit informational recommendation "Consider adding a PodDisruptionBudget for high availability." DO NOT attempt registry.getByKind('PodDisruptionBudget') as PDB is not in the GVK registry -- just recommend it. Resolve AST node at /spec.

**KA-R006 (warning, deployment-level):** Check Deployment resources. Flag if spec.strategy.type is not 'RollingUpdate'. Note: if strategy is completely absent, Kubernetes defaults to RollingUpdate, so only flag when strategy exists and type is not RollingUpdate (e.g., Recreate). Resolve AST node at /spec/strategy/type.

Each rule must export a named const (e.g., KAR001) implementing K8sLintRule with id, title, severity, category: 'reliability', explanation, fix (with beforeCode/afterCode), and check(ctx) method. Follow the exact code style from KA-C001 (2-space indent, single quotes, trailing commas).
  </action>
  <verify>
    npx tsc --noEmit --project /Users/patrykattc/work/git/PatrykQuantumNomad/tsconfig.json 2>&1 | grep -E "k8s-analyzer/rules/reliability" | head -20; echo "---"; ls -la /Users/patrykattc/work/git/PatrykQuantumNomad/src/lib/tools/k8s-analyzer/rules/reliability/KA-R00*.ts | wc -l
  </verify>
  <done>6 reliability rule files (KA-R001 through KA-R006) exist in rules/reliability/, each exports a K8sLintRule with category 'reliability', and TypeScript compiles without errors for these files.</done>
</task>

<task type="auto">
  <name>Task 2: Create reliability rules KA-R007 through KA-R012 and reliability index</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R007-missing-anti-affinity.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R008-missing-topology-spread.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R009-latest-image-tag.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R010-image-pull-policy.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R011-selector-mismatch.ts
    src/lib/tools/k8s-analyzer/rules/reliability/KA-R012-cronjob-missing-deadline.ts
    src/lib/tools/k8s-analyzer/rules/reliability/index.ts
  </files>
  <action>
Implement 6 more reliability rules and the category index:

**KA-R007 (info, pod-level):** Use getPodSpec() to check for absence of affinity.podAntiAffinity in the podSpec. Apply to all workload kinds that have a PodSpec (Pod, Deployment, StatefulSet, DaemonSet, Job, CronJob). If podSpec.affinity?.podAntiAffinity is undefined, flag.

**KA-R008 (info, pod-level):** Use getPodSpec() to check for absence of topologySpreadConstraints array. If podSpec.topologySpreadConstraints is undefined or not an array or empty, flag.

**KA-R009 (warning, container-level):** Parse container.image string to extract tag. Use a module-private getImageTag function: (1) if image contains '@' (digest reference), return null (skip -- digest is pinned). (2) Split on '/' to separate registry from name. (3) Check only the LAST segment for ':tag'. (4) If no ':' in last segment, tag is implicit 'latest'. (5) If tag is literally 'latest' or empty string, flag. This handles registry:port correctly (e.g., registry.example.com:5000/myapp:1.0 -- the last segment is 'myapp:1.0'). Apply to ALL containers including initContainers.

**KA-R010 (info, container-level):** Check container.imagePullPolicy. Flag if not set to 'Always'. Note: if imagePullPolicy is undefined, Kubernetes uses the tag to determine policy (latest -> Always, specific tag -> IfNotPresent). Only flag when imagePullPolicy is explicitly set to something other than 'Always'. Apply to ALL containers including initContainers.

**KA-R011 (error, deployment-level):** Apply to Deployment, StatefulSet, and DaemonSet (use a Set of kinds). Compare spec.selector.matchLabels with spec.template.metadata.labels. Every key-value in matchLabels must exist in template labels (subset check, NOT exact match). Template labels can have extra keys. Fire one violation per resource (break after first mismatch found). Resolve AST at /spec/selector/matchLabels.

**KA-R012 (warning, CronJob-level):** Check CronJob resources only. Flag if spec.startingDeadlineSeconds is undefined. Path is /spec/startingDeadlineSeconds on the CronJob (NOT inside jobTemplate). Resolve AST at /spec.

**reliability/index.ts:** Import all 12 rule exports (KAR001 through KAR012) and export a reliabilityRules: K8sLintRule[] array. Follow exact pattern from security/index.ts.
  </action>
  <verify>
    npx tsc --noEmit --project /Users/patrykattc/work/git/PatrykQuantumNomad/tsconfig.json 2>&1 | grep -E "k8s-analyzer/rules/reliability" | head -20; echo "---"; ls /Users/patrykattc/work/git/PatrykQuantumNomad/src/lib/tools/k8s-analyzer/rules/reliability/*.ts | wc -l
  </verify>
  <done>13 files in rules/reliability/ (12 rule files + index.ts), all compile without TypeScript errors, reliability/index.ts exports reliabilityRules array with 12 entries.</done>
</task>

</tasks>

<verification>
- All 12 reliability rule files exist in src/lib/tools/k8s-analyzer/rules/reliability/
- reliability/index.ts exports reliabilityRules: K8sLintRule[] with 12 entries
- Every rule has category: 'reliability'
- Probe rules (R001, R002, R003) filter to containerType === 'container' (exclude initContainers)
- R009 image tag parser handles registry:port format correctly
- R011 uses subset check (not exact match) for selector vs template labels
- R004 treats undefined replicas as 1
- R005 does NOT call registry.getByKind (PDB not in GVK registry)
- TypeScript compiles with no errors: npx tsc --noEmit
</verification>

<success_criteria>
12 reliability rules and index aggregator compile cleanly and follow the Phase 42 rule pattern exactly. Each rule implements K8sLintRule with proper id, title, severity, category, explanation, fix, and check() method.
</success_criteria>

<output>
After completion, create `.planning/phases/43-reliability-best-practice-rules/43-01-SUMMARY.md`
</output>
