---
phase: 48-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 48-01
files_modified:
  - package.json
  - astro.config.mjs
  - src/pages/eda/test-d3-isolation.astro
  - src/components/eda/DistributionExplorerStub.tsx
autonomous: false
requirements:
  - INFRA-03
  - INFRA-11

must_haves:
  truths:
    - "D3 micro-modules (d3-scale, d3-shape, d3-axis, d3-selection, d3-array, d3-path) are installed and importable"
    - "Vite bundle analysis confirms D3 modules appear only in distribution page chunks, not in shared or other EDA page chunks"
    - "Navigating Home > EDA test page > Blog > EDA test page > Home (5 cycles) produces no console errors or animation leaks"
    - "D3 React island loads via client:visible (not client:load)"
  artifacts:
    - path: "package.json"
      provides: "D3 micro-modules and rollup-plugin-visualizer as dependencies"
      contains: "d3-scale"
    - path: "src/components/eda/DistributionExplorerStub.tsx"
      provides: "Minimal React island importing D3 to verify bundle isolation"
      contains: "d3-selection"
    - path: "src/pages/eda/test-d3-isolation.astro"
      provides: "Test page loading D3 stub via client:visible"
      contains: "client:visible"
  key_links:
    - from: "src/pages/eda/test-d3-isolation.astro"
      to: "src/components/eda/DistributionExplorerStub.tsx"
      via: "client:visible hydration directive"
      pattern: "client:visible"
    - from: "src/components/eda/DistributionExplorerStub.tsx"
      to: "d3-selection, d3-axis, d3-scale, d3-shape"
      via: "ES module imports inside React island"
      pattern: "import.*d3-"
---

<objective>
Install D3 micro-modules, create a minimal React island stub to verify Vite code-splitting isolates D3 to distribution pages only, run bundle analysis to confirm, and verify animation lifecycle across navigation cycles.

Purpose: D3 bundle leaking to non-distribution pages would add ~17KB to 70+ pages that don't need it. This plan proves the isolation pattern works before building the actual DistributionExplorer component in Phase 53. The navigation lifecycle test validates GSAP/D3 coexistence.

Output: D3 micro-modules installed, bundle analysis proving isolation, navigation lifecycle verified clean across 5 cycles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-infrastructure-foundation/48-RESEARCH.md
@.planning/phases/48-infrastructure-foundation/48-01-SUMMARY.md

@astro.config.mjs
@src/layouts/EDALayout.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install D3 micro-modules, create stub island, run bundle analysis</name>
  <files>
    package.json
    astro.config.mjs
    src/components/eda/DistributionExplorerStub.tsx
    src/pages/eda/test-d3-isolation.astro
  </files>
  <action>
1. Install D3 micro-modules:
   ```
   npm install d3-scale@^4.0.2 d3-shape@^3.2.0 d3-axis@^3.0.0 d3-selection@^3.0.0 d3-array@^3.2.4 d3-path@^3.1.0
   ```

2. Install D3 TypeScript types (dev only):
   ```
   npm install -D @types/d3-scale @types/d3-shape @types/d3-axis @types/d3-selection @types/d3-array @types/d3-path
   ```

3. Install bundle analysis tool (dev only):
   ```
   npm install -D rollup-plugin-visualizer
   ```

4. Create `src/components/eda/DistributionExplorerStub.tsx` — a minimal React island that imports D3 modules to verify they get code-split:
   ```tsx
   import { useEffect, useRef } from 'react';
   import { select } from 'd3-selection';
   import { scaleLinear } from 'd3-scale';
   import { line } from 'd3-shape';
   import { axisBottom, axisLeft } from 'd3-axis';

   export default function DistributionExplorerStub() {
     const svgRef = useRef<SVGSVGElement>(null);

     useEffect(() => {
       if (!svgRef.current) return;
       const svg = select(svgRef.current);
       svg.selectAll('*').remove(); // Clear on re-mount (view transition safety)

       const width = 400, height = 200;
       const x = scaleLinear().domain([-3, 3]).range([40, width - 20]);
       const y = scaleLinear().domain([0, 0.5]).range([height - 30, 10]);

       // Draw simple normal curve
       const data = Array.from({ length: 61 }, (_, i) => {
         const xVal = -3 + i * 0.1;
         return { x: xVal, y: Math.exp(-0.5 * xVal * xVal) / Math.sqrt(2 * Math.PI) };
       });

       const pathGen = line<{ x: number; y: number }>()
         .x(d => x(d.x))
         .y(d => y(d.y));

       svg.append('path')
         .datum(data)
         .attr('d', pathGen)
         .attr('fill', 'none')
         .attr('stroke', 'var(--color-accent)')
         .attr('stroke-width', 2);

       svg.append('g')
         .attr('transform', `translate(0,${height - 30})`)
         .call(axisBottom(x).ticks(7));

       svg.append('g')
         .attr('transform', 'translate(40,0)')
         .call(axisLeft(y).ticks(5));

       // Cleanup on unmount
       return () => { svg.selectAll('*').remove(); };
     }, []);

     return (
       <div>
         <p style={{ marginBottom: '1rem', color: 'var(--color-text-secondary)' }}>
           D3 Distribution Explorer Stub (verifying bundle isolation)
         </p>
         <svg ref={svgRef} viewBox="0 0 400 200" width="100%" style={{ maxWidth: 600 }} />
       </div>
     );
   }
   ```
   Key requirements:
   - Import d3-selection, d3-scale, d3-shape, d3-axis (all four DOM-related modules)
   - Clear SVG on mount (`svg.selectAll('*').remove()`) to handle view transition re-mounts
   - Cleanup on unmount via useEffect return
   - Use `viewBox` for responsive sizing

5. Create `src/pages/eda/test-d3-isolation.astro`:
   - Import EDALayout from the layout created in Plan 01
   - Import DistributionExplorerStub with `client:visible` directive
   - Title: "D3 Isolation Test | EDA Visual Encyclopedia"
   - Do NOT set useKatex (this page doesn't need math)
   - Include the stub component and explanatory text

6. Temporarily add rollup-plugin-visualizer to astro.config.mjs for build analysis:
   - Import: `import { visualizer } from 'rollup-plugin-visualizer';`
   - Add to vite.plugins array:
     ```js
     vite: {
       plugins: [
         visualizer({ emitFile: true, filename: 'stats.html' }),
       ],
     },
     ```
   - Run `npm run build`
   - After verification, REMOVE the visualizer from astro.config.mjs (it's a dev-time analysis tool, not needed in production builds). The plugin and package stay installed for future use.

7. After build, verify D3 isolation:
   - Check `dist/stats.html` — search for `d3-scale`, `d3-shape`, `d3-axis`, `d3-selection` in the treemap
   - They must appear ONLY in chunks associated with the test-d3-isolation page, NOT in shared chunks
   - Check that `dist/eda/test-formulas/index.html` does NOT contain any d3 chunk references (the KaTeX-only test page must not load D3)
   - Alternative CLI check: `grep -r "d3-scale\|d3-shape\|d3-axis\|d3-selection" dist/_astro/ --include="*.js" -l` to identify which JS chunks contain D3 code — should be exactly 1 chunk

8. After verification, remove visualizer from astro.config.mjs (revert the vite.plugins addition). Keep the npm package installed for future INFRA-11 re-verification.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npm run build 2>&1 | tail -10 && echo "--- D3 chunk count ---" && grep -rl "d3-selection\|d3Selection" dist/_astro/ --include="*.js" 2>/dev/null | wc -l && echo "--- KaTeX test page D3 check ---" && grep -c "d3" dist/eda/test-formulas/index.html 2>/dev/null || echo "0"</automated>
    <manual>Build succeeds. D3 modules appear in exactly 1 JS chunk (the distribution stub island). The KaTeX test page (test-formulas) has 0 references to D3 chunks. stats.html treemap confirms isolation.</manual>
  </verify>
  <done>D3 micro-modules installed (6 runtime + 6 type packages). Bundle analysis confirms D3 code appears in exactly 1 JS chunk loaded only by the distribution test page. Non-distribution EDA pages load zero D3 code. Visualizer removed from production config after verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify navigation lifecycle and visual rendering</name>
  <files>n/a</files>
  <action>
Human verification of the complete Phase 48 infrastructure: KaTeX formula rendering, D3 bundle isolation, EDA layout with animation isolation, content collections with sample data, OG image caching utility, technique page template with breadcrumbs.

Start the dev server with `npm run dev` and perform the following checks:

1. KaTeX Formula Test at http://localhost:4321/eda/test-formulas/ — verify all 11 formula categories render as formatted math, Greek symbols use KaTeX font, matrices have brackets, formulas visible in dark mode, NO D3 JS loaded (Network tab).

2. D3 Isolation Test at http://localhost:4321/eda/test-d3-isolation/ — verify normal curve renders, D3 chunks load on scroll (client:visible), NO KaTeX CSS loaded on this page.

3. Navigation Lifecycle Test — 5 full cycles: Home > /eda/test-formulas/ > /blog/ > /eda/test-d3-isolation/ > Home. Watch Console for errors, Memory tab for leaks, check for duplicate chart renders.

4. Non-EDA Page Check at http://localhost:4321/blog/ — verify NO katex.min.css or D3 chunks loaded (conditional loading works).
  </action>
  <verify>Human visual inspection and browser DevTools verification as described above.</verify>
  <done>All 11 KaTeX formula categories render correctly. D3 chart renders on distribution test page. Navigation lifecycle clean across 5 cycles (zero console errors, no memory leaks). Non-EDA pages load neither KaTeX CSS nor D3 chunks. User types "approved".</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with D3 modules installed
2. D3 modules appear in exactly 1 JS chunk (distribution page only)
3. KaTeX test page HTML contains zero D3 references
4. Non-EDA pages contain zero KaTeX CSS references and zero D3 references
5. Navigation lifecycle (5 cycles) produces zero console errors
6. No memory leaks across navigation cycles
7. D3 chart renders correctly after view transition re-mount
</verification>

<success_criteria>
- D3 micro-modules installed (d3-scale, d3-shape, d3-axis, d3-selection, d3-array, d3-path)
- Bundle analysis proves D3 isolation to distribution page chunks only
- KaTeX and D3 do not cross-contaminate (each loads only where needed)
- Navigation lifecycle clean across 5 cycles (zero errors, no memory leaks)
- Human verification confirms visual rendering of formulas and charts
</success_criteria>

<output>
After completion, create `.planning/phases/48-infrastructure-foundation/48-03-SUMMARY.md`
</output>
