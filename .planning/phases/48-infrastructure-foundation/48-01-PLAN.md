---
phase: 48-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - astro.config.mjs
  - scripts/copy-katex-assets.mjs
  - public/styles/katex.min.css
  - public/fonts/katex/
  - src/layouts/EDALayout.astro
  - src/components/eda/EdaBreadcrumb.astro
  - src/components/eda/TechniquePage.astro
  - src/pages/eda/test-formulas.mdx
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-04
  - INFRA-08
  - INFRA-09
  - INFRA-10

must_haves:
  truths:
    - "KaTeX renders 10+ formula categories (Greek, fractions, summations, integrals, matrices, etc.) on the test page without build errors"
    - "KaTeX CSS loads only on EDA pages that set useKatex=true, not on non-EDA pages"
    - "EDALayout.astro extends Layout.astro via slot composition without GSAP conflicts in content area"
    - "TechniquePage.astro template renders with breadcrumb, named slots, and related technique links"
    - "EdaBreadcrumb shows EDA > Category > Technique hierarchy with proper links"
  artifacts:
    - path: "astro.config.mjs"
      provides: "remark-math + rehype-katex in markdown.remarkPlugins/rehypePlugins"
      contains: "remarkMath"
    - path: "src/layouts/EDALayout.astro"
      provides: "EDA-specific layout with conditional KaTeX CSS"
      contains: "useKatex"
    - path: "src/components/eda/EdaBreadcrumb.astro"
      provides: "Visual breadcrumb navigation for EDA pages"
      contains: "aria-label=\"Breadcrumb\""
    - path: "src/components/eda/TechniquePage.astro"
      provides: "Technique page template with named slots"
      contains: "slot name=\"plot\""
    - path: "src/pages/eda/test-formulas.mdx"
      provides: "KaTeX validation page with 10+ formula categories using real remark-math + rehype-katex pipeline"
      contains: "\\sum_{i=1}"
    - path: "public/styles/katex.min.css"
      provides: "Self-hosted KaTeX CSS with patched font paths"
      contains: "url(/fonts/katex/"
    - path: "scripts/copy-katex-assets.mjs"
      provides: "One-time script to copy KaTeX CSS + woff2 fonts"
      contains: "woff2"
  key_links:
    - from: "astro.config.mjs"
      to: "remark-math + rehype-katex"
      via: "remarkPlugins and rehypePlugins arrays"
      pattern: "remarkMath.*rehypeKatex"
    - from: "src/layouts/EDALayout.astro"
      to: "src/layouts/Layout.astro"
      via: "import and slot composition"
      pattern: "import Layout from.*Layout.astro"
    - from: "src/pages/eda/test-formulas.mdx"
      to: "remark-math + rehype-katex"
      via: "MDX pipeline processes $...$ and $$...$$ syntax through remark-math into rehype-katex"
      pattern: "\\$\\$.*\\$\\$"
    - from: "src/components/eda/TechniquePage.astro"
      to: "src/layouts/EDALayout.astro"
      via: "layout wrapper"
      pattern: "EDALayout"
---

<objective>
Install and validate the KaTeX math rendering pipeline, create the EDA-specific layout with animation isolation, and build the technique page template with breadcrumb navigation. The test page proves KaTeX works end-to-end before any content pages are created.

Purpose: KaTeX formula rendering is the highest-risk item in Phase 48 due to known remark-math version conflicts (Astro issue #8650). Validating it first with a dedicated test page prevents wasted effort on content that cannot build. The EDA layout and template establish the structural foundation all 90+ future EDA pages will use.

Output: Working KaTeX pipeline, EDALayout.astro, TechniquePage.astro, EdaBreadcrumb.astro, and a test page at /eda/test-formulas/ rendering 11 formula categories.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-infrastructure-foundation/48-RESEARCH.md

@astro.config.mjs
@src/layouts/Layout.astro
@src/components/BreadcrumbJsonLd.astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install KaTeX pipeline, self-host assets, configure Astro</name>
  <files>
    astro.config.mjs
    scripts/copy-katex-assets.mjs
    public/styles/katex.min.css
    public/fonts/katex/*.woff2
  </files>
  <action>
1. Install remark-math and rehype-katex. Attempt v6 first per project decision:
   ```
   npm install remark-math@^6.0.0 rehype-katex@^7.0.1
   ```
   If the build later fails with a `mathFlowInside` error, immediately fall back:
   ```
   npm install remark-math@5.1.1 rehype-katex@6.0.3
   ```

2. Update `astro.config.mjs`:
   - Import `remarkMath` from `'remark-math'` and `rehypeKatex` from `'rehype-katex'`
   - Add `remarkMath` to the existing `markdown.remarkPlugins` array (after `remarkReadingTime`)
   - Add `rehypePlugins: [rehypeKatex]` to the `markdown` config object
   - Do NOT modify any other config (integrations, site, output, etc.)

3. Create `scripts/copy-katex-assets.mjs` (copy from research Pattern: KaTeX Self-Hosting Script):
   - Copies `katex.min.css` from `node_modules/katex/dist/` to `public/styles/`
   - Patches all `url(fonts/` references to `url(/fonts/katex/` (absolute paths)
   - Copies all `.woff2` font files from `node_modules/katex/dist/fonts/` to `public/fonts/katex/`
   - Logs count of copied fonts

4. Run the copy script: `node scripts/copy-katex-assets.mjs`

5. Verify the patched CSS: Open `public/styles/katex.min.css` and confirm all font-face URLs use `/fonts/katex/` prefix (absolute, not relative).

6. Verify woff2 fonts exist: Check `public/fonts/katex/` contains ~20 woff2 files (KaTeX ships ~20 font variants).

IMPORTANT: Do NOT load KaTeX CSS globally in Layout.astro. It will be conditionally loaded in EDALayout.astro (Task 2).
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npm run build 2>&1 | tail -20</automated>
    <manual>Build completes without mathFlowInside errors. public/styles/katex.min.css exists with patched font paths. public/fonts/katex/ contains woff2 files.</manual>
  </verify>
  <done>remark-math + rehype-katex installed and configured in astro.config.mjs. KaTeX CSS and woff2 fonts self-hosted in public/ with correct absolute font paths. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Create EDALayout, EdaBreadcrumb, TechniquePage template, and KaTeX test page</name>
  <files>
    src/layouts/EDALayout.astro
    src/components/eda/EdaBreadcrumb.astro
    src/components/eda/TechniquePage.astro
    src/pages/eda/test-formulas.mdx
  </files>
  <action>
1. Create `src/layouts/EDALayout.astro`:
   - Import `Layout` from `'./Layout.astro'`
   - Props interface: `title: string`, `description?: string`, `ogImage?: string`, `ogImageAlt?: string`, `useKatex?: boolean` (default false)
   - Wrap content in `<Layout>` passing through title, description, ogImage, ogImageAlt
   - Conditionally inject KaTeX CSS via `<link slot="head" rel="stylesheet" href="/styles/katex.min.css" />` when `useKatex` is true
   - Add a dark-mode override style block for KaTeX: `.katex { color: var(--color-text-primary); }` to ensure formulas are visible on dark backgrounds (research open question #2)
   - Do NOT add any GSAP ScrollTrigger initialization in this layout. EDA content animations should use CSS or IntersectionObserver only. The base Layout already handles header/footer GSAP.
   - Pass through a default `<slot />` for page content

2. Create `src/components/eda/EdaBreadcrumb.astro`:
   - Props: `category: string`, `techniqueName?: string`
   - Build crumbs array: `[{ label: 'EDA', href: '/eda/' }, { label: category, href: '/eda/${categorySlug}/' }]`
   - If `techniqueName` provided, add final crumb with no href (current page)
   - Render as `<nav aria-label="Breadcrumb">` with `<ol>` containing `<li>` items separated by `/` dividers
   - Style: `text-sm text-[var(--color-text-secondary)]`, links with `hover:text-[var(--color-accent)]`, current page in `text-[var(--color-text-primary)] font-medium`
   - Add `class="mb-6"` to nav element

3. Create `src/components/eda/TechniquePage.astro`:
   - Import EDALayout, EdaBreadcrumb, and BreadcrumbJsonLd
   - Props: `title: string`, `description: string`, `category: string`, `nistSection: string`, `relatedTechniques?: Array<{ slug: string; name: string }>` (default []), `useKatex?: boolean` (default false)
   - Wrap in EDALayout with title formatted as `{title} | EDA Visual Encyclopedia`
   - Include BreadcrumbJsonLd with crumbs: Home > EDA > category > title (use `https://patrykgolabek.dev` as base)
   - Article container: `max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-16`
   - Header with h1 and NIST section reference
   - Named slots: `plot`, `description`, `formula`, `code`, `interpretation`
   - Related techniques section (conditionally rendered if array non-empty): pill-shaped links to `/eda/techniques/{slug}/`

4. Create `src/pages/eda/test-formulas.mdx` (MDX format to exercise the real remark-math + rehype-katex pipeline):
   - Import EDALayout from the layouts directory
   - Use EDALayout as the wrapper with `useKatex={true}`
   - Title: "KaTeX Formula Test | EDA Visual Encyclopedia"
   - Use standard MDX `$...$` for inline math and `$$...$$` for display math — these are processed by the remark-math + rehype-katex pipeline configured in astro.config.mjs
   - Include ALL 11 formula categories:
     1. Greek Symbols (inline): `$\alpha, \beta, \gamma, \delta, \sigma, \mu, \lambda, \chi^2$`
     2. Fractions: `$$\frac{x + y}{z - w}$$`
     3. Summations: `$$\sum_{i=1}^{n} x_i$$`
     4. Integrals: `$$\int_{-\infty}^{\infty} f(x) \, dx$$`
     5. Square Roots: `$$\sqrt{\frac{1}{n} \sum_{i=1}^{n} (x_i - \bar{x})^2}$$`
     6. Matrices: `$$\begin{pmatrix} a & b \\ c & d \end{pmatrix}$$`
     7. Subscripts/Superscripts: `$$\hat{\beta}_1 = ...$$`
     8. Normal PDF: `$$f(x) = \frac{1}{\sigma\sqrt{2\pi}} e^{-\frac{1}{2}\left(\frac{x - \mu}{\sigma}\right)^2}$$`
     9. Multi-line Aligned: `$$\begin{aligned} ... \end{aligned}$$`
     10. Chi-Squared Test: `$$\chi^2 = \sum_{i=1}^k \frac{(O_i - E_i)^2}{E_i}$$`
     11. Product/Large Operators: `$$L(\theta) = \prod_{i=1}^n f(x_i | \theta)$$`
   - Wrap in prose styling: `class="prose prose-lg dark:prose-invert max-w-3xl mx-auto px-4 py-16"`
   - IMPORTANT: This MUST be .mdx (not .astro) so remark-math + rehype-katex process the `$...$` syntax. This validates the real pipeline that all future content pages will use (INFRA-01).

5. Run build and verify the test page renders without errors. If `mathFlowInside` error occurs, execute the fallback: `npm install remark-math@5.1.1 rehype-katex@6.0.3` and rebuild.
  </action>
  <verify>
    <automated>cd /Users/patrykattc/work/git/PatrykQuantumNomad && npm run build 2>&1 | tail -20 && ls -la dist/eda/test-formulas/index.html && grep -c "katex" dist/eda/test-formulas/index.html</automated>
    <manual>Build succeeds. dist/eda/test-formulas/index.html exists and contains multiple "katex" class references (pre-rendered formula HTML from the remark-math + rehype-katex pipeline). Open in browser to verify all 11 formula categories render correctly with proper symbols, not raw LaTeX.</manual>
  </verify>
  <done>EDALayout.astro conditionally loads KaTeX CSS. EdaBreadcrumb renders EDA > Category > Technique navigation. TechniquePage.astro has all named slots. Test page at /eda/test-formulas/ is an MDX file that exercises the real remark-math + rehype-katex pipeline, rendering 11 KaTeX formula categories (Greek, fractions, summations, integrals, roots, matrices, sub/superscripts, normal PDF, aligned equations, chi-squared, products) without build errors.</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors (no mathFlowInside, no missing module errors)
2. `dist/eda/test-formulas/index.html` exists and contains pre-rendered KaTeX HTML (grep for "katex" class)
3. `public/styles/katex.min.css` references `/fonts/katex/` (absolute paths)
4. `public/fonts/katex/` contains woff2 files
5. KaTeX CSS link appears ONLY in the test page HTML, NOT in non-EDA pages (grep dist/blog/index.html for katex — should find 0 matches)
6. EDALayout.astro imports from Layout.astro (slot composition pattern)
7. TechniquePage.astro contains 5 named slots: plot, description, formula, code, interpretation
8. EdaBreadcrumb.astro has aria-label="Breadcrumb"
</verification>

<success_criteria>
- Build succeeds with KaTeX pipeline active
- Test page renders 11 formula categories as formatted math (not raw LaTeX text)
- KaTeX CSS conditionally loaded only on useKatex=true pages
- EDALayout extends Layout.astro without adding content-area GSAP
- TechniquePage template has named slots and breadcrumb integration
- EdaBreadcrumb renders accessible navigation hierarchy
</success_criteria>

<output>
After completion, create `.planning/phases/48-infrastructure-foundation/48-01-SUMMARY.md`
</output>
