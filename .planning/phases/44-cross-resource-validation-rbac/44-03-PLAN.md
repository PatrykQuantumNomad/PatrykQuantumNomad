---
phase: 44-cross-resource-validation-rbac
plan: 03
type: execute
wave: 2
depends_on: ["44-01", "44-02"]
files_modified:
  - src/lib/tools/k8s-analyzer/rules/index.ts
  - src/lib/tools/k8s-analyzer/sample-manifest.ts
autonomous: true

must_haves:
  truths:
    - "allK8sRules includes all cross-resource and RBAC rules (total = 20 security + 12 reliability + 12 best-practice + 8 cross-resource + 5 RBAC = 57 rules)"
    - "Engine totalRules auto-adapts via 10 + allK8sRules.length formula (no hardcoded count change needed)"
    - "Sample manifest triggers at least one cross-resource violation and at least one RBAC violation when analyzed"
    - "RBAC rules are scored under Security category weight because they use category: 'security'"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/rules/index.ts"
      provides: "Master rule index with crossResourceRules and rbacRules added to allK8sRules"
      exports: ["allK8sRules", "allDocumentedK8sRules", "getK8sRuleById"]
    - path: "src/lib/tools/k8s-analyzer/sample-manifest.ts"
      provides: "Sample manifest with RBAC and cross-resource violation triggers"
      exports: ["SAMPLE_K8S_MANIFEST"]
  key_links:
    - from: "src/lib/tools/k8s-analyzer/rules/index.ts"
      to: "src/lib/tools/k8s-analyzer/rules/cross-resource/index.ts"
      via: "import { crossResourceRules } from './cross-resource'"
      pattern: "crossResourceRules"
    - from: "src/lib/tools/k8s-analyzer/rules/index.ts"
      to: "src/lib/tools/k8s-analyzer/rules/rbac/index.ts"
      via: "import { rbacRules } from './rbac'"
      pattern: "rbacRules"
    - from: "src/lib/tools/k8s-analyzer/engine.ts"
      to: "src/lib/tools/k8s-analyzer/rules/index.ts"
      via: "allK8sRules import auto-picks up new rules (no engine.ts changes needed)"
      pattern: "allK8sRules"
---

<objective>
Integrate cross-resource and RBAC rules into the master rule index and update the sample manifest with RBAC and cross-resource violation triggers.

Purpose: This wiring plan connects the 13 new rules from Plans 01 and 02 into the engine pipeline. The engine auto-adapts via `10 + allK8sRules.length`, so no engine.ts changes are needed. The sample manifest must demonstrate the new rule categories for the pre-loaded editor experience (Phase 45).

Output: Updated `rules/index.ts` with 57 total rules; updated `sample-manifest.ts` with RBAC and cross-resource violation examples.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-cross-resource-validation-rbac/44-RESEARCH.md
@.planning/phases/44-cross-resource-validation-rbac/44-01-SUMMARY.md
@.planning/phases/44-cross-resource-validation-rbac/44-02-SUMMARY.md

# Files to modify:
@src/lib/tools/k8s-analyzer/rules/index.ts
@src/lib/tools/k8s-analyzer/sample-manifest.ts
@src/lib/tools/k8s-analyzer/engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update master rule index and sample manifest</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/index.ts
    src/lib/tools/k8s-analyzer/sample-manifest.ts
  </files>
  <action>
    **rules/index.ts updates:**
    1. Add two new imports after the existing category imports:
       ```typescript
       import { crossResourceRules } from './cross-resource';
       import { rbacRules } from './rbac';
       ```
    2. Update `allK8sRules` array to spread the new category arrays:
       ```typescript
       export const allK8sRules: K8sLintRule[] = [
         ...securityRules,
         ...reliabilityRules,
         ...bestPracticeRules,
         ...crossResourceRules,
         ...rbacRules,
       ];
       ```
    3. Update the JSDoc comment on allK8sRules to reflect the new total
    4. DO NOT modify engine.ts -- the `10 + allK8sRules.length` formula auto-adapts

    **sample-manifest.ts updates:**
    Add new YAML documents BEFORE the trailing backtick to trigger Phase 44 rules. Add these resources to the existing sample:

    1. **ClusterRole with wildcard permissions** (triggers KA-A001):
       ```yaml
       apiVersion: rbac.authorization.k8s.io/v1
       kind: ClusterRole
       metadata:
         name: overly-permissive-role
       rules:
         - apiGroups: ["*"]
           resources: ["*"]
           verbs: ["*"]
       ```

    2. **ClusterRoleBinding granting cluster-admin** (triggers KA-A002):
       ```yaml
       apiVersion: rbac.authorization.k8s.io/v1
       kind: ClusterRoleBinding
       metadata:
         name: give-admin-to-dev
       subjects:
         - kind: User
           name: developer
           apiGroup: rbac.authorization.k8s.io
       roleRef:
         kind: ClusterRole
         name: cluster-admin
         apiGroup: rbac.authorization.k8s.io
       ```

    3. **Ingress with dangling service reference** (triggers KA-X002):
       ```yaml
       apiVersion: networking.k8s.io/v1
       kind: Ingress
       metadata:
         name: broken-ingress
         namespace: online-store
       spec:
         rules:
           - host: api.example.com
             http:
               paths:
                 - path: /
                   pathType: Prefix
                   backend:
                     service:
                       name: nonexistent-api-svc
                       port:
                         number: 8080
       ```

    4. Update the comment block at the top of the sample manifest to document the new triggers:
       - Cross-resource triggers: KA-X002 (broken-ingress -> nonexistent-api-svc)
       - RBAC triggers: KA-A001 (wildcard permissions), KA-A002 (cluster-admin binding)

    Keep the existing sample resources intact. The new resources should be added as additional `---` separated documents after the existing NodePort service and before the trailing backtick.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` -- zero errors
    2. Verify allK8sRules.length is 57 by checking the imports: 20 security + 12 reliability + 12 best-practice + 8 cross-resource + 5 RBAC
    3. Run the Astro build: `npm run build` -- zero errors
  </verify>
  <done>
    `rules/index.ts` imports and spreads crossResourceRules + rbacRules into allK8sRules (57 total). `sample-manifest.ts` includes RBAC resources and a broken Ingress reference. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. `allK8sRules` array contains 57 rules (20+12+12+8+5)
4. Engine totalRules = 10 + 57 = 67 (auto-calculated, no hardcoded value)
5. Sample manifest triggers at least: KA-A001, KA-A002, KA-X002
6. Existing sample resources and their triggers are preserved
7. No changes to engine.ts required or made
</verification>

<success_criteria>
- Master index aggregates all 5 category arrays into allK8sRules
- Engine auto-adapts via 10 + allK8sRules.length formula
- Sample manifest demonstrates RBAC and cross-resource violations
- Build passes cleanly with all new rules wired in
- allDocumentedK8sRules includes the 13 new rules for future rule documentation pages
</success_criteria>

<output>
After completion, create `.planning/phases/44-cross-resource-validation-rbac/44-03-SUMMARY.md`
</output>
