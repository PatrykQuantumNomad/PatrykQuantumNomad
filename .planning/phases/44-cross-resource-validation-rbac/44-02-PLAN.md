---
phase: 44-cross-resource-validation-rbac
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/tools/k8s-analyzer/rules/rbac/KA-A001-wildcard-permissions.ts
  - src/lib/tools/k8s-analyzer/rules/rbac/KA-A002-cluster-admin-binding.ts
  - src/lib/tools/k8s-analyzer/rules/rbac/KA-A003-pod-exec-attach.ts
  - src/lib/tools/k8s-analyzer/rules/rbac/KA-A004-secret-access.ts
  - src/lib/tools/k8s-analyzer/rules/rbac/KA-A005-pod-creation.ts
  - src/lib/tools/k8s-analyzer/rules/rbac/index.ts
autonomous: true

must_haves:
  truths:
    - "A Role or ClusterRole with wildcard (*) in apiGroups, resources, or verbs produces an error referencing CIS 5.1.3"
    - "A RoleBinding or ClusterRoleBinding with roleRef.name 'cluster-admin' produces an error referencing CIS 5.1.1"
    - "A Role/ClusterRole granting pods/exec, pods/attach, or pods/* access produces a warning"
    - "A Role/ClusterRole granting get, list, or watch on secrets produces a warning referencing CIS 5.1.2"
    - "A Role/ClusterRole granting create on pods produces a warning referencing CIS 5.1.4"
    - "All 5 RBAC rules use category: 'security' for scoring under Security weight (35%)"
    - "Rules gracefully skip ClusterRoles with aggregationRule and no rules array"
  artifacts:
    - path: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A001-wildcard-permissions.ts"
      provides: "Wildcard permission detection in Role/ClusterRole rules array"
      exports: ["KAA001"]
    - path: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A002-cluster-admin-binding.ts"
      provides: "cluster-admin RoleBinding detection"
      exports: ["KAA002"]
    - path: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A003-pod-exec-attach.ts"
      provides: "Pod exec/attach permission detection"
      exports: ["KAA003"]
    - path: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A004-secret-access.ts"
      provides: "Secret access permission detection"
      exports: ["KAA004"]
    - path: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A005-pod-creation.ts"
      provides: "Pod creation permission detection"
      exports: ["KAA005"]
    - path: "src/lib/tools/k8s-analyzer/rules/rbac/index.ts"
      provides: "rbacRules aggregation array"
      exports: ["rbacRules"]
  key_links:
    - from: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A001-wildcard-permissions.ts"
      to: "src/lib/tools/k8s-analyzer/types.ts"
      via: "K8sLintRule with category: 'security' for SCORE-04 compliance"
      pattern: "category: 'security'"
    - from: "src/lib/tools/k8s-analyzer/rules/rbac/KA-A002-cluster-admin-binding.ts"
      to: "src/lib/tools/k8s-analyzer/types.ts"
      via: "Checks RoleBinding/ClusterRoleBinding kind, not Role/ClusterRole"
      pattern: "kind !== 'RoleBinding' && resource.kind !== 'ClusterRoleBinding'"
---

<objective>
Implement all 5 RBAC analysis rules (KA-A001 through KA-A005) that detect overly permissive Role/ClusterRole permissions and dangerous RoleBinding configurations.

Purpose: RBAC misconfiguration is a top Kubernetes security concern. These rules catch wildcard permissions, cluster-admin bindings, and dangerous permission grants (exec/attach, secret access, pod creation) that violate CIS Kubernetes Benchmark controls 5.1.1 through 5.1.4. All RBAC rules are scored under the Security category (35% weight) per SCORE-04.

Output: 5 rule files + 1 category index in `rules/rbac/` directory.
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-cross-resource-validation-rbac/44-RESEARCH.md

# Existing patterns to follow exactly:
@src/lib/tools/k8s-analyzer/types.ts
@src/lib/tools/k8s-analyzer/parser.ts
@src/lib/tools/k8s-analyzer/rules/security/KA-C001-privileged-container.ts
@src/lib/tools/k8s-analyzer/rules/security/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement all 5 RBAC rules (KA-A001 through KA-A005)</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/rbac/KA-A001-wildcard-permissions.ts
    src/lib/tools/k8s-analyzer/rules/rbac/KA-A002-cluster-admin-binding.ts
    src/lib/tools/k8s-analyzer/rules/rbac/KA-A003-pod-exec-attach.ts
    src/lib/tools/k8s-analyzer/rules/rbac/KA-A004-secret-access.ts
    src/lib/tools/k8s-analyzer/rules/rbac/KA-A005-pod-creation.ts
  </files>
  <action>
    Create the `rules/rbac/` directory and implement all 5 RBAC rules. All RBAC rules MUST use `category: 'security'` (NOT 'cross-resource' or 'rbac') to satisfy SCORE-04 requirement.

    **KA-A001 (Wildcard permissions -- CIS 5.1.3):**
    - Iterate `ctx.resources`, filter `kind === 'Role' || kind === 'ClusterRole'`
    - Extract `resource.json.rules` as array. If `rules` is not an array (e.g., aggregated ClusterRole with no rules), skip gracefully
    - For each rule entry, check `apiGroups`, `resources`, and `verbs` arrays
    - If any of these contain `"*"`, collect which fields have wildcards
    - Emit ONE violation per rules entry that has wildcards (not per wildcard field), listing all wildcard fields in the message
    - Point violation at `/rules/{i}` JSON path for line resolution
    - severity: 'error', category: 'security'
    - Message must include resource kind, name, which fields have wildcards, and "(CIS 5.1.3 violation)"

    **KA-A002 (cluster-admin RoleBinding -- CIS 5.1.1):**
    - Iterate `ctx.resources`, filter `kind === 'RoleBinding' || kind === 'ClusterRoleBinding'`
    - Check `roleRef.name === 'cluster-admin'`
    - Emit violation at `/roleRef/name` JSON path
    - severity: 'error', category: 'security'
    - Message must include resource kind, name, and "(CIS 5.1.1 violation)"

    **KA-A003 (Pod exec/attach permissions):**
    - Iterate `ctx.resources`, filter `kind === 'Role' || kind === 'ClusterRole'`
    - For each rules entry, check if it grants exec/attach access via a helper:
      - Target resources: `['pods/exec', 'pods/attach', 'pods/*']`
      - Target verbs: `['create', 'get', '*']` (exec/attach require create or get)
      - Also trigger if `resources` contains `"*"` (covers all sub-resources) AND verbs match
    - severity: 'warning', category: 'security'
    - Point violation at the specific `/rules/{i}` entry

    **KA-A004 (Secret access -- CIS 5.1.2):**
    - Same pattern as A003 but:
      - Target resources: `['secrets']`
      - Target verbs: `['get', 'list', 'watch', '*']`
      - Also trigger if `resources` contains `"*"` AND verbs match
    - severity: 'warning', category: 'security'
    - Message must include "(CIS 5.1.2 violation)"

    **KA-A005 (Pod creation -- CIS 5.1.4):**
    - Same pattern as A003 but:
      - Target resources: `['pods']`
      - Target verbs: `['create', '*']`
      - Also trigger if `resources` contains `"*"` AND verbs match
    - severity: 'warning', category: 'security'
    - Message must include "(CIS 5.1.4 violation)"

    **Shared helper function:** Create a local `ruleGrantsPermission(rule, targetResources, targetVerbs): boolean` helper in each of KA-A003, KA-A004, KA-A005 (or extract to a shared module if preferred -- but since it's 5 lines and only used by 3 rules in the same directory, inline is fine). The helper checks:
    1. `resources` includes `'*'` OR any `targetResources` entry
    2. `verbs` includes `'*'` OR any `targetVerbs` entry
    3. Both conditions must be true

    Each rule must follow the exact pattern from KA-C001: import types from `../../types`, import parser helpers from `../../parser`, export a named const implementing K8sLintRule with id, title, severity, category, explanation (with CIS reference where applicable), fix (with before/after YAML), and check() method.
  </action>
  <verify>
    Run `npx tsc --noEmit` from the project root. All 5 new files compile without errors. Each exports the correct named constant (KAA001 through KAA005).
  </verify>
  <done>
    5 RBAC rule files exist in `rules/rbac/`, each implementing K8sLintRule with `category: 'security'`, correct severity, CIS references in explanation/message, and a check() method that inspects the correct RBAC fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RBAC category index</name>
  <files>
    src/lib/tools/k8s-analyzer/rules/rbac/index.ts
  </files>
  <action>
    Create `rules/rbac/index.ts` following the exact pattern from `rules/security/index.ts`:

    ```typescript
    import type { K8sLintRule } from '../../types';

    import { KAA001 } from './KA-A001-wildcard-permissions';
    import { KAA002 } from './KA-A002-cluster-admin-binding';
    import { KAA003 } from './KA-A003-pod-exec-attach';
    import { KAA004 } from './KA-A004-secret-access';
    import { KAA005 } from './KA-A005-pod-creation';

    /** All 5 RBAC analysis rules for K8s manifest validation. */
    export const rbacRules: K8sLintRule[] = [
      KAA001,
      KAA002,
      KAA003,
      KAA004,
      KAA005,
    ];
    ```

    This is a direct, minimal file. No logic, just aggregation.
  </action>
  <verify>
    Run `npx tsc --noEmit`. The index compiles and `rbacRules` is a valid K8sLintRule array with 5 entries.
  </verify>
  <done>
    `rules/rbac/index.ts` exports `rbacRules` array with all 5 RBAC rules. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All 6 files exist in `src/lib/tools/k8s-analyzer/rules/rbac/`
3. Each rule file exports a named K8sLintRule const with id matching `KA-A00X` pattern
4. ALL 5 rules have `category: 'security'` (not 'rbac' or 'cross-resource') -- SCORE-04 compliance
5. KA-A001 and KA-A002 have `severity: 'error'`; KA-A003/A004/A005 have `severity: 'warning'`
6. CIS benchmark references present in explanations and messages: 5.1.1 (A002), 5.1.2 (A004), 5.1.3 (A001), 5.1.4 (A005)
7. KA-A001 gracefully handles ClusterRoles without a `rules` array (aggregated ClusterRoles)
8. KA-A003 detects all three patterns: `pods/exec`, `pods/attach`, `pods/*`
9. `rbacRules` array contains exactly 5 rules
</verification>

<success_criteria>
- 5 RBAC rules compile and implement K8sLintRule interface with category: 'security'
- CIS Benchmark references (5.1.1-5.1.4) present in rule explanations and violation messages
- Aggregated ClusterRoles (no rules array) handled gracefully
- Category index exports rbacRules with 5 entries
- Wildcard resource detection works for both explicit sub-resources and `*` wildcards
</success_criteria>

<output>
After completion, create `.planning/phases/44-cross-resource-validation-rbac/44-02-SUMMARY.md`
</output>
