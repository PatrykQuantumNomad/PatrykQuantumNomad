---
phase: 09-external-blog-integration
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/BlogCard.astro
  - src/pages/rss.xml.ts
autonomous: true

must_haves:
  truths:
    - "External blog posts on the listing page show a source badge (e.g., 'on Kubert AI') and an external link icon"
    - "Clicking an external blog card opens the external site in a new tab (target=_blank, rel=noopener noreferrer)"
    - "Local blog posts continue to link to their internal /blog/[slug]/ detail page with no badge or icon"
    - "RSS feed at /rss.xml includes all 11 blog posts (1 local + 10 external)"
    - "External posts in RSS feed use their canonical external URL as the link, not /blog/ext-*/"
    - "RSS feed sorts posts chronologically by publishedDate"
  artifacts:
    - path: "src/components/BlogCard.astro"
      provides: "Blog card with external link handling, source badge, and external icon"
      contains: "externalUrl"
    - path: "src/pages/rss.xml.ts"
      provides: "RSS feed with external URL support"
      contains: "externalUrl"
  key_links:
    - from: "src/components/BlogCard.astro"
      to: "post.data.externalUrl"
      via: "conditional href and target/rel attributes"
      pattern: "target.*_blank.*noopener"
    - from: "src/components/BlogCard.astro"
      to: "post.data.source"
      via: "source badge rendering"
      pattern: "on.*source"
    - from: "src/pages/rss.xml.ts"
      to: "post.data.externalUrl"
      via: "conditional link field in RSS items"
      pattern: "externalUrl.*blog/"
    - from: "src/pages/blog/index.astro"
      to: "src/components/BlogCard.astro"
      via: "BlogCard component renders each post"
      pattern: "BlogCard"
    - from: "src/pages/blog/tags/[tag].astro"
      to: "src/components/BlogCard.astro"
      via: "BlogCard component renders tagged posts"
      pattern: "BlogCard"
---

<objective>
Update BlogCard component to handle external blog links with source badges and external link icons, and update the RSS feed to include external posts with their canonical URLs.

Purpose: This is the user-facing layer of external blog integration. After Plan 01 created the data and guards, this plan makes external posts visible and functional in the blog listing, tag pages, and RSS feed. Users see source attribution ("on Kubert AI"), visual external link indicators, and proper new-tab behavior.

Output: Updated BlogCard.astro with external post handling, updated rss.xml.ts with external URL support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-external-blog-integration/09-RESEARCH.md
@.planning/phases/09-external-blog-integration/09-01-SUMMARY.md
@src/components/BlogCard.astro
@src/pages/rss.xml.ts
@src/pages/blog/index.astro
@src/pages/blog/tags/[tag].astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update BlogCard for external link behavior with source badge and icon</name>
  <files>src/components/BlogCard.astro</files>
  <action>
    Replace the existing BlogCard.astro with external-aware version. The component must:

    1. **Destructure externalUrl and source** from post.data alongside existing fields
    2. **Compute isExternal** as `!!externalUrl` and **href** as `isExternal ? externalUrl : \`/blog/${post.id}/\``
    3. **Update the overlay anchor tag** (`<a class="absolute inset-0 z-0">`) to:
       - Use the computed `href` instead of hardcoded `/blog/${post.id}/`
       - Add `target="_blank"` and `rel="noopener noreferrer"` when isExternal is true
       - Use Astro's conditional spread pattern: `{...isExternal && { target: "_blank", rel: "noopener noreferrer" }}`
    4. **Add source badge** next to the date: When `source` is defined, render a small badge:
       ```
       <span class="text-xs px-2 py-0.5 rounded-full bg-[var(--color-accent)]/10 text-[var(--color-accent)]">
         on {source}
       </span>
       ```
    5. **Add external link icon** next to the date/badge: When isExternal is true, render an inline SVG icon (external link / arrow-top-right-on-square):
       ```
       <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-[var(--color-text-secondary)]" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
         <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5zm7.25-.75a.75.75 0 01.75-.75h3.5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V6.31l-5.47 5.47a.75.75 0 01-1.06-1.06l5.47-5.47H12.25a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
       </svg>
       ```
    6. **Wrap date, badge, and icon** in a flex container: `<div class="flex items-center gap-2">` so they align horizontally
    7. **Preserve all existing styling and behavior** for local posts -- tags, hover states, transitions, z-index on tag links

    The full component structure (see 09-RESEARCH.md Pattern 3 for reference implementation):
    - Props and interface remain the same (CollectionEntry<'blog'>)
    - Article wrapper styling unchanged
    - Overlay link gets conditional target/rel
    - Date + source badge + external icon in a flex row
    - Title, description, tags remain unchanged

    IMPORTANT: Do NOT add a separate external link icon component or dependency. Use inline SVG as shown above.
    IMPORTANT: The tag links must retain `relative z-10` so they remain clickable above the overlay link.
  </action>
  <verify>
    Run `npx astro build` -- should complete with zero errors. The BlogCard component is used on both blog listing (/blog/) and tag pages (/blog/tags/[tag]/), so both will automatically use the updated component. Visually verify by checking the built HTML: `grep -l "noopener noreferrer" dist/blog/index.html` should match (confirming external links have the attribute). `grep -c "on Kubert AI" dist/blog/index.html` should return 6 (one badge per Kubert AI post).
  </verify>
  <done>
    BlogCard renders external posts with: (1) source badge showing "on Kubert AI" or "on Translucent Computing", (2) external link SVG icon, (3) target="_blank" rel="noopener noreferrer" on the link. Local posts render unchanged with internal /blog/[slug]/ links and no badge/icon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update RSS feed to include external posts with canonical URLs</name>
  <files>src/pages/rss.xml.ts</files>
  <action>
    Update src/pages/rss.xml.ts to:

    1. **Sort posts by publishedDate** before mapping to RSS items (currently unsorted -- add `.sort((a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf())`)
    2. **Use externalUrl for external post links**: Change the `link` field from the hardcoded `/blog/${post.id}/` to a conditional:
       ```
       link: post.data.externalUrl ?? `/blog/${post.id}/`,
       ```
       When `externalUrl` is defined (external post), use it as the canonical link. When undefined (local post), use the internal path. The `@astrojs/rss` package (v4.0.15) natively handles absolute URLs -- its `isValidURL()` check passes absolute URLs through unchanged (verified in research).

    The full updated file should be:
    ```typescript
    import rss from '@astrojs/rss';
    import { getCollection } from 'astro:content';
    import type { APIContext } from 'astro';

    export async function GET(context: APIContext) {
      const posts = await getCollection('blog', ({ data }) => {
        return import.meta.env.PROD ? data.draft !== true : true;
      });

      const sortedPosts = posts.sort(
        (a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf()
      );

      return rss({
        title: 'Patryk Golabek | Blog',
        description:
          'Articles on cloud-native architecture, Kubernetes, AI/ML, and platform engineering',
        site: context.site!,
        items: sortedPosts.map((post) => ({
          title: post.data.title,
          pubDate: post.data.publishedDate,
          description: post.data.description,
          link: post.data.externalUrl ?? `/blog/${post.id}/`,
        })),
      });
    }
    ```

    IMPORTANT: Do NOT filter out external posts from RSS. All posts (local + external) should appear in the feed. The only filtering is the existing draft filter.
    IMPORTANT: Do NOT wrap the link in `new URL()` -- @astrojs/rss handles URL canonicalization internally.
  </action>
  <verify>
    Run `npx astro build` and then inspect the generated RSS feed: `cat dist/rss.xml`. Verify:
    1. The feed contains 11 items (1 local + 10 external, excluding the draft-placeholder)
    2. External post items have links starting with `https://mykubert.com/` or `https://translucentcomputing.com/`
    3. The local post item has a link to `https://patrykgolabek.dev/blog/building-kubernetes-observability-stack/`
    4. Items are sorted by date (most recent first)
    5. No doubled URLs like `https://patrykgolabek.dev/https://mykubert.com/...`
  </verify>
  <done>
    RSS feed at /rss.xml includes all 11 blog posts sorted by date. External posts link to their canonical external URLs. Local post links to its internal /blog/[slug]/ URL. No URL mangling.
  </done>
</task>

</tasks>

<verification>
1. `npx astro build` completes with zero errors
2. Blog listing page HTML contains source badges ("on Kubert AI" x6, "on Translucent Computing" x4)
3. Blog listing page HTML contains `target="_blank"` and `rel="noopener noreferrer"` on external post links
4. Blog listing page HTML does NOT contain target="_blank" on the local post link
5. RSS feed contains 11 items with correct URLs (external URLs for external posts, internal path for local post)
6. Tag pages correctly render external posts with badges and external links via the shared BlogCard component
</verification>

<success_criteria>
- External posts on blog listing show "on Kubert AI" or "on Translucent Computing" source badge
- External posts show external link SVG icon
- Clicking external post opens external URL in new tab (target="_blank" rel="noopener noreferrer")
- Local post continues to open its internal detail page (no badge, no icon, no target="_blank")
- RSS feed contains all 11 posts with correct links (external URLs for external, internal path for local)
- Tag pages render external posts correctly via BlogCard (automatic -- no tag page changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/09-external-blog-integration/09-02-SUMMARY.md`
</output>
