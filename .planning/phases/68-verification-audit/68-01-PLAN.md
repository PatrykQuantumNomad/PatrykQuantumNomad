---
phase: 68-verification-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [VRFY-01, VRFY-02, VRFY-03, VRFY-04, VRFY-05]

must_haves:
  truths:
    - "astro build completes with exit code 0 and zero EDA-related warnings"
    - "All 29 technique pages exist as dist/eda/techniques/{slug}/index.html"
    - "Zero deprecated Python API patterns found across all 29 technique pythonCode entries"
    - "All 19 technique-to-case-study cross-links resolve to existing pages in built output"
    - "All 13 formula technique pages contain rendered KaTeX elements and zero raw LaTeX leaks"
    - "KaTeX CSS loads only on formula pages, not on non-formula pages"
    - "Lighthouse performance score is 90+ on bootstrap-plot, bihistogram, and histogram pages"
  artifacts:
    - path: "dist/eda/techniques/autocorrelation-plot/index.html"
      provides: "Built technique page with KaTeX formulas"
      contains: "class=\"katex\""
    - path: "dist/eda/techniques/bihistogram/index.html"
      provides: "Built technique page without formulas"
    - path: "dist/eda/techniques/histogram/index.html"
      provides: "Built Tier B technique page with variants"
    - path: "dist/eda/case-studies/beam-deflections/index.html"
      provides: "Built case study page for cross-link resolution"
  key_links:
    - from: "src/lib/eda/technique-content/*.ts"
      to: "dist/eda/techniques/*/index.html"
      via: "astro build static generation"
      pattern: "dist/eda/techniques/.*/index\\.html"
    - from: "technique caseStudySlugs"
      to: "dist/eda/case-studies/*/index.html"
      via: "href links in built HTML"
      pattern: "/eda/case-studies/"
    - from: "technique formulas tex"
      to: "katex.renderToString() output"
      via: "build-time KaTeX rendering in [slug].astro"
      pattern: "class=\"katex\""
---

<objective>
Full-sweep verification of the v1.10 milestone: clean build, deprecated API scan, cross-link validation, KaTeX formula rendering, and Lighthouse performance scoring across all 29 graphical technique pages.

Purpose: Final quality gate before closing milestone v1.10 (EDA Graphical Techniques -- NIST Parity & Validation). Ensures zero regressions from Phases 64-67 and all 5 VRFY requirements pass.
Output: Documented verification evidence for all 5 requirements (VRFY-01 through VRFY-05). No files created or modified -- this is a read-only audit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-verification-audit/68-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean build and deprecated Python API scan (VRFY-01 + VRFY-05)</name>
  <files></files>
  <action>
Run a clean Astro build and verify zero errors/warnings, then scan all technique content files for deprecated Python API patterns.

**Step 1 -- Clean build (VRFY-01):**
1. Delete dist/ to avoid stale cache: `rm -rf dist`
2. Run `npx astro build 2>&1 | tee /tmp/astro-build-output.txt`
3. Verify exit code is 0
4. Scan build output for EDA-related warnings: `grep -i -E "warn|error" /tmp/astro-build-output.txt | grep -i -E "eda|technique|katex|formula|svg"` -- expect zero matches
5. Verify all 29 technique pages exist in dist/:
   ```
   for slug in autocorrelation-plot bihistogram block-plot bootstrap-plot box-cox-linearity box-cox-normality box-plot complex-demodulation contour-plot doe-plots histogram lag-plot linear-plots mean-plot normal-probability-plot probability-plot ppcc-plot qq-plot run-sequence-plot scatter-plot spectral-plot std-deviation-plot star-plot weibull-plot youden-plot 4-plot 6-plot scatterplot-matrix conditioning-plot; do
     test -f "dist/eda/techniques/$slug/index.html" || echo "MISSING: $slug"
   done
   ```

**Step 2 -- Deprecated API grep (VRFY-05):**
Search all 7 technique-content .ts files for deprecated patterns:
```
grep -rn "distplot\|vert=True\|plt\.acorr\|normed=True\|random_state=" src/lib/eda/technique-content/*.ts
```
Expect zero matches. Each pattern is a specific deprecated API:
- `distplot` -- removed from seaborn 0.11
- `vert=True` -- deprecated matplotlib boxplot kwarg
- `plt.acorr` -- project uses manual autocorrelation per NIST
- `normed=True` -- deprecated matplotlib hist kwarg
- `random_state=` -- legacy numpy API (project uses np.random.default_rng)

Record exact match counts for the summary.
  </action>
  <verify>
`npx astro build` exits with code 0 AND all 29 technique slugs produce dist/eda/techniques/{slug}/index.html AND `grep -rn "distplot\|vert=True\|plt\.acorr\|normed=True\|random_state=" src/lib/eda/technique-content/*.ts` returns zero matches (exit code 1 = no matches)
  </verify>
  <done>Build completes cleanly with zero EDA-related errors/warnings, all 29 technique pages exist in dist/, and zero deprecated Python API patterns found across all technique content files</done>
</task>

<task type="auto">
  <name>Task 2: Cross-link and KaTeX formula validation (VRFY-03 + VRFY-04)</name>
  <files></files>
  <action>
Inspect built HTML to validate cross-link resolution and KaTeX formula rendering. Requires dist/ from Task 1.

**Step 1 -- Case study cross-link validation (VRFY-03):**
Verify all 10 case study destination pages exist:
```
for slug in beam-deflections ceramic-strength cryothermometry fatigue-life filter-transmittance heat-flow-meter normal-random-numbers random-walk standard-resistor uniform-random-numbers; do
  test -f "dist/eda/case-studies/$slug/index.html" && echo "OK: $slug" || echo "MISSING: $slug"
done
```

Then verify each technique's built HTML contains the expected cross-links (checking both directions -- link is present AND target exists). The 19 technique-to-case-study mappings are:
- autocorrelation-plot -> beam-deflections
- lag-plot -> beam-deflections
- run-sequence-plot -> beam-deflections
- spectral-plot -> beam-deflections
- linear-plots -> beam-deflections
- bootstrap-plot -> uniform-random-numbers
- histogram -> ceramic-strength
- bihistogram -> ceramic-strength
- block-plot -> ceramic-strength
- qq-plot -> ceramic-strength
- normal-probability-plot -> heat-flow-meter
- ppcc-plot -> normal-random-numbers
- probability-plot -> uniform-random-numbers
- weibull-plot -> fatigue-life
- scatter-plot -> standard-resistor
- complex-demodulation -> filter-transmittance
- 6-plot -> fatigue-life
- 4-plot -> normal-random-numbers, uniform-random-numbers, random-walk, cryothermometry, beam-deflections, filter-transmittance, standard-resistor, heat-flow-meter

For each mapping, grep the technique's built HTML for `/eda/case-studies/{slug}/`:
```
grep -q "/eda/case-studies/beam-deflections/" dist/eda/techniques/autocorrelation-plot/index.html
```

IMPORTANT: getStaticPaths silently drops invalid slugs. A missing link is NOT a 404 -- it means the slug was silently filtered out. Check for expected links being PRESENT, not just absence of errors.

**Step 2 -- KaTeX formula rendering validation (VRFY-04):**
For each of the 13 formula techniques, inspect built HTML:
```
FORMULA_TECHNIQUES="autocorrelation-plot spectral-plot ppcc-plot weibull-plot 4-plot mean-plot std-deviation-plot bootstrap-plot box-cox-linearity box-cox-normality normal-probability-plot probability-plot qq-plot"

for slug in $FORMULA_TECHNIQUES; do
  html="dist/eda/techniques/$slug/index.html"
  katex_present=$(grep -c 'class="katex"' "$html" 2>/dev/null || echo 0)
  katex_errors=$(grep -c 'katex-error' "$html" 2>/dev/null || echo 0)
  katex_css=$(grep -c 'katex.min.css' "$html" 2>/dev/null || echo 0)
  echo "$slug: rendered=$katex_present errors=$katex_errors css=$katex_css"
done
```

For each formula technique, verify:
1. `class="katex"` count > 0 (formulas rendered)
2. `katex-error` count = 0 (no malformed formulas)
3. `katex.min.css` count > 0 (CSS loaded)

Also verify KaTeX CSS does NOT load on 3 representative non-formula pages (bihistogram, box-plot, histogram):
```
for slug in bihistogram box-plot histogram; do
  katex_css=$(grep -c 'katex.min.css' "dist/eda/techniques/$slug/index.html" 2>/dev/null || echo 0)
  echo "$slug (no formulas): katex_css=$katex_css (expect 0)"
done
```

Note: Raw LaTeX appearing inside KaTeX `<annotation>` tags is EXPECTED (MathML accessibility). Only raw LaTeX appearing as visible text content outside KaTeX wrappers would be a failure.
  </action>
  <verify>
All 19 technique-to-case-study links found in built HTML AND all 10 case study pages exist in dist/ AND all 13 formula techniques have class="katex" present with zero katex-error instances AND non-formula pages do not load katex.min.css
  </verify>
  <done>Every case study cross-link on all technique pages resolves to a valid page, and all KaTeX formulas render as styled math with no raw LaTeX visible and no katex-error instances</done>
</task>

<task type="auto">
  <name>Task 3: Lighthouse performance scoring (VRFY-02)</name>
  <files></files>
  <action>
Run Lighthouse CLI against 3 representative technique pages served by `astro preview`. Requires built dist/ from Task 1.

**Three representative pages:**
1. bootstrap-plot -- Tier A with KaTeX formulas (2 formulas, pythonCode, case study links)
2. bihistogram -- Tier A without formulas (pythonCode, case study links, no KaTeX)
3. histogram -- Tier B with variants (4 SVG variants via PlotVariantSwap, pythonCode, no KaTeX)

**Steps:**
1. Check port 4322 is free: `lsof -ti:4322 | xargs kill 2>/dev/null || true`
2. Start preview server: `npx astro preview --port 4322 &` and capture PID
3. Wait for server to be ready (sleep 4, then curl localhost:4322 to confirm)
4. For each page, run Lighthouse:
   ```
   lighthouse "http://localhost:4322/eda/techniques/bootstrap-plot/" \
     --output=json \
     --output-path="/tmp/lh-bootstrap-plot.json" \
     --chrome-flags="--headless --no-sandbox" \
     --only-categories=performance \
     --quiet
   ```
5. Extract score: `node -e "const r=require('/tmp/lh-bootstrap-plot.json'); console.log(Math.round(r.categories.performance.score * 100))"`
6. Repeat for bihistogram and histogram
7. Kill preview server: `kill $PREVIEW_PID`

**Score threshold:** All 3 pages must score >= 90.

**Borderline handling:** If any score is 85-89, re-run that specific page 3 times and take the median. Lighthouse scores vary 5-10 points due to CPU throttling simulation. A score of 85-89 on first run may pass on subsequent runs.

**Pitfall avoidance:**
- Use `--port 4322` (not 4321) to avoid conflict with any running dev server
- Always kill the preview server in cleanup, even if Lighthouse fails
- Use `--only-categories=performance` to skip irrelevant accessibility/SEO audits
- Use `--chrome-flags="--headless --no-sandbox"` for CLI execution
  </action>
  <verify>
All 3 Lighthouse performance scores >= 90 (extracted from JSON output files at /tmp/lh-*.json)
  </verify>
  <done>Lighthouse performance score is 90+ on bootstrap-plot (with formulas), bihistogram (without formulas), and histogram (Tier B with variants)</done>
</task>

</tasks>

<verification>
All 5 VRFY requirements pass:
1. VRFY-01: `astro build` exits 0, zero EDA-related warnings, 29 technique pages in dist/
2. VRFY-02: Lighthouse performance >= 90 on 3 representative pages
3. VRFY-03: All 19 technique-to-case-study links present in built HTML, all 10 case study pages exist
4. VRFY-04: All 13 formula techniques have rendered KaTeX (class="katex"), zero katex-error, KaTeX CSS absent on non-formula pages
5. VRFY-05: Zero matches for deprecated Python patterns (distplot, vert=True, plt.acorr, normed=True, random_state=)
</verification>

<success_criteria>
- astro build exits 0 with zero EDA-related warnings
- 29/29 technique pages exist in dist/
- 0 deprecated Python API matches across all technique content files
- 19/19 cross-links present in built HTML, 10/10 case study pages exist
- 13/13 formula pages have class="katex" present, 0 katex-error instances
- 3/3 non-formula sample pages do NOT load katex.min.css
- 3/3 Lighthouse scores >= 90
</success_criteria>

<output>
After completion, create `.planning/phases/68-verification-audit/68-01-SUMMARY.md`
</output>
