---
phase: 29-visualization-components
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/components/db-compass/CompassScoreBreakdown.astro
  - src/components/db-compass/CompassScoringTable.astro
  - src/components/db-compass/CapBadge.astro
autonomous: true

must_haves:
  truths:
    - "The score breakdown component displays all 8 dimension scores with colored bars proportional to score value and a total row showing /80"
    - "The sortable scoring table renders all 12 models across 8 dimensions and sorts correctly (ascending/descending) when column headers are clicked"
    - "The CAP theorem badge shows the correct classification (CP, AP, CA, or Tunable) with appropriate color coding"
    - "The scoring table works on mobile with horizontal scroll and a sticky model name column"
  artifacts:
    - path: "src/components/db-compass/CompassScoreBreakdown.astro"
      provides: "8-dimension score bars with total row"
      contains: "DIMENSIONS.map"
    - path: "src/components/db-compass/CompassScoringTable.astro"
      provides: "Sortable 12x8 scoring table with inline script"
      contains: "data-sortable"
    - path: "src/components/db-compass/CapBadge.astro"
      provides: "CAP theorem classification badge"
      contains: "classification"
  key_links:
    - from: "src/lib/db-compass/dimensions.ts"
      to: "src/components/db-compass/CompassScoreBreakdown.astro"
      via: "DIMENSIONS, DIMENSION_COLORS imports"
      pattern: "import.*DIMENSION_COLORS.*dimensions"
    - from: "src/lib/db-compass/dimensions.ts"
      to: "src/components/db-compass/CompassScoringTable.astro"
      via: "DIMENSIONS imports for column headers"
      pattern: "import.*DIMENSIONS.*dimensions"
    - from: "src/components/db-compass/CompassScoringTable.astro"
      to: "inline script"
      via: "data attributes on tr elements parsed by sort script"
      pattern: "data-sort.*dataset"
---

<objective>
Build the three remaining visualization components: CompassScoreBreakdown (VIZ-03), CompassScoringTable (VIZ-04), and CapBadge (VIZ-05). The score breakdown shows per-dimension bars, the table enables interactive sorting of all 12 models, and the badge displays CAP theorem classification.

Purpose: These components complete the visualization primitive set — the score breakdown and CAP badge appear on detail pages, while the sortable table is the primary comparison tool on the overview page.

Output: 3 Astro components in src/components/db-compass/
</objective>

<execution_context>
@/Users/patrykattc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/patrykattc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-visualization-components/29-RESEARCH.md
@.planning/phases/29-visualization-components/29-01-SUMMARY.md

@src/lib/db-compass/schema.ts
@src/lib/db-compass/dimensions.ts
@src/components/beauty-index/ScoreBreakdown.astro
@src/components/beauty-index/ScoringTable.astro
@src/components/beauty-index/TierBadge.astro
@src/components/beauty-index/FeatureMatrix.astro
@src/data/db-compass/models.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build CompassScoreBreakdown and CapBadge components</name>
  <files>
    src/components/db-compass/CompassScoreBreakdown.astro
    src/components/db-compass/CapBadge.astro
  </files>
  <action>
**1. CompassScoreBreakdown.astro (VIZ-03):**

Create `src/components/db-compass/CompassScoreBreakdown.astro` following `src/components/beauty-index/ScoreBreakdown.astro` closely.

Props: `model: DbModel`

Key differences from Beauty Index ScoreBreakdown:
- Import from `../../lib/db-compass/dimensions` (DIMENSIONS, DIMENSION_COLORS) and `../../lib/db-compass/schema` (DbModel, totalScore) — NOT beauty-index
- Score access: `model.scores[dim.key]` (nested object) instead of `language[dim.key]` (flat)
- 8 dimensions instead of 6
- Total row shows `/80` (8 dims x 10 max) instead of `/60`
- Total icon: use `\u03A3` (Greek capital sigma, sum symbol) instead of "B" (beauty)
- Color bars: `widthPercent = (score / 10) * 100` using `DIMENSION_COLORS[dim.key]`

Iterate over DIMENSIONS array (canonical order), NOT Object.keys(model.scores). This ensures the score breakdown matches the radar chart axis ordering.

Structure:
```
<div class="space-y-2 w-full max-w-xs">
  {dimensionRows.map(...)} <!-- 8 rows: symbol | shortName | score | bar -->
  <!-- Total row with border-top separator -->
  <div>Σ | Total | {total}/80</div>
</div>
```

Each row: dimension symbol (colored), shortName, numeric score, proportional bar (colored). Same layout as Beauty Index but with 8 rows.

Ships ZERO client-side JavaScript.

**2. CapBadge.astro (VIZ-05):**

Create `src/components/db-compass/CapBadge.astro` following `src/components/beauty-index/TierBadge.astro` pattern.

Props: `classification: 'CP' | 'AP' | 'CA' | 'Tunable'`, `size?: 'sm' | 'md' | 'lg'` (default 'md')

CAP_CONFIG record mapping each classification to display properties:
```typescript
const CAP_CONFIG: Record<string, { label: string; color: string; textColor: string; description: string }> = {
  CP: { label: 'CP', color: '#4A90D9', textColor: '#2c6fad', description: 'Consistency + Partition Tolerance' },
  AP: { label: 'AP', color: '#2AAA8A', textColor: '#1f8068', description: 'Availability + Partition Tolerance' },
  CA: { label: 'CA', color: '#E8734A', textColor: '#c45a34', description: 'Consistency + Availability' },
  Tunable: { label: 'Tunable', color: '#D4A843', textColor: '#a88335', description: 'Configurable consistency/availability trade-off' },
};
```

Size variant classes (same pattern as TierBadge):
- sm: `text-xs px-2 py-0.5`
- md: `text-sm px-3 py-1`
- lg: `text-base px-4 py-1.5`

Render: `<span>` with inline `background-color: ${color}20` and `color: ${textColor}`. Add `title` attribute with the description for accessibility on hover. Add `role="text"` and `aria-label="CAP Theorem: {label} — {description}"`.

Ships ZERO client-side JavaScript.
  </action>
  <verify>
Run `npx astro check` — no type errors. Verify CompassScoreBreakdown iterates over DIMENSIONS array (not Object.keys). Verify CapBadge accepts all 4 classification values.
  </verify>
  <done>
CompassScoreBreakdown renders 8 dimension rows with colored bars plus total/80 row, using DIMENSIONS canonical order. CapBadge renders color-coded CP/AP/CA/Tunable badge with hover description.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build CompassScoringTable with interactive column sorting</name>
  <files>
    src/components/db-compass/CompassScoringTable.astro
  </files>
  <action>
Create `src/components/db-compass/CompassScoringTable.astro` following `src/components/beauty-index/ScoringTable.astro` closely. This is the most complex component — it includes HTML table rendering AND an inline `<script>` for client-side sorting.

Props: `models: DbModel[]`

**Frontmatter:**
- Import DIMENSIONS from `../../lib/db-compass/dimensions`
- Import DbModel, totalScore from `../../lib/db-compass/schema`
- Sort models by totalScore descending (default display order)

**HTML Table Structure:**

Wrap in `<div class="overflow-x-auto">` for mobile horizontal scroll.

Table columns (11 total): Rank | Model | 8 dimension columns | Total

**Header row (`<thead>`):**
- Each `<th>` contains a `<button>` with `data-sort` attribute for sort key and optional `data-type="number"` for numeric sorting
- Rank column: `data-sort="rank"`, `data-type="number"`
- Model column: `data-sort="name"`, no data-type (string sort)
- Dimension columns: iterate `DIMENSIONS.map(dim => ...)`, use `dim.symbol` as the visible button text, `title={dim.name}` for hover. Use kebab-case data-sort attribute: convert dim.key to kebab-case (e.g., `operationalSimplicity` → `operational-simplicity`). This ensures the dataset API maps correctly: `data-operational-simplicity` → `dataset.operationalSimplicity`.
- Total column: `data-sort="total"`, `data-type="number"`
- Default sort indicator: Rank column gets `class="sort-desc"` and `aria-sort="descending"`

**Body rows (`<tbody>`):**
- Each `<tr>` carries data attributes for sorting. Use kebab-case for multi-word dimension keys:
  - `data-rank={i + 1}`
  - `data-name={model.name.toLowerCase()}`
  - For each dimension: `data-scalability`, `data-performance`, `data-reliability`, `data-operational-simplicity`, `data-query-flexibility`, `data-schema-flexibility`, `data-ecosystem-maturity`, `data-learning-curve` — values from `model.scores[dim.key]`
  - `data-total={totalScore(model)}`
- Model name cell: `<a href="/tools/db-compass/${model.slug}/">` with accent color link
- Dimension score cells: `<td class="px-2 py-1.5 text-center">{model.scores[dim.key]}</td>`
- Total cell: `<td class="px-2 py-1.5 text-center font-bold">{total}</td>`

**Mobile responsive (VIZ-06 partial):**
- Model name column sticky: `<th>` and `<td>` for model name get `sticky left-0 bg-[var(--color-surface)] z-10` (FeatureMatrix pattern)
- Dimension column headers use `dim.symbol` (single character) to minimize width
- Table container has `overflow-x-auto`

**Inline `<script>` (sort logic):**
Adapt the ScoringTable.astro inline script. Key changes:
- Use `astro:page-load` event listener for View Transition compatibility
- Query `[data-sortable]` table, get all `button[data-sort]` elements
- On click: read `button.dataset.sort` to get the sort key
- **Critical:** The sort key from the button's `data-sort` uses kebab-case (e.g., `operational-simplicity`). The `dataset` API on `<tr>` elements auto-converts kebab-case `data-operational-simplicity` to camelCase `dataset.operationalSimplicity`. So in the sort comparator, convert the kebab-case sort key to camelCase before accessing `row.dataset[camelKey]`. Add a small helper:
  ```javascript
  const toCamel = (s) => s.replace(/-([a-z])/g, (_, c) => c.toUpperCase());
  ```
- Sort direction toggle: if `th` already has `sort-asc`, switch to `sort-desc`, else `sort-asc`
- Clear all `sort-asc`/`sort-desc` classes and `aria-sort` from other headers
- Reorder rows via `tbody.appendChild(row)` after sort
- Update rank column (first `<td>`) text to reflect new position
- Live region `#sort-status` announces sort changes to screen readers

**`<style>` block:**
Copy the sort indicator styles from ScoringTable.astro:
- `.sort-btn .sort-indicator::after` for default empty state
- `th.sort-asc .sort-btn .sort-indicator::after` for up arrow `\25B2`
- `th.sort-desc .sort-btn .sort-indicator::after` for down arrow `\25BC`
- `.sort-btn:focus-visible` for keyboard accessibility outline

Add screen-reader-only live region: `<div id="sort-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>` after the table wrapper.
  </action>
  <verify>
1. Run `npx astro check` — no type errors
2. Run `npx astro build` — build succeeds
3. Verify the inline script uses `toCamel()` helper for kebab-case → camelCase dataset key conversion
4. Verify the model name column has `sticky left-0` classes
5. Verify all 8 dimension data attributes on `<tr>` elements use kebab-case
6. Verify `aria-sort` and live region are present for accessibility
  </verify>
  <done>
CompassScoringTable renders all 12 models in a sortable HTML table with 8 dimension columns using dimension symbols as headers. Clicking any column header sorts ascending/descending with visual indicators. Model name column is sticky on mobile scroll. Keyboard accessible with aria-sort and live region announcements.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in any db-compass component
2. `npx astro build` succeeds
3. CompassScoreBreakdown iterates DIMENSIONS array, not Object.keys(model.scores)
4. CompassScoringTable data attributes use kebab-case for multi-word keys
5. CompassScoringTable inline script converts kebab-case sort keys to camelCase for dataset access
6. CapBadge handles all 4 classification values (CP, AP, CA, Tunable)
7. All components use proper imports from db-compass (not beauty-index) for data/types
8. Scoring table model name column is sticky with overflow-x-auto wrapper
9. All components have zero client-side JavaScript except the table sort script
</verification>

<success_criteria>
- CompassScoreBreakdown shows 8 bars + total/80 in DIMENSIONS canonical order
- CompassScoringTable is sortable by any column, mobile-friendly with sticky column
- CapBadge renders correct color per classification with accessible hover text
- All sort interactions have keyboard accessibility (button elements, focus-visible, aria-sort)
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-visualization-components/29-02-SUMMARY.md`
</output>
