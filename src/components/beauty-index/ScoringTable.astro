---
/**
 * ScoringTable.astro â€” Sortable HTML table of all Beauty Index languages.
 * Displays rank, name, 6 dimension scores, and total score with tier color indication.
 * Includes inline client-side JavaScript for column sorting.
 * Sort headers use button elements for WCAG 2.1 AA keyboard accessibility.
 */
import { DIMENSIONS } from '../../lib/beauty-index/dimensions';
import { getTierColor } from '../../lib/beauty-index/tiers';
import { type Language, totalScore } from '../../lib/beauty-index/schema';

interface Props {
  languages: Language[];
}

const { languages } = Astro.props;

// Sort by total score descending (default)
const sorted = [...languages].sort((a, b) => totalScore(b) - totalScore(a));
---

<div class="overflow-x-auto">
  <table class="w-full text-sm" data-sortable>
    <thead>
      <tr class="border-b-2 border-[var(--color-border)]">
        <th scope="col" class="px-2 py-0 sort-desc" aria-sort="descending">
          <button
            type="button"
            class="sort-btn inline-flex items-center gap-0.5 px-2 py-2 w-full text-left cursor-pointer select-none bg-transparent border-none font-inherit text-inherit"
            data-sort="rank"
            data-type="number"
          >
            Rank<span class="sort-indicator" aria-hidden="true"></span>
          </button>
        </th>
        <th scope="col" class="px-2 py-0">
          <button
            type="button"
            class="sort-btn inline-flex items-center gap-0.5 px-2 py-2 w-full text-left cursor-pointer select-none bg-transparent border-none font-inherit text-inherit"
            data-sort="name"
          >
            Language<span class="sort-indicator" aria-hidden="true"></span>
          </button>
        </th>
        {DIMENSIONS.map((dim) => (
          <th scope="col" class="px-2 py-0">
            <button
              type="button"
              class="sort-btn inline-flex items-center justify-center gap-0.5 px-2 py-2 w-full cursor-pointer select-none bg-transparent border-none font-inherit text-inherit"
              data-sort={dim.key}
              data-type="number"
              title={dim.name}
            >
              {dim.symbol}<span class="sort-indicator" aria-hidden="true"></span>
            </button>
          </th>
        ))}
        <th scope="col" class="px-2 py-0">
          <button
            type="button"
            class="sort-btn inline-flex items-center justify-center gap-0.5 px-2 py-2 w-full cursor-pointer select-none bg-transparent border-none font-inherit text-inherit"
            data-sort="total"
            data-type="number"
          >
            Total<span class="sort-indicator" aria-hidden="true"></span>
          </button>
        </th>
      </tr>
    </thead>
    <tbody>
      {sorted.map((lang, i) => {
        const total = totalScore(lang);
        const tierColor = getTierColor(lang.tier);
        return (
          <tr
            class="border-b border-[var(--color-border)]/50 hover:bg-[var(--color-surface-alt)] transition-colors"
            style={`border-left: 3px solid ${tierColor};`}
            data-rank={i + 1}
            data-name={lang.name.toLowerCase()}
            data-phi={lang.phi}
            data-omega={lang.omega}
            data-lambda={lang.lambda}
            data-psi={lang.psi}
            data-gamma={lang.gamma}
            data-sigma={lang.sigma}
            data-total={total}
          >
            <td class="px-2 py-1.5 text-[var(--color-text-secondary)]">{i + 1}</td>
            <td class="px-2 py-1.5">
              <a
                href={`/beauty-index/${lang.id}/`}
                class="text-[var(--color-accent)] hover:underline font-medium"
              >
                {lang.name}
              </a>
            </td>
            {DIMENSIONS.map((dim) => (
              <td class="px-2 py-1.5 text-center" data-col={dim.key}>
                {lang[dim.key]}
              </td>
            ))}
            <td class="px-2 py-1.5 text-center font-bold">{total}</td>
          </tr>
        );
      })}
    </tbody>
  </table>
  <div id="sort-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</div>

<style>
  .sort-btn .sort-indicator::after {
    content: '';
    display: inline-block;
    margin-left: 4px;
    opacity: 0.3;
  }
  th.sort-asc .sort-btn .sort-indicator::after {
    content: '\25B2';
    opacity: 1;
  }
  th.sort-desc .sort-btn .sort-indicator::after {
    content: '\25BC';
    opacity: 1;
  }
  .sort-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: -2px;
    border-radius: 4px;
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const table = document.querySelector<HTMLTableElement>('[data-sortable]');
    if (!table) return;
    const buttons = table.querySelectorAll<HTMLButtonElement>('button[data-sort]');
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        const th = button.closest('th');
        if (!th) return;

        const key = button.dataset.sort!;
        const isNumeric = button.dataset.type === 'number';
        const isAsc = th.classList.contains('sort-asc');
        const newDir = isAsc ? 'desc' : 'asc';

        // Clear all sort classes and aria-sort attributes
        const allThs = table.querySelectorAll<HTMLTableCellElement>('thead th');
        allThs.forEach((h) => {
          h.classList.remove('sort-asc', 'sort-desc');
          h.removeAttribute('aria-sort');
        });

        // Set active sort state
        th.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
        th.setAttribute('aria-sort', newDir === 'asc' ? 'ascending' : 'descending');

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const aVal = a.dataset[key] ?? '';
          const bVal = b.dataset[key] ?? '';
          let cmp: number;
          if (isNumeric) {
            cmp = parseFloat(aVal) - parseFloat(bVal);
          } else {
            cmp = aVal.localeCompare(bVal);
          }
          return newDir === 'asc' ? cmp : -cmp;
        });

        rows.forEach((row, idx) => {
          row.querySelector('td')!.textContent = String(idx + 1);
          tbody.appendChild(row);
        });

        // Announce sort change to screen readers
        const liveRegion = document.getElementById('sort-status');
        if (liveRegion) {
          const label = button.getAttribute('title') || button.textContent?.trim() || key;
          liveRegion.textContent = `Table sorted by ${label}, ${newDir === 'asc' ? 'ascending' : 'descending'}`;
        }
      });
    });
  });
</script>
