---
/**
 * FatigueLifePlots — Build-time SVG plot generator for the Fatigue Life case study.
 * Accepts a `type` prop to select which plot to render.
 * Covers standard EDA diagnostics for the BIRNSAUN.DAT fatigue life dataset.
 * All SVG is generated at build time — zero client-side JS.
 */
import PlotFigure from './PlotFigure.astro';
import { fatigueLife } from '../../data/eda/datasets';
import {
  generate4Plot,
  generateLinePlot,
  generateLagPlot,
  generateHistogram,
  generateProbabilityPlot,
  generateBoxPlot,
  generateAutocorrelationPlot,
  generateSpectralPlot,
} from '../../lib/eda/svg-generators/index';
import {
  locationTest,
  bartlettTest,
  runsTest,
  autocorrelation,
  andersonDarlingNormal,
  ppccNormal,
  grubbsTest,
} from '../../lib/eda/math/statistics';

type PlotType =
  | '4-plot' | 'run-sequence' | 'lag' | 'histogram'
  | 'normal-probability' | 'box-plot'
  | 'autocorrelation' | 'spectral'
  | 'weibull-probability'
  | 'gamma-probability';

interface Props {
  type: PlotType;
  caption?: string;
}

const { type, caption } = Astro.props;

const singleConfig = {
  width: 720,
  height: 450,
  margin: { top: 35, right: 20, bottom: 45, left: 55 },
};

const compositeConfig = {
  width: 720,
  height: 540,
};

// Quantitative test battery
const locTest = locationTest(fatigueLife);
const bartTest = bartlettTest(fatigueLife, 4);
const runs = runsTest(fatigueLife);
const acf = autocorrelation(fatigueLife, 1);
const r1 = acf[1];
const adTest = andersonDarlingNormal(fatigueLife);
const ppcc = ppccNormal(fatigueLife);
const grubbs = grubbsTest(fatigueLife);

let svg = '';

switch (type) {
  case '4-plot':
    svg = generate4Plot(fatigueLife, compositeConfig);
    break;
  case 'run-sequence':
    svg = generateLinePlot({
      data: fatigueLife,
      mode: 'run-sequence',
      config: singleConfig,
      title: 'Run Sequence Plot',
      xLabel: 'Observation',
      yLabel: 'Fatigue Life (×1000 cycles)',
    });
    break;
  case 'lag':
    svg = generateLagPlot({
      data: fatigueLife,
      lag: 1,
      config: singleConfig,
      title: 'Lag Plot (k = 1)',
    });
    break;
  case 'histogram':
    svg = generateHistogram({
      data: fatigueLife,
      showKDE: true,
      config: singleConfig,
      title: 'Histogram',
      xLabel: 'Fatigue Life (×1000 cycles)',
      yLabel: 'Frequency',
    });
    break;
  case 'normal-probability':
    svg = generateProbabilityPlot({
      data: fatigueLife,
      type: 'normal',
      config: singleConfig,
      title: 'Normal Probability Plot',
    });
    break;
  case 'box-plot':
    svg = generateBoxPlot({
      groups: [{ label: 'Fatigue Life', values: fatigueLife }],
      config: singleConfig,
      title: 'Box Plot',
      xLabel: '',
      yLabel: 'Fatigue Life (×1000 cycles)',
      showOutliers: true,
    });
    break;
  case 'autocorrelation':
    svg = generateAutocorrelationPlot({
      data: fatigueLife,
      maxLag: 50,
      config: singleConfig,
      title: 'Autocorrelation Plot',
      xLabel: 'Lag',
      yLabel: 'Autocorrelation',
    });
    break;
  case 'spectral':
    svg = generateSpectralPlot({
      data: fatigueLife,
      config: singleConfig,
      title: 'Spectral Plot',
    });
    break;
  case 'weibull-probability':
    // 3-parameter Weibull: subtract location=181 from data before plotting
    svg = generateProbabilityPlot({
      data: fatigueLife.map(v => v - 181),
      type: 'weibull',
      config: singleConfig,
      title: 'Weibull Probability Plot',
      xLabel: 'ln(-ln(1-p))',
      yLabel: 'ln(Fatigue Life - 181)',
    });
    break;
  case 'gamma-probability':
    svg = generateProbabilityPlot({
      data: fatigueLife,
      type: 'gamma',
      gammaShape: 11.85,
      gammaScale: 118.2,
      config: singleConfig,
      title: 'Gamma Probability Plot',
    });
    break;
}

const defaultCaptions: Record<PlotType, string> = {
  '4-plot': 'Four-plot diagnostic layout for the fatigue life dataset (run sequence, lag, histogram, normal probability).',
  'run-sequence': 'Run sequence plot of 101 fatigue life measurements showing stable location and variation around a mean of approximately 1401 thousand cycles.',
  'lag': 'Lag-1 plot showing a structureless scatter cloud, consistent with independent observations. The elongation reflects the right-skewed distribution rather than serial dependence.',
  'histogram': 'Histogram with KDE overlay revealing a right-skewed distribution. Most observations cluster between 800 and 1,600 thousand cycles with a long upper tail past 2,000.',
  'normal-probability': 'Normal probability plot of the fatigue life data. Deviation from linearity in the tails suggests departure from a Gaussian model, though the effect is moderate.',
  'box-plot': 'Box plot of fatigue life measurements showing the interquartile range, median, whiskers, and a potential outlier at the high end near 2,440 thousand cycles.',
  'autocorrelation': 'Autocorrelation plot confirming that the fatigue life measurements are independent — all coefficients fall within the 95% confidence bands.',
  'spectral': 'Spectral plot showing a flat spectrum with no dominant peaks, consistent with independent observations.',
  'weibull-probability': 'Weibull probability plot of location-shifted fatigue life data (x - 181). The 3-parameter Weibull model with location=181, shape=3.43, scale=1357 uses the NIST MLE estimates. Points near the reference line indicate a reasonable Weibull fit.',
  'gamma-probability': 'Gamma probability plot of fatigue life data with shape=11.85, scale=118.2 (NIST MLE estimates). Points near the reference line indicate a good gamma fit.',
};

const figCaption = caption ?? defaultCaptions[type];
---

<PlotFigure svg={svg} caption={figCaption} />
