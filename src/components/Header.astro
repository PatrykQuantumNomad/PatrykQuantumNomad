---
// Header.astro
// Scroll-aware sticky header with backdrop blur, animated underlines, and smooth mobile menu.
import { Image } from 'astro:assets';
import hulkImg from '../assets/images/hulk.png';

const navLinks = [
  { href: '/', label: 'Home' },
  { href: '/blog/', label: 'Blog' },
  { href: '/beauty-index/', label: 'Beauty Index' },
  { href: '/db-compass/', label: 'DB Compass' },
  { href: '/eda/', label: 'EDA' },
  { href: '/tools/', label: 'Tools' },
  { href: '/projects/', label: 'Projects' },
  { href: '/about/', label: 'About' },
  { href: '/contact/', label: 'Contact' },
];

const currentPath = Astro.url.pathname;
---

<header
  id="site-header"
  role="banner"
  class="sticky top-0 z-50 bg-[var(--color-surface)]/60 backdrop-blur-xl border-b border-transparent transition-all duration-300"
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <a
        href="/"
        class="flex items-center gap-2 hover:opacity-80 transition-opacity"
      >
        <Image
          src={hulkImg}
          alt="Patryk Golabek"
          width={36}
          height={36}
          class="rounded-full"
        />
        <span class="font-mono text-lg font-bold text-[var(--color-accent)] tracking-widest">PG<span class="text-[var(--color-accent-secondary)]">_</span></span>
      </a>

      <!-- Desktop navigation (hidden on mobile, shown md+) -->
      <nav aria-label="Main navigation" class="hidden md:flex items-center gap-6">
        {navLinks.map((link) => {
          const isActive = currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href));
          return (
            <a
              href={link.href}
              class:list={[
                'nav-link font-medium transition-colors',
                isActive
                  ? 'text-[var(--color-accent)]'
                  : 'text-[var(--color-text-secondary)] hover:text-[var(--color-accent)]',
              ]}
              {...(isActive ? { 'aria-current': 'page' } : {})}
            >
              {link.label}
            </a>
          );
        })}
      </nav>

      <!-- Right side: theme toggle + mobile menu button -->
      <div class="flex items-center gap-2">
        <!-- Mobile menu button (visible below md) -->
        <button
          id="mobile-menu-btn"
          type="button"
          class="md:hidden w-10 h-10 flex items-center justify-center rounded-lg hover:bg-[var(--color-surface-alt)] transition-colors cursor-pointer border-none bg-transparent text-[var(--color-text-primary)]"
          aria-label="Open menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <!-- Hamburger icon -->
          <svg
            id="menu-icon-open"
            class="w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>

          <!-- Close icon (hidden by default) -->
          <svg
            id="menu-icon-close"
            class="hidden w-5 h-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile navigation panel (slide transition) -->
  <nav
    id="mobile-menu"
    class="md:hidden border-t border-[var(--color-border)] overflow-hidden transition-all duration-300 ease-in-out"
    style="max-height: 0; opacity: 0;"
    aria-label="Mobile navigation"
  >
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      {navLinks.map((link) => {
        const isActive = currentPath === link.href || (link.href !== '/' && currentPath.startsWith(link.href));
        return (
          <a
            href={link.href}
            class:list={[
              'block py-3 font-medium transition-colors',
              isActive
                ? 'text-[var(--color-accent)]'
                : 'text-[var(--color-text-secondary)] hover:text-[var(--color-accent)]',
            ]}
            {...(isActive ? { 'aria-current': 'page' } : {})}
          >
            {link.label}
          </a>
        );
      })}
    </div>
  </nav>
</header>

<script>
  function initHeader() {
    const header = document.getElementById('site-header');
    const menuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu') as HTMLElement;
    const iconOpen = document.getElementById('menu-icon-open');
    const iconClose = document.getElementById('menu-icon-close');

    if (!header) return;
    const headerEl = header;

    // Scroll-aware header: hide on scroll down, show on scroll up
    let lastScroll = 0;
    let ticking = false;

    function updateHeader() {
      const scrollY = window.scrollY;
      const isScrolled = scrollY > 20;

      // Show/hide border based on scroll position
      if (isScrolled) {
        headerEl.style.borderColor = 'var(--color-border)';
      } else {
        headerEl.style.borderColor = 'transparent';
      }

      // Hide on scroll down, show on scroll up
      if (scrollY > lastScroll && scrollY > 80) {
        headerEl.style.transform = 'translateY(-100%)';
      } else {
        headerEl.style.transform = 'translateY(0)';
      }

      lastScroll = scrollY;
      ticking = false;
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(updateHeader);
        ticking = true;
      }
    }, { passive: true });

    // Mobile menu toggle with slide animation
    menuBtn?.addEventListener('click', () => {
      const isOpen = mobileMenu.style.maxHeight !== '0px' && mobileMenu.style.maxHeight !== '';

      if (isOpen) {
        mobileMenu.style.maxHeight = '0';
        mobileMenu.style.opacity = '0';
        iconOpen?.classList.remove('hidden');
        iconClose?.classList.add('hidden');
        menuBtn.setAttribute('aria-expanded', 'false');
        menuBtn.setAttribute('aria-label', 'Open menu');
      } else {
        mobileMenu.style.maxHeight = mobileMenu.scrollHeight + 'px';
        mobileMenu.style.opacity = '1';
        iconOpen?.classList.add('hidden');
        iconClose?.classList.remove('hidden');
        menuBtn.setAttribute('aria-expanded', 'true');
        menuBtn.setAttribute('aria-label', 'Close menu');
      }
    });

    // Close mobile menu when a link is clicked
    const mobileLinks = mobileMenu?.querySelectorAll('a');
    mobileLinks?.forEach((link) => {
      link.addEventListener('click', () => {
        mobileMenu.style.maxHeight = '0';
        mobileMenu.style.opacity = '0';
        iconOpen?.classList.remove('hidden');
        iconClose?.classList.add('hidden');
        menuBtn?.setAttribute('aria-expanded', 'false');
        menuBtn?.setAttribute('aria-label', 'Open menu');
      });
    });
  }

  document.addEventListener('astro:page-load', initHeader);
</script>
