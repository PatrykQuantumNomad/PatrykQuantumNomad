---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';
import Pagination from '../../components/Pagination.astro';

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  const sortedPosts = posts.sort(
    (a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf()
  );
  return paginate(sortedPosts, { pageSize: 10 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// For tag cloud and stats, use the full collection
const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allSorted = allPosts.sort(
  (a, b) => b.data.publishedDate.valueOf() - a.data.publishedDate.valueOf()
);

// Tag cloud from ALL posts
const tagCounts = new Map<string, number>();
allSorted.forEach((post) => {
  post.data.tags.forEach((tag) => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});
const sortedTags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1]);

// Year groups from CURRENT PAGE posts only
const postsByYear = new Map<number, typeof page.data>();
page.data.forEach((post) => {
  const year = post.data.publishedDate.getFullYear();
  if (!postsByYear.has(year)) postsByYear.set(year, []);
  postsByYear.get(year)!.push(post);
});
const years = [...postsByYear.keys()].sort((a, b) => b - a);

// Global stats
const totalPosts = allSorted.length;
const allYears = [...new Set(allSorted.map((p) => p.data.publishedDate.getFullYear()))];
const oldestYear = Math.min(...allYears);
const newestYear = Math.max(...allYears);
---

<Layout
  title="Blog — Patryk Golabek | Cloud-Native & AI/ML Articles"
  description="Technical articles on Kubernetes, cloud-native architecture, AI/ML engineering, LLM agents, RAG pipelines, and platform engineering by Patryk Golabek."
>
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

    {/* Hero Section */}
    <div data-blog-hero>
      <h1
        class="text-4xl sm:text-5xl font-heading font-extrabold"
        data-blog-hero-title
      >
        Blog
      </h1>
      <p
        class="text-lg text-[var(--color-text-secondary)] mt-4"
        data-blog-hero-subtitle
      >
        Articles on building things — cloud platforms, AI agents, data pipelines, mobile apps, and the occasional robotic arm.
      </p>
      <p class="meta-mono mt-3" data-blog-hero-stats>
        {totalPosts} ARTICLES &middot; {oldestYear} &mdash; {newestYear}{page.lastPage > 1 && <> &middot; PAGE {page.currentPage} OF {page.lastPage}</>}
      </p>
    </div>

    <div class="gradient-divider mt-10" data-divider-reveal aria-hidden="true"></div>

    {/* Tag Cloud Section */}
    <div class="mt-10">
      <h2
        class="text-lg font-heading font-bold mb-4"
        data-reveal
      >
        Browse by Topic
      </h2>
      <div class="flex flex-wrap gap-2" data-reveal>
        {sortedTags.map(([tag, count]) => (
          <a
            href={`/blog/tags/${tag}/`}
            class="text-xs px-3 py-1.5 rounded-full bg-[var(--color-accent)]/10 text-[var(--color-accent)] hover:bg-[var(--color-accent)]/20 transition-colors font-medium"
          >
            {tag} <span class="opacity-60">({count})</span>
          </a>
        ))}
      </div>
    </div>

    <div class="gradient-divider mt-10" data-divider-reveal aria-hidden="true"></div>

    {/* Year-Grouped Post Listing */}
    {page.data.length > 0 ? (
      <div>
        {years.map((year) => (
          <div data-card-group>
            <h2
              class="flex items-center justify-between text-2xl font-heading font-bold text-[var(--color-accent)] mb-6 mt-12 first:mt-0"
              data-reveal
            >
              <span>{year}</span>
              <span class="meta-mono text-sm">{postsByYear.get(year)!.length} posts</span>
            </h2>
            <div class="space-y-6">
              {postsByYear.get(year)!.map((post) => (
                <div data-card-item>
                  <BlogCard post={post} />
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p class="text-[var(--color-text-secondary)] mt-12">No posts yet. Check back soon!</p>
    )}

    {/* Pagination */}
    <Pagination
      currentPage={page.currentPage}
      lastPage={page.lastPage}
      prevUrl={page.url.prev}
      nextUrl={page.url.next}
    />
  </section>
</Layout>

<script>
  import { gsap } from 'gsap';

  function initBlogHero() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) return;

    const hero = document.querySelector('[data-blog-hero]');
    if (!hero) return;

    const tl = gsap.timeline({ defaults: { ease: 'power3.out' } });
    tl.from('[data-blog-hero-title]', {
      y: 40,
      opacity: 0,
      duration: 0.8,
    })
    .from('[data-blog-hero-subtitle]', {
      y: 30,
      opacity: 0,
      duration: 0.7,
    }, '-=0.5')
    .from('[data-blog-hero-stats]', {
      y: 20,
      opacity: 0,
      duration: 0.6,
    }, '-=0.4');
  }

  document.addEventListener('astro:page-load', initBlogHero);
</script>
