---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import BlogPostingJsonLd from '../../components/BlogPostingJsonLd.astro';
import BreadcrumbJsonLd from '../../components/BreadcrumbJsonLd.astro';
import FAQPageJsonLd from '../../components/FAQPageJsonLd.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  const nativePosts = allPosts.filter((p) => !p.data.externalUrl);

  return nativePosts.map((post) => ({
    params: { slug: post.id },
    props: { post, allPosts },
  }));
}

const { post, allPosts } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(post);
const { title, description, publishedDate, tags } = post.data;

// Compute related posts by tag overlap
const relatedPosts = allPosts
  .filter((p) => p.id !== post.id)
  .map((p) => {
    const overlap = p.data.tags.filter((t) => tags.includes(t)).length;
    return { post: p, overlap };
  })
  .filter((r) => r.overlap > 0)
  .sort((a, b) => b.overlap - a.overlap || b.post.data.publishedDate.valueOf() - a.post.data.publishedDate.valueOf())
  .slice(0, 5)
  .map((r) => r.post);
const postURL = new URL('/blog/' + post.id + '/', Astro.site).toString();
const ogImageURL = new URL('/open-graph/blog/' + post.id + '.png?cb=20260216', Astro.site).toString();
const wordCount = remarkPluginFrontmatter.words as number | undefined;

const isBeautyIndexPost = post.id === 'the-beauty-index';
const articleSection = isBeautyIndexPost ? 'Programming Languages' : undefined;
const aboutDataset = isBeautyIndexPost
  ? { type: 'Dataset', name: 'The Beauty Index', url: 'https://patrykgolabek.dev/beauty-index/' }
  : undefined;

const beautyIndexFAQ = isBeautyIndexPost ? [
  {
    question: 'What does "beauty" mean for a programming language?',
    answer: 'Beauty in programming languages is the embodied experience of encountering code — visual rhythm, balance of whitespace and characters, and whether code looks intentional or accidental. Research shows perceived beauty correlates with perceived quality, and aesthetic judgments of code are made faster than judgments of correctness. The Beauty Index measures it across 6 dimensions: Aesthetic Geometry, Mathematical Elegance, Linguistic Clarity, Practitioner Happiness, Organic Habitability, and Conceptual Integrity.',
  },
  {
    question: 'How are programming languages scored in the Beauty Index?',
    answer: 'Each language is scored 1-10 across six aesthetic dimensions (Phi, Omega, Lambda, Psi, Gamma, Sigma) for a maximum of 60 points. Scores of 1-3 represent "Ugly" code, 4-6 the "Not Ugly" baseline, 7-9 "Beautiful" code, and 10 is "The Book" — transcendental elegance. Languages are then grouped into four tiers: Workhorses, Practical, Handsome, and Beautiful.',
  },
  {
    question: 'What are the six aesthetic dimensions of the Beauty Index?',
    answer: 'The six dimensions are: Phi (Aesthetic Geometry) — visual cleanliness and grid-based order; Omega (Mathematical Elegance) — inevitability, unexpectedness, and economy à la Hardy; Lambda (Linguistic Clarity) — Knuthian literate readability; Psi (Practitioner Happiness) — developer experience and community love; Gamma (Organic Habitability) — Wabi-Sabi growth points and lived-in quality; Sigma (Conceptual Integrity) — whether the language has a coherent design philosophy.',
  },
] : [];

// Shorten title tag for SEO (Google truncates ~60 chars)
const suffix = ' — Patryk Golabek';
const titleTag = (title.length + suffix.length > 65)
  ? `${title.split(':')[0]}${suffix}`
  : `${title}${suffix}`;

---

<Layout
  title={titleTag}
  description={description}
  ogType="article"
  publishedDate={publishedDate}
  updatedDate={post.data.updatedDate}
  tags={tags}
  ogImage={ogImageURL}
>
  <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <header class="mb-8" data-reveal="up">
      <h1 class="text-3xl sm:text-4xl font-heading font-bold">{title}</h1>
      <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-4 text-sm text-[var(--color-text-secondary)]">
        <time datetime={publishedDate.toISOString()}>
          {publishedDate.toLocaleDateString('en-CA', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        <span aria-label="Reading time">{remarkPluginFrontmatter.minutesRead}</span>
      </div>
      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {tags.map((tag) => (
            <a
              href={`/blog/tags/${tag}/`}
              class="text-xs px-2 py-1 rounded-full bg-[var(--color-accent)]/10 text-[var(--color-accent)] hover:bg-[var(--color-accent)]/20 transition-colors"
            >
              {tag}
            </a>
          ))}
        </div>
      )}
    </header>
    <div class="mb-8">
      <TableOfContents headings={headings} />
    </div>
    <div class:list={['prose max-w-none mt-8', { 'dark-code': isBeautyIndexPost }]}>
      <Content />
    </div>
    {isBeautyIndexPost && (
      <script is:inline>
        document.querySelectorAll('.dark-code .expressive-code').forEach(function(el) { el.classList.add('dark'); });
      </script>
    )}
    <BlogPostingJsonLd
      title={title}
      description={description}
      publishedDate={publishedDate}
      updatedDate={post.data.updatedDate}
      url={postURL}
      tags={tags}
      image={ogImageURL}
      articleSection={articleSection}
      wordCount={wordCount}
      about={aboutDataset}
    />
    {beautyIndexFAQ.length > 0 && <FAQPageJsonLd items={beautyIndexFAQ} />}
    <BreadcrumbJsonLd crumbs={[
      { name: "Home", url: `${Astro.site}` },
      { name: "Blog", url: `${new URL('/blog/', Astro.site)}` },
      { name: title, url: postURL },
    ]} />
  </article>
  {relatedPosts.length > 0 && (
    <aside class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
      <h2 class="text-xl font-heading font-bold mb-6">Related Articles</h2>
      <div class="space-y-4">
        {relatedPosts.map((related) => {
          const isExternal = !!related.data.externalUrl;
          const href = isExternal ? related.data.externalUrl : `/blog/${related.id}/`;
          return (
            <a
              href={href}
              class="block p-4 rounded-lg border border-[var(--color-border)] hover:border-[var(--color-accent)] transition-colors"
              {...isExternal && { target: "_blank", rel: "noopener noreferrer" }}
            >
              <div class="flex items-center gap-2 text-sm text-[var(--color-text-secondary)]">
                <time datetime={related.data.publishedDate.toISOString()}>
                  {related.data.publishedDate.toLocaleDateString('en-CA', { year: 'numeric', month: 'short' })}
                </time>
                {related.data.source && (
                  <span class="text-xs px-2 py-0.5 rounded-full bg-[var(--color-accent)]/10 text-[var(--color-accent)]">
                    {related.data.source}
                  </span>
                )}
                {isExternal && (
                  <svg class="w-3.5 h-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5zm7.25-.75a.75.75 0 01.75-.75h3.5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V6.31l-5.47 5.47a.75.75 0 01-1.06-1.06l5.47-5.47H12.25a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                  </svg>
                )}
              </div>
              <h3 class="font-heading font-bold mt-1 hover:text-[var(--color-accent)] transition-colors">
                {related.data.title}
              </h3>
            </a>
          );
        })}
      </div>
    </aside>
  )}
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
    <a href="/blog/" class="text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors">
      &larr; Back to Blog
    </a>
  </div>

  <!-- Back to Top Button -->
  <button
    id="back-to-top"
    aria-label="Back to top"
    class="fixed bottom-8 right-8 z-40 w-10 h-10 rounded-full bg-[var(--color-accent)] text-white shadow-lg flex items-center justify-center opacity-0 translate-y-4 transition-all duration-300 hover:bg-[var(--color-accent-hover)] hover:shadow-xl"
    style="pointer-events: none;"
  >
    <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.612L5.03 9.97a.75.75 0 01-1.06-1.06l5.5-5.5a.75.75 0 011.06 0l5.5 5.5a.75.75 0 11-1.06 1.06l-4.22-4.358V16.25A.75.75 0 0110 17z" clip-rule="evenodd" />
    </svg>
  </button>
</Layout>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  gsap.registerPlugin(ScrollTrigger);

  function initBlogEnhancements() {
    const REDUCED_MOTION = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Back to top button
    const btn = document.getElementById('back-to-top');
    if (btn) {
      function toggleVisibility() {
        if (window.scrollY > 400) {
          btn.style.opacity = '1';
          btn.style.transform = 'translateY(0)';
          btn.style.pointerEvents = 'auto';
        } else {
          btn.style.opacity = '0';
          btn.style.transform = 'translateY(1rem)';
          btn.style.pointerEvents = 'none';
        }
      }
      window.addEventListener('scroll', toggleVisibility, { passive: true });
      toggleVisibility();
      btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // TOC active indicator
    const toc = document.querySelector('[aria-label="Table of contents"]');
    if (toc) {
      const links = toc.querySelectorAll('a[href^="#"]');
      const targets = Array.from(links)
        .map((l) => document.getElementById(l.getAttribute('href')!.slice(1)))
        .filter(Boolean) as HTMLElement[];

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              links.forEach((l) => {
                l.classList.remove('text-[var(--color-accent)]', 'font-medium');
              });
              const active = toc.querySelector(`a[href="#${entry.target.id}"]`);
              if (active) {
                active.classList.add('text-[var(--color-accent)]', 'font-medium');
              }
            }
          });
        },
        { rootMargin: '-80px 0px -60% 0px' },
      );
      targets.forEach((t) => observer.observe(t));
    }

    // GSAP heading and figure animations
    if (!REDUCED_MOTION) {
      const headings = document.querySelectorAll('.prose h2');
      headings.forEach((h2) => {
        gsap.from(h2, {
          x: -20,
          opacity: 0,
          duration: 0.6,
          ease: 'power2.out',
          scrollTrigger: {
            trigger: h2,
            start: 'top 85%',
            once: true,
          },
        });
      });

      const figures = document.querySelectorAll('.prose figure, .prose .not-prose');
      figures.forEach((fig) => {
        gsap.from(fig, {
          y: 30,
          opacity: 0,
          duration: 0.7,
          ease: 'power3.out',
          scrollTrigger: {
            trigger: fig,
            start: 'top 88%',
            once: true,
          },
        });
      });
    }
  }

  document.addEventListener('astro:page-load', initBlogEnhancements);
</script>
