---
/**
 * Dynamic route for all 29 graphical technique pages.
 * Composes technique-renderer (SVG), technique-content (prose),
 * and PlotVariantSwap (Tier B tab switching) into TechniquePage layout.
 */
import { getCollection } from 'astro:content';
import { Code } from 'astro-expressive-code/components';
import katex from 'katex';
import TechniquePage from '../../../components/eda/TechniquePage.astro';
import PlotVariantSwap from '../../../components/eda/PlotVariantSwap.astro';
import { renderTechniquePlot, renderVariants } from '../../../lib/eda/technique-renderer';
import { getTechniqueContent } from '../../../lib/eda/technique-content';
import { techniqueUrl, caseStudyUrl } from '../../../lib/eda/routes';

export async function getStaticPaths() {
  const allTechniques = await getCollection('edaTechniques');
  const allTechMap = new Map(allTechniques.map(t => [t.data.slug, t.data]));
  const graphical = allTechniques
    .filter(t => t.data.category === 'graphical')
    .map(t => t.data);

  // Resolve case study pages for cross-linking
  const caseStudyPages = await getCollection('edaPages');
  const caseStudyMap = new Map(
    caseStudyPages
      .filter(p => p.data.category === 'case-studies')
      .map(p => [p.id.replace('case-studies/', ''), p.data])
  );

  return graphical.map(technique => {
    const content = getTechniqueContent(technique.slug);
    const caseStudyLinks = (content?.caseStudySlugs ?? [])
      .filter(slug => caseStudyMap.has(slug))
      .map(slug => ({
        slug,
        title: caseStudyMap.get(slug)!.title,
        url: caseStudyUrl(slug),
      }));

    return {
      params: { slug: technique.slug },
      props: {
        technique,
        caseStudyLinks,
        relatedTechniques: technique.relatedTechniques
          .filter((slug: string) => allTechMap.has(slug))
          .map((slug: string) => {
            const related = allTechMap.get(slug)!;
            return {
              slug,
              name: related.title,
              url: techniqueUrl(slug, related.category),
            };
          }),
      },
    };
  });
}

const { technique, relatedTechniques, caseStudyLinks } = Astro.props;
const plotSvg = renderTechniquePlot(technique.slug);
const content = getTechniqueContent(technique.slug);
const isTierB = technique.tier === 'B';
const variants = isTierB ? renderVariants(technique.slug) : [];

// Pre-render KaTeX formulas at build time (pattern from quantitative/[slug].astro)
const renderedFormulas = content?.formulas?.map(f => ({
  ...f,
  html: katex.renderToString(f.tex, { displayMode: true, throwOnError: false }),
})) ?? [];
const hasFormulas = renderedFormulas.length > 0;
---

<TechniquePage
  title={technique.title}
  description={technique.description}
  category="Graphical Techniques"
  nistSection={technique.nistSection}
  slug={technique.slug}
  relatedTechniques={relatedTechniques}
  useKatex={hasFormulas}
>
  <Fragment slot="plot">
    {isTierB ? (
      <PlotVariantSwap variants={variants} techniqueTitle={technique.title} />
    ) : (
      <div role="img" aria-label={`${technique.title} statistical chart`} class="mt-8 mb-10" set:html={plotSvg} />
    )}
  </Fragment>

  {content && (
    <Fragment slot="description">
      <section class="prose-section mt-8 space-y-6">
        <div>
          <h2 class="text-xl font-heading font-bold mb-3">What It Is</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed">{content.definition}</p>
        </div>
        <div>
          <h2 class="text-xl font-heading font-bold mb-3">When to Use It</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed">{content.purpose}</p>
        </div>
        <div>
          <h2 class="text-xl font-heading font-bold mb-3">How to Interpret</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed">{content.interpretation}</p>
        </div>
        <div>
          <h2 class="text-xl font-heading font-bold mb-3">Assumptions and Limitations</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed">{content.assumptions}</p>
        </div>
        <p class="text-sm text-[var(--color-text-secondary)] italic mt-4">
          Reference: {content.nistReference}
        </p>
      </section>
    </Fragment>
  )}
</TechniquePage>
