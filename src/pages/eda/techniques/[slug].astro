---
/**
 * Dynamic route for all 29 graphical technique pages.
 * Composes technique-renderer (SVG), technique-content (prose),
 * and PlotVariantSwap (Tier B tab switching) into TechniquePage layout.
 */
import { getCollection } from 'astro:content';
import { Code } from 'astro-expressive-code/components';
import katex from 'katex';
import TechniquePage from '../../../components/eda/TechniquePage.astro';
import PlotVariantSwap from '../../../components/eda/PlotVariantSwap.astro';
import { renderTechniquePlot, renderVariants } from '../../../lib/eda/technique-renderer';
import { getTechniqueContent } from '../../../lib/eda/technique-content';
import { techniqueUrl, caseStudyUrl } from '../../../lib/eda/routes';

export async function getStaticPaths() {
  const allTechniques = await getCollection('edaTechniques');
  const allTechMap = new Map(allTechniques.map(t => [t.data.slug, t.data]));
  const graphical = allTechniques
    .filter(t => t.data.category === 'graphical')
    .map(t => t.data);

  // Resolve case study pages for cross-linking
  const caseStudyPages = await getCollection('edaPages');
  const caseStudyMap = new Map(
    caseStudyPages
      .filter(p => p.data.category === 'case-studies')
      .map(p => [p.id.replace('case-studies/', ''), p.data])
  );

  return graphical.map(technique => {
    const content = getTechniqueContent(technique.slug);
    const caseStudyLinks = (content?.caseStudySlugs ?? [])
      .filter(slug => caseStudyMap.has(slug))
      .map(slug => ({
        slug,
        title: caseStudyMap.get(slug)!.title,
        url: caseStudyUrl(slug),
      }));

    return {
      params: { slug: technique.slug },
      props: {
        technique,
        caseStudyLinks,
        relatedTechniques: technique.relatedTechniques
          .filter((slug: string) => allTechMap.has(slug))
          .map((slug: string) => {
            const related = allTechMap.get(slug)!;
            return {
              slug,
              name: related.title,
              url: techniqueUrl(slug, related.category),
            };
          }),
      },
    };
  });
}

const { technique, relatedTechniques, caseStudyLinks } = Astro.props;
const plotSvg = renderTechniquePlot(technique.slug);
const content = getTechniqueContent(technique.slug);
const isTierB = technique.tier === 'B';
const variants = isTierB ? renderVariants(technique.slug) : [];

/** Replace $...$ delimiters with KaTeX inline HTML at build time */
function renderInlineMath(text: string): string {
  return text.replace(/\$([^$]+)\$/g, (_, tex) =>
    katex.renderToString(tex, { displayMode: false, throwOnError: false })
  );
}

// Pre-render KaTeX formulas at build time (pattern from quantitative/[slug].astro)
const renderedFormulas = content?.formulas?.map(f => ({
  ...f,
  html: katex.renderToString(f.tex, { displayMode: true, throwOnError: false }),
})) ?? [];
const hasFormulas = renderedFormulas.length > 0;
const hasInlineMath = [
  content?.definition, content?.definitionExpanded, content?.importance,
  content?.purpose, content?.interpretation, content?.assumptions,
  ...(content?.questions ?? []),
  ...(content?.examples?.map(e => e.description) ?? []),
].some(t => t?.includes('$'));
const needsKatex = hasFormulas || hasInlineMath;
---

<TechniquePage
  title={technique.title}
  description={technique.description}
  category="Graphical Techniques"
  nistSection={technique.nistSection}
  slug={technique.slug}
  relatedTechniques={relatedTechniques}
  useKatex={needsKatex}
>
  <Fragment slot="plot">
    {isTierB ? (
      <PlotVariantSwap variants={variants} techniqueTitle={technique.title} />
    ) : (
      <figure class="mt-8 mb-10">
        <div role="img" aria-label={`${technique.title} â€” ${content?.definition?.substring(0, 120) ?? 'statistical chart'}`} set:html={plotSvg} />
        <figcaption class="sr-only">{content?.definition}</figcaption>
      </figure>
    )}
  </Fragment>

  {content && (
    <Fragment slot="description">
      <section class="prose-section mt-8 space-y-6">
        {/* 1. What It Is (definition + optional definitionExpanded) */}
        <div>
          <h2 id="what-it-is" class="text-xl font-heading font-bold mb-3">What It Is</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed" set:html={renderInlineMath(content.definition)} />
          {content.anatomyDiagram && (
            <div role="img" aria-label="Annotated box plot anatomy diagram" class="my-6" set:html={content.anatomyDiagram} />
          )}
          {content.definitionExpanded && (
            <p class="text-[var(--color-text-secondary)] leading-relaxed mt-3" set:html={renderInlineMath(content.definitionExpanded)} />
          )}
        </div>

        {/* 2. Questions This Plot Answers */}
        {content.questions && content.questions.length > 0 && (
          <div>
            <h2 id="questions" class="text-xl font-heading font-bold mb-3">Questions This Plot Answers</h2>
            <ul class="list-disc list-inside space-y-1 text-[var(--color-text-secondary)]">
              {content.questions.map(q => (
                <li set:html={renderInlineMath(q)} />
              ))}
            </ul>
          </div>
        )}

        {/* 3. Why It Matters */}
        {content.importance && (
          <div>
            <h2 id="why-it-matters" class="text-xl font-heading font-bold mb-3">Why It Matters</h2>
            <p class="text-[var(--color-text-secondary)] leading-relaxed" set:html={renderInlineMath(content.importance)} />
          </div>
        )}

        {/* 4. When to Use It */}
        <div>
          <h2 id="when-to-use" class="text-xl font-heading font-bold mb-3">When to Use a {technique.title}</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed" set:html={renderInlineMath(content.purpose)} />
        </div>

        {/* 5. How to Interpret */}
        <div>
          <h2 id="how-to-interpret" class="text-xl font-heading font-bold mb-3">How to Interpret a {technique.title}</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed" set:html={renderInlineMath(content.interpretation)} />
        </div>

        {/* 6. Examples */}
        {content.examples && content.examples.length > 0 && (
          <div>
            <h2 class="text-xl font-heading font-bold mb-3">Examples</h2>
            {content.examples.map(ex => (
              <div class="mb-4">
                <h3 class="text-lg font-semibold mb-1">{ex.label}</h3>
                <p class="text-[var(--color-text-secondary)] leading-relaxed" set:html={renderInlineMath(ex.description)} />
              </div>
            ))}
          </div>
        )}

        {/* 7. Assumptions and Limitations */}
        <div>
          <h2 id="assumptions" class="text-xl font-heading font-bold mb-3">Assumptions and Limitations</h2>
          <p class="text-[var(--color-text-secondary)] leading-relaxed" set:html={renderInlineMath(content.assumptions)} />
        </div>

        {/* 8. See It In Action (case study cross-links) */}
        {caseStudyLinks.length > 0 && (
          <div>
            <h2 class="text-xl font-heading font-bold mb-3">See It In Action</h2>
            <p class="text-[var(--color-text-secondary)] leading-relaxed mb-3">This technique is demonstrated in the following case studies:</p>
            <div class="flex flex-wrap gap-3">
              {caseStudyLinks.map(cs => (
                <a href={cs.url}
                   class="inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-[var(--color-accent)]/10 text-[var(--color-accent)] hover:bg-[var(--color-accent)]/20 transition-colors">
                  {cs.title}
                </a>
              ))}
            </div>
          </div>
        )}

        {/* 9. Reference */}
        <p class="text-sm text-[var(--color-text-secondary)] italic mt-4">
          Reference: {content.nistReference}
        </p>
      </section>
    </Fragment>
  )}

  {/* Formula slot: KaTeX pre-rendered at build time */}
  {renderedFormulas.length > 0 && (
    <Fragment slot="formula">
      <section class="prose-section mt-8 space-y-6">
        <h2 class="text-xl font-heading font-bold mb-3">Formulas</h2>
        {renderedFormulas.map(f => (
          <div class="formula-block mb-6">
            <h3 class="text-lg font-semibold mb-2">{f.label}</h3>
            <div class="katex-display-wrapper my-4 overflow-x-auto" set:html={f.html} />
            <p class="text-[var(--color-text-secondary)]" set:html={renderInlineMath(f.explanation)} />
          </div>
        ))}
      </section>
    </Fragment>
  )}

  {/* Code slot: Python syntax-highlighted via astro-expressive-code */}
  {content?.pythonCode && (
    <Fragment slot="code">
      <section class="prose-section mt-8">
        <h2 class="text-xl font-heading font-bold mb-3">Python Example</h2>
        <Code code={content.pythonCode} lang="python" />
      </section>
    </Fragment>
  )}
</TechniquePage>
