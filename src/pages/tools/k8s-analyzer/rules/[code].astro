---
import { Code as AstroCode } from 'astro:components';
import Layout from '../../../../layouts/Layout.astro';
import BreadcrumbJsonLd from '../../../../components/BreadcrumbJsonLd.astro';
import FAQPageJsonLd from '../../../../components/FAQPageJsonLd.astro';
import { allDocumentedK8sRules } from '../../../../lib/tools/k8s-analyzer/rules/index';
import { getRelatedK8sRules } from '../../../../lib/tools/k8s-analyzer/rules/related';
import { PSS_BASELINE_RULES, PSS_RESTRICTED_RULES } from '../../../../lib/tools/k8s-analyzer/pss-compliance';
import { CIS_BENCHMARK_REFS } from '../../../../lib/tools/k8s-analyzer/cis-benchmark';
import type { K8sSeverity, K8sCategory } from '../../../../lib/tools/k8s-analyzer/types';
import type { DocumentedK8sRule } from '../../../../lib/tools/k8s-analyzer/rules/index';

export function getStaticPaths() {
  return allDocumentedK8sRules.map((rule) => ({
    params: { code: rule.id.toLowerCase() },
    props: { rule },
  }));
}

interface Props {
  rule: DocumentedK8sRule;
}

const { rule } = Astro.props;
const relatedRules = getRelatedK8sRules(rule.id);
const pssProfile = PSS_RESTRICTED_RULES.has(rule.id)
  ? 'PSS Restricted'
  : PSS_BASELINE_RULES.has(rule.id)
    ? 'PSS Baseline'
    : null;
const cisRef = CIS_BENCHMARK_REFS[rule.id];

const severityLabel: Record<K8sSeverity, string> = {
  error: 'Error',
  warning: 'Warning',
  info: 'Info',
};

const categoryLabel: Record<K8sCategory, string> = {
  schema: 'Schema',
  security: 'Security',
  reliability: 'Reliability',
  'best-practice': 'Best Practice',
  'cross-resource': 'Cross-Resource',
};

const severityColor: Record<K8sSeverity, { bg: string; text: string }> = {
  error: { bg: 'bg-red-100', text: 'text-red-700' },
  warning: { bg: 'bg-amber-100', text: 'text-amber-700' },
  info: { bg: 'bg-blue-100', text: 'text-blue-700' },
};

const pageTitle = `${rule.id}: ${rule.title} | Kubernetes Manifest Analyzer`;
const truncatedExplanation = rule.explanation.length > 155
  ? rule.explanation.slice(0, 155) + '...'
  : rule.explanation;
const pageDesc = truncatedExplanation;
const pageUrl = new URL(`/tools/k8s-analyzer/rules/${rule.id.toLowerCase()}/`, Astro.site).toString();
---

<Layout title={pageTitle} description={pageDesc}>
  <BreadcrumbJsonLd crumbs={[
    { name: 'Home', url: 'https://patrykgolabek.dev/' },
    { name: 'Tools', url: 'https://patrykgolabek.dev/tools/' },
    { name: 'K8s Analyzer', url: 'https://patrykgolabek.dev/tools/k8s-analyzer/' },
    { name: rule.id, url: pageUrl },
  ]} />
  <FAQPageJsonLd items={[
    {
      question: `What does K8s rule ${rule.id} mean?`,
      answer: rule.explanation,
    },
    {
      question: `How do I fix ${rule.id} (${rule.title}) in my Kubernetes manifest?`,
      answer: rule.fix.description,
    },
  ]} />
  <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-16">

    {/* Header section */}
    <header class="mb-10">
      <h1 class="text-3xl sm:text-4xl font-heading font-bold mb-4">
        {rule.id}: {rule.title}
      </h1>
      <div class="flex flex-wrap gap-3">
        <span class:list={[
          'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium',
          severityColor[rule.severity].bg,
          severityColor[rule.severity].text,
        ]}>
          {severityLabel[rule.severity]}
        </span>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-[var(--color-accent)]/10 text-[var(--color-accent)]">
          {categoryLabel[rule.category]}
        </span>
        {pssProfile && (
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-700">
            {pssProfile}
          </span>
        )}
      </div>
      {cisRef && (
        <p class="mt-3 text-sm text-[var(--color-text-secondary)]">
          CIS Kubernetes Benchmark v1.8, Section {cisRef.section}: {cisRef.title}
        </p>
      )}
    </header>

    {/* Explanation section */}
    <section class="mb-10">
      <h2 class="text-2xl font-heading font-bold mb-4">Why This Matters</h2>
      <div class="prose max-w-none">
        <p class="text-[var(--color-text-secondary)] leading-relaxed">{rule.explanation}</p>
      </div>
    </section>

    {/* How to Fix section */}
    <section class="mb-10">
      <h2 class="text-2xl font-heading font-bold mb-4">How to Fix</h2>
      <p class="text-[var(--color-text-secondary)] leading-relaxed mb-6">{rule.fix.description}</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <h3 class="text-sm font-medium text-[var(--color-text-secondary)] mb-2">Before (incorrect)</h3>
          <AstroCode code={rule.fix.beforeCode} lang="yaml" />
        </div>
        <div>
          <h3 class="text-sm font-medium text-[var(--color-text-secondary)] mb-2">After (correct)</h3>
          <AstroCode code={rule.fix.afterCode} lang="yaml" />
        </div>
      </div>
    </section>

    {/* Rule Details section */}
    <section class="mb-10">
      <h2 class="text-2xl font-heading font-bold mb-4">Rule Details</h2>
      <dl class="space-y-3">
        <div class="flex gap-3">
          <dt class="text-[var(--color-text-secondary)] min-w-[8rem]">Rule Code</dt>
          <dd class="font-medium text-[var(--color-text-primary)]">{rule.id}</dd>
        </div>
        <div class="flex gap-3">
          <dt class="text-[var(--color-text-secondary)] min-w-[8rem]">Severity</dt>
          <dd class="font-medium text-[var(--color-text-primary)]">{severityLabel[rule.severity]}</dd>
        </div>
        <div class="flex gap-3">
          <dt class="text-[var(--color-text-secondary)] min-w-[8rem]">Category</dt>
          <dd class="font-medium text-[var(--color-text-primary)]">{categoryLabel[rule.category]}</dd>
        </div>
      </dl>
    </section>

    {/* Related Rules section */}
    {relatedRules.length > 0 && (
      <section class="mb-10">
        <h2 class="text-2xl font-heading font-bold mb-4">Related Rules</h2>
        <div class="space-y-3">
          {relatedRules.map((related) => (
            <a
              href={`/tools/k8s-analyzer/rules/${related.id.toLowerCase()}/`}
              class="block p-4 rounded-lg border border-[var(--color-border)] hover:border-[var(--color-accent)] transition-colors"
            >
              <div class="flex items-center gap-3">
                <span class="font-mono text-sm font-medium text-[var(--color-text-primary)]">{related.id}</span>
                <span class:list={[
                  'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium',
                  severityColor[related.severity].bg,
                  severityColor[related.severity].text,
                ]}>
                  {severityLabel[related.severity]}
                </span>
              </div>
              <p class="mt-1 text-[var(--color-text-secondary)] text-sm">{related.title}</p>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Back-links footer */}
    <footer class="pt-8 border-t border-[var(--color-border)] flex flex-col sm:flex-row gap-4">
      <a
        href="/tools/k8s-analyzer/"
        class="text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors font-medium"
      >
        &larr; Try the K8s Manifest Analyzer
      </a>
      <a
        href="/blog/kubernetes-manifest-best-practices/"
        class="text-[var(--color-accent)] hover:text-[var(--color-accent-hover)] transition-colors font-medium"
      >
        Read the best practices guide &rarr;
      </a>
    </footer>
  </article>

</Layout>
