---
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SEOHead from '../components/SEOHead.astro';
import CustomCursor from '../components/animations/CustomCursor.astro';
import TiltCard from '../components/animations/TiltCard.astro';
import MagneticButton from '../components/animations/MagneticButton.astro';
import SplitText from '../components/animations/SplitText.astro';
import TextScramble from '../components/animations/TextScramble.astro';
import WordReveal from '../components/animations/WordReveal.astro';
import FloatingOrbs from '../components/animations/FloatingOrbs.astro';
import TimelineDrawLine from '../components/animations/TimelineDrawLine.astro';

interface Props {
  title: string;
  description?: string;
  canonicalURL?: URL | string;
  ogType?: 'website' | 'article';
  publishedDate?: Date;
  updatedDate?: Date;
  tags?: string[];
  ogImage?: string;
}

const {
  title,
  description = 'Patryk Golabek â€” Cloud-Native Software Architect',
  canonicalURL,
  ogType = 'website',
  publishedDate,
  updatedDate,
  tags,
  ogImage = `${new URL('/open-graph/default.png', Astro.site)}`,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/favicon-32.png" sizes="32x32" type="image/png" />
    <link rel="icon" href="/favicon-16.png" sizes="16x16" type="image/png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#c44b20" />

    <ClientRouter />
    <SEOHead
      title={title}
      description={description}
      canonicalURL={canonicalURL}
      ogType={ogType}
      publishedDate={publishedDate}
      updatedDate={updatedDate}
      tags={tags}
      ogImage={ogImage}
    />

    <!-- RSS Autodiscovery -->
    <link rel="alternate" type="application/rss+xml" title="Patryk Golabek | Blog" href="/rss.xml" />

    <!-- Google Fonts: Bricolage Grotesque (headings), DM Sans (body), Fira Code (mono) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@700;800&family=DM+Sans:wght@400;500;700&family=Fira+Code:wght@400&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@700;800&family=DM+Sans:wght@400;500;700&family=Fira+Code:wght@400&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <slot name="head" />
  </head>
  <body class="min-h-screen flex flex-col bg-[var(--color-surface)] text-[var(--color-text-primary)]">
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress" aria-hidden="true">
      <div class="scroll-progress-bar" id="scroll-progress-bar"></div>
    </div>

    <!-- Navigation Loading Indicator -->
    <div id="nav-loading" class="fixed top-0 left-0 w-full h-[2px] bg-[var(--color-accent)] z-[60] scale-x-0 origin-left transition-transform duration-300" aria-hidden="true"></div>

    <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-[var(--color-accent)] focus:text-white focus:rounded-lg focus:outline-none">
      Skip to main content
    </a>
    <Header />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />
    <CustomCursor />
    <TiltCard />
    <MagneticButton />
    <SplitText />
    <TextScramble />
    <WordReveal />
    <FloatingOrbs />
    <TimelineDrawLine />

    <!-- Animation lifecycle: GSAP ScrollTrigger + Lenis smooth scroll -->
    <script>
      import { initSmoothScroll } from '../lib/smooth-scroll';
      import { initScrollAnimations } from '../lib/scroll-animations';
      import { cleanupAnimations } from '../lib/animation-lifecycle';

      function initAll() {
        initSmoothScroll();
        initScrollAnimations();
        initScrollProgress();
      }

      function initScrollProgress() {
        const bar = document.getElementById('scroll-progress-bar');
        if (!bar) return;

        function updateProgress() {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
          bar!.style.width = `${progress}%`;
        }

        window.addEventListener('scroll', updateProgress, { passive: true });
        updateProgress();
      }

      document.addEventListener('astro:page-load', initAll);
      document.addEventListener('astro:before-swap', cleanupAnimations);
    </script>

    <!-- Navigation loading indicator -->
    <script>
      document.addEventListener('astro:before-preparation', () => {
        const bar = document.getElementById('nav-loading');
        if (bar) bar.style.transform = 'scaleX(0.7)';
      });
      document.addEventListener('astro:page-load', () => {
        const bar = document.getElementById('nav-loading');
        if (bar) {
          bar.style.transform = 'scaleX(1)';
          setTimeout(() => {
            bar.style.opacity = '0';
            setTimeout(() => {
              bar.style.transform = 'scaleX(0)';
              bar.style.opacity = '1';
            }, 200);
          }, 150);
        }
      });
    </script>
  </body>
</html>
