---
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SEOHead from '../components/SEOHead.astro';
import CustomCursor from '../components/animations/CustomCursor.astro';
import TiltCard from '../components/animations/TiltCard.astro';
import MagneticButton from '../components/animations/MagneticButton.astro';
import SplitText from '../components/animations/SplitText.astro';
import TextScramble from '../components/animations/TextScramble.astro';
import WordReveal from '../components/animations/WordReveal.astro';
import FloatingOrbs from '../components/animations/FloatingOrbs.astro';
import TimelineDrawLine from '../components/animations/TimelineDrawLine.astro';

interface Props {
  title: string;
  description?: string;
  canonicalURL?: URL | string;
  ogType?: 'website' | 'article';
  publishedDate?: Date;
  updatedDate?: Date;
  tags?: string[];
  ogImage?: string;
  ogImageAlt?: string;
  robots?: string;
}

const {
  title,
  description = 'Patryk Golabek — Cloud-Native Software Architect',
  canonicalURL,
  ogType = 'website',
  publishedDate,
  updatedDate,
  tags,
  ogImage = `${new URL('/open-graph/default.png', Astro.site)}`,
  ogImageAlt,
  robots,
} = Astro.props;

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "@id": "https://patrykgolabek.dev/#website",
  "name": "Patryk Golabek",
  "url": "https://patrykgolabek.dev",
  "description": "Portfolio of Patryk Golabek, Cloud-Native Software Architect with 17+ years of experience in Kubernetes, AI/ML systems, platform engineering, and DevSecOps.",
  "inLanguage": "en",
  "publisher": {
    "@type": "Person",
    "@id": "https://patrykgolabek.dev/#person"
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": "https://www.google.com/search?q=site:patrykgolabek.dev+{search_term_string}"
    },
    "query-input": "required name=search_term_string"
  }
};
---

<!doctype html>
<html lang="en-CA">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Security Headers -->
    <!--
      Note: frame-ancestors directive is NOT supported in meta CSP tags (only in HTTP headers).
      Using frame-src 'self' to allow Astro View Transitions (which use iframes). For inbound clickjacking protection
      (X-Frame-Options equivalent), a server-level header is needed — not possible on GitHub Pages.
      Note: X-Content-Type-Options: nosniff cannot be set via meta tags (GitHub Pages limitation).
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' blob: 'wasm-unsafe-eval' https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https://www.google-analytics.com; connect-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com blob: https://www.google-analytics.com https://www.googletagmanager.com; worker-src 'self' blob:; frame-src 'self'; base-uri 'self'; form-action 'self'" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" />

    <meta name="generator" content={Astro.generator} />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/favicon-32.png" sizes="32x32" type="image/png" />
    <link rel="icon" href="/favicon-16.png" sizes="16x16" type="image/png" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#c44b20" />

    <ClientRouter />
    <SEOHead
      title={title}
      description={description}
      canonicalURL={canonicalURL}
      ogType={ogType}
      publishedDate={publishedDate}
      updatedDate={updatedDate}
      tags={tags}
      ogImage={ogImage}
      ogImageAlt={ogImageAlt}
      robots={robots}
    />

    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

    <!-- RSS Autodiscovery -->
    <link rel="alternate" type="application/rss+xml" title="Patryk Golabek | Blog" href="/rss.xml" />

    <!-- LLM-friendly plain-text summary (llmstxt.org) -->
    <link rel="alternate" type="text/plain" href="/llms.txt" title="LLM-friendly site summary" />

    <!-- Google Fonts: Bricolage Grotesque (headings), DM Sans (body), Fira Code (mono), Noto Sans (Greek fallback) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@700;800&family=DM+Sans:wght@400;500;700&family=Fira+Code:wght@400&family=Noto+Sans:wght@400;700&display=swap"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@700;800&family=DM+Sans:wght@400;500;700&family=Fira+Code:wght@400&family=Noto+Sans:wght@400;700&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <!-- Google Analytics -->
    <script is:inline async src="https://www.googletagmanager.com/gtag/js?id=G-Z0PWW9KH5R"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Z0PWW9KH5R');
    </script>

    <slot name="head" />
  </head>
  <body class="min-h-screen flex flex-col bg-[var(--color-surface)] text-[var(--color-text-primary)]">
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress" aria-hidden="true">
      <div class="scroll-progress-bar" id="scroll-progress-bar"></div>
    </div>

    <!-- Navigation Loading Indicator -->
    <div id="nav-loading" class="fixed top-0 left-0 w-full h-[2px] bg-[var(--color-accent)] z-[60] scale-x-0 origin-left transition-transform duration-300" aria-hidden="true"></div>

    <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-[var(--color-accent)] focus:text-white focus:rounded-lg focus:outline-none">
      Skip to main content
    </a>
    <Header />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />
    <CustomCursor />
    <TiltCard />
    <MagneticButton />
    <SplitText />
    <TextScramble />
    <WordReveal />
    <FloatingOrbs />
    <TimelineDrawLine />

    <!-- Animation lifecycle: GSAP ScrollTrigger + Lenis smooth scroll -->
    <script>
      import { initSmoothScroll } from '../lib/smooth-scroll';
      import { initScrollAnimations } from '../lib/scroll-animations';
      import { cleanupAnimations } from '../lib/animation-lifecycle';

      function initAll() {
        initSmoothScroll();
        initScrollAnimations();
        initScrollProgress();
      }

      function initScrollProgress() {
        const bar = document.getElementById('scroll-progress-bar');
        if (!bar) return;

        function updateProgress() {
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
          bar!.style.width = `${progress}%`;
        }

        window.addEventListener('scroll', updateProgress, { passive: true });
        updateProgress();
      }

      document.addEventListener('astro:page-load', initAll);
      document.addEventListener('astro:before-swap', cleanupAnimations);
    </script>

    <!-- Navigation loading indicator -->
    <script>
      document.addEventListener('astro:before-preparation', () => {
        const bar = document.getElementById('nav-loading');
        if (bar) bar.style.transform = 'scaleX(0.7)';
      });
      document.addEventListener('astro:page-load', () => {
        const bar = document.getElementById('nav-loading');
        if (bar) {
          bar.style.transform = 'scaleX(1)';
          setTimeout(() => {
            bar.style.opacity = '0';
            setTimeout(() => {
              bar.style.transform = 'scaleX(0)';
              bar.style.opacity = '1';
            }, 200);
          }, 150);
        }
      });
    </script>
  </body>
</html>
